<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XCLIP</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Noto+Sans+JP:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
  --white:#ffffff; --off:#f7f6f3; --paper:#faf9f6;
  --ink:#111111; --ink2:#444444; --ink3:#999999;
  --line:#e0ddd6; --accent:#d4502a; --accent-light:#f5e8e3;
  --blue:#3b82f6; --purple:#8b5cf6; --green:#059669;
  --yellow:#f59e0b; --yellow-bg:#fff8e1;
  --shadow-sm:0 1px 4px rgba(0,0,0,.06);
  --shadow-md:0 4px 24px rgba(0,0,0,.08);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--paper);color:var(--ink);font-family:'Noto Sans JP',sans-serif;font-weight:300;min-height:100vh;-webkit-font-smoothing:antialiased;}

/* â”€â”€ REMINDER BAR â”€â”€ */
#reminderBar{background:var(--yellow-bg);border-bottom:2px solid var(--yellow);padding:.6rem 2rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap;min-height:44px;}
#reminderBar .rb-label{font-family:'DM Mono',monospace;font-size:.62rem;letter-spacing:.15em;text-transform:uppercase;color:#92400e;white-space:nowrap;}
#reminderBar .rb-empty{font-size:.8rem;color:#a16207;}
.rb-item{display:flex;align-items:center;gap:.5rem;background:#fff;border:1px solid var(--yellow);border-radius:4px;padding:.25rem .7rem;font-size:.78rem;}
.rb-item .rb-dismiss{background:transparent;border:none;color:#a16207;cursor:pointer;font-size:.9rem;margin-left:.3rem;}

/* â”€â”€ HEADER â”€â”€ */
header{position:sticky;top:0;z-index:200;background:rgba(250,249,246,.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--line);}
.header-inner{max-width:1400px;margin:0 auto;padding:0 2rem;height:56px;display:flex;align-items:center;gap:1.5rem;}
.logo-main{font-family:'Playfair Display',serif;font-weight:900;font-size:1.35rem;color:var(--ink);letter-spacing:-.03em;}
.logo-main em{color:var(--accent);font-style:normal;}
.logo-sub{font-family:'DM Mono',monospace;font-size:.52rem;letter-spacing:.18em;color:var(--ink3);text-transform:uppercase;}
.header-rule{flex:1;height:1px;background:var(--line);}
.header-stats{display:flex;gap:1.5rem;}
.stat-n{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;}
.stat-l{font-family:'DM Mono',monospace;font-size:.52rem;letter-spacing:.12em;color:var(--ink3);text-transform:uppercase;}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;border-bottom:1px solid var(--line);background:var(--white);position:sticky;top:56px;z-index:150;}
.tab-btn{flex:1;padding:.75rem;font-size:.82rem;font-family:'Noto Sans JP',sans-serif;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--ink3);cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:.4rem;}
.tab-btn:hover{color:var(--ink);background:var(--off);}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:500;}
.tab-pane{display:none;max-width:1400px;margin:0 auto;padding:1.5rem 2rem;}
.tab-pane.active{display:block;}

/* â”€â”€ HOME TAB â”€â”€ */
.home-toolbar{display:flex;align-items:center;gap:1rem;margin-bottom:1.25rem;flex-wrap:wrap;}
.search-wrap{flex:1;min-width:180px;position:relative;}
.search-ico{position:absolute;left:.75rem;top:50%;transform:translateY(-50%);color:var(--ink3);font-size:.9rem;}
.search-fi{width:100%;background:var(--white);border:1px solid var(--line);border-radius:6px;padding:.5rem .75rem .5rem 2.2rem;font-size:.85rem;outline:none;transition:border-color .2s;}
.search-fi:focus{border-color:var(--ink);}
.view-toggle{display:flex;gap:.25rem;}
.vt-btn{background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.4rem .65rem;cursor:pointer;color:var(--ink3);font-size:.9rem;transition:all .15s;}
.vt-btn.active{background:var(--ink);color:var(--white);border-color:var(--ink);}
.mode-toggle{display:flex;gap:.25rem;}
.mode-btn{background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.35rem .75rem;cursor:pointer;color:var(--ink2);font-size:.72rem;font-family:'DM Mono',monospace;letter-spacing:.05em;transition:all .15s;}
.mode-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);}

.home-layout{display:grid;grid-template-columns:220px 1fr;gap:1.5rem;}
.sidebar{background:var(--white);border:1px solid var(--line);border-radius:6px;padding:1.25rem;height:fit-content;position:sticky;top:120px;}
.sb-head{font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.2em;text-transform:uppercase;color:var(--ink3);padding-bottom:.6rem;border-bottom:1px solid var(--line);margin-bottom:.6rem;}
.filter-btn{display:flex;align-items:center;gap:.5rem;width:100%;padding:.4rem .6rem;background:transparent;border:none;border-radius:4px;color:var(--ink2);cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-size:.8rem;font-weight:300;text-align:left;transition:all .15s;margin-bottom:2px;}
.filter-btn:hover{background:var(--off);}
.filter-btn.active{background:var(--ink);color:var(--white);}
.filter-btn .fc{margin-left:auto;font-family:'DM Mono',monospace;font-size:.62rem;opacity:.6;}
.tag-tree-parent{margin-bottom:3px;}
.tag-row{display:flex;align-items:center;gap:.4rem;padding:.35rem .6rem;border-radius:4px;cursor:pointer;transition:background .15s;font-size:.8rem;color:var(--ink2);}
.tag-row:hover{background:var(--off);}
.tag-row.active{background:var(--accent-light);color:var(--accent);font-weight:500;}
.tag-row .t-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.tag-row .t-cnt{margin-left:auto;font-family:'DM Mono',monospace;font-size:.62rem;color:var(--ink3);}
.tag-child-wrap{padding-left:1rem;}
.tag-child-wrap .tag-row{font-size:.75rem;}
.tag-child-wrap .tag-row .t-dot{width:5px;height:5px;}
.area-select{width:100%;background:var(--off);border:1px solid var(--line);border-radius:4px;color:var(--ink);padding:.4rem .6rem;font-size:.78rem;font-family:'Noto Sans JP',sans-serif;outline:none;cursor:pointer;margin-bottom:.4rem;}

.result-info{font-family:'DM Mono',monospace;font-size:.68rem;color:var(--ink3);letter-spacing:.08em;margin-bottom:.75rem;}
.posts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;}
.posts-list{display:flex;flex-direction:column;gap:.6rem;}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--white);border:1px solid var(--line);border-radius:6px;overflow:hidden;transition:box-shadow .2s;}
.card:hover{box-shadow:var(--shadow-md);}
.card-img{width:100%;height:160px;object-fit:cover;display:block;}
.card-body{padding:1rem;}
.card-meta{display:flex;align-items:center;gap:.6rem;margin-bottom:.6rem;}
.c-avatar{width:28px;height:28px;border-radius:50%;background:var(--ink);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;flex-shrink:0;}
.c-author{font-size:.82rem;font-weight:500;color:var(--ink);}
.c-handle{font-size:.72rem;color:var(--ink3);}
.c-date{font-family:'DM Mono',monospace;font-size:.62rem;color:var(--ink3);margin-left:auto;white-space:nowrap;}
.c-content{font-size:.82rem;color:var(--ink2);line-height:1.6;margin-bottom:.5rem;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
.c-summary{font-size:.75rem;color:#6d28d9;background:#f5f3ff;border-left:2px solid #8b5cf6;padding:.4rem .6rem;border-radius:0 4px 4px 0;margin-bottom:.5rem;line-height:1.5;}
.c-memo{font-size:.75rem;color:var(--ink2);background:var(--off);border-left:2px solid var(--line);padding:.35rem .6rem;border-radius:0 3px 3px 0;margin-bottom:.5rem;}
.c-area{font-size:.7rem;color:var(--ink3);margin-bottom:.4rem;}
.c-dist{font-family:'DM Mono',monospace;font-size:.62rem;color:var(--blue);background:#eff6ff;padding:1px 5px;border-radius:3px;margin-left:.3rem;}
.c-tags{display:flex;flex-wrap:wrap;gap:.3rem;margin-bottom:.5rem;}
.c-tag{font-size:.68rem;padding:1px 7px;border-radius:10px;}
.c-footer{display:flex;align-items:center;gap:.4rem;flex-wrap:wrap;margin-top:.5rem;padding-top:.5rem;border-top:1px solid var(--line);}
.c-btn{background:var(--off);border:1px solid var(--line);border-radius:3px;padding:.2rem .55rem;font-size:.7rem;cursor:pointer;color:var(--ink2);transition:all .15s;font-family:'Noto Sans JP',sans-serif;}
.c-btn:hover{background:var(--ink);color:#fff;border-color:var(--ink);}
.c-btn.del:hover{background:#dc2626;border-color:#dc2626;color:#fff;}
.c-link{font-size:.72rem;color:var(--blue);text-decoration:none;margin-left:auto;}
.c-link:hover{text-decoration:underline;}
.type-badge{font-family:'DM Mono',monospace;font-size:.58rem;padding:1px 6px;border-radius:10px;margin-right:.25rem;}

/* LIST ROW */
.list-row{background:var(--white);border:1px solid var(--line);border-radius:6px;display:grid;grid-template-columns:80px 1fr;overflow:hidden;transition:box-shadow .2s;}
.list-row:hover{box-shadow:var(--shadow-sm);}
.list-img{width:80px;height:80px;object-fit:cover;}
.list-img-ph{width:80px;height:80px;display:flex;align-items:center;justify-content:center;background:var(--off);color:var(--ink3);font-size:1.2rem;}
.list-body{padding:.6rem .85rem;display:flex;flex-direction:column;gap:.2rem;}
.list-top{display:flex;align-items:center;gap:.5rem;font-size:.78rem;}
.list-author{font-weight:500;}
.list-handle{color:var(--ink3);font-size:.72rem;}
.list-date{color:var(--ink3);font-family:'DM Mono',monospace;font-size:.62rem;margin-left:auto;}
.list-content{font-size:.78rem;color:var(--ink2);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.list-bottom{display:flex;align-items:center;gap:.3rem;flex-wrap:wrap;margin-top:.2rem;}

/* GROUP HEADER */
.group-header{font-family:'DM Mono',monospace;font-size:.62rem;letter-spacing:.15em;text-transform:uppercase;color:var(--ink3);padding:.5rem 0 .3rem;border-bottom:1px solid var(--line);margin-bottom:.5rem;margin-top:1rem;}
.group-header:first-child{margin-top:0;}

/* â”€â”€ ADD TAB â”€â”€ */
.add-card{background:var(--white);border:1px solid var(--line);border-radius:8px;padding:1.5rem;max-width:720px;margin:0 auto;}
.type-tabs{display:flex;gap:.5rem;margin-bottom:1.25rem;}
.type-tab{flex:1;padding:.55rem;background:var(--off);border:1.5px solid var(--line);border-radius:20px;color:var(--ink2);font-size:.8rem;cursor:pointer;transition:all .15s;font-family:'Noto Sans JP',sans-serif;text-align:center;}
.type-tab.active{background:var(--ink);border-color:var(--ink);color:#fff;}
.url-row{display:flex;gap:.5rem;margin-bottom:1rem;}
.url-field{flex:1;background:var(--off);border:1px solid var(--line);border-radius:6px;padding:.55rem .85rem;font-size:.85rem;outline:none;transition:border-color .2s;font-family:'Noto Sans JP',sans-serif;}
.url-field:focus{border-color:var(--ink);}
.fetch-btn{background:var(--ink);border:none;border-radius:6px;color:#fff;padding:.55rem 1.1rem;font-size:.82rem;cursor:pointer;white-space:nowrap;transition:background .15s;}
.fetch-btn:hover{background:var(--accent);}
.fetch-btn:disabled{opacity:.5;cursor:not-allowed;}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:.75rem;}
.fg-full{grid-column:1/-1;}
.fl{font-size:.72rem;color:var(--ink3);letter-spacing:.05em;margin-bottom:.25rem;display:block;}
.fi{width:100%;background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.45rem .7rem;font-size:.82rem;color:var(--ink);outline:none;transition:border-color .2s;font-family:'Noto Sans JP',sans-serif;}
.fi:focus{border-color:var(--ink);}
.fi::placeholder{color:var(--ink3);}
.fta{width:100%;background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.5rem .7rem;font-size:.82rem;color:var(--ink);outline:none;resize:vertical;min-height:80px;transition:border-color .2s;font-family:'Noto Sans JP',sans-serif;}
.fta:focus{border-color:var(--ink);}
.img-area{border:1.5px dashed var(--line);border-radius:6px;overflow:hidden;cursor:pointer;position:relative;min-height:80px;display:flex;align-items:center;justify-content:center;background:var(--off);}
.img-area input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;}
.img-area img{width:100%;max-height:200px;object-fit:cover;display:block;}
.img-area-placeholder{display:flex;flex-direction:column;align-items:center;gap:.3rem;color:var(--ink3);font-size:.78rem;pointer-events:none;}
.tag-picker{display:flex;flex-wrap:wrap;gap:.35rem;}
.tp-pill{font-size:.74rem;padding:.25rem .65rem;border-radius:12px;cursor:pointer;border:1.5px solid;transition:all .15s;}
.status-bar{font-size:.78rem;color:var(--ink3);background:var(--off);border-left:2px solid var(--accent);padding:.5rem .75rem;border-radius:0 4px 4px 0;margin-bottom:.75rem;display:none;}
.form-actions{display:flex;justify-content:flex-end;gap:.6rem;margin-top:1rem;padding-top:1rem;border-top:1px solid var(--line);}
.btn-ghost{background:transparent;border:1px solid var(--line);border-radius:6px;padding:.5rem 1.2rem;font-size:.82rem;cursor:pointer;color:var(--ink2);transition:all .15s;}
.btn-ghost:hover{border-color:var(--ink);color:var(--ink);}
.btn-solid{background:var(--ink);border:none;border-radius:6px;padding:.5rem 1.5rem;font-size:.82rem;color:#fff;cursor:pointer;transition:background .15s;}
.btn-solid:hover{background:var(--accent);}

/* â”€â”€ SETTINGS TAB â”€â”€ */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;max-width:900px;}
.settings-card{background:var(--white);border:1px solid var(--line);border-radius:8px;padding:1.25rem;}
.settings-title{font-family:'DM Mono',monospace;font-size:.65rem;letter-spacing:.15em;text-transform:uppercase;color:var(--ink3);margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px solid var(--line);}
.tag-mgr-row{display:flex;align-items:center;gap:.4rem;padding:.3rem .4rem;border-radius:4px;transition:background .15s;margin-bottom:2px;}
.tag-mgr-row:hover{background:var(--off);}
.tag-mgr-row .tn{font-size:.8rem;flex:1;color:var(--ink2);}
.tag-del{background:transparent;border:none;color:var(--ink3);cursor:pointer;font-size:.8rem;padding:.1rem .3rem;border-radius:3px;transition:all .15s;}
.tag-del:hover{color:var(--accent);background:var(--accent-light);}
.add-tag-row{display:flex;gap:.4rem;margin-top:.75rem;}
.add-tag-row input{flex:1;background:var(--off);border:1px solid var(--line);border-radius:4px;color:var(--ink);padding:.4rem .6rem;font-size:.78rem;font-family:'Noto Sans JP',sans-serif;outline:none;}
.add-tag-row button{background:var(--ink);border:none;border-radius:4px;color:#fff;padding:.4rem .8rem;font-size:.78rem;cursor:pointer;}
.reminder-display-item{display:flex;align-items:center;gap:.5rem;padding:.35rem .5rem;border-radius:4px;transition:background .15s;font-size:.8rem;color:var(--ink2);cursor:pointer;}
.reminder-display-item:hover{background:var(--off);}
.reminder-display-item input[type=checkbox]{accent-color:var(--accent);}

/* â”€â”€ MODAL â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:500;display:flex;align-items:center;justify-content:center;padding:1rem;opacity:0;pointer-events:none;transition:opacity .2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--white);border-radius:10px;padding:1.5rem;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-md);}
.modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem;padding-bottom:.75rem;border-bottom:1px solid var(--line);}
.modal-title{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;}
.modal-close{background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.25rem .65rem;cursor:pointer;font-size:.78rem;color:var(--ink2);}

/* â”€â”€ YOUTUBE â”€â”€ */
.yt-thumb{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:4px;margin-bottom:.5rem;}
.yt-status{font-size:.68rem;padding:2px 8px;border-radius:10px;font-family:'DM Mono',monospace;}
.yt-status.unwatch{background:#fee2e2;color:#991b1b;}
.yt-status.watched{background:#d1fae5;color:#065f46;}
.yt-priority{color:#f59e0b;font-size:.85rem;}
.yt-player-wrap{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:6px;margin-bottom:.75rem;}
.yt-player-wrap iframe{position:absolute;top:0;left:0;width:100%;height:100%;}

/* â”€â”€ LOADING â”€â”€ */
.ld{display:flex;gap:3px;align-items:center;}
.ld span{width:4px;height:4px;border-radius:50%;background:currentColor;animation:ld .8s ease-in-out infinite;}
.ld span:nth-child(2){animation-delay:.15s;}
.ld span:nth-child(3){animation-delay:.3s;}
@keyframes ld{0%,80%,100%{opacity:.2}40%{opacity:1}}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:1.5rem;right:1.5rem;background:var(--ink);color:#fff;padding:.6rem 1.25rem;border-radius:6px;font-size:.82rem;z-index:1000;opacity:0;transform:translateY(8px);transition:all .25s;pointer-events:none;}
.toast.show{opacity:1;transform:translateY(0);}
.toast.ok{background:var(--green);}
.toast.err{background:#dc2626;}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:4rem 2rem;color:var(--ink3);}
.empty-mark{font-family:'Playfair Display',serif;font-size:3rem;opacity:.2;margin-bottom:1rem;}
.empty h3{font-size:1rem;font-weight:400;margin-bottom:.5rem;color:var(--ink2);}
.empty p{font-size:.82rem;}

/* â”€â”€ MOBILE FILTER BAR â”€â”€ */
#mobileFilterBar{display:none;}
.mfb-scroll{display:flex;gap:.4rem;overflow-x:auto;padding:.5rem 1rem .5rem;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.mfb-scroll::-webkit-scrollbar{display:none;}
.mfb-pill{flex-shrink:0;padding:.35rem .85rem;border-radius:20px;border:1.5px solid var(--line);background:var(--white);color:var(--ink2);font-size:.76rem;font-family:'Noto Sans JP',sans-serif;cursor:pointer;transition:all .15s;white-space:nowrap;}
.mfb-pill.active{background:var(--ink);border-color:var(--ink);color:#fff;}
.mfb-pill.tag-pill{border-style:solid;}
.mfb-pill.accent{background:var(--accent);border-color:var(--accent);color:#fff;}
/* ã‚¿ã‚°ãƒ»ã‚¨ãƒªã‚¢ã®å±•é–‹ã‚¨ãƒªã‚¢ */
.mfb-expand{display:none;padding:.4rem 1rem .6rem;gap:.35rem;flex-wrap:wrap;border-bottom:1px solid var(--line);background:var(--white);}
.mfb-expand.open{display:flex;}
.mfb-expand-pill{flex-shrink:0;padding:.28rem .75rem;border-radius:16px;border:1.5px solid var(--line);background:var(--off);color:var(--ink2);font-size:.72rem;cursor:pointer;transition:all .15s;white-space:nowrap;}
.mfb-expand-pill.active{background:var(--accent);border-color:var(--accent);color:#fff;}

/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…ˆé ­ã‚¢ãƒ³ã‚«ãƒ¼ */
#contentAnchor{scroll-margin-top:110px;}

@media(max-width:768px){
  #mobileFilterBar{display:block;position:sticky;top:112px;z-index:100;background:var(--white);border-bottom:1px solid var(--line);}
  .home-layout{grid-template-columns:1fr;}
  .sidebar{display:none !important;}
  .settings-grid{grid-template-columns:1fr;}
  .tab-pane{padding:.75rem 1rem;}
  .posts-grid{grid-template-columns:1fr;}
  .home-toolbar{gap:.5rem;padding-bottom:.25rem;}
  .mode-toggle .mode-btn{font-size:.68rem;padding:.3rem .6rem;}
  /* YTãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ã‚¹ãƒãƒ›ã¯ç¸¦ç©ã¿ */
  #homeYtPanel [style*="grid-template-columns:1fr 260px"]{display:flex !important;flex-direction:column !important;}
  #homeYtPanel [style*="max-height:280px"]{max-height:160px;}
}
@media(min-width:769px){
  .sidebar{display:block !important;}
  #mobileFilterBar{display:none !important;}
}
</style>
</head>
<body>

<!-- â”€â”€ REMINDER BAR â”€â”€ -->
<div id="reminderBar">
  <span class="rb-label">ğŸ”” Today</span>
  <span class="rb-empty" id="rbEmpty">æœ¬æ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</span>
  <div id="rbItems" style="display:flex;gap:.5rem;flex-wrap:wrap;flex:1"></div>
</div>

<!-- â”€â”€ HEADER â”€â”€ -->
<header>
  <div class="header-inner">
    <div>
      <div class="logo-main">XC<em>L</em>IP</div>
      <div style="font-family:'DM Mono',monospace;font-size:.5rem;letter-spacing:.18em;color:var(--ink3);text-transform:uppercase;">Clip Collector</div>
    </div>
    <div class="header-rule"></div>
    <div class="header-stats">
      <div class="stat"><div class="stat-n" id="totalCount">0</div><div class="stat-l">Clips</div></div>
      <div class="stat"><div class="stat-n" id="tagCount">0</div><div class="stat-l">Tags</div></div>
    </div>
  </div>
</header>

<!-- â”€â”€ TABS â”€â”€ -->
<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('home')">ğŸ  Home</button>
  <button class="tab-btn" onclick="switchTab('add')">ï¼‹ Add</button>
  <button class="tab-btn" onclick="switchTab('settings')">âš™ Settings</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- HOME TAB -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-pane active" id="tab-home">

  <!-- â–¼ ã‚¹ãƒãƒ›ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ï¼ˆ768pxä»¥ä¸‹ã§è¡¨ç¤ºï¼‰ -->
  <div id="mobileFilterBar">
    <div class="mfb-scroll" id="mfbMain">
      <button class="mfb-pill active" data-f="all"        onclick="mfbFilter('all')">ã™ã¹ã¦</button>
      <button class="mfb-pill"        data-f="recent"     onclick="mfbFilter('recent')">æœ€è¿‘è¿½åŠ </button>
      <button class="mfb-pill"        data-f="memo"       onclick="mfbFilter('memo')">ãƒ¡ãƒ¢ã‚ã‚Š</button>
      <button class="mfb-pill"        data-f="img"        onclick="mfbFilter('img')">ç”»åƒã‚ã‚Š</button>
      <button class="mfb-pill"        data-f="youtube"    onclick="mfbFilter('youtube')">YouTube</button>
      <button class="mfb-pill"        data-f="yt-unwatch" onclick="mfbFilter('yt-unwatch')">â–¶ æœªè¦–è´</button>
      <button class="mfb-pill accent"                     onclick="startHomePlaylist()">â–¶ é€£ç¶šå†ç”Ÿ</button>
      <button class="mfb-pill"        data-f="tag"        onclick="toggleMfbExpand('tags')">ğŸ· ã‚¿ã‚° â–¾</button>
      <button class="mfb-pill"        data-f="area"       onclick="toggleMfbExpand('area')">ğŸ“ ã‚¨ãƒªã‚¢ â–¾</button>
    </div>
    <!-- ã‚¿ã‚°å±•é–‹ -->
    <div class="mfb-expand" id="mfbTags"></div>
    <!-- ã‚¨ãƒªã‚¢å±•é–‹ -->
    <div class="mfb-expand" id="mfbArea">
      <select class="area-select" id="mCountrySelect" onchange="mfbSetCountry(this.value)" style="flex:1;min-width:120px">
        <option value="">å›½ã‚’é¸æŠ...</option>
      </select>
      <select class="area-select" id="mPrefSelect" onchange="mfbSetPref(this.value)" style="flex:1;min-width:120px;display:none">
        <option value="">éƒ½é“åºœçœŒ...</option>
      </select>
    </div>
  </div>

  <div class="home-toolbar">
    <div class="search-wrap">
      <span class="search-ico">ğŸ”</span>
      <input class="search-fi" id="searchIn" placeholder="æ¤œç´¢..." oninput="renderHome()">
    </div>
    <div class="mode-toggle">
      <button class="mode-btn active" id="modeA" onclick="setMode('A')" title="ã‚¸ãƒ£ãƒ³ãƒ«ä¸»è»¸">A: ã‚¸ãƒ£ãƒ³ãƒ«</button>
      <button class="mode-btn" id="modeB" onclick="setMode('B')" title="ã‚¨ãƒªã‚¢ä¸»è»¸">B: ã‚¨ãƒªã‚¢</button>
    </div>
    <div class="view-toggle">
      <button class="vt-btn active" id="vGrid" onclick="setView('grid')" title="ã‚°ãƒªãƒƒãƒ‰">âŠ</button>
      <button class="vt-btn" id="vList" onclick="setView('list')" title="ãƒªã‚¹ãƒˆ">â˜°</button>
      <button class="vt-btn" id="vMap" onclick="setView('map')" title="ãƒãƒƒãƒ—">ğŸ—º</button>
    </div>
    <button class="c-btn" onclick="locateMe()" title="ç¾åœ¨åœ°å–å¾—" style="white-space:nowrap">ğŸ“ ç¾åœ¨åœ°</button>
  </div>

  <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…ˆé ­ã‚¢ãƒ³ã‚«ãƒ¼ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å…ˆï¼‰ -->
  <div id="contentAnchor"></div>

  <div class="home-layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sb-head">Filter</div>
      <button class="filter-btn active" id="fAll" onclick="setFilter('all')">ã™ã¹ã¦ <span class="fc" id="cAll">0</span></button>
      <button class="filter-btn" id="fRecent" onclick="setFilter('recent')">æœ€è¿‘è¿½åŠ  <span class="fc" id="cRec">0</span></button>
      <button class="filter-btn" id="fMemo" onclick="setFilter('memo')">ãƒ¡ãƒ¢ã‚ã‚Š <span class="fc" id="cMemo">0</span></button>
      <button class="filter-btn" id="fImg" onclick="setFilter('img')">ç”»åƒã‚ã‚Š <span class="fc" id="cImg">0</span></button>
      <button class="filter-btn" id="fYt" onclick="setFilter('youtube')">YouTube <span class="fc" id="cYt">0</span></button>
      <button class="filter-btn" id="fYtUn" onclick="setFilter('yt-unwatch')">â–¶ æœªè¦–è´ <span class="fc" id="cYtUn">0</span></button>
      <button onclick="startHomePlaylist()" style="width:100%;margin-top:.3rem;padding:.4rem .6rem;background:var(--ink);border:none;border-radius:4px;color:#fff;font-size:.75rem;cursor:pointer;font-family:'Noto Sans JP',sans-serif;display:flex;align-items:center;justify-content:center;gap:.3rem">â–¶ é€£ç¶šå†ç”Ÿ</button>

      <div class="sb-head" style="margin-top:1.25rem">ğŸ“ ã‚¨ãƒªã‚¢</div>
      <select class="area-select" id="countrySelect" onchange="setCountryFilter(this.value)">
        <option value="">å›½ã‚’é¸æŠ...</option>
      </select>
      <select class="area-select" id="prefSelect" onchange="setPrefFilter(this.value)" style="display:none">
        <option value="">éƒ½é“åºœçœŒã‚’é¸æŠ...</option>
      </select>

      <div class="sb-head" style="margin-top:1.25rem">Tags</div>
      <div id="sideTagList"></div>
    </aside>

    <!-- MAIN -->
    <div>
      <div class="result-info" id="resultInfo"></div>
      <div id="mapWrap" style="display:none;height:480px;border-radius:6px;border:1px solid var(--line);overflow:hidden;margin-bottom:1rem"></div>

      <!-- YouTube ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«ï¼ˆHomeå†…ï¼‰ -->
      <div id="homeYtPanel" style="display:none;background:var(--ink);color:#fff;border-radius:8px;padding:1rem;margin-bottom:1rem">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem">
          <div style="font-family:'DM Mono',monospace;font-size:.62rem;letter-spacing:.1em;opacity:.6">â–¶ PLAYLIST</div>
          <button onclick="closeHomePlayer()" style="background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:4px;padding:.2rem .6rem;cursor:pointer;font-size:.75rem">âœ• é–‰ã˜ã‚‹</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 260px;gap:1rem;align-items:start">
          <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
          <div>
            <div id="homeYtIframeContainer" style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:6px;background:#000;margin-bottom:.75rem"></div>
            <div id="homeYtPlayInfo" style="font-size:.82rem;margin-bottom:.6rem;display:flex;align-items:center;flex-wrap:wrap;gap:.4rem;opacity:.9"></div>
            <div style="display:flex;gap:.5rem;flex-wrap:wrap">
              <button class="c-btn" onclick="ytPrev()" style="background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.2);color:#fff">â—€ å‰ã¸</button>
              <button class="c-btn" onclick="ytNext()" style="background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.2);color:#fff">æ¬¡ã¸ â–¶</button>
              <button class="c-btn" onclick="markWatched()" style="background:#d1fae5;border-color:#6ee7b7;color:#065f46;margin-left:auto">âœ… è¦–è´æ¸ˆã¿</button>
            </div>
          </div>
          <!-- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ -->
          <div style="max-height:280px;overflow-y:auto">
            <div style="font-size:.65rem;letter-spacing:.1em;opacity:.5;margin-bottom:.4rem;font-family:'DM Mono',monospace">QUEUE</div>
            <div id="homeYtQueue"></div>
          </div>
        </div>
      </div>

      <div id="postsWrap"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- ADD TAB -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-pane" id="tab-add">
  <div class="add-card">
    <div class="type-tabs">
      <button class="type-tab active" id="typeX" onclick="setType('x')">ğ• ãƒã‚¹ãƒˆ</button>
      <button class="type-tab" id="typeWeb" onclick="setType('web')">ğŸŒ Webè¨˜äº‹</button>
      <button class="type-tab" id="typeYt" onclick="setType('youtube')">â–¶ YouTube</button>
      <button class="type-tab" id="typeMemo" onclick="setType('memo')">ğŸ“ ãƒ¡ãƒ¢</button>
    </div>

    <div id="urlRow" class="url-row">
      <input type="text" class="url-field" id="urlIn" placeholder="URLã‚’è²¼ã‚Šä»˜ã‘...">
      <button class="fetch-btn" id="fetchBtn" onclick="fetchFromUrl()">æƒ…å ±å–å¾—</button>
    </div>

    <div class="status-bar" id="statusBar"></div>

    <div class="fg">
      <!-- X fields -->
      <div id="xFields" style="display:contents">
        <div><label class="fl">æŠ•ç¨¿è€…å</label><input class="fi" id="fAuthor" placeholder="Taro Yamada"></div>
        <div><label class="fl">ãƒãƒ³ãƒ‰ãƒ«</label><input class="fi" id="fHandle" placeholder="@taroyamada"></div>
      </div>
      <!-- Web fields -->
      <div id="webFields" style="display:none;grid-column:1/-1">
        <div class="fg" style="margin:0">
          <div class="fg-full"><label class="fl">è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«</label><input class="fi" id="fTitle" placeholder="è‡ªå‹•å–å¾—ã¾ãŸã¯æ‰‹å‹•å…¥åŠ›"></div>
          <div><label class="fl">ã‚µã‚¤ãƒˆå</label><input class="fi" id="fSite" placeholder="Qiita, note..."></div>
          <div><label class="fl">è‘—è€…</label><input class="fi" id="fAuthorWeb" placeholder="å±±ç”°å¤ªéƒ"></div>
        </div>
      </div>
      <!-- YouTube fields -->
      <div id="ytFields" style="display:none;grid-column:1/-1">
        <div class="fg" style="margin:0">
          <div class="fg-full"><label class="fl">å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«</label><input class="fi" id="fYtTitle" placeholder="è‡ªå‹•å–å¾—ã¾ãŸã¯æ‰‹å‹•å…¥åŠ›"></div>
          <div><label class="fl">ãƒãƒ£ãƒ³ãƒãƒ«å</label><input class="fi" id="fYtChannel" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«å"></div>
          <div style="display:flex;align-items:center;gap:.75rem;padding:.5rem 0">
            <label style="display:flex;align-items:center;gap:.4rem;font-size:.82rem;cursor:pointer">
              <input type="checkbox" id="fYtPriority" style="accent-color:var(--yellow)"> â­ å„ªå…ˆ
            </label>
            <label style="display:flex;align-items:center;gap:.4rem;font-size:.82rem;cursor:pointer">
              <input type="checkbox" id="fYtWatched" style="accent-color:var(--green)"> âœ… è¦–è´æ¸ˆã¿
            </label>
          </div>
        </div>
      </div>

      <div class="fg-full"><label class="fl">æœ¬æ–‡ãƒ»å†…å®¹</label><textarea class="fta" id="fContent" placeholder="å†…å®¹..."></textarea></div>
      <div class="fg-full" id="summaryField" style="display:none">
        <label class="fl">âœ¨ AIè¦ç´„</label>
        <textarea class="fta" id="fSummary" style="min-height:60px;background:var(--paper)"></textarea>
      </div>
      <div class="fg-full"><label class="fl">ãƒ¡ãƒ¢ï¼ˆURLã‚‚å¯ï¼‰</label><input class="fi" id="fMemo" placeholder="ãƒ¡ãƒ¢ã‚„å‚è€ƒURLã‚’å…¥åŠ›..."></div>
      <div class="fg-full">
        <label class="fl">ç”»åƒ URL</label>
        <input class="fi" id="fImgUrl" placeholder="https://..." oninput="prevImgUrl()" style="margin-bottom:.4rem">
        <div class="img-area" id="imgArea">
          <input type="file" accept="image/*" onchange="handleFile(event)">
          <div class="img-area-placeholder" id="imgPh"><span style="font-size:1.5rem">â†‘</span><span>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span></div>
          <img id="imgPrev" style="display:none">
        </div>
      </div>
      <div class="fg-full"><label class="fl">ã‚¿ã‚°</label><div class="tag-picker" id="formPicker"></div></div>
      <div class="fg-full">
        <label class="fl">ğŸ“ ã‚¨ãƒªã‚¢ï¼ˆä»»æ„ï¼‰</label>
        <div class="fg" style="margin:0">
          <div><label class="fl">å›½</label><input class="fi" id="fCountry" placeholder="æ—¥æœ¬, ã‚¢ãƒ¡ãƒªã‚«..."></div>
          <div><label class="fl">éƒ½é“åºœçœŒ</label><input class="fi" id="fPrefecture" placeholder="æ±äº¬éƒ½, å¤§é˜ªåºœ..."></div>
          <div class="fg-full">
            <label class="fl">è©³ç´°ãªå ´æ‰€å</label>
            <div style="display:flex;gap:.4rem">
              <input class="fi" id="fArea" placeholder="æ¸‹è°·, æ¢…ç”°..." style="flex:1">
              <button class="btn-ghost" onclick="geocodeArea()" style="white-space:nowrap;font-size:.72rem">ä½ç½®å–å¾—</button>
            </div>
            <div id="fAreaStatus" style="font-size:.7rem;color:var(--ink3);margin-top:.25rem"></div>
          </div>
        </div>
        <input type="hidden" id="fLat"><input type="hidden" id="fLng">
      </div>
      <!-- Reminder -->
      <div class="fg-full" style="background:var(--yellow-bg);border-radius:6px;padding:.75rem">
        <label class="fl" style="color:#92400e">ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼ˆä»»æ„ï¼‰</label>
        <div style="display:flex;gap:.5rem">
          <input type="date" class="fi" id="fRemindDate" style="flex:1">
          <input type="text" class="fi" id="fRemindMsg" placeholder="ãƒ¡ãƒ¢..." style="flex:2">
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button class="btn-ghost" onclick="clearForm()">ã‚¯ãƒªã‚¢</button>
      <button class="btn-solid" onclick="savePost()">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- SETTINGS TAB -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-pane" id="tab-settings">
  <div class="settings-grid">
    <!-- TAG MANAGEMENT -->
    <div class="settings-card">
      <div class="settings-title">ã‚¿ã‚°ç®¡ç†</div>
      <div id="tagMgrList"></div>
      <div class="add-tag-row" style="margin-top:.75rem">
        <input type="text" id="newTagIn" placeholder="æ–°ã—ã„ã‚¿ã‚°..." maxlength="20">
        <button onclick="addTag()">è¿½åŠ </button>
      </div>
      <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--line)">
        <div class="fl" style="margin-bottom:.5rem">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿½åŠ </div>
        <select class="area-select" id="parentTagSelect"><option value="">è¦ªã‚¿ã‚°ã‚’é¸æŠ...</option></select>
        <div class="add-tag-row">
          <input type="text" id="newSubTagIn" placeholder="ã‚µãƒ–ã‚¿ã‚°å..." maxlength="20">
          <button onclick="addSubTag()">è¿½åŠ </button>
        </div>
      </div>
    </div>

    <!-- REMINDER SETTINGS -->
    <div class="settings-card">
      <div class="settings-title">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºè¨­å®š</div>
      <div style="font-size:.78rem;color:var(--ink3);margin-bottom:.75rem">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼æ ã«è¡¨ç¤ºã™ã‚‹é …ç›®ã‚’é¸æŠ</div>
      <div id="reminderDisplaySettings"></div>
      <div style="margin-top:1rem">
        <div class="settings-title">æœ¬æ—¥ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ä¸€è¦§</div>
        <div id="allRemindersList"></div>
      </div>
    </div>

    <!-- YOUTUBE PLAYLIST -->
    <div class="settings-card">
      <div class="settings-title">YouTube é€£ç¶šå†ç”Ÿ</div>
      <div style="font-size:.78rem;color:var(--ink2);margin-bottom:.75rem">æœªè¦–è´å‹•ç”»ã‚’å„ªå…ˆåº¦é †ã«é€£ç¶šå†ç”Ÿã€‚çµ‚äº†ã™ã‚‹ã¨è‡ªå‹•ã§æ¬¡ã¸é€²ã¿ã¾ã™</div>
      <select class="area-select" id="ytPlayTag"><option value="">ã‚¿ã‚°ã§çµã‚Šè¾¼ã¿ï¼ˆä»»æ„ï¼‰</option></select>
      <button class="btn-solid" onclick="startPlaylist()" style="width:100%;margin-top:.75rem">â–¶ é€£ç¶šå†ç”Ÿã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <div id="ytPlayerWrap" style="margin-top:1rem;display:none">
        <div class="yt-player-wrap" id="ytIframeContainer" style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:6px;margin-bottom:.75rem"></div>
        <div id="ytPlayInfo" style="font-size:.8rem;color:var(--ink2);margin-bottom:.5rem;display:flex;align-items:center;flex-wrap:wrap;gap:.4rem"></div>
        <div style="display:flex;gap:.5rem">
          <button class="c-btn" onclick="ytPrev()">â—€ å‰ã¸</button>
          <button class="c-btn" onclick="ytNext()">æ¬¡ã¸ â–¶</button>
          <button class="c-btn" onclick="markWatched()" style="margin-left:auto;background:#d1fae5;border-color:#6ee7b7;color:#065f46">âœ… è¦–è´æ¸ˆã¿ã«ã™ã‚‹</button>
        </div>
      </div>
    </div>

    <!-- STATS -->
    <div class="settings-card">
      <div class="settings-title">çµ±è¨ˆ</div>
      <div id="statsWrap" style="font-size:.82rem;line-height:2;color:var(--ink2)"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- MODALS -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- Detail Modal -->
<div class="overlay" id="detailModal">
  <div class="modal">
    <div class="modal-head">
      <span class="modal-title">è©³ç´°</span>
      <button class="modal-close" onclick="closeModal('detailModal')">âœ• é–‰ã˜ã‚‹</button>
    </div>
    <div id="detailBody"></div>
  </div>
</div>

<!-- Edit Modal -->
<div class="overlay" id="editModal">
  <div class="modal">
    <div class="modal-head">
      <span class="modal-title">ç·¨é›†</span>
      <button class="modal-close" onclick="closeModal('editModal')">âœ• é–‰ã˜ã‚‹</button>
    </div>
    <div class="fg">
      <div><label class="fl">æŠ•ç¨¿è€…å / ã‚¿ã‚¤ãƒˆãƒ«</label><input class="fi" id="eAuthor"></div>
      <div><label class="fl">ãƒãƒ³ãƒ‰ãƒ« / ã‚µã‚¤ãƒˆå</label><input class="fi" id="eHandle"></div>
      <div class="fg-full"><label class="fl">æœ¬æ–‡</label><textarea class="fta" id="eContent"></textarea></div>
      <div class="fg-full"><label class="fl">ãƒ¡ãƒ¢</label><input class="fi" id="eMemo"></div>
      <div class="fg-full"><label class="fl">ç”»åƒ URL</label><input class="fi" id="eImgUrl"></div>
      <div><label class="fl">å›½</label><input class="fi" id="eCountry"></div>
      <div><label class="fl">éƒ½é“åºœçœŒ</label><input class="fi" id="ePrefecture"></div>
      <div class="fg-full">
        <label class="fl">è©³ç´°ãªå ´æ‰€</label>
        <div style="display:flex;gap:.4rem">
          <input class="fi" id="eArea" style="flex:1">
          <button class="btn-ghost" onclick="geocodeEditArea()" style="white-space:nowrap;font-size:.72rem">ä½ç½®å–å¾—</button>
        </div>
        <div id="eAreaStatus" style="font-size:.7rem;color:var(--ink3);margin-top:.25rem"></div>
        <input type="hidden" id="eLat"><input type="hidden" id="eLng">
      </div>
      <div class="fg-full" id="eYtFields" style="display:none">
        <label style="display:flex;align-items:center;gap:.75rem;font-size:.82rem;cursor:pointer">
          <span>YouTube: </span>
          <label style="display:flex;align-items:center;gap:.3rem"><input type="checkbox" id="eYtPriority"> â­ å„ªå…ˆ</label>
          <label style="display:flex;align-items:center;gap:.3rem"><input type="checkbox" id="eYtWatched"> âœ… è¦–è´æ¸ˆã¿</label>
        </label>
      </div>
      <div class="fg-full"><label class="fl">ã‚¿ã‚°</label><div class="tag-picker" id="editPicker"></div></div>
    </div>
    <div class="form-actions">
      <button class="btn-ghost" onclick="closeModal('editModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-solid" onclick="saveEdit()">æ›´æ–°ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- Reminder Modal -->
<div class="overlay" id="reminderModal">
  <div class="modal">
    <div class="modal-head">
      <span class="modal-title">ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</span>
      <button class="modal-close" onclick="closeModal('reminderModal')">âœ• é–‰ã˜ã‚‹</button>
    </div>
    <div id="reminderPostInfo" style="background:var(--off);border-radius:4px;padding:.75rem 1rem;margin-bottom:1rem;font-size:.82rem;color:var(--ink2)"></div>
    <div class="fg">
      <div class="fg-full"><label class="fl">ãƒªãƒã‚¤ãƒ³ãƒ‰æ—¥</label><input type="date" class="fi" id="rDate"></div>
      <div class="fg-full"><label class="fl">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><input class="fi" id="rMessage" placeholder="ã‚ã¨ã§èª­ã‚€ã€è¿”ä¿¡ã™ã‚‹..."></div>
    </div>
    <div id="existingReminders" style="margin-top:.75rem"></div>
    <div class="form-actions">
      <button class="btn-ghost" onclick="closeModal('reminderModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-solid" onclick="saveReminder()">è¨­å®šã™ã‚‹</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL = 'https://hpgcymyyugrzblvahkcc.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwZ2N5bXl5dWdyemJsdmFoa2NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MjAxOTEsImV4cCI6MjA4NzM5NjE5MX0.l2C4TWVU-CeMPB3Thz238z5qqeiOsFLhkm-GlOYVL8o';

async function sb(path, method='GET', body=null){
  const h = {
    'apikey': SB_KEY, 'Authorization': 'Bearer '+SB_KEY,
    'Content-Type': 'application/json'
  };
  if(method==='POST') h['Prefer']='return=representation,resolution=merge-duplicates';
  if(method==='PATCH') h['Prefer']='return=representation';
  const opts = {method, headers:h};
  if(body) opts.body = JSON.stringify(body);
  const r = await fetch(SB_URL+'/rest/v1/'+path, opts);
  if(!r.ok){ const e=await r.text(); throw new Error(e); }
  const txt = await r.text();
  return txt ? JSON.parse(txt) : [];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let posts=[], tags=[], reminders=[];
let curFilter='all', tagFilter=null, viewMode='grid', displayMode='A';
let areaFilter={country:null, prefecture:null};
let fSel=new Set(), eSel=new Set();
let editId=null, reminderPostId=null, currentType='x';
let myLat=null, myLng=null;
let map=null, mapMarkers=[];
let ytPlaylist=[], ytPlayIdx=0;
let reminderDisplayKeys = ['author','content','memo']; // è¡¨ç¤ºé …ç›®è¨­å®š
const COLORS=['#3b82f6','#8b5cf6','#e11d48','#d97706','#059669','#dc2626','#0891b2','#65a30d','#9333ea','#ea580c'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  toast('èª­ã¿è¾¼ã¿ä¸­...','');
  try {
    const [rawP, rawT, rawR] = await Promise.all([
      sb('posts?select=*&order=created_at.desc'),
      sb('tags?select=*&order=name.asc'),
      sb('reminders?select=*&order=remind_at.asc')
    ]);
    posts = rawP.map(mapPost);
    tags  = rawT;
    reminders = rawR;

    if(!tags.length){
      const defs=['å‚è€ƒ','ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³','æŠ€è¡“','ãƒ‡ã‚¶ã‚¤ãƒ³','ãƒ‹ãƒ¥ãƒ¼ã‚¹','ãŠæ°—ã«å…¥ã‚Š'];
      for(let i=0;i<defs.length;i++){
        const t={id:'t'+(Date.now()+i), name:defs[i], color:COLORS[i], parent_id:null};
        await sb('tags','POST',t); tags.push(t);
      }
    }
    renderAll();
    renderReminderBar();
    renderSettings();
    setTimeout(()=>{ document.getElementById('toast').className='toast'; },500);
    // 1åˆ†ã”ã¨ã«ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯
    setInterval(renderReminderBar, 60000);
  } catch(e){
    toast('æ¥ç¶šã‚¨ãƒ©ãƒ¼: '+e.message,'err'); console.error(e);
  }
}

function mapPost(r){
  return {
    id:r.id, url:r.url||'', author:r.author||'', handle:r.handle||'',
    content:r.content||'', memo:r.memo||'', image:r.image||'',
    tags:r.tags||[], createdAt:r.created_at||0,
    area:r.area||'', country:r.country||'', prefecture:r.prefecture||'',
    lat:r.lat||null, lng:r.lng||null,
    type:r.type||'x', summary:r.summary||'',
    youtube_status:r.youtube_status||'unwatch',
    youtube_priority:r.youtube_priority||false,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab){
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  const idx = ['home','add','settings'].indexOf(tab);
  document.querySelectorAll('.tab-btn')[idx].classList.add('active');
  if(tab==='home') renderHome();
  if(tab==='settings') renderSettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  renderSide(); renderPickers(); renderHome(); updateStats(); renderMobileFilterBar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSide(){
  const parentTags = tags.filter(t=>!t.parent_id);
  const childTags  = tags.filter(t=> t.parent_id);
  let html='';
  parentTags.forEach(pt=>{
    const children = childTags.filter(c=>c.parent_id===pt.id);
    const cnt = posts.filter(p=>p.tags&&p.tags.includes(pt.id)).length;
    html += `<div class="tag-tree-parent">
      <div class="tag-row${tagFilter===pt.id?' active':''}" onclick="toggleTagFilter('${pt.id}')">
        <div class="t-dot" style="background:${pt.color}"></div>
        <span>${esc(pt.name)}</span>
        <span class="t-cnt">${cnt}</span>
      </div>`;
    if(children.length){
      html += `<div class="tag-child-wrap">`;
      children.forEach(ct=>{
        const ccnt = posts.filter(p=>p.tags&&p.tags.includes(ct.id)).length;
        html += `<div class="tag-row${tagFilter===ct.id?' active':''}" onclick="toggleTagFilter('${ct.id}')">
          <div class="t-dot" style="background:${ct.color}"></div>
          <span>${esc(ct.name)}</span>
          <span class="t-cnt">${ccnt}</span>
        </div>`;
      });
      html += `</div>`;
    }
    html += `</div>`;
  });
  document.getElementById('sideTagList').innerHTML = html;
  renderAreaFilter();
}

function renderAreaFilter(){
  const countries = [...new Set(posts.map(p=>p.country).filter(Boolean))].sort();
  const cSel = document.getElementById('countrySelect');
  const curC = areaFilter.country||'';
  cSel.innerHTML = '<option value="">å›½ã‚’é¸æŠ...</option>' +
    countries.map(c=>`<option value="${esc(c)}"${curC===c?' selected':''}>${esc(c)}</option>`).join('');
  const prefSel = document.getElementById('prefSelect');
  if(areaFilter.country){
    const prefs = [...new Set(posts.filter(p=>p.country===areaFilter.country).map(p=>p.prefecture).filter(Boolean))].sort();
    if(prefs.length){
      prefSel.style.display='block';
      prefSel.innerHTML = '<option value="">éƒ½é“åºœçœŒã‚’é¸æŠ...</option>' +
        prefs.map(pr=>`<option value="${esc(pr)}"${areaFilter.prefecture===pr?' selected':''}>${esc(pr)}</option>`).join('');
    } else { prefSel.style.display='none'; }
  } else { prefSel.style.display='none'; prefSel.value=''; }
}

function setCountryFilter(v){ areaFilter.country=v||null; areaFilter.prefecture=null; renderAreaFilter(); syncMobileAreaFilter(); renderHome(); scrollToContent(); }
function setPrefFilter(v){ areaFilter.prefecture=v||null; renderHome(); scrollToContent(); }
function toggleTagFilter(id){ tagFilter=tagFilter===id?null:id; renderSide(); renderMobileFilterBar(); renderHome(); scrollToContent(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER & SORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFiltered(){
  const s = document.getElementById('searchIn')?.value.toLowerCase()||'';
  const now = Date.now(), wk=7*864e5;
  let result = posts.filter(p=>{
    if(s && ![(p.author||''),(p.handle||''),(p.content||''),(p.memo||'')].join(' ').toLowerCase().includes(s)) return false;
    if(tagFilter && !(p.tags&&p.tags.includes(tagFilter))) return false;
    if(curFilter==='recent' && now-p.createdAt>wk) return false;
    if(curFilter==='memo' && !p.memo) return false;
    if(curFilter==='img' && !p.image) return false;
    if(curFilter==='youtube' && p.type!=='youtube') return false;
    if(curFilter==='yt-unwatch' && (p.type!=='youtube'||p.youtube_status==='watched')) return false;
    if(areaFilter.country && p.country!==areaFilter.country) return false;
    if(areaFilter.prefecture && p.prefecture!==areaFilter.prefecture) return false;
    if(displayMode==='B' && !p.area && !p.country) return false;
    return true;
  });

  // ç¾åœ¨åœ°ã‚½ãƒ¼ãƒˆ
  if(myLat!==null){
    result = result.map(p=>{
      let dist=Infinity;
      if(p.lat&&p.lng) dist=haversine(myLat,myLng,p.lat,p.lng);
      return {...p,_dist:dist};
    }).sort((a,b)=>a._dist-b._dist);
  }
  return result;
}

function haversine(la1,lo1,la2,lo2){
  const R=6371, dLat=(la2-la1)*Math.PI/180, dLon=(lo2-lo1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function locateMe(){
  if(!navigator.geolocation){ toast('ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“','err'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    myLat=pos.coords.latitude; myLng=pos.coords.longitude;
    toast('ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸã€‚è¿‘ã„é †ã«ä¸¦ã³æ›¿ãˆã¾ã™','ok');
    renderHome();
  }, ()=>toast('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ','err'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHome(){
  if(viewMode==='map'){ renderMap(); return; }
  document.getElementById('mapWrap').style.display='none';
  document.getElementById('postsWrap').style.display='block';
  const filtered = getFiltered();
  document.getElementById('resultInfo').textContent = filtered.length+' clips'+(myLat?' (ç¾åœ¨åœ°å„ªå…ˆ)':'');
  const wrap = document.getElementById('postsWrap');
  if(!filtered.length){
    wrap.className='';
    wrap.innerHTML=`<div class="empty"><div class="empty-mark">â€”</div><h3>ã‚¯ãƒªãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</h3><p>ã€ŒAddã€ã‚¿ãƒ–ã‹ã‚‰è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†</p></div>`;
    return;
  }

  if(displayMode==='A'){
    // ã‚¸ãƒ£ãƒ³ãƒ«ä¸»è»¸ï¼šã‚¿ã‚°ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    renderGrouped(filtered, wrap, 'tag');
  } else {
    // ã‚¨ãƒªã‚¢ä¸»è»¸ï¼šã‚¨ãƒªã‚¢ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    renderGrouped(filtered, wrap, 'area');
  }
  updateStats();
}

function renderGrouped(filtered, wrap, groupBy){
  if(viewMode==='list') wrap.className='';
  else wrap.className='';

  let groups={};
  const ungroupedKey = groupBy==='tag' ? 'ã‚¿ã‚°ãªã—' : 'ã‚¨ãƒªã‚¢ãªã—';

  if(groupBy==='tag'){
    // ã‚¿ã‚°ã§ã‚°ãƒ«ãƒ¼ãƒ—
    const parentTags = tags.filter(t=>!t.parent_id);
    filtered.forEach(p=>{
      const ptags = (p.tags||[]).map(tid=>tags.find(t=>t.id===tid)).filter(Boolean);
      const parents = ptags.filter(t=>!t.parent_id);
      if(parents.length){
        parents.forEach(pt=>{ (groups[pt.name]=groups[pt.name]||[]).push(p); });
      } else {
        (groups[ungroupedKey]=groups[ungroupedKey]||[]).push(p);
      }
    });
  } else {
    // ã‚¨ãƒªã‚¢ã§ã‚°ãƒ«ãƒ¼ãƒ—
    filtered.forEach(p=>{
      const key = [p.country, p.prefecture].filter(Boolean).join(' â€º ') || ungroupedKey;
      (groups[key]=groups[key]||[]).push(p);
    });
  }

  let html='';
  // tagãªã—/ã‚¨ãƒªã‚¢ãªã—ã‚’æœ«å°¾ã«
  const sortedKeys = Object.keys(groups).sort((a,b)=>a===ungroupedKey?1:b===ungroupedKey?-1:a.localeCompare(b,'ja'));
  sortedKeys.forEach(k=>{
    html += `<div class="group-header">${esc(k)} <span style="opacity:.5">(${groups[k].length})</span></div>`;
    if(viewMode==='grid'){
      html += `<div class="posts-grid" style="margin-bottom:1rem">${groups[k].map(cardHTML).join('')}</div>`;
    } else {
      html += `<div class="posts-list" style="margin-bottom:1rem">${groups[k].map(rowHTML).join('')}</div>`;
    }
  });
  wrap.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARD / ROW HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function typeBadge(type){
  const map={x:'ğ•',web:'WEB',youtube:'â–¶ YT',memo:'MEMO'};
  const bg={x:'#111',web:'#0369a1',youtube:'#dc2626',memo:'#166534'};
  const fg={x:'#fff',web:'#e0f2fe',youtube:'#fee2e2',memo:'#f0fdf4'};
  return `<span class="type-badge" style="background:${bg[type]||'#111'};color:${fg[type]||'#fff'}">${map[type]||type}</span>`;
}

function cardHTML(p){
  const tagS=(p.tags||[]).map(tid=>{const t=tags.find(t=>t.id===tid);return t?`<span class="c-tag" style="background:${t.color}18;color:${t.color}">${esc(t.name)}</span>`:''}).join('');
  const d=p.createdAt?new Date(p.createdAt).toLocaleDateString('ja-JP',{month:'short',day:'numeric'}):'';
  const preview=p.content&&p.content.length>100?esc(p.content.slice(0,100))+'â€¦':esc(p.content||'');
  const distBadge=p._dist&&p._dist<Infinity?`<span class="c-dist">${p._dist<1?Math.round(p._dist*1000)+'m':p._dist.toFixed(1)+'km'}</span>`:'';
  const areaStr=[p.country,p.prefecture,p.area].filter(Boolean).join(' â€º ');
  const ytBadge=p.type==='youtube'?`<span class="yt-status ${p.youtube_status}">${p.youtube_status==='watched'?'è¦–è´æ¸ˆ':'æœªè¦–è´'}</span>${p.youtube_priority?'<span class="yt-priority">â­</span>':''}`:' ';

  return `<div class="card">
    ${p.image?`<img class="card-img" src="${esc(p.image)}" onerror="this.style.display='none'" alt="">`:
      p.type==='youtube'&&p.url?`<img class="card-img" src="https://img.youtube.com/vi/${getYtId(p.url)}/mqdefault.jpg" onerror="this.style.display='none'" alt="">`:'' }
    <div class="card-body">
      <div class="card-meta">
        <div class="c-avatar">${(p.author||'?').charAt(0).toUpperCase()}</div>
        <div><div class="c-author">${typeBadge(p.type)}${esc(p.author)}</div><div class="c-handle">${esc(p.handle)}</div></div>
        <div class="c-date">${d}</div>
      </div>
      ${ytBadge !== ' ' ? `<div style="margin-bottom:.4rem">${ytBadge}</div>` : ''}
      ${preview?`<div class="c-content">${preview}</div>`:''}
      ${p.summary?`<div class="c-summary">âœ¨ ${esc(p.summary.slice(0,80))}${p.summary.length>80?'â€¦':''}</div>`:''}
      ${areaStr?`<div class="c-area">ğŸ“ ${esc(areaStr)}${distBadge}</div>`:''}
      ${p.memo?`<div class="c-memo">${memoHTML(p.memo)}</div>`:''}
      ${tagS?`<div class="c-tags">${tagS}</div>`:''}
      <div class="c-footer">
        <button class="c-btn" onclick="openDetail('${p.id}')">è©³ç´°</button>
        <button class="c-btn" onclick="openReminderModal('${p.id}')" title="ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼">ğŸ””</button>
        ${p.type==='youtube'?`<button class="c-btn" onclick="playYt('${p.id}')">â–¶ å†ç”Ÿ</button>`:''}
        ${p.url?`<a class="c-link" href="${esc(p.url)}" target="_blank" rel="noopener">â†—</a>`:''}
        <div style="margin-left:auto;display:flex;gap:.3rem">
          <button class="c-btn" onclick="openEdit('${p.id}')">ç·¨é›†</button>
          <button class="c-btn del" onclick="delPost('${p.id}')">å‰Šé™¤</button>
        </div>
      </div>
    </div>
  </div>`;
}

function rowHTML(p){
  const tagS=(p.tags||[]).map(tid=>{const t=tags.find(t=>t.id===tid);return t?`<span class="c-tag" style="background:${t.color}18;color:${t.color}">${esc(t.name)}</span>`:''}).join('');
  const d=p.createdAt?new Date(p.createdAt).toLocaleDateString('ja-JP',{month:'short',day:'numeric'}):'';
  const thumb=p.type==='youtube'&&p.url?`https://img.youtube.com/vi/${getYtId(p.url)}/mqdefault.jpg`:'';
  return `<div class="list-row">
    ${p.image?`<img class="list-img" src="${esc(p.image)}" onerror="this.style.display='none'" alt="">`:
      thumb?`<img class="list-img" src="${thumb}" onerror="this.style.display='none'" alt="">`:
      `<div class="list-img-ph">${p.type==='youtube'?'â–¶':'â€”'}</div>`}
    <div class="list-body">
      <div class="list-top">
        <span class="list-author">${typeBadge(p.type)}${esc(p.author)}</span>
        <span class="list-handle">${esc(p.handle)}</span>
        <span class="list-date">${d}</span>
      </div>
      ${p.content?`<div class="list-content">${esc(p.content.slice(0,120))}</div>`:''}
      <div class="list-bottom">
        ${tagS}
        <button class="c-btn" onclick="openDetail('${p.id}')" style="font-size:.68rem">è©³ç´°</button>
        <button class="c-btn" onclick="openEdit('${p.id}')" style="font-size:.68rem">ç·¨é›†</button>
        <button class="c-btn del" onclick="delPost('${p.id}')" style="font-size:.68rem">å‰Šé™¤</button>
      </div>
    </div>
  </div>`;
}

function memoHTML(memo){
  // URLã‚’æ¤œå‡ºã—ã¦ãƒªãƒ³ã‚¯åŒ–
  return esc(memo).replace(/https?:\/\/[^\s]+/g, m=>`<a href="${m}" target="_blank" rel="noopener" style="color:var(--blue)">${m}</a>`);
}

function getYtId(url){
  const m = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/);
  return m?m[1]:'';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAPï¼ˆç¾åœ¨åœ°ä¸­å¿ƒå¯¾å¿œï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMap(){
  document.getElementById('mapWrap').style.display='block';
  document.getElementById('postsWrap').style.display='none';
  const initLat=myLat||35.6812, initLng=myLng||139.7671, initZoom=myLat?13:10;
  if(!map){
    map=L.map('mapWrap').setView([initLat,initLng],initZoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
  } else if(myLat){
    map.setView([myLat,myLng],13);
  }
  mapMarkers.forEach(m=>m.remove()); mapMarkers=[];

  // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼
  if(myLat){
    const icon=L.divIcon({className:'',html:'<div style="width:14px;height:14px;border-radius:50%;background:#3b82f6;border:3px solid white;box-shadow:0 0 0 3px rgba(59,130,246,.4)"></div>',iconSize:[14,14],iconAnchor:[7,7]});
    L.marker([myLat,myLng],{icon}).addTo(map).bindPopup('ğŸ“ ç¾åœ¨åœ°');
  }

  const filtered=getFiltered().filter(p=>p.lat&&p.lng);
  document.getElementById('resultInfo').textContent=filtered.length?filtered.length+' clips (åœ°å›³)':'åœ°å›³è¡¨ç¤ºã§ãã‚‹æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“';
  if(!filtered.length){ setTimeout(()=>map.invalidateSize(),100); return; }

  const bounds=[];
  filtered.forEach(p=>{
    const popup=`<div style="min-width:180px;font-family:sans-serif">
      <b>${esc(p.author)}</b><br>
      <span style="font-size:11px;color:#555">${esc((p.content||'').slice(0,80))}</span><br>
      <button onclick="openDetail('${p.id}')" style="margin-top:4px;font-size:11px;padding:2px 8px;background:#111;color:#fff;border:none;border-radius:2px;cursor:pointer">è©³ç´°</button>
    </div>`;
    const m=L.marker([p.lat,p.lng]).addTo(map).bindPopup(popup);
    mapMarkers.push(m); bounds.push([p.lat,p.lng]);
  });

  if(myLat){ bounds.push([myLat,myLng]); map.fitBounds(bounds,{padding:[40,40],maxZoom:14}); }
  else { map.fitBounds(bounds,{padding:[40,40]}); }
  setTimeout(()=>map.invalidateSize(),100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetail(id){
  const p=posts.find(p=>p.id===id); if(!p) return;
  const tagS=(p.tags||[]).map(tid=>{const t=tags.find(t=>t.id===tid);return t?`<span class="c-tag" style="background:${t.color}18;color:${t.color};padding:2px 8px;border-radius:10px">${esc(t.name)}</span>`:''}).join(' ');
  const d=p.createdAt?new Date(p.createdAt).toLocaleDateString('ja-JP',{year:'numeric',month:'long',day:'numeric'}):'';
  const areaStr=[p.country,p.prefecture,p.area].filter(Boolean).join(' â€º ');
  const gmapUrl=areaStr?`https://www.google.com/maps/search/${encodeURIComponent(areaStr)}`:'';

  let ytSection='';
  if(p.type==='youtube'&&p.url){
    const vid=getYtId(p.url);
    ytSection=`<div class="yt-player-wrap"><iframe src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen allow="autoplay"></iframe></div>`;
  }

  document.getElementById('detailBody').innerHTML=`
    ${ytSection}
    ${!ytSection&&p.image?`<img src="${esc(p.image)}" style="width:100%;border-radius:4px;margin-bottom:1rem;border:1px solid var(--line)" onerror="this.style.display='none'" alt="">`: ''}
    <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:1rem">
      <div class="c-avatar">${(p.author||'?').charAt(0).toUpperCase()}</div>
      <div><div class="c-author">${typeBadge(p.type)}${esc(p.author)}</div><div class="c-handle">${esc(p.handle)}</div></div>
      <div class="c-date" style="margin-left:auto">${d}</div>
    </div>
    ${p.type==='youtube'?`<div style="margin-bottom:.75rem"><span class="yt-status ${p.youtube_status}">${p.youtube_status==='watched'?'âœ… è¦–è´æ¸ˆ':'â–¶ æœªè¦–è´'}</span>${p.youtube_priority?'<span class="yt-priority" style="margin-left:.5rem">â­ å„ªå…ˆ</span>':''}</div>`:''}
    ${p.content?`<div style="font-size:.88rem;line-height:1.8;color:var(--ink2);margin-bottom:1rem;white-space:pre-wrap">${esc(p.content)}</div>`:''}
    ${p.summary?`<div class="c-summary" style="margin-bottom:1rem">âœ¨ ${esc(p.summary)}</div>`:''}
    ${areaStr?`<div style="font-size:.8rem;color:var(--ink3);margin-bottom:.75rem">ğŸ“ ${esc(areaStr)} ${gmapUrl?`<a href="${gmapUrl}" target="_blank" rel="noopener" style="color:var(--blue);margin-left:.5rem">Googleãƒãƒƒãƒ—ã§é–‹ã â†—</a>`:''}</div>`:''}
    ${p.memo?`<div class="c-memo" style="margin-bottom:.75rem">${memoHTML(p.memo)}</div>`:''}
    ${tagS?`<div class="c-tags" style="margin-bottom:.75rem">${tagS}</div>`:''}
    <div style="display:flex;gap:.5rem;flex-wrap:wrap">
      ${p.url?`<a class="btn-ghost" href="${esc(p.url)}" target="_blank" rel="noopener" style="font-size:.8rem;padding:.35rem .85rem;text-decoration:none">â†— å…ƒã®ãƒªãƒ³ã‚¯</a>`:''}
      ${p.type==='youtube'?`<button class="c-btn" onclick="toggleWatched('${p.id}')">${p.youtube_status==='watched'?'â–¶ æœªè¦–è´ã«æˆ»ã™':'âœ… è¦–è´æ¸ˆã¿ã«ã™ã‚‹'}</button>`:''}
      <button class="c-btn" onclick="closeModal('detailModal');openEdit('${p.id}')" style="margin-left:auto">ç·¨é›†</button>
    </div>`;
  openModal('detailModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEdit(id){
  const p=posts.find(p=>p.id===id); if(!p) return;
  editId=id;
  document.getElementById('eAuthor').value=p.author;
  document.getElementById('eHandle').value=p.handle;
  document.getElementById('eContent').value=p.content;
  document.getElementById('eMemo').value=p.memo||'';
  document.getElementById('eImgUrl').value=p.image||'';
  document.getElementById('eCountry').value=p.country||'';
  document.getElementById('ePrefecture').value=p.prefecture||'';
  document.getElementById('eArea').value=p.area||'';
  document.getElementById('eLat').value='';
  document.getElementById('eLng').value='';
  document.getElementById('eAreaStatus').textContent=p.lat?`ç¾åœ¨ã®ä½ç½®: ${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}`:'';
  const ytF=document.getElementById('eYtFields');
  if(p.type==='youtube'){
    ytF.style.display='block';
    document.getElementById('eYtPriority').checked=p.youtube_priority;
    document.getElementById('eYtWatched').checked=p.youtube_status==='watched';
  } else { ytF.style.display='none'; }
  eSel=new Set(p.tags||[]);
  renderPicker('editPicker',eSel);
  openModal('editModal');
}

async function saveEdit(){
  const p=posts.find(p=>p.id===editId); if(!p) return;
  p.author=document.getElementById('eAuthor').value.trim()||'ä¸æ˜';
  p.handle=document.getElementById('eHandle').value.trim();
  p.content=document.getElementById('eContent').value.trim();
  p.memo=document.getElementById('eMemo').value.trim();
  p.image=document.getElementById('eImgUrl').value.trim();
  p.country=document.getElementById('eCountry').value.trim();
  p.prefecture=document.getElementById('ePrefecture').value.trim();
  p.area=document.getElementById('eArea').value.trim();
  // ä½ç½®å–å¾—ãƒœã‚¿ãƒ³ã§æ›´æ–°ã•ã‚ŒãŸå ´åˆã®ã¿ lat/lng ã‚’ä¸Šæ›¸ã
  const newLat=parseFloat(document.getElementById('eLat').value);
  const newLng=parseFloat(document.getElementById('eLng').value);
  if(!isNaN(newLat)&&!isNaN(newLng)){ p.lat=newLat; p.lng=newLng; }
  p.tags=[...eSel];
  if(p.type==='youtube'){
    p.youtube_priority=document.getElementById('eYtPriority').checked;
    p.youtube_status=document.getElementById('eYtWatched').checked?'watched':'unwatch';
  }
  try {
    await sb('posts?id=eq.'+p.id,'PATCH',{
      author:p.author, handle:p.handle, content:p.content, memo:p.memo,
      image:p.image, country:p.country, prefecture:p.prefecture, area:p.area,
      lat:p.lat||null, lng:p.lng||null,
      tags:p.tags, youtube_priority:p.youtube_priority, youtube_status:p.youtube_status
    });
    closeModal('editModal'); renderAll(); toast('æ›´æ–°ã—ã¾ã—ãŸ âœ“','ok');
  } catch(e){ toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err'); }
}

async function toggleWatched(id){
  const p=posts.find(p=>p.id===id); if(!p) return;
  p.youtube_status=p.youtube_status==='watched'?'unwatch':'watched';
  try {
    await sb('posts?id=eq.'+id,'PATCH',{youtube_status:p.youtube_status});
    closeModal('detailModal'); renderAll(); toast(p.youtube_status==='watched'?'è¦–è´æ¸ˆã¿ã«ã—ã¾ã—ãŸ':'æœªè¦–è´ã«æˆ»ã—ã¾ã—ãŸ','ok');
  } catch(e){ toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function delPost(id){
  if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  try {
    await sb('posts?id=eq.'+id,'DELETE');
    posts=posts.filter(p=>p.id!==id); renderAll(); toast('å‰Šé™¤ã—ã¾ã—ãŸ');
  } catch(e){ toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE POST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function savePost(){
  const url=document.getElementById('urlIn')?.value.trim()||'';
  const content=document.getElementById('fContent').value.trim();
  const memo=document.getElementById('fMemo').value.trim();
  if(!content&&!memo&&!url){ toast('å†…å®¹ãƒ»ãƒ¡ãƒ¢ãƒ»URLã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err'); return; }

  const now=Date.now();
  let author='',handle='',summary='';

  if(currentType==='x'){
    author=document.getElementById('fAuthor').value.trim()||'ä¸æ˜';
    handle=document.getElementById('fHandle').value.trim();
  } else if(currentType==='web'){
    const title=document.getElementById('fTitle').value.trim();
    const site=document.getElementById('fSite').value.trim();
    author=document.getElementById('fAuthorWeb').value.trim()||title||'Webè¨˜äº‹';
    handle=site;
    summary=document.getElementById('fSummary').value.trim();
  } else if(currentType==='youtube'){
    author=document.getElementById('fYtTitle').value.trim()||'YouTubeå‹•ç”»';
    handle=document.getElementById('fYtChannel').value.trim();
  } else {
    author='ãƒ¡ãƒ¢';
  }

  const remindDate=document.getElementById('fRemindDate').value;
  const remindMsg=document.getElementById('fRemindMsg').value.trim();

  const p={
    id:'p'+now, url, created_at:now,
    author, handle, content, memo,
    image:document.getElementById('fImgUrl').value.trim(),
    tags:[...fSel],
    area:document.getElementById('fArea').value.trim()||null,
    country:document.getElementById('fCountry').value.trim()||null,
    prefecture:document.getElementById('fPrefecture').value.trim()||null,
    lat:parseFloat(document.getElementById('fLat').value)||null,
    lng:parseFloat(document.getElementById('fLng').value)||null,
    type:currentType, summary:summary||null,
    youtube_status:document.getElementById('fYtWatched')?.checked?'watched':'unwatch',
    youtube_priority:document.getElementById('fYtPriority')?.checked||false,
  };

  try {
    await sb('posts','POST',p);
    posts.unshift(mapPost({...p}));

    // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ä¿å­˜
    if(remindDate){
      const r={id:'r'+now, post_id:p.id, remind_at:new Date(remindDate).getTime(), message:remindMsg, done:false};
      await sb('reminders','POST',r);
      reminders.push(r);
    }

    clearForm(); renderAll(); renderReminderBar();
    toast('ä¿å­˜ã—ã¾ã—ãŸ âœ“','ok');
    switchTab('home');
  } catch(e){ toast('ä¿å­˜ã‚¨ãƒ©ãƒ¼: '+e.message,'err'); console.error(e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH FROM URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchFromUrl(){
  const url=document.getElementById('urlIn').value.trim();
  if(!url){ toast('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err'); return; }
  const btn=document.getElementById('fetchBtn');
  btn.disabled=true; btn.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  const status=document.getElementById('statusBar');
  status.style.display='block'; status.textContent='å–å¾—ä¸­...';

  try {
    if(currentType==='x'){
      const m=url.match(/(?:twitter\.com|x\.com)\/@?([\w]+)\/status\/(\d+)/);
      if(!m){ toast('Xã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err'); return; }
      document.getElementById('fHandle').value='@'+m[1];
      document.getElementById('fAuthor').value=m[1];
      const r=await fetch(`https://publish.twitter.com/oembed?url=${encodeURIComponent(url)}&omit_script=true`);
      const d=await r.json();
      if(d.html){
        const doc=new DOMParser().parseFromString(d.html,'text/html');
        let txt=doc.querySelector('p')?.textContent||'';
        // pic.twitter.com ãƒªãƒ³ã‚¯ã‚’ç”»åƒURLã«å¤‰æ›
        const picMatch=txt.match(/pic\.twitter\.com\/\S+/);
        if(picMatch){
          const picUrl='https://'+picMatch[0];
          document.getElementById('fImgUrl').value=picUrl;
          prevImgUrl();
          txt=txt.replace(picMatch[0],'').trim();
        }
        document.getElementById('fContent').value=txt;
        if(d.author_name) document.getElementById('fAuthor').value=d.author_name;
      }
      status.textContent='âœ“ XæŠ•ç¨¿ã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ';

    } else if(currentType==='youtube'){
      const vid=getYtId(url);
      if(!vid){ toast('YouTubeã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err'); return; }
      // oEmbedã§ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ãƒãƒ£ãƒ³ãƒãƒ«å–å¾—
      try {
        const r=await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
        const d=await r.json();
        if(d.title) document.getElementById('fYtTitle').value=d.title;
        if(d.author_name) document.getElementById('fYtChannel').value=d.author_name;
        // ã‚µãƒ ãƒ
        document.getElementById('fImgUrl').value=`https://img.youtube.com/vi/${vid}/mqdefault.jpg`;
        prevImgUrl();
      } catch(e){}
      status.textContent='âœ“ YouTubeå‹•ç”»ã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ';

    } else if(currentType==='web'){
      let html='';
      const proxies=[
        `https://corsproxy.io/?${encodeURIComponent(url)}`,
        `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
      ];
      for(const px of proxies){
        try {
          const r=await fetch(px,{signal:AbortSignal.timeout(8000)});
          html=px.includes('allorigins')?(await r.json()).contents||'':await r.text();
          if(html) break;
        } catch(e){ continue; }
      }
      if(!html) throw new Error('å–å¾—å¤±æ•—');
      const doc=new DOMParser().parseFromString(html,'text/html');
      const get=(sel,attr)=>doc.querySelector(sel)?.getAttribute(attr)||'';
      const title=get('meta[property="og:title"]','content')||get('meta[name="twitter:title"]','content')||doc.querySelector('title')?.textContent||'';
      const desc=get('meta[property="og:description"]','content')||get('meta[name="description"]','content')||'';
      const site=get('meta[property="og:site_name"]','content')||'';
      const img=get('meta[property="og:image"]','content')||get('meta[name="twitter:image"]','content')||'';
      const author=get('meta[name="author"]','content')||'';
      if(title) document.getElementById('fTitle').value=title;
      if(site) document.getElementById('fSite').value=site;
      if(author) document.getElementById('fAuthorWeb').value=author;
      if(desc) document.getElementById('fContent').value=desc;
      if(img){ document.getElementById('fImgUrl').value=img; prevImgUrl(); }
      status.textContent='âœ“ è¨˜äº‹æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸã€‚è¦ç´„ä¸­...';
      // AIè¦ç´„
      const toSummarize=[title,desc].filter(Boolean).join('\n');
      if(toSummarize){
        try {
          const cr=await fetch('https://api.anthropic.com/v1/messages',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:300,
              messages:[{role:'user',content:`ä»¥ä¸‹ã®è¨˜äº‹ã‚’æ—¥æœ¬èªã§3ã€œ5æ–‡ã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚\n\n${toSummarize}`}]})
          });
          const cd=await cr.json();
          const sum=cd.content?.[0]?.text||'';
          if(sum){ document.getElementById('fSummary').value=sum; status.textContent='âœ“ å–å¾—ãƒ»è¦ç´„ãŒå®Œäº†ã—ã¾ã—ãŸ'; }
          else status.textContent='âœ“ æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ';
        } catch(e){ status.textContent='âœ“ æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸï¼ˆè¦ç´„ã‚¹ã‚­ãƒƒãƒ—ï¼‰'; }
      } else { status.textContent='âœ“ æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ'; }
    }
  } catch(e){
    status.textContent='âš ï¸ è‡ªå‹•å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
  }
  btn.disabled=false; btn.innerHTML='æƒ…å ±å–å¾—';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORM HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setType(t){
  currentType=t;
  ['x','web','youtube','memo'].forEach(tt=>{
    document.getElementById('type'+tt.charAt(0).toUpperCase()+tt.slice(1))?.classList.toggle('active',tt===t);
  });
  document.getElementById('urlRow').style.display=t==='memo'?'none':'flex';
  document.getElementById('xFields').style.display=t==='x'?'contents':'none';
  document.getElementById('webFields').style.display=t==='web'?'block':'none';
  document.getElementById('ytFields').style.display=t==='youtube'?'block':'none';
  document.getElementById('summaryField').style.display=t==='web'?'block':'none';
  document.getElementById('statusBar').style.display='none';
  const placeholders={x:'https://x.com/username/status/...',web:'https://example.com/article...',youtube:'https://youtube.com/watch?v=...',memo:''};
  if(document.getElementById('urlIn')) document.getElementById('urlIn').placeholder=placeholders[t]||'';
}

function clearForm(){
  ['urlIn','fAuthor','fHandle','fTitle','fSite','fAuthorWeb','fYtTitle','fYtChannel',
   'fContent','fSummary','fMemo','fImgUrl','fArea','fCountry','fPrefecture','fLat','fLng',
   'fRemindDate','fRemindMsg'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  if(document.getElementById('fYtPriority')) document.getElementById('fYtPriority').checked=false;
  if(document.getElementById('fYtWatched')) document.getElementById('fYtWatched').checked=false;
  document.getElementById('imgPrev').style.display='none';
  document.getElementById('imgPh').style.display='flex';
  document.getElementById('fAreaStatus').textContent='';
  document.getElementById('statusBar').style.display='none';
  fSel.clear(); renderPicker('formPicker',fSel);
  setType('x');
}

function prevImgUrl(){
  const u=document.getElementById('fImgUrl').value.trim();
  const img=document.getElementById('imgPrev'),ph=document.getElementById('imgPh');
  if(u){img.src=u;img.style.display='block';ph.style.display='none';}
  else{img.style.display='none';ph.style.display='flex';}
}

function handleFile(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    document.getElementById('imgPrev').src=ev.target.result;
    document.getElementById('imgPrev').style.display='block';
    document.getElementById('imgPh').style.display='none';
    document.getElementById('fImgUrl').value=ev.target.result;
  };
  r.readAsDataURL(f);
}

async function geocodeArea(){
  const area=document.getElementById('fArea').value.trim();
  const country=document.getElementById('fCountry').value.trim();
  const q=[area,country].filter(Boolean).join(', ');
  if(!q){ toast('å ´æ‰€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err'); return; }
  const status=document.getElementById('fAreaStatus');
  status.textContent='æ¤œç´¢ä¸­...';
  try {
    const r=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=1&addressdetails=1`);
    const d=await r.json();
    if(!d.length){ status.textContent='å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'; return; }
    const addr=d[0].address||{};
    document.getElementById('fLat').value=d[0].lat;
    document.getElementById('fLng').value=d[0].lon;
    if(!document.getElementById('fCountry').value&&addr.country) document.getElementById('fCountry').value=addr.country;
    if(!document.getElementById('fPrefecture').value){
      const pref=addr.state||addr.province||addr.region||'';
      if(pref) document.getElementById('fPrefecture').value=pref;
    }
    status.textContent='âœ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ';
  } catch(e){ status.textContent='ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAG PICKERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPickers(){ renderPicker('formPicker',fSel); renderPicker('editPicker',eSel); }

function renderPicker(id,sel){
  const el=document.getElementById(id); if(!el) return;
  el.innerHTML=tags.map(t=>`
    <span class="tp-pill ${sel.has(t.id)?'on':'off'}"
      style="border-color:${t.color};color:${t.color};${sel.has(t.id)?'background:'+t.color+'22':''}"
      onclick="togglePill('${t.id}','${id}',this)">${esc(t.name)}</span>`).join('');
}

function togglePill(id,pickerId,el){
  const sel=pickerId==='formPicker'?fSel:eSel;
  if(sel.has(id)){sel.delete(id);el.className='tp-pill off';el.style.background='';}
  else{sel.add(id);el.className='tp-pill on';const t=tags.find(t=>t.id===id);el.style.background=t.color+'22';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAGS CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addTag(){
  const inp=document.getElementById('newTagIn'),name=inp.value.trim();
  if(!name)return;
  if(tags.find(t=>t.name===name)){toast('åŒã˜åå‰ã®ã‚¿ã‚°ãŒå­˜åœ¨ã—ã¾ã™','err');return;}
  const t={id:'t'+Date.now(),name,color:COLORS[tags.length%COLORS.length],parent_id:null};
  try{await sb('tags','POST',t);tags.push(t);inp.value='';renderAll();renderSettings();toast('ã‚¿ã‚°è¿½åŠ ','ok');}
  catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

async function addSubTag(){
  const parentId=document.getElementById('parentTagSelect').value;
  const name=document.getElementById('newSubTagIn').value.trim();
  if(!parentId){toast('è¦ªã‚¿ã‚°ã‚’é¸æŠã—ã¦ãã ã•ã„','err');return;}
  if(!name){toast('ã‚¿ã‚°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err');return;}
  if(tags.find(t=>t.name===name)){toast('åŒã˜åå‰ã®ã‚¿ã‚°ãŒå­˜åœ¨ã—ã¾ã™','err');return;}
  const parent=tags.find(t=>t.id===parentId);
  const t={id:'t'+Date.now(),name,color:parent?.color||COLORS[tags.length%COLORS.length],parent_id:parentId};
  try{await sb('tags','POST',t);tags.push(t);document.getElementById('newSubTagIn').value='';renderAll();renderSettings();toast(`ã€Œ${name}ã€ã‚’è¿½åŠ `,'ok');}
  catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

async function delTag(id){
  if(!confirm('ã“ã®ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  try{
    await sb('tags?id=eq.'+id,'DELETE');
    tags=tags.filter(t=>t.id!==id);
    for(const p of posts){if(p.tags?.includes(id)){p.tags=p.tags.filter(x=>x!==id);await sb('posts?id=eq.'+p.id,'PATCH',{tags:p.tags});}}
    if(tagFilter===id)tagFilter=null;
    renderAll();renderSettings();toast('ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  }catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

function startRenameTag(id){
  const t=tags.find(t=>t.id===id);if(!t)return;
  const name=prompt('æ–°ã—ã„ã‚¿ã‚°å',t.name);
  if(!name||name.trim()===t.name)return;
  renameTag(id,name.trim());
}

async function renameTag(id,name){
  try{
    await sb('tags?id=eq.'+id,'PATCH',{name});
    const t=tags.find(t=>t.id===id);if(t)t.name=name;
    renderAll();renderSettings();toast('ã‚¿ã‚°åã‚’å¤‰æ›´ã—ã¾ã—ãŸ','ok');
  }catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REMINDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderReminderBar(){
  const today=new Date(); today.setHours(0,0,0,0);
  const tomorrow=new Date(today); tomorrow.setDate(tomorrow.getDate()+1);
  const todayMs=today.getTime(), tomorrowMs=tomorrow.getTime();
  const due=reminders.filter(r=>!r.done&&r.remind_at>=todayMs&&r.remind_at<tomorrowMs);
  const rbEmpty=document.getElementById('rbEmpty');
  const rbItems=document.getElementById('rbItems');
  if(!due.length){
    rbEmpty.style.display='block';
    rbItems.innerHTML='';
    return;
  }
  rbEmpty.style.display='none';
  rbItems.innerHTML=due.filter(r=>{
    // è¡¨ç¤ºè¨­å®šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    return true; // å…¨è¡¨ç¤ºï¼ˆè¨­å®šã§çµã‚Šè¾¼ã¿å¯èƒ½ï¼‰
  }).map(r=>{
    const p=posts.find(p=>p.id===r.post_id);
    const label=p?esc(p.author+(r.message?' â€” '+r.message:'')):esc(r.message||'ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼');
    return `<div class="rb-item">
      <span>${label}</span>
      ${p?`<button class="c-btn" onclick="openDetail('${p.id}')" style="font-size:.68rem;padding:.15rem .45rem">ç¢ºèª</button>`:''}
      <button class="rb-dismiss" onclick="dismissReminder('${r.id}')">âœ•</button>
    </div>`;
  }).join('');
}

async function dismissReminder(id){
  try{
    await sb('reminders?id=eq.'+id,'PATCH',{done:true});
    const r=reminders.find(r=>r.id===id); if(r)r.done=true;
    renderReminderBar();
  }catch(e){console.error(e);}
}

function openReminderModal(postId){
  reminderPostId=postId;
  const p=posts.find(p=>p.id===postId);
  document.getElementById('reminderPostInfo').textContent=p?`ã€Œ${p.author}ã€: ${(p.content||p.memo||'').slice(0,60)}`:'';
  document.getElementById('rDate').value='';
  document.getElementById('rMessage').value='';
  const existing=reminders.filter(r=>r.post_id===postId&&!r.done);
  const el=document.getElementById('existingReminders');
  el.innerHTML=existing.length?`<div style="font-size:.78rem;color:var(--ink3);margin-bottom:.4rem">è¨­å®šæ¸ˆã¿</div>`+
    existing.map(r=>`<div class="tag-mgr-row">
      <span style="font-family:'DM Mono',monospace;font-size:.7rem">${new Date(r.remind_at).toLocaleDateString('ja-JP')}</span>
      <span style="font-size:.78rem;flex:1;padding-left:.5rem">${esc(r.message||'')}</span>
      <button class="tag-del" onclick="deleteReminder('${r.id}')">âœ•</button>
    </div>`).join(''):'';
  openModal('reminderModal');
}

async function saveReminder(){
  const date=document.getElementById('rDate').value;
  if(!date){toast('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„','err');return;}
  const r={id:'r'+Date.now(),post_id:reminderPostId,remind_at:new Date(date).getTime(),message:document.getElementById('rMessage').value.trim(),done:false};
  try{
    await sb('reminders','POST',r);
    reminders.push(r);
    toast('ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ âœ“','ok');
    closeModal('reminderModal');
    renderReminderBar();
  }catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

async function deleteReminder(id){
  try{
    await sb('reminders?id=eq.'+id,'DELETE');
    reminders=reminders.filter(r=>r.id!==id);
    toast('ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    if(reminderPostId) openReminderModal(reminderPostId);
    renderReminderBar();
  }catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YOUTUBE PLAYLISTï¼ˆHomeã‚¿ãƒ–å†…ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ytPlayer=null, ytApiReady=false;

(function(){
  const tag=document.createElement('script');
  tag.src='https://www.youtube.com/iframe_api';
  document.head.appendChild(tag);
})();

window.onYouTubeIframeAPIReady=function(){ ytApiReady=true; };

// ã‚«ãƒ¼ãƒ‰ã®ã€Œâ–¶ å†ç”Ÿã€ãƒœã‚¿ãƒ³ â†’ ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿å†…ã®YTã‚’ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆåŒ–ã—ã¦èµ·å‹•
function playYt(id){
  const filtered=getFiltered().filter(p=>p.type==='youtube');
  if(!filtered.length){ toast('YouTubeãŒã‚ã‚Šã¾ã›ã‚“','err'); return; }
  ytPlaylist=filtered.sort((a,b)=>(b.youtube_priority?1:0)-(a.youtube_priority?1:0));
  const idx=ytPlaylist.findIndex(p=>p.id===id);
  ytPlayIdx=idx>=0?idx:0;
  openHomePlayer();
}

// ã‚µã‚¤ãƒ‰ãƒãƒ¼ã€Œâ–¶ é€£ç¶šå†ç”Ÿã€â†’ ãƒ•ã‚£ãƒ«ã‚¿å¾Œã®æœªè¦–è´YTã‚’å†ç”Ÿ
function startHomePlaylist(){
  const filtered=getFiltered().filter(p=>p.type==='youtube'&&p.youtube_status!=='watched');
  if(!filtered.length){ toast('æœªè¦–è´ã®YouTubeãŒã‚ã‚Šã¾ã›ã‚“','err'); return; }
  ytPlaylist=filtered.sort((a,b)=>(b.youtube_priority?1:0)-(a.youtube_priority?1:0));
  ytPlayIdx=0;
  openHomePlayer();
}

// Settingsç”¨ï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
function startPlaylist(){
  startHomePlaylist();
  switchTab('home');
}

function openHomePlayer(){
  document.getElementById('homeYtPanel').style.display='block';
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¦‹ãˆã‚‹ã‚ˆã†ã«
  document.getElementById('homeYtPanel').scrollIntoView({behavior:'smooth',block:'start'});
  loadHomeYtVideo();
  renderYtQueue();
}

function closeHomePlayer(){
  document.getElementById('homeYtPanel').style.display='none';
  // iframeã‚’ç©ºã«ã—ã¦å†ç”Ÿåœæ­¢
  document.getElementById('homeYtIframeContainer').innerHTML='';
  ytPlayer=null;
}

function loadHomeYtVideo(){
  const p=ytPlaylist[ytPlayIdx]; if(!p) return;
  const vid=getYtId(p.url); if(!vid) return;
  if(ytPlayer&&ytPlayer.loadVideoById){
    ytPlayer.loadVideoById(vid);
  } else if(ytApiReady&&window.YT&&window.YT.Player){
    document.getElementById('homeYtIframeContainer').innerHTML='<div id="ytIframeEl" style="width:100%;height:100%;position:absolute;top:0;left:0"></div>';
    ytPlayer=new YT.Player('ytIframeEl',{
      videoId:vid, width:'100%', height:'100%',
      playerVars:{autoplay:1,rel:0},
      events:{
        onStateChange(e){
          if(e.data===YT.PlayerState.ENDED) ytNextAuto();
        }
      }
    });
  } else {
    document.getElementById('homeYtIframeContainer').innerHTML=
      `<iframe src="https://www.youtube.com/embed/${vid}?autoplay=1&rel=0"
        style="width:100%;height:100%;position:absolute;top:0;left:0"
        frameborder="0" allowfullscreen allow="autoplay"></iframe>`;
  }
  updateYtPlayInfo();
  renderYtQueue();
}

function updateYtPlayInfo(){
  const p=ytPlaylist[ytPlayIdx]; if(!p) return;
  const el=document.getElementById('homeYtPlayInfo');
  if(el) el.innerHTML=
    `<span style="font-family:'DM Mono',monospace;font-size:.65rem;opacity:.6">${ytPlayIdx+1} / ${ytPlaylist.length}</span>
     <span style="font-weight:500;margin-left:.4rem">${esc(p.author)}</span>
     ${p.youtube_priority?'<span style="color:#fbbf24"> â­</span>':''}
     ${p.youtube_status==='watched'?'<span style="font-size:.68rem;background:rgba(255,255,255,.15);padding:1px 6px;border-radius:10px;margin-left:.3rem">è¦–è´æ¸ˆ</span>':''}`;
  // Settingså´ã‚‚æ›´æ–°
  const el2=document.getElementById('ytPlayInfo');
  if(el2) el2.innerHTML=el?.innerHTML||'';
}

function renderYtQueue(){
  const el=document.getElementById('homeYtQueue'); if(!el) return;
  el.innerHTML=ytPlaylist.map((p,i)=>`
    <div onclick="ytJump(${i})" style="display:flex;align-items:center;gap:.5rem;padding:.4rem .5rem;border-radius:4px;cursor:pointer;transition:background .15s;background:${i===ytPlayIdx?'rgba(255,255,255,.15)':'transparent'};margin-bottom:2px">
      <img src="https://img.youtube.com/vi/${getYtId(p.url)}/default.jpg" style="width:40px;height:28px;object-fit:cover;border-radius:2px;flex-shrink:0" onerror="this.style.display='none'">
      <div style="min-width:0">
        <div style="font-size:.72rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:${p.youtube_status==='watched'?.5:1}">${esc(p.author)}</div>
        ${p.youtube_priority?'<span style="font-size:.6rem;color:#fbbf24">â­</span>':''}
        ${p.youtube_status==='watched'?'<span style="font-size:.6rem;opacity:.5">âœ…</span>':''}
      </div>
    </div>`).join('');
}

function ytJump(idx){
  ytPlayIdx=idx;
  loadHomeYtVideo();
}

function ytPrev(){
  if(ytPlayIdx>0){ ytPlayIdx--; loadHomeYtVideo(); }
  else toast('æœ€åˆã®å‹•ç”»ã§ã™');
}

function ytNext(){
  if(ytPlayIdx<ytPlaylist.length-1){ ytPlayIdx++; loadHomeYtVideo(); }
  else { toast('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆçµ‚äº† ğŸ‰','ok'); closeHomePlayer(); }
}

async function ytNextAuto(){
  const p=ytPlaylist[ytPlayIdx];
  if(p&&p.youtube_status!=='watched'){
    p.youtube_status='watched';
    try{ await sb('posts?id=eq.'+p.id,'PATCH',{youtube_status:'watched'}); }catch(e){}
  }
  // æ¬¡ã®æœªè¦–è´ã‚’æ¢ã™
  let next=ytPlayIdx+1;
  while(next<ytPlaylist.length&&ytPlaylist[next].youtube_status==='watched') next++;
  if(next<ytPlaylist.length){
    ytPlayIdx=next; loadHomeYtVideo();
    toast(`æ¬¡ã®å‹•ç”»ã¸: ${ytPlaylist[ytPlayIdx].author}`);
  } else {
    toast('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆçµ‚äº† ğŸ‰','ok');
    closeHomePlayer();
    renderAll();
  }
}

async function markWatched(){
  const p=ytPlaylist[ytPlayIdx]; if(!p) return;
  p.youtube_status='watched';
  try{
    await sb('posts?id=eq.'+p.id,'PATCH',{youtube_status:'watched'});
    toast('è¦–è´æ¸ˆã¿ã«ã—ã¾ã—ãŸ âœ“','ok');
    renderYtQueue();
    await ytNextAuto();
  }catch(e){ toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDIT GEOCODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function geocodeEditArea(){
  const area=document.getElementById('eArea').value.trim();
  const country=document.getElementById('eCountry').value.trim();
  const q=[area,country].filter(Boolean).join(', ');
  if(!q){ toast('å ´æ‰€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err'); return; }
  const status=document.getElementById('eAreaStatus');
  status.textContent='æ¤œç´¢ä¸­...';
  try {
    const r=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=1&addressdetails=1`);
    const d=await r.json();
    if(!d.length){ status.textContent='å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'; return; }
    const addr=d[0].address||{};
    document.getElementById('eLat').value=d[0].lat;
    document.getElementById('eLng').value=d[0].lon;
    if(!document.getElementById('eCountry').value&&addr.country) document.getElementById('eCountry').value=addr.country;
    if(!document.getElementById('ePrefecture').value){
      const pref=addr.state||addr.province||addr.region||'';
      if(pref){ const el=document.getElementById('ePrefecture'); if(el&&!el.value) el.value=pref; }
    }
    status.textContent='âœ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ';
  } catch(e){ status.textContent='ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSettings(){
  // ã‚¿ã‚°ç®¡ç†
  const parentTags=tags.filter(t=>!t.parent_id);
  const childTags=tags.filter(t=>t.parent_id);
  let html='';
  parentTags.forEach(pt=>{
    const children=childTags.filter(c=>c.parent_id===pt.id);
    html+=`<div class="tag-mgr-row">
      <div style="width:8px;height:8px;border-radius:50%;background:${pt.color};flex-shrink:0"></div>
      <span class="tn">${esc(pt.name)}</span>
      <button class="tag-del" onclick="startRenameTag('${pt.id}')">âœï¸</button>
      <button class="tag-del" onclick="delTag('${pt.id}')">âœ•</button>
    </div>`;
    children.forEach(ct=>{
      html+=`<div class="tag-mgr-row" style="padding-left:1.5rem;background:var(--off);margin-bottom:1px;border-radius:3px">
        <div style="width:5px;height:5px;border-radius:50%;background:${ct.color};flex-shrink:0"></div>
        <span class="tn" style="font-size:.75rem;color:var(--ink3)">â”” ${esc(ct.name)}</span>
        <button class="tag-del" onclick="startRenameTag('${ct.id}')">âœï¸</button>
        <button class="tag-del" onclick="delTag('${ct.id}')">âœ•</button>
      </div>`;
    });
  });
  document.getElementById('tagMgrList').innerHTML=html;

  // è¦ªã‚¿ã‚°ã‚»ãƒ¬ã‚¯ãƒˆæ›´æ–°
  const psel=document.getElementById('parentTagSelect');
  if(psel) psel.innerHTML='<option value="">è¦ªã‚¿ã‚°ã‚’é¸æŠ...</option>'+parentTags.map(t=>`<option value="${t.id}">${esc(t.name)}</option>`).join('');

  // YouTube ã‚¿ã‚°ã‚»ãƒ¬ã‚¯ãƒˆ
  const ytSel=document.getElementById('ytPlayTag');
  if(ytSel) ytSel.innerHTML='<option value="">ã™ã¹ã¦ï¼ˆã‚¿ã‚°çµã‚Šè¾¼ã¿ãªã—ï¼‰</option>'+tags.map(t=>`<option value="${t.id}">${esc(t.name)}</option>`).join('');

  // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ä¸€è¦§
  const allR=document.getElementById('allRemindersList');
  if(allR){
    const upcoming=reminders.filter(r=>!r.done).sort((a,b)=>a.remind_at-b.remind_at);
    allR.innerHTML=upcoming.length?upcoming.map(r=>{
      const p=posts.find(p=>p.id===r.post_id);
      return `<div class="tag-mgr-row">
        <span style="font-family:'DM Mono',monospace;font-size:.68rem;color:var(--ink3)">${new Date(r.remind_at).toLocaleDateString('ja-JP')}</span>
        <span style="font-size:.78rem;flex:1;padding-left:.5rem">${esc(p?.author||'')} ${esc(r.message||'')}</span>
        <button class="tag-del" onclick="deleteReminder('${r.id}')">âœ•</button>
      </div>`;
    }).join(''):`<div style="font-size:.8rem;color:var(--ink3)">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãªã—</div>`;
  }

  // çµ±è¨ˆ
  const yt=posts.filter(p=>p.type==='youtube');
  const statsWrap=document.getElementById('statsWrap');
  if(statsWrap) statsWrap.innerHTML=`
    <div>ç·ã‚¯ãƒªãƒƒãƒ—æ•°: <b>${posts.length}</b></div>
    <div>Xãƒã‚¹ãƒˆ: <b>${posts.filter(p=>p.type==='x').length}</b></div>
    <div>Webè¨˜äº‹: <b>${posts.filter(p=>p.type==='web').length}</b></div>
    <div>YouTube: <b>${yt.length}</b>ï¼ˆæœªè¦–è´: <b>${yt.filter(p=>p.youtube_status!=='watched').length}</b>ï¼‰</div>
    <div>ãƒ¡ãƒ¢: <b>${posts.filter(p=>p.type==='memo').length}</b></div>
    <div>ã‚¿ã‚°æ•°: <b>${tags.length}</b></div>
    <div>ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼: <b>${reminders.filter(r=>!r.done).length}</b> ä»¶</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE FILTER BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMobileFilterBar(){
  // ã‚¿ã‚°ãƒ”ãƒ«
  const mfbTags = document.getElementById('mfbTags');
  if(mfbTags){
    const parentTags=tags.filter(t=>!t.parent_id);
    const childTags=tags.filter(t=>t.parent_id);
    let html='';
    parentTags.forEach(pt=>{
      const active=tagFilter===pt.id;
      html+=`<button class="mfb-expand-pill${active?' active':''}" style="border-color:${pt.color};${active?'':'color:'+pt.color}" onclick="mfbTag('${pt.id}')">${esc(pt.name)}</button>`;
      childTags.filter(c=>c.parent_id===pt.id).forEach(ct=>{
        const ca=tagFilter===ct.id;
        html+=`<button class="mfb-expand-pill${ca?' active':''}" style="border-color:${ct.color};${ca?'':'color:'+ct.color}" onclick="mfbTag('${ct.id}')">â”” ${esc(ct.name)}</button>`;
      });
    });
    mfbTags.innerHTML=html;
  }
  // ã‚¨ãƒªã‚¢ã‚»ãƒ¬ã‚¯ãƒˆåŒæœŸ
  syncMobileAreaFilter();
}

function syncMobileAreaFilter(){
  const countries=[...new Set(posts.map(p=>p.country).filter(Boolean))].sort();
  const mcs=document.getElementById('mCountrySelect');
  if(mcs){
    const cur=areaFilter.country||'';
    mcs.innerHTML='<option value="">å›½ã‚’é¸æŠ...</option>'+countries.map(c=>`<option value="${esc(c)}"${cur===c?' selected':''}>${esc(c)}</option>`).join('');
  }
  const mps=document.getElementById('mPrefSelect');
  if(mps){
    if(areaFilter.country){
      const prefs=[...new Set(posts.filter(p=>p.country===areaFilter.country).map(p=>p.prefecture).filter(Boolean))].sort();
      if(prefs.length){
        mps.style.display='block';
        mps.innerHTML='<option value="">éƒ½é“åºœçœŒ...</option>'+prefs.map(pr=>`<option value="${esc(pr)}"${areaFilter.prefecture===pr?' selected':''}>${esc(pr)}</option>`).join('');
      } else { mps.style.display='none'; }
    } else { mps.style.display='none'; mps.value=''; }
  }
}

function mfbFilter(f){
  curFilter=f; tagFilter=null;
  // ãƒ”ãƒ«ã®activeæ›´æ–°
  document.querySelectorAll('#mfbMain .mfb-pill[data-f]').forEach(el=>{
    el.classList.toggle('active', el.dataset.f===f);
  });
  // ã‚µã‚¤ãƒ‰ãƒãƒ¼å´ã‚‚åŒæœŸ
  ['fAll','fRecent','fMemo','fImg','fYt','fYtUn'].forEach(id=>document.getElementById(id)?.classList.remove('active'));
  const map={all:'fAll',recent:'fRecent',memo:'fMemo',img:'fImg',youtube:'fYt','yt-unwatch':'fYtUn'};
  document.getElementById(map[f])?.classList.add('active');
  renderMobileFilterBar();
  renderHome();
  scrollToContent();
}

function mfbTag(id){
  tagFilter=tagFilter===id?null:id;
  renderMobileFilterBar();
  renderHome();
  scrollToContent();
  // ã‚¨ãƒªã‚¢ã‚’é–‰ã˜ã‚‹
  document.getElementById('mfbTags').classList.remove('open');
}

function mfbSetCountry(v){
  areaFilter.country=v||null; areaFilter.prefecture=null;
  syncMobileAreaFilter(); renderAreaFilter(); renderHome(); scrollToContent();
}
function mfbSetPref(v){
  areaFilter.prefecture=v||null;
  renderHome(); scrollToContent();
}

let mfbOpenExpand=null;
function toggleMfbExpand(name){
  const el=document.getElementById('mfb'+name.charAt(0).toUpperCase()+name.slice(1));
  if(!el) return;
  const isOpen=el.classList.contains('open');
  // ä»–ã‚’é–‰ã˜ã‚‹
  document.querySelectorAll('.mfb-expand').forEach(e=>e.classList.remove('open'));
  if(!isOpen) el.classList.add('open');
}

function scrollToContent(){
  const anchor=document.getElementById('contentAnchor');
  if(anchor) anchor.scrollIntoView({behavior:'smooth', block:'start'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER / VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFilter(f){
  curFilter=f; tagFilter=null;
  ['fAll','fRecent','fMemo','fImg','fYt','fYtUn'].forEach(id=>document.getElementById(id)?.classList.remove('active'));
  const map={all:'fAll',recent:'fRecent',memo:'fMemo',img:'fImg',youtube:'fYt','yt-unwatch':'fYtUn'};
  document.getElementById(map[f])?.classList.add('active');
  // ãƒ¢ãƒã‚¤ãƒ«ãƒãƒ¼åŒæœŸ
  document.querySelectorAll('#mfbMain .mfb-pill[data-f]').forEach(el=>el.classList.toggle('active',el.dataset.f===f));
  renderHome();
  scrollToContent();
}

function setView(v){
  viewMode=v;
  ['vGrid','vList','vMap'].forEach(id=>document.getElementById(id)?.classList.remove('active'));
  document.getElementById('v'+v.charAt(0).toUpperCase()+v.slice(1))?.classList.add('active');
  document.getElementById('mapWrap').style.display=v==='map'?'block':'none';
  document.getElementById('postsWrap').style.display=v==='map'?'none':'block';
  renderHome();
}

function setMode(m){
  displayMode=m;
  document.getElementById('modeA')?.classList.toggle('active',m==='A');
  document.getElementById('modeB')?.classList.toggle('active',m==='B');
  renderHome();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats(){
  const now=Date.now(),wk=7*864e5;
  document.getElementById('totalCount').textContent=posts.length;
  document.getElementById('tagCount').textContent=tags.length;
  document.getElementById('cAll').textContent=posts.length;
  document.getElementById('cRec').textContent=posts.filter(p=>now-p.createdAt<wk).length;
  document.getElementById('cMemo').textContent=posts.filter(p=>p.memo).length;
  document.getElementById('cImg').textContent=posts.filter(p=>p.image).length;
  const yt=posts.filter(p=>p.type==='youtube');
  document.getElementById('cYt').textContent=yt.length;
  document.getElementById('cYtUn').textContent=yt.filter(p=>p.youtube_status!=='watched').length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST & UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s){ return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

let tTimer;
function toast(msg,type=''){
  const el=document.getElementById('toast');
  el.textContent=msg; el.className='toast show'+(type?' '+type:'');
  clearTimeout(tTimer); tTimer=setTimeout(()=>{el.className='toast';},3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('newTagIn')?.addEventListener('keydown',e=>{if(e.key==='Enter')addTag();});
['detailModal','editModal','reminderModal'].forEach(id=>{
  document.getElementById(id)?.addEventListener('click',e=>{if(e.target===document.getElementById(id))closeModal(id);});
});

init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XCLIP</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Noto+Sans+JP:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root{
  --white:#fff;--off:#f7f6f3;--paper:#faf9f6;
  --ink:#111;--ink2:#444;--ink3:#999;
  --line:#e0ddd6;--line2:#ebebeb;
  --accent:#d4502a;--accent-light:#f5e8e3;
  --blue:#3b82f6;--green:#059669;--yellow:#f59e0b;--yellow-bg:#fff8e1;
  --red:#dc2626;--purple:#8b5cf6;
  --shadow-sm:0 1px 4px rgba(0,0,0,.06);
  --shadow-md:0 4px 24px rgba(0,0,0,.09);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--paper);color:var(--ink);font-family:'Noto Sans JP',sans-serif;font-weight:300;min-height:100vh;-webkit-font-smoothing:antialiased;}

/* â”€â”€â”€ REMINDER BAR â”€â”€â”€ */
#reminderBar{background:var(--yellow-bg);border-bottom:2px solid var(--yellow);padding:.55rem 1.5rem;display:flex;align-items:center;gap:.75rem;flex-wrap:wrap;min-height:42px;}
#reminderBar .rb-label{font-family:'DM Mono',monospace;font-size:.6rem;letter-spacing:.15em;color:#92400e;white-space:nowrap;}
.rb-item{display:flex;align-items:center;gap:.4rem;background:#fff;border:1px solid #fcd34d;border-radius:4px;padding:.2rem .6rem;font-size:.76rem;color:#92400e;}
.rb-dismiss{background:transparent;border:none;color:#a16207;cursor:pointer;font-size:.85rem;margin-left:.2rem;}
#rbEmpty{font-size:.78rem;color:#a16207;}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
header{position:sticky;top:0;z-index:300;background:rgba(250,249,246,.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--line);}
.hd{max-width:1440px;margin:0 auto;padding:0 1.5rem;height:52px;display:flex;align-items:center;gap:1.25rem;}
.logo{font-family:'Playfair Display',serif;font-weight:900;font-size:1.3rem;letter-spacing:-.03em;}
.logo em{color:var(--accent);font-style:normal;}
.hd-rule{flex:1;height:1px;background:var(--line);}
.hd-stat{text-align:right;}
.hd-stat .n{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;line-height:1;}
.hd-stat .l{font-family:'DM Mono',monospace;font-size:.48rem;letter-spacing:.12em;color:var(--ink3);text-transform:uppercase;}
.hd-stats{display:flex;gap:1.25rem;}

/* â”€â”€â”€ TABS â”€â”€â”€ */
.tabs{display:flex;background:var(--white);border-bottom:1px solid var(--line);position:sticky;top:52px;z-index:200;}
.tab-btn{flex:1;padding:.7rem;font-size:.8rem;font-family:'Noto Sans JP',sans-serif;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--ink3);cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:.35rem;}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:500;}
.tab-btn:hover:not(.active){background:var(--off);color:var(--ink);}
.tab-pane{display:none;}
.tab-pane.active{display:block;}

/* â”€â”€â”€ ACTIVE FILTER BADGE â”€â”€â”€ */
#activeBadgeBar{display:none;padding:.4rem 1.5rem;background:var(--accent-light);border-bottom:1px solid #f0c4b4;gap:.4rem;flex-wrap:wrap;align-items:center;}
#activeBadgeBar.show{display:flex;}
.a-badge{display:inline-flex;align-items:center;gap:.3rem;background:var(--accent);color:#fff;border-radius:12px;padding:.2rem .7rem;font-size:.72rem;}
.a-badge-clear{background:transparent;border:none;color:#fff;cursor:pointer;opacity:.7;font-size:.8rem;margin-left:.1rem;}
.a-badge-clear:hover{opacity:1;}

/* â”€â”€â”€ MOBILE FILTER BAR â”€â”€â”€ */
#mobileFilterBar{display:none;position:sticky;top:104px;z-index:150;background:var(--white);border-bottom:1px solid var(--line);}
.mfb-scroll{display:flex;gap:.35rem;overflow-x:auto;padding:.5rem 1rem;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.mfb-scroll::-webkit-scrollbar{display:none;}
.mfb-pill{flex-shrink:0;padding:.3rem .8rem;border-radius:20px;border:1.5px solid var(--line);background:var(--white);color:var(--ink2);font-size:.74rem;font-family:'Noto Sans JP',sans-serif;cursor:pointer;transition:all .15s;white-space:nowrap;}
.mfb-pill.active{background:var(--ink);border-color:var(--ink);color:#fff;}
.mfb-pill.yt-pill.active{background:#dc2626;border-color:#dc2626;color:#fff;}
.mfb-pill.fav-pill.active{background:#f59e0b;border-color:#f59e0b;color:#fff;}
.mfb-expand{display:none;padding:.35rem 1rem .5rem;gap:.3rem;flex-wrap:wrap;border-bottom:1px solid var(--line);}
.mfb-expand.open{display:flex;}
.mfb-ep{flex-shrink:0;padding:.25rem .7rem;border-radius:14px;border:1.5px solid var(--line);background:var(--off);color:var(--ink2);font-size:.71rem;cursor:pointer;white-space:nowrap;transition:all .15s;}
.mfb-ep.active{background:var(--accent);border-color:var(--accent);color:#fff;}
#contentAnchor{scroll-margin-top:160px;}

/* â”€â”€â”€ HOME LAYOUT â”€â”€â”€ */
.home-wrap{max-width:1440px;margin:0 auto;display:grid;grid-template-columns:300px 1fr;min-height:calc(100vh - 160px);}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
.sidebar{border-right:1px solid var(--line);padding:1.25rem;position:sticky;top:104px;height:calc(100vh - 104px);overflow-y:auto;background:var(--white);}
.sb-section{margin-bottom:1.25rem;}
.sb-head{font-family:'DM Mono',monospace;font-size:.56rem;letter-spacing:.2em;text-transform:uppercase;color:var(--ink3);padding-bottom:.5rem;border-bottom:1px solid var(--line);margin-bottom:.5rem;}
.filter-btn{display:flex;align-items:center;gap:.5rem;width:100%;padding:.38rem .55rem;background:transparent;border:none;border-radius:4px;color:var(--ink2);cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-size:.79rem;font-weight:300;text-align:left;transition:all .15s;margin-bottom:1px;}
.filter-btn:hover{background:var(--off);}
.filter-btn.active{background:var(--ink);color:#fff;}
.filter-btn.yt-btn.active{background:#dc2626;}
.filter-btn.fav-btn.active{background:#f59e0b;color:#fff;}
.filter-btn .fc{margin-left:auto;font-family:'DM Mono',monospace;font-size:.6rem;opacity:.55;}
.tag-tree-parent{margin-bottom:2px;}
.tag-row{display:flex;align-items:center;gap:.4rem;padding:.32rem .55rem;border-radius:4px;cursor:pointer;transition:background .15s;font-size:.79rem;color:var(--ink2);}
.tag-row:hover{background:var(--off);}
.tag-row.active{background:var(--accent-light);color:var(--accent);font-weight:500;}
.t-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.t-cnt{margin-left:auto;font-family:'DM Mono',monospace;font-size:.6rem;color:var(--ink3);}
.tag-child-wrap{padding-left:.9rem;}
.tag-child-wrap .tag-row{font-size:.74rem;}
.tag-child-wrap .t-dot{width:5px;height:5px;}
.area-select{width:100%;background:var(--off);border:1px solid var(--line);border-radius:4px;color:var(--ink);padding:.38rem .55rem;font-size:.76rem;font-family:'Noto Sans JP',sans-serif;outline:none;cursor:pointer;margin-bottom:.35rem;}
.sb-play-btn{width:100%;padding:.38rem .55rem;background:var(--ink);border:none;border-radius:4px;color:#fff;font-size:.74rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.3rem;font-family:'Noto Sans JP',sans-serif;margin-top:.3rem;transition:background .15s;}
.sb-play-btn:hover{background:var(--accent);}

/* â”€â”€â”€ MAIN AREA â”€â”€â”€ */
.main-area{padding:1.25rem 1.5rem;}
.toolbar{display:flex;align-items:center;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap;}
.search-wrap{flex:1;min-width:160px;position:relative;}
.search-ico{position:absolute;left:.7rem;top:50%;transform:translateY(-50%);color:var(--ink3);font-size:.85rem;}
.search-fi{width:100%;background:var(--white);border:1px solid var(--line);border-radius:6px;padding:.45rem .7rem .45rem 2rem;font-size:.82rem;outline:none;transition:border-color .2s;font-family:'Noto Sans JP',sans-serif;}
.search-fi:focus{border-color:var(--ink);}
.view-toggle{display:flex;gap:.2rem;}
.vt-btn{background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.36rem .6rem;cursor:pointer;color:var(--ink3);font-size:.88rem;transition:all .15s;}
.vt-btn.active{background:var(--ink);color:#fff;border-color:var(--ink);}
.mode-toggle{display:flex;gap:.2rem;}
.mode-btn{background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.3rem .65rem;cursor:pointer;color:var(--ink2);font-size:.7rem;font-family:'DM Mono',monospace;transition:all .15s;}
.mode-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);}
.result-info{font-family:'DM Mono',monospace;font-size:.65rem;color:var(--ink3);letter-spacing:.08em;margin-bottom:.75rem;}

/* â”€â”€â”€ CARDS â”€â”€â”€ */
.posts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:.9rem;}
.posts-list{display:flex;flex-direction:column;gap:.5rem;}
.card{background:var(--white);border:1px solid var(--line);border-radius:6px;overflow:hidden;transition:box-shadow .2s;position:relative;}
.card:hover{box-shadow:var(--shadow-md);}
.card-img-wrap{width:100%;height:160px;background:#f8f8f8;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.card-img-wrap img{max-width:100%;max-height:100%;object-fit:contain;}
.card-body{padding:.85rem;}
.card-meta{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;}
.c-avatar{width:26px;height:26px;border-radius:50%;background:var(--ink);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.68rem;font-weight:700;flex-shrink:0;}
.c-author{font-size:.8rem;font-weight:500;}
.c-handle{font-size:.7rem;color:var(--ink3);}
.c-date{font-family:'DM Mono',monospace;font-size:.6rem;color:var(--ink3);margin-left:auto;white-space:nowrap;}
.c-content{font-size:.8rem;color:var(--ink2);line-height:1.6;margin-bottom:.45rem;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
.c-summary{font-size:.73rem;color:#6d28d9;background:#f5f3ff;border-left:2px solid #8b5cf6;padding:.35rem .55rem;border-radius:0 4px 4px 0;margin-bottom:.45rem;line-height:1.5;}
.c-memo-row{font-size:.72rem;color:var(--ink2);background:var(--off);border-left:2px solid var(--line);padding:.3rem .55rem;border-radius:0 3px 3px 0;margin-bottom:.4rem;word-break:break-all;}
.c-area{font-size:.68rem;color:var(--ink3);margin-bottom:.35rem;}
.c-dist{font-family:'DM Mono',monospace;font-size:.6rem;color:var(--blue);background:#eff6ff;padding:1px 5px;border-radius:3px;margin-left:.3rem;}
.c-tags{display:flex;flex-wrap:wrap;gap:.25rem;margin-bottom:.4rem;}
.c-tag{font-size:.66rem;padding:1px 7px;border-radius:10px;}
.c-footer{display:flex;align-items:center;gap:.3rem;flex-wrap:wrap;padding-top:.45rem;border-top:1px solid var(--line);}
.c-btn{background:var(--off);border:1px solid var(--line);border-radius:3px;padding:.18rem .52rem;font-size:.68rem;cursor:pointer;color:var(--ink2);transition:all .15s;font-family:'Noto Sans JP',sans-serif;}
.c-btn:hover{background:var(--ink);color:#fff;border-color:var(--ink);}
.c-btn.del:hover{background:var(--red);border-color:var(--red);color:#fff;}
.c-btn.green{background:#d1fae5;border-color:#6ee7b7;color:#065f46;}
.c-link{font-size:.7rem;color:var(--blue);text-decoration:none;}
.c-link:hover{text-decoration:underline;}
.type-badge{font-family:'DM Mono',monospace;font-size:.56rem;padding:1px 6px;border-radius:10px;margin-right:.2rem;vertical-align:middle;}
/* ãƒ•ãƒ©ã‚°ã‚¢ã‚¤ã‚³ãƒ³ */
.flag-fav{position:absolute;top:.5rem;right:.5rem;font-size:.95rem;line-height:1;}
.flag-wl{font-size:.8rem;color:var(--blue);}
.yt-status-badge{font-size:.66rem;padding:1px 7px;border-radius:10px;font-family:'DM Mono',monospace;}
.yt-status-badge.unwatch{background:#fee2e2;color:#991b1b;}
.yt-status-badge.watched{background:#d1fae5;color:#065f46;}

/* LIST ROW */
.list-row{background:var(--white);border:1px solid var(--line);border-radius:6px;display:grid;grid-template-columns:80px 1fr;overflow:hidden;transition:box-shadow .2s;position:relative;}
.list-row:hover{box-shadow:var(--shadow-sm);}
.list-thumb{width:80px;height:80px;background:#f8f8f8;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;}
.list-thumb img{max-width:100%;max-height:100%;object-fit:contain;}
.list-thumb-ph{width:80px;height:80px;display:flex;align-items:center;justify-content:center;background:var(--off);color:var(--ink3);font-size:1.1rem;}
.list-body{padding:.55rem .75rem;display:flex;flex-direction:column;gap:.15rem;min-width:0;}
.list-top{display:flex;align-items:center;gap:.4rem;font-size:.76rem;}
.list-author{font-weight:500;}
.list-handle{color:var(--ink3);font-size:.7rem;}
.list-date{color:var(--ink3);font-family:'DM Mono',monospace;font-size:.6rem;margin-left:auto;white-space:nowrap;}
.list-content{font-size:.76rem;color:var(--ink2);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.list-bottom{display:flex;align-items:center;gap:.25rem;flex-wrap:wrap;margin-top:.2rem;}

/* GROUP HEADER */
.group-header{font-family:'DM Mono',monospace;font-size:.6rem;letter-spacing:.15em;text-transform:uppercase;color:var(--ink3);padding:.4rem 0 .25rem;border-bottom:1px solid var(--line);margin-bottom:.5rem;margin-top:.9rem;}
.group-header:first-child{margin-top:0;}

/* â”€â”€â”€ ADD TAB â”€â”€â”€ */
.add-wrap{max-width:740px;margin:0 auto;padding:1.5rem;}
.add-card{background:var(--white);border:1px solid var(--line);border-radius:8px;padding:1.5rem;}
.type-tabs{display:flex;gap:.4rem;margin-bottom:1.1rem;}
.type-tab{flex:1;padding:.5rem;background:var(--off);border:1.5px solid var(--line);border-radius:20px;color:var(--ink2);font-size:.78rem;cursor:pointer;transition:all .15s;font-family:'Noto Sans JP',sans-serif;text-align:center;}
.type-tab.active{background:var(--ink);border-color:var(--ink);color:#fff;}
.url-row{display:flex;gap:.4rem;margin-bottom:.9rem;}
.url-field{flex:1;background:var(--off);border:1px solid var(--line);border-radius:6px;padding:.5rem .75rem;font-size:.82rem;outline:none;transition:border-color .2s;font-family:'Noto Sans JP',sans-serif;}
.url-field:focus{border-color:var(--ink);}
.fetch-btn{background:var(--ink);border:none;border-radius:6px;color:#fff;padding:.5rem 1rem;font-size:.8rem;cursor:pointer;white-space:nowrap;transition:background .15s;}
.fetch-btn:hover{background:var(--accent);}
.fetch-btn:disabled{opacity:.5;cursor:not-allowed;}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:.65rem;margin-bottom:.65rem;}
.fg-full{grid-column:1/-1;}
.fl{font-size:.7rem;color:var(--ink3);letter-spacing:.05em;margin-bottom:.2rem;display:block;}
.fi{width:100%;background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.42rem .65rem;font-size:.8rem;color:var(--ink);outline:none;transition:border-color .2s;font-family:'Noto Sans JP',sans-serif;}
.fi:focus{border-color:var(--ink);}
.fi::placeholder{color:var(--ink3);}
.fta{width:100%;background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.45rem .65rem;font-size:.8rem;color:var(--ink);outline:none;resize:vertical;min-height:75px;transition:border-color .2s;font-family:'Noto Sans JP',sans-serif;}
.fta:focus{border-color:var(--ink);}
.img-area{border:1.5px dashed var(--line);border-radius:6px;overflow:hidden;cursor:pointer;position:relative;min-height:90px;display:flex;align-items:center;justify-content:center;background:#f8f8f8;}
.img-area input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;}
.img-area-prev{width:100%;max-height:220px;object-fit:contain;display:block;}
.img-area-ph{display:flex;flex-direction:column;align-items:center;gap:.3rem;color:var(--ink3);font-size:.76rem;pointer-events:none;}
.tag-picker{display:flex;flex-wrap:wrap;gap:.3rem;}
.tp-pill{font-size:.72rem;padding:.22rem .62rem;border-radius:12px;cursor:pointer;border:1.5px solid;transition:all .15s;}
.status-bar{font-size:.76rem;color:var(--ink3);background:var(--off);border-left:2px solid var(--accent);padding:.45rem .7rem;border-radius:0 4px 4px 0;margin-bottom:.7rem;display:none;}
.form-actions{display:flex;justify-content:flex-end;gap:.5rem;margin-top:.9rem;padding-top:.9rem;border-top:1px solid var(--line);}
.btn-ghost{background:transparent;border:1px solid var(--line);border-radius:6px;padding:.45rem 1.1rem;font-size:.8rem;cursor:pointer;color:var(--ink2);transition:all .15s;}
.btn-ghost:hover{border-color:var(--ink);color:var(--ink);}
.btn-solid{background:var(--ink);border:none;border-radius:6px;padding:.45rem 1.4rem;font-size:.8rem;color:#fff;cursor:pointer;transition:background .15s;}
.btn-solid:hover{background:var(--accent);}
.flag-row{display:flex;align-items:center;gap:1.25rem;padding:.45rem 0;}
.flag-row label{display:flex;align-items:center;gap:.4rem;font-size:.8rem;cursor:pointer;color:var(--ink2);}

/* â”€â”€â”€ SETTINGS TAB â”€â”€â”€ */
.settings-wrap{max-width:980px;margin:0 auto;padding:1.5rem;}
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;}
.settings-card{background:var(--white);border:1px solid var(--line);border-radius:8px;padding:1.1rem;}
.settings-title{font-family:'DM Mono',monospace;font-size:.62rem;letter-spacing:.15em;text-transform:uppercase;color:var(--ink3);margin-bottom:.9rem;padding-bottom:.45rem;border-bottom:1px solid var(--line);}
.tag-mgr-row{display:flex;align-items:center;gap:.35rem;padding:.28rem .4rem;border-radius:4px;transition:background .15s;margin-bottom:1px;}
.tag-mgr-row:hover{background:var(--off);}
.tmr-name{font-size:.78rem;flex:1;color:var(--ink2);}
.tmr-btn{background:transparent;border:none;cursor:pointer;font-size:.78rem;padding:.1rem .28rem;border-radius:3px;color:var(--ink3);transition:all .15s;}
.tmr-btn:hover{color:var(--ink);background:var(--off);}
.tmr-order{display:flex;flex-direction:column;gap:1px;}
.tmr-order button{background:var(--off);border:1px solid var(--line);border-radius:2px;width:18px;height:14px;cursor:pointer;font-size:.55rem;color:var(--ink2);display:flex;align-items:center;justify-content:center;padding:0;}
.add-row{display:flex;gap:.35rem;margin-top:.65rem;}
.add-row input{flex:1;background:var(--off);border:1px solid var(--line);border-radius:4px;color:var(--ink);padding:.38rem .55rem;font-size:.76rem;font-family:'Noto Sans JP',sans-serif;outline:none;}
.add-row input:focus{border-color:var(--ink);}
.add-row button{background:var(--ink);border:none;border-radius:4px;color:#fff;padding:.38rem .75rem;font-size:.76rem;cursor:pointer;}

/* â”€â”€â”€ YOUTUBE PLAYER â”€â”€â”€ */
#homeYtPanel{display:none;background:var(--ink);color:#fff;border-radius:8px;padding:1rem;margin-bottom:1rem;}
.yt-panel-grid{display:grid;grid-template-columns:1fr 240px;gap:1rem;align-items:start;}
.yt-iframe-wrap{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:6px;background:#000;}
#homeYtIframeContainer{position:absolute;inset:0;}
.yt-controls{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.6rem;align-items:center;}
.yt-btn{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:4px;color:#fff;padding:.25rem .6rem;font-size:.72rem;cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:background .15s;}
.yt-btn:hover{background:rgba(255,255,255,.22);}
.yt-btn.green{background:#065f46;border-color:#6ee7b7;color:#d1fae5;}
.yt-queue{max-height:280px;overflow-y:auto;}
.yt-queue-item{display:flex;align-items:center;gap:.45rem;padding:.35rem .4rem;border-radius:4px;cursor:pointer;transition:background .15s;margin-bottom:2px;}
.yt-queue-item:hover{background:rgba(255,255,255,.08);}
.yt-queue-item.active{background:rgba(255,255,255,.15);}
.yt-queue-thumb{width:42px;height:30px;object-fit:cover;border-radius:2px;flex-shrink:0;}
.yt-queue-title{font-size:.7rem;line-height:1.3;opacity:.85;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.yt-info{font-size:.79rem;opacity:.88;margin:.45rem 0;display:flex;align-items:center;gap:.4rem;flex-wrap:wrap;}
.watched-toggle{display:flex;align-items:center;gap:.3rem;font-size:.72rem;opacity:.75;}
.watched-toggle input{accent-color:#6ee7b7;}

/* â”€â”€â”€ MODAL â”€â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.48);z-index:600;display:flex;align-items:center;justify-content:center;padding:1rem;opacity:0;pointer-events:none;transition:opacity .2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--white);border-radius:10px;padding:1.5rem;max-width:620px;width:100%;max-height:92vh;overflow-y:auto;box-shadow:var(--shadow-md);}
.modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.1rem;padding-bottom:.65rem;border-bottom:1px solid var(--line);}
.modal-title{font-family:'Playfair Display',serif;font-size:1.05rem;font-weight:700;}
.modal-close{background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.22rem .6rem;cursor:pointer;font-size:.76rem;color:var(--ink2);}
.modal-close-bottom{width:100%;margin-top:1rem;padding:.5rem;background:var(--off);border:1px solid var(--line);border-radius:6px;cursor:pointer;font-size:.8rem;color:var(--ink2);font-family:'Noto Sans JP',sans-serif;}
.modal-close-bottom:hover{background:var(--ink);color:#fff;border-color:var(--ink);}
.detail-img-wrap{width:100%;background:#f8f8f8;border-radius:4px;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:1rem;max-height:320px;}
.detail-img-wrap img{max-width:100%;max-height:320px;object-fit:contain;}
.yt-embed-wrap{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:6px;margin-bottom:1rem;}
.yt-embed-wrap iframe{position:absolute;inset:0;width:100%;height:100%;}

/* â”€â”€â”€ TOAST / LOADING â”€â”€â”€ */
.toast{position:fixed;bottom:1.5rem;right:1.5rem;background:var(--ink);color:#fff;padding:.55rem 1.2rem;border-radius:6px;font-size:.8rem;z-index:1000;opacity:0;transform:translateY(8px);transition:all .25s;pointer-events:none;}
.toast.show{opacity:1;transform:translateY(0);}
.toast.ok{background:var(--green);}
.toast.err{background:var(--red);}
.ld{display:inline-flex;gap:3px;align-items:center;}
.ld span{width:4px;height:4px;border-radius:50%;background:currentColor;animation:ld .8s ease-in-out infinite;}
.ld span:nth-child(2){animation-delay:.15s;}
.ld span:nth-child(3){animation-delay:.3s;}
@keyframes ld{0%,80%,100%{opacity:.2}40%{opacity:1}}
.empty{text-align:center;padding:4rem 2rem;color:var(--ink3);}
.empty-mark{font-family:'Playfair Display',serif;font-size:3rem;opacity:.18;margin-bottom:1rem;}
.empty h3{font-size:.95rem;font-weight:400;margin-bottom:.4rem;color:var(--ink2);}
.empty p{font-size:.8rem;}

/* â”€â”€â”€ COLOR PICKER â”€â”€â”€ */
.color-swatch{width:16px;height:16px;border-radius:50%;flex-shrink:0;cursor:pointer;border:2px solid rgba(255,255,255,.4);box-shadow:0 0 0 1px rgba(0,0,0,.15);}
input[type=color]{border:none;background:transparent;cursor:pointer;width:22px;height:22px;padding:0;border-radius:50%;}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media(max-width:768px){
  #mobileFilterBar{display:block;}
  .sidebar{display:none;}
  .home-wrap{grid-template-columns:1fr;}
  .main-area{padding:.75rem 1rem;}
  .settings-grid{grid-template-columns:1fr;}
  .yt-panel-grid{grid-template-columns:1fr;}
  .posts-grid{grid-template-columns:1fr;}
  .add-wrap{padding:.75rem 1rem;}
}
@media(min-width:769px){
  #mobileFilterBar{display:none !important;}
  .sidebar{display:block;}
}
</style>
</head>
<body>

<!-- REMINDER BAR -->
<div id="reminderBar">
  <span class="rb-label">ğŸ”” Today</span>
  <span id="rbEmpty" class="rb-empty">æœ¬æ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</span>
  <div id="rbItems" style="display:flex;gap:.4rem;flex-wrap:wrap;flex:1"></div>
</div>

<!-- HEADER -->
<header>
  <div class="hd">
    <div class="logo">XC<em>L</em>IP</div>
    <div class="hd-rule"></div>
    <div class="hd-stats">
      <div class="hd-stat"><div class="n" id="totalCount">0</div><div class="l">Clips</div></div>
      <div class="hd-stat"><div class="n" id="tagCount">0</div><div class="l">Tags</div></div>
    </div>
  </div>
</header>

<!-- TABS -->
<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('home')">ğŸ  Home</button>
  <button class="tab-btn" onclick="switchTab('add')">ï¼‹ Add</button>
  <button class="tab-btn" onclick="switchTab('settings')">âš™ Settings</button>
</div>

<!-- ACTIVE FILTER BADGE BAR -->
<div id="activeBadgeBar"></div>

<!-- MOBILE FILTER BAR -->
<div id="mobileFilterBar">
  <div class="mfb-scroll" id="mfbMain">
    <button class="mfb-pill active" data-f="all" onclick="setFilter('all')">ã™ã¹ã¦</button>
    <button class="mfb-pill fav-pill" data-f="fav" onclick="setFilter('fav')">â­ ãŠæ°—ã«å…¥ã‚Š</button>
    <button class="mfb-pill yt-pill" data-f="yt-watchlater" onclick="setFilter('yt-watchlater')">â–¶ ã‚ã¨ã§è¦‹ã‚‹</button>
    <button class="mfb-pill" data-f="recent" onclick="setFilter('recent')">æœ€è¿‘è¿½åŠ </button>
    <button class="mfb-pill accent" onclick="startHomePlaylist()">â–¶ é€£ç¶šå†ç”Ÿ</button>
    <button class="mfb-pill" onclick="toggleMfbExpand('Tags')">ğŸ· ã‚¿ã‚° â–¾</button>
    <button class="mfb-pill" onclick="toggleMfbExpand('Area')">ğŸ“ ã‚¨ãƒªã‚¢ â–¾</button>
  </div>
  <div class="mfb-expand" id="mfbTags"></div>
  <div class="mfb-expand" id="mfbArea">
    <select class="area-select" id="mCountrySelect" onchange="setCountryFilter(this.value)" style="flex:1;min-width:120px"><option value="">å›½ã‚’é¸æŠ...</option></select>
    <select class="area-select" id="mPrefSelect" onchange="setPrefFilter(this.value)" style="flex:1;min-width:120px;display:none"><option value="">éƒ½é“åºœçœŒ...</option></select>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• HOME TAB â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-pane active" id="tab-home">
  <div class="home-wrap">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sb-section">
        <div class="sb-head">Filter</div>
        <button class="filter-btn active" id="fAll" onclick="setFilter('all')">ã™ã¹ã¦ <span class="fc" id="cAll">0</span></button>
        <button class="filter-btn fav-btn" id="fFav" onclick="setFilter('fav')">â­ ãŠæ°—ã«å…¥ã‚Š <span class="fc" id="cFav">0</span></button>
        <button class="filter-btn yt-btn" id="fYtWl" onclick="setFilter('yt-watchlater')">â–¶ ã‚ã¨ã§è¦‹ã‚‹ï¼ˆæœªè¦–è´ï¼‰ <span class="fc" id="cYtWl">0</span></button>
        <button class="filter-btn" id="fRecent" onclick="setFilter('recent')">æœ€è¿‘è¿½åŠ  <span class="fc" id="cRec">0</span></button>
      </div>

      <div class="sb-section">
        <div class="sb-head">ğŸ“ ã‚¨ãƒªã‚¢</div>
        <select class="area-select" id="countrySelect" onchange="setCountryFilter(this.value)"><option value="">å›½ã‚’é¸æŠ...</option></select>
        <select class="area-select" id="prefSelect" onchange="setPrefFilter(this.value)" style="display:none"><option value="">éƒ½é“åºœçœŒã‚’é¸æŠ...</option></select>
      </div>

      <div class="sb-section">
        <div class="sb-head">Tags</div>
        <div id="sideTagList"></div>
      </div>

      <div class="sb-section">
        <div class="sb-head">â–¶ YouTube</div>
        <label class="watched-toggle" style="color:var(--ink2);font-size:.76rem;display:flex;align-items:center;gap:.4rem;cursor:pointer;padding:.2rem 0">
          <input type="checkbox" id="includeWatched" onchange="renderHome()"> è¦–è´æ¸ˆã¿ã‚‚å«ã‚ã‚‹
        </label>
        <button class="sb-play-btn" onclick="startHomePlaylist()">â–¶ é€£ç¶šå†ç”Ÿ</button>
      </div>
    </aside>

    <!-- MAIN -->
    <div class="main-area">
      <div id="contentAnchor"></div>

      <!-- YouTube Player Panel -->
      <div id="homeYtPanel">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.65rem">
          <span style="font-family:'DM Mono',monospace;font-size:.6rem;letter-spacing:.1em;opacity:.5">â–¶ NOW PLAYING</span>
          <button class="yt-btn" onclick="closeHomePlayer()">âœ• é–‰ã˜ã‚‹</button>
        </div>
        <div class="yt-panel-grid">
          <div>
            <div class="yt-iframe-wrap"><div id="homeYtIframeContainer"></div></div>
            <div class="yt-info" id="homeYtPlayInfo"></div>
            <div class="yt-controls">
              <button class="yt-btn" onclick="ytPrev()">â—€ å‰ã¸</button>
              <button class="yt-btn" onclick="ytNext()">æ¬¡ã¸ â–¶</button>
              <button class="yt-btn green" onclick="markWatched()" style="margin-left:auto">âœ… è¦–è´æ¸ˆã¿</button>
              <label class="watched-toggle" style="margin-left:.5rem"><input type="checkbox" id="plIncludeWatched" onchange="renderYtQueue()"> è¦–è´æ¸ˆã¿ã‚‚è¡¨ç¤º</label>
            </div>
          </div>
          <div>
            <div style="font-family:'DM Mono',monospace;font-size:.6rem;opacity:.4;margin-bottom:.35rem">QUEUE</div>
            <div class="yt-queue" id="homeYtQueue"></div>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <div class="search-wrap">
          <span class="search-ico">ğŸ”</span>
          <input class="search-fi" id="searchIn" placeholder="æ¤œç´¢..." oninput="renderHome()">
        </div>
        <div class="mode-toggle">
          <button class="mode-btn active" id="modeA" onclick="setMode('A')">A: ã‚¸ãƒ£ãƒ³ãƒ«</button>
          <button class="mode-btn" id="modeB" onclick="setMode('B')">B: ã‚¨ãƒªã‚¢</button>
        </div>
        <div class="view-toggle">
          <button class="vt-btn active" id="vGrid" onclick="setView('grid')" title="ã‚°ãƒªãƒƒãƒ‰">âŠ</button>
          <button class="vt-btn" id="vList" onclick="setView('list')" title="ãƒªã‚¹ãƒˆ">â˜°</button>
          <button class="vt-btn" id="vMap" onclick="setView('map')" title="ãƒãƒƒãƒ—">ğŸ—º</button>
        </div>
        <button class="c-btn" onclick="locateMe()" title="ç¾åœ¨åœ°" style="white-space:nowrap">ğŸ“ ç¾åœ¨åœ°</button>
      </div>
      <div class="result-info" id="resultInfo"></div>
      <div id="mapWrap" style="display:none;height:460px;border-radius:6px;border:1px solid var(--line);overflow:hidden;margin-bottom:1rem"></div>
      <div id="postsWrap"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• ADD TAB â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-pane" id="tab-add">
  <div class="add-wrap">
    <div class="add-card">
      <div class="type-tabs">
        <button class="type-tab active" id="typeX" onclick="setType('x')">ğ• ãƒã‚¹ãƒˆ</button>
        <button class="type-tab" id="typeWeb" onclick="setType('web')">ğŸŒ Webè¨˜äº‹</button>
        <button class="type-tab" id="typeYt" onclick="setType('youtube')">â–¶ YouTube</button>
        <button class="type-tab" id="typeMemo" onclick="setType('memo')">ğŸ“ ãƒ¡ãƒ¢</button>
      </div>
      <div id="urlRow" class="url-row">
        <input class="url-field" id="urlIn" placeholder="URLã‚’è²¼ã‚Šä»˜ã‘...">
        <button class="fetch-btn" id="fetchBtn" onclick="fetchFromUrl()">æƒ…å ±å–å¾—</button>
      </div>
      <div class="status-bar" id="statusBar"></div>
      <div class="fg">
        <div id="xFields" style="display:contents">
          <div><label class="fl">æŠ•ç¨¿è€…å</label><input class="fi" id="fAuthor" placeholder="Taro Yamada"></div>
          <div><label class="fl">ãƒãƒ³ãƒ‰ãƒ«</label><input class="fi" id="fHandle" placeholder="@handle"></div>
        </div>
        <div id="webFields" style="display:none;grid-column:1/-1">
          <div class="fg" style="margin:0">
            <div class="fg-full"><label class="fl">è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«</label><input class="fi" id="fTitle" placeholder="è‡ªå‹•å–å¾—ã¾ãŸã¯æ‰‹å‹•å…¥åŠ›"></div>
            <div><label class="fl">ã‚µã‚¤ãƒˆå</label><input class="fi" id="fSite"></div>
            <div><label class="fl">è‘—è€…</label><input class="fi" id="fAuthorWeb"></div>
          </div>
        </div>
        <div id="ytFields" style="display:none;grid-column:1/-1">
          <div class="fg" style="margin:0">
            <div class="fg-full"><label class="fl">å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«</label><input class="fi" id="fYtTitle"></div>
            <div><label class="fl">ãƒãƒ£ãƒ³ãƒãƒ«å</label><input class="fi" id="fYtChannel"></div>
          </div>
        </div>
        <div class="fg-full"><label class="fl">æœ¬æ–‡ãƒ»å†…å®¹</label><textarea class="fta" id="fContent" placeholder="å†…å®¹..."></textarea></div>
        <div class="fg-full" id="summaryField" style="display:none"><label class="fl">âœ¨ AIè¦ç´„</label><textarea class="fta" id="fSummary" style="min-height:55px"></textarea></div>
        <div class="fg-full"><label class="fl">ãƒ¡ãƒ¢ï¼ˆURLã‚‚å¯ï¼‰</label><input class="fi" id="fMemo" placeholder="ãƒ¡ãƒ¢ã‚„å‚è€ƒURL..."></div>
        <div class="fg-full">
          <label class="fl">ç”»åƒ</label>
          <input class="fi" id="fImgUrl" placeholder="https://... ã¾ãŸã¯ä¸‹ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ" oninput="prevImgUrl()" style="margin-bottom:.4rem">
          <div class="img-area" id="imgArea">
            <input type="file" accept="image/*" onchange="handleFile(event)">
            <div class="img-area-ph" id="imgPh"><span style="font-size:1.4rem">ğŸ“·</span><span>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠ</span></div>
            <img class="img-area-prev" id="imgPrev" style="display:none">
          </div>
        </div>
        <div class="fg-full">
          <label class="fl">ğŸ· ã‚¿ã‚°</label>
          <div class="tag-picker" id="formPicker"></div>
        </div>
        <div class="fg-full">
          <label class="fl">ğŸ“ ã‚¨ãƒªã‚¢ï¼ˆä»»æ„ï¼‰</label>
          <div class="fg" style="margin:0">
            <div><label class="fl">å›½</label><input class="fi" id="fCountry" placeholder="æ—¥æœ¬..."></div>
            <div><label class="fl">éƒ½é“åºœçœŒ</label><input class="fi" id="fPrefecture" placeholder="æ±äº¬éƒ½..."></div>
            <div class="fg-full">
              <label class="fl">è©³ç´°ãªå ´æ‰€</label>
              <div style="display:flex;gap:.35rem">
                <input class="fi" id="fArea" placeholder="æ¸‹è°·, æ¢…ç”°..." style="flex:1">
                <button class="btn-ghost" onclick="geocodeArea('f')" style="font-size:.7rem;white-space:nowrap">ä½ç½®å–å¾—</button>
              </div>
              <div id="fAreaStatus" style="font-size:.68rem;color:var(--ink3);margin-top:.2rem"></div>
            </div>
          </div>
          <input type="hidden" id="fLat"><input type="hidden" id="fLng">
        </div>
        <div class="fg-full" style="background:var(--yellow-bg);border-radius:6px;padding:.75rem">
          <label class="fl" style="color:#92400e">ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼ˆä»»æ„ï¼‰</label>
          <div style="display:flex;gap:.4rem">
            <input type="date" class="fi" id="fRemindDate" style="flex:1">
            <input class="fi" id="fRemindMsg" placeholder="ãƒ¡ãƒ¢..." style="flex:2">
          </div>
        </div>
        <div class="fg-full">
          <div class="flag-row">
            <label><input type="checkbox" id="fFavorite" style="accent-color:var(--yellow)"> â­ ãŠæ°—ã«å…¥ã‚Š</label>
            <label id="watchLaterLabel" style="display:none"><input type="checkbox" id="fWatchLater" style="accent-color:var(--blue)"> ğŸ“Œ ã‚ã¨ã§è¦‹ã‚‹</label>
            <label id="ytWatchedLabel" style="display:none"><input type="checkbox" id="fYtWatched" style="accent-color:var(--green)"> âœ… è¦–è´æ¸ˆã¿</label>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn-ghost" onclick="clearForm()">ã‚¯ãƒªã‚¢</button>
        <button class="btn-solid" onclick="savePost()">ä¿å­˜ã™ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• SETTINGS TAB â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-pane" id="tab-settings">
  <div class="settings-wrap">
    <div class="settings-grid">
      <!-- ã‚¿ã‚°ç®¡ç† -->
      <div class="settings-card">
        <div class="settings-title">ã‚¿ã‚°ç®¡ç†ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ä¸å¯ã®å ´åˆâ†‘â†“ã§ä¸¦ã¹æ›¿ãˆï¼‰</div>
        <div id="tagMgrList"></div>
        <div class="add-row" style="margin-top:.65rem">
          <input id="newTagIn" placeholder="æ–°ã—ã„ã‚¿ã‚°..." maxlength="20">
          <input type="color" id="newTagColor" value="#3b82f6" title="è‰²ã‚’é¸æŠ" style="width:36px;padding:2px;border:1px solid var(--line);border-radius:4px;">
          <button onclick="addTag()">è¿½åŠ </button>
        </div>
        <div style="margin-top:.9rem;padding-top:.9rem;border-top:1px solid var(--line)">
          <div style="font-size:.72rem;color:var(--ink3);margin-bottom:.4rem">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿½åŠ </div>
          <select class="area-select" id="parentTagSelect"><option value="">è¦ªã‚¿ã‚°ã‚’é¸æŠ...</option></select>
          <div class="add-row">
            <input id="newSubTagIn" placeholder="ã‚µãƒ–ã‚¿ã‚°å..." maxlength="20">
            <button onclick="addSubTag()">è¿½åŠ </button>
          </div>
        </div>
      </div>

      <!-- ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ -->
      <div class="settings-card">
        <div class="settings-title">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ä¸€è¦§</div>
        <div id="allRemindersList"></div>
      </div>

      <!-- YouTubeé€£ç¶šå†ç”Ÿ -->
      <div class="settings-card">
        <div class="settings-title">YouTube é€£ç¶šå†ç”Ÿè¨­å®š</div>
        <div style="font-size:.78rem;color:var(--ink2);margin-bottom:.65rem">ã‚¿ã‚°ã§çµã‚Šè¾¼ã‚“ã§Homeã‚¿ãƒ–ã§å†ç”Ÿ</div>
        <select class="area-select" id="ytPlayTag"><option value="">ã‚¿ã‚°ã§çµã‚Šè¾¼ã¿ï¼ˆä»»æ„ï¼‰</option></select>
        <button class="btn-solid" onclick="startHomePlaylist();switchTab('home')" style="width:100%;margin-top:.65rem">â–¶ é€£ç¶šå†ç”Ÿã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>

      <!-- çµ±è¨ˆ -->
      <div class="settings-card">
        <div class="settings-title">çµ±è¨ˆ</div>
        <div id="statsWrap" style="font-size:.8rem;line-height:2.1;color:var(--ink2)"></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- Detail -->
<div class="overlay" id="detailModal">
  <div class="modal">
    <div class="modal-head">
      <span class="modal-title">è©³ç´°</span>
      <button class="modal-close" onclick="closeModal('detailModal')">âœ•</button>
    </div>
    <div id="detailBody"></div>
    <button class="modal-close-bottom" onclick="closeModal('detailModal')">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- Edit -->
<div class="overlay" id="editModal">
  <div class="modal">
    <div class="modal-head">
      <span class="modal-title">ç·¨é›†</span>
      <button class="modal-close" onclick="closeModal('editModal')">âœ•</button>
    </div>
    <div class="fg">
      <div><label class="fl">æŠ•ç¨¿è€…å / ã‚¿ã‚¤ãƒˆãƒ«</label><input class="fi" id="eAuthor"></div>
      <div><label class="fl">ãƒãƒ³ãƒ‰ãƒ« / ã‚µã‚¤ãƒˆå</label><input class="fi" id="eHandle"></div>
      <div class="fg-full"><label class="fl">æœ¬æ–‡</label><textarea class="fta" id="eContent"></textarea></div>
      <div class="fg-full"><label class="fl">ãƒ¡ãƒ¢</label><input class="fi" id="eMemo"></div>
      <div class="fg-full">
        <label class="fl">ç”»åƒURL</label>
        <input class="fi" id="eImgUrl" style="margin-bottom:.35rem" oninput="eImgPrev()">
        <div class="img-area" id="eImgArea" style="min-height:70px">
          <input type="file" accept="image/*" onchange="handleEditFile(event)">
          <div class="img-area-ph" id="eImgPh"><span style="font-size:1.2rem">ğŸ“·</span><span>ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¤‰æ›´</span></div>
          <img class="img-area-prev" id="eImgPrevImg" style="display:none">
        </div>
      </div>
      <div><label class="fl">å›½</label><input class="fi" id="eCountry"></div>
      <div><label class="fl">éƒ½é“åºœçœŒ</label><input class="fi" id="ePrefecture"></div>
      <div class="fg-full">
        <label class="fl">è©³ç´°ãªå ´æ‰€</label>
        <div style="display:flex;gap:.35rem">
          <input class="fi" id="eArea" style="flex:1">
          <button class="btn-ghost" onclick="geocodeArea('e')" style="font-size:.7rem;white-space:nowrap">ä½ç½®å–å¾—</button>
        </div>
        <div id="eAreaStatus" style="font-size:.68rem;color:var(--ink3);margin-top:.2rem"></div>
        <input type="hidden" id="eLat"><input type="hidden" id="eLng">
      </div>
      <div class="fg-full" id="eYtFields" style="display:none">
        <div class="flag-row">
          <label><input type="checkbox" id="eYtWatched" style="accent-color:var(--green)"> âœ… è¦–è´æ¸ˆã¿</label>
          <label><input type="checkbox" id="eWatchLater" style="accent-color:var(--blue)"> ğŸ“Œ ã‚ã¨ã§è¦‹ã‚‹</label>
        </div>
      </div>
      <div class="fg-full">
        <div class="flag-row">
          <label><input type="checkbox" id="eFavorite" style="accent-color:var(--yellow)"> â­ ãŠæ°—ã«å…¥ã‚Š</label>
        </div>
      </div>
      <div class="fg-full"><label class="fl">ã‚¿ã‚°</label><div class="tag-picker" id="editPicker"></div></div>
    </div>
    <div class="form-actions">
      <button class="btn-ghost" onclick="closeModal('editModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-solid" onclick="saveEdit()">æ›´æ–°ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- Reminder -->
<div class="overlay" id="reminderModal">
  <div class="modal">
    <div class="modal-head">
      <span class="modal-title">ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</span>
      <button class="modal-close" onclick="closeModal('reminderModal')">âœ•</button>
    </div>
    <div id="reminderPostInfo" style="background:var(--off);border-radius:4px;padding:.7rem .9rem;margin-bottom:.9rem;font-size:.8rem;color:var(--ink2)"></div>
    <div class="fg">
      <div class="fg-full"><label class="fl">ãƒªãƒã‚¤ãƒ³ãƒ‰æ—¥</label><input type="date" class="fi" id="rDate"></div>
      <div class="fg-full"><label class="fl">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><input class="fi" id="rMessage" placeholder="ã‚ã¨ã§èª­ã‚€..."></div>
    </div>
    <div id="existingReminders" style="margin-top:.65rem"></div>
    <div class="form-actions">
      <button class="btn-ghost" onclick="closeModal('reminderModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-solid" onclick="saveReminder()">è¨­å®šã™ã‚‹</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL='https://hpgcymyyugrzblvahkcc.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwZ2N5bXl5dWdyemJsdmFoa2NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MjAxOTEsImV4cCI6MjA4NzM5NjE5MX0.l2C4TWVU-CeMPB3Thz238z5qqeiOsFLhkm-GlOYVL8o';

async function sb(path,method='GET',body=null){
  const h={'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json'};
  if(method==='POST') h['Prefer']='return=representation,resolution=merge-duplicates';
  if(method==='PATCH') h['Prefer']='return=representation';
  const opts={method,headers:h};
  if(body) opts.body=JSON.stringify(body);
  const r=await fetch(SB_URL+'/rest/v1/'+path,opts);
  if(!r.ok){const e=await r.text();throw new Error(e);}
  const t=await r.text(); return t?JSON.parse(t):[];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let posts=[],tags=[],reminders=[];
let curFilter='all',tagFilter=null,viewMode='grid',displayMode='A';
let areaFilter={country:null,prefecture:null};
let fSel=new Set(),eSel=new Set();
let editId=null,reminderPostId=null,currentType='x';
let myLat=null,myLng=null;
let map=null,mapMarkers=[];
let ytPlaylist=[],ytPlayIdx=0;
let ytPlayer=null,ytApiReady=false;
const COLORS=['#3b82f6','#8b5cf6','#e11d48','#d97706','#059669','#0891b2','#65a30d','#9333ea','#ea580c','#6366f1'];
// LocalStorage: ã‚¿ã‚°ä¸¦ã³é †
function loadTagOrder(){return JSON.parse(localStorage.getItem('xclip_tag_order')||'[]');}
function saveTagOrder(ids){localStorage.setItem('xclip_tag_order',JSON.stringify(ids));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  toast('èª­ã¿è¾¼ã¿ä¸­...','');
  try{
    const [rawP,rawT,rawR]=await Promise.all([
      sb('posts?select=*&order=created_at.desc'),
      sb('tags?select=*&order=sort_order.asc,name.asc'),
      sb('reminders?select=*&order=remind_at.asc')
    ]);
    posts=rawP.map(mapPost);
    tags=applyTagOrder(rawT);
    reminders=rawR;
    if(!tags.length){
      const defs=[['å‚è€ƒ','#3b82f6'],['æŠ€è¡“','#8b5cf6'],['ãƒ‡ã‚¶ã‚¤ãƒ³','#e11d48'],['ãƒ‹ãƒ¥ãƒ¼ã‚¹','#d97706'],['ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³','#059669'],['ãŠæ°—ã«å…¥ã‚Š','#f59e0b']];
      for(let i=0;i<defs.length;i++){
        const t={id:'t'+(Date.now()+i),name:defs[i][0],color:defs[i][1],parent_id:null,sort_order:i};
        await sb('tags','POST',t); tags.push(t);
      }
    }
    renderAll(); renderReminderBar(); renderSettings();
    setTimeout(()=>{document.getElementById('toast').className='toast';},600);
    setInterval(renderReminderBar,60000);
    loadYtApi();
  }catch(e){toast('æ¥ç¶šã‚¨ãƒ©ãƒ¼: '+e.message,'err');console.error(e);}
}

function applyTagOrder(rawTags){
  const order=loadTagOrder();
  if(!order.length) return rawTags;
  const map=new Map(rawTags.map(t=>[t.id,t]));
  const sorted=order.map(id=>map.get(id)).filter(Boolean);
  rawTags.forEach(t=>{if(!order.includes(t.id)) sorted.push(t);});
  return sorted;
}

function mapPost(r){
  return{
    id:r.id,url:r.url||'',author:r.author||'',handle:r.handle||'',
    content:r.content||'',memo:r.memo||'',image:r.image||'',
    tags:r.tags||[],createdAt:typeof r.created_at==='number'?r.created_at:new Date(r.created_at).getTime()||0,
    area:r.area||'',country:r.country||'',prefecture:r.prefecture||'',
    lat:r.lat||null,lng:r.lng||null,
    type:r.type||'x',summary:r.summary||'',
    youtube_status:r.youtube_status||'unwatch',
    youtube_priority:r.youtube_priority||false,
    is_favorite:r.is_favorite||false,
    watch_later:r.watch_later||false,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab){
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  ['home','add','settings'].forEach((t,i)=>{
    if(t===tab) document.querySelectorAll('.tab-btn')[i].classList.add('active');
  });
  if(tab==='home') renderHome();
  if(tab==='settings') renderSettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){renderSide();renderPickers();renderHome();updateStats();renderMobileFilterBar();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSide(){
  const parentTags=tags.filter(t=>!t.parent_id);
  const childTags=tags.filter(t=>t.parent_id);
  let html='';
  parentTags.forEach(pt=>{
    const children=childTags.filter(c=>c.parent_id===pt.id);
    const cnt=posts.filter(p=>p.tags&&p.tags.includes(pt.id)).length;
    html+=`<div class="tag-tree-parent">
      <div class="tag-row${tagFilter===pt.id?' active':''}" onclick="toggleTagFilter('${pt.id}')">
        <div class="t-dot" style="background:${pt.color}"></div>
        <span>${esc(pt.name)}</span><span class="t-cnt">${cnt}</span>
      </div>`;
    if(children.length){
      html+=`<div class="tag-child-wrap">`;
      children.forEach(ct=>{
        const cc=posts.filter(p=>p.tags&&p.tags.includes(ct.id)).length;
        html+=`<div class="tag-row${tagFilter===ct.id?' active':''}" onclick="toggleTagFilter('${ct.id}')">
          <div class="t-dot" style="background:${ct.color}"></div>
          <span>${esc(ct.name)}</span><span class="t-cnt">${cc}</span>
        </div>`;
      });
      html+=`</div>`;
    }
    html+=`</div>`;
  });
  document.getElementById('sideTagList').innerHTML=html;
  renderAreaFilter();
}

function renderAreaFilter(){
  const countries=[...new Set(posts.map(p=>p.country).filter(Boolean))].sort();
  ['countrySelect','mCountrySelect'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    const cur=areaFilter.country||'';
    el.innerHTML='<option value="">å›½ã‚’é¸æŠ...</option>'+countries.map(c=>`<option value="${esc(c)}"${cur===c?' selected':''}>${esc(c)}</option>`).join('');
  });
  ['prefSelect','mPrefSelect'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    if(areaFilter.country){
      const prefs=[...new Set(posts.filter(p=>p.country===areaFilter.country).map(p=>p.prefecture).filter(Boolean))].sort();
      if(prefs.length){
        el.style.display='block';
        el.innerHTML='<option value="">éƒ½é“åºœçœŒã‚’é¸æŠ...</option>'+prefs.map(pr=>`<option value="${esc(pr)}"${areaFilter.prefecture===pr?' selected':''}>${esc(pr)}</option>`).join('');
      } else el.style.display='none';
    } else {el.style.display='none'; el.value='';}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE FILTER BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMobileFilterBar(){
  const parentTags=tags.filter(t=>!t.parent_id);
  const childTags=tags.filter(t=>t.parent_id);
  let html='';
  parentTags.forEach(pt=>{
    const children=childTags.filter(c=>c.parent_id===pt.id);
    const active=tagFilter===pt.id;
    html+=`<button class="mfb-ep${active?' active':''}" style="${active?'':'border-color:'+pt.color+';color:'+pt.color}" onclick="mfbTag('${pt.id}')">${esc(pt.name)}</button>`;
    children.forEach(ct=>{
      const ca=tagFilter===ct.id;
      html+=`<button class="mfb-ep${ca?' active':''}" style="${ca?'':'border-color:'+ct.color+';color:'+ct.color}" onclick="mfbTag('${ct.id}')">â”” ${esc(ct.name)}</button>`;
    });
  });
  const mfbTags=document.getElementById('mfbTags');
  if(mfbTags) mfbTags.innerHTML=html;
  // ãƒ”ãƒ«ã®activeåŒæœŸ
  document.querySelectorAll('#mfbMain .mfb-pill[data-f]').forEach(el=>el.classList.toggle('active',el.dataset.f===curFilter));
  renderAreaFilter();
}

function mfbTag(id){tagFilter=tagFilter===id?null:id;renderSide();renderMobileFilterBar();renderHome();scrollToContent();document.querySelectorAll('.mfb-expand').forEach(e=>e.classList.remove('open'));}
function toggleMfbExpand(name){const el=document.getElementById('mfb'+name);if(!el)return;const open=el.classList.contains('open');document.querySelectorAll('.mfb-expand').forEach(e=>e.classList.remove('open'));if(!open)el.classList.add('open');}
function scrollToContent(){const a=document.getElementById('contentAnchor');if(a)a.scrollIntoView({behavior:'smooth',block:'start'});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIVE BADGE BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBadgeBar(){
  const bar=document.getElementById('activeBadgeBar');
  const badges=[];
  const filterLabels={all:null,fav:'â­ ãŠæ°—ã«å…¥ã‚Š','yt-watchlater':'â–¶ ã‚ã¨ã§è¦‹ã‚‹ï¼ˆæœªè¦–è´ï¼‰',recent:'æœ€è¿‘è¿½åŠ '};
  if(curFilter&&curFilter!=='all'&&filterLabels[curFilter]){
    badges.push(`<span class="a-badge">${filterLabels[curFilter]}<button class="a-badge-clear" onclick="setFilter('all')">âœ•</button></span>`);
  }
  if(tagFilter){
    const t=tags.find(t=>t.id===tagFilter);
    if(t) badges.push(`<span class="a-badge" style="background:${t.color}">${esc(t.name)}<button class="a-badge-clear" onclick="toggleTagFilter('${t.id}')">âœ•</button></span>`);
  }
  if(areaFilter.country){
    badges.push(`<span class="a-badge">${esc(areaFilter.country)}${areaFilter.prefecture?' â€º '+esc(areaFilter.prefecture):''}<button class="a-badge-clear" onclick="clearAreaFilter()">âœ•</button></span>`);
  }
  if(badges.length){bar.innerHTML=badges.join('');bar.classList.add('show');}
  else{bar.innerHTML='';bar.classList.remove('show');}
}

function clearAreaFilter(){areaFilter={country:null,prefecture:null};renderAreaFilter();renderMobileFilterBar();renderHome();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER & SORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFiltered(){
  const s=document.getElementById('searchIn')?.value.toLowerCase()||'';
  const now=Date.now(),wk=7*864e5;
  let result=posts.filter(p=>{
    if(s&&![p.author,p.handle,p.content,p.memo].join(' ').toLowerCase().includes(s)) return false;
    if(tagFilter&&!(p.tags&&p.tags.includes(tagFilter))) return false;
    if(curFilter==='fav'&&!p.is_favorite) return false;
    if(curFilter==='yt-watchlater'&&!(p.type==='youtube'&&p.watch_later&&p.youtube_status!=='watched')) return false;
    if(curFilter==='recent'&&now-p.createdAt>wk) return false;
    if(areaFilter.country&&p.country!==areaFilter.country) return false;
    if(areaFilter.prefecture&&p.prefecture!==areaFilter.prefecture) return false;
    if(displayMode==='B'&&!p.area&&!p.country) return false;
    return true;
  });

  // ã‚½ãƒ¼ãƒˆ: ãŠæ°—ã«å…¥ã‚Š > ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼æ—¥ï¼ˆè¿‘ï¼‰> ç™»éŒ²æ—¥ï¼ˆæ–°ï¼‰
  const todayMs=Date.now();
  const remindMap=new Map();
  reminders.filter(r=>!r.done).forEach(r=>{
    if(!remindMap.has(r.post_id)||r.remind_at<remindMap.get(r.post_id)) remindMap.set(r.post_id,r.remind_at);
  });

  result.sort((a,b)=>{
    // ãŠæ°—ã«å…¥ã‚Šå„ªå…ˆ
    if(a.is_favorite!==b.is_favorite) return a.is_favorite?-1:1;
    // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¿‘ã„é †
    const ra=remindMap.get(a.id)??Infinity, rb=remindMap.get(b.id)??Infinity;
    if(ra!==rb) return ra-rb;
    // ç™»éŒ²æ—¥æ–°ã—ã„é †
    return b.createdAt-a.createdAt;
  });

  // ç¾åœ¨åœ°ã‚½ãƒ¼ãƒˆã¯ is_favorite ä»¥å¤–ã®éƒ¨åˆ†ã«é©ç”¨
  if(myLat!==null){
    result=result.map(p=>{
      let dist=Infinity;
      if(p.lat&&p.lng) dist=haversine(myLat,myLng,p.lat,p.lng);
      return{...p,_dist:dist};
    });
    // ãŠæ°—ã«å…¥ã‚Šã‚°ãƒ«ãƒ¼ãƒ—å†…ã§ã‚‚è·é›¢ã‚½ãƒ¼ãƒˆ
    result.sort((a,b)=>{
      if(a.is_favorite!==b.is_favorite) return a.is_favorite?-1:1;
      return a._dist-b._dist;
    });
  }
  return result;
}

function haversine(la1,lo1,la2,lo2){
  const R=6371,dLat=(la2-la1)*Math.PI/180,dLon=(lo2-lo1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function locateMe(){
  if(!navigator.geolocation){toast('ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“','err');return;}
  navigator.geolocation.getCurrentPosition(pos=>{myLat=pos.coords.latitude;myLng=pos.coords.longitude;toast('ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸ','ok');renderHome();},()=>toast('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ','err'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER SETTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFilter(f){
  curFilter=f; tagFilter=null;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  const map={all:'fAll',fav:'fFav','yt-watchlater':'fYtWl',recent:'fRecent'};
  document.getElementById(map[f]||'fAll')?.classList.add('active');
  document.querySelectorAll('#mfbMain .mfb-pill[data-f]').forEach(el=>el.classList.toggle('active',el.dataset.f===f));
  renderBadgeBar(); renderHome(); scrollToContent();
}
function setCountryFilter(v){areaFilter.country=v||null;areaFilter.prefecture=null;renderAreaFilter();renderBadgeBar();renderHome();scrollToContent();}
function setPrefFilter(v){areaFilter.prefecture=v||null;renderBadgeBar();renderHome();scrollToContent();}
function toggleTagFilter(id){tagFilter=tagFilter===id?null:id;renderSide();renderMobileFilterBar();renderBadgeBar();renderHome();scrollToContent();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHome(){
  if(viewMode==='map'){renderMap();return;}
  document.getElementById('mapWrap').style.display='none';
  document.getElementById('postsWrap').style.display='block';
  const filtered=getFiltered();
  document.getElementById('resultInfo').textContent=filtered.length+' clips'+(myLat?' (ç¾åœ¨åœ°å„ªå…ˆ)':'');
  const wrap=document.getElementById('postsWrap');
  if(!filtered.length){wrap.innerHTML=`<div class="empty"><div class="empty-mark">â€”</div><h3>ã‚¯ãƒªãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</h3><p>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å¤‰æ›´ã™ã‚‹ã‹ã€ŒAddã€ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„</p></div>`;return;}
  if(displayMode==='A') renderGrouped(filtered,wrap,'tag');
  else renderGrouped(filtered,wrap,'area');
}

function renderGrouped(filtered,wrap,groupBy){
  const ungrouped=groupBy==='tag'?'ã‚¿ã‚°ãªã—':'ã‚¨ãƒªã‚¢ãªã—';
  const groups={};
  if(groupBy==='tag'){
    const parentTags=tags.filter(t=>!t.parent_id);
    filtered.forEach(p=>{
      const ptags=(p.tags||[]).map(id=>tags.find(t=>t.id===id)).filter(t=>t&&!t.parent_id);
      if(ptags.length) ptags.forEach(pt=>{(groups[pt.name]=groups[pt.name]||[]).push(p);});
      else (groups[ungrouped]=groups[ungrouped]||[]).push(p);
    });
  } else {
    filtered.forEach(p=>{
      const key=[p.country,p.prefecture].filter(Boolean).join(' â€º ')||ungrouped;
      (groups[key]=groups[key]||[]).push(p);
    });
  }
  const sortedKeys=Object.keys(groups).sort((a,b)=>a===ungrouped?1:b===ungrouped?-1:a.localeCompare(b,'ja'));
  let html='';
  sortedKeys.forEach(k=>{
    html+=`<div class="group-header">${esc(k)} <span style="opacity:.4">(${groups[k].length})</span></div>`;
    if(viewMode==='grid') html+=`<div class="posts-grid" style="margin-bottom:.9rem">${groups[k].map(cardHTML).join('')}</div>`;
    else html+=`<div class="posts-list" style="margin-bottom:.9rem">${groups[k].map(rowHTML).join('')}</div>`;
  });
  wrap.innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARD / ROW HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function typeBadge(type){
  const label={x:'ğ•',web:'WEB',youtube:'â–¶',memo:'MEMO'};
  const bg={x:'#111',web:'#0369a1',youtube:'#dc2626',memo:'#166534'};
  const fg={x:'#fff',web:'#e0f2fe',youtube:'#fee2e2',memo:'#f0fdf4'};
  return `<span class="type-badge" style="background:${bg[type]||'#111'};color:${fg[type]||'#fff'}">${label[type]||type}</span>`;
}

function cardHTML(p){
  const d=p.createdAt?new Date(p.createdAt).toLocaleDateString('ja-JP',{month:'short',day:'numeric'}):'';
  const tagS=(p.tags||[]).map(id=>{const t=tags.find(t=>t.id===id);return t?`<span class="c-tag" style="background:${t.color}1a;color:${t.color}">${esc(t.name)}</span>`:''}).join('');
  const areaStr=[p.country,p.prefecture,p.area].filter(Boolean).join(' â€º ');
  const distBadge=p._dist&&p._dist<Infinity?`<span class="c-dist">${p._dist<1?Math.round(p._dist*1000)+'m':p._dist.toFixed(1)+'km'}</span>`:'';
  const ytThumb=p.type==='youtube'&&p.url?`https://img.youtube.com/vi/${getYtId(p.url)}/mqdefault.jpg`:'';
  const imgSrc=p.image||ytThumb;
  const favFlag=p.is_favorite?`<span class="flag-fav">â­</span>`:'';
  const wlFlag=p.watch_later?`<span class="flag-wl">ğŸ“Œ</span>`:'';
  const ytStatusBadge=p.type==='youtube'?`<span class="yt-status-badge ${p.youtube_status}">${p.youtube_status==='watched'?'âœ… è¦–è´æ¸ˆ':'â–¶ æœªè¦–è´'}</span>`:'';
  const reminderEl=reminders.filter(r=>r.post_id===p.id&&!r.done).length?`<span style="font-size:.65rem;color:var(--yellow);background:#fff8e1;padding:1px 6px;border-radius:10px">ğŸ””</span>`:'';
  return `<div class="card">
    ${favFlag}
    ${imgSrc?`<div class="card-img-wrap"><img src="${esc(imgSrc)}" onerror="this.parentElement.style.display='none'" alt="" loading="lazy"></div>`:''}
    <div class="card-body">
      <div class="card-meta">
        <div class="c-avatar">${(p.author||'?').charAt(0).toUpperCase()}</div>
        <div><div class="c-author">${typeBadge(p.type)}${esc(p.author)}</div><div class="c-handle">${esc(p.handle)}</div></div>
        <div class="c-date">${d}</div>
      </div>
      ${ytStatusBadge?`<div style="margin-bottom:.35rem">${ytStatusBadge}${wlFlag}</div>`:''}
      ${p.content?`<div class="c-content">${esc(p.content.slice(0,120))}</div>`:''}
      ${p.summary?`<div class="c-summary">âœ¨ ${esc(p.summary.slice(0,80))}${p.summary.length>80?'â€¦':''}</div>`:''}
      ${areaStr?`<div class="c-area">ğŸ“ ${esc(areaStr)}${distBadge}</div>`:''}
      ${p.memo?`<div class="c-memo-row">${memoHTML(p.memo.slice(0,60))}</div>`:''}
      ${tagS?`<div class="c-tags">${tagS}</div>`:''}
      <div class="c-footer">
        <button class="c-btn" onclick="openDetail('${p.id}')">è©³ç´°</button>
        <button class="c-btn" onclick="openReminderModal('${p.id}')" title="ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼">ğŸ””${reminderEl}</button>
        ${p.type==='youtube'?`<button class="c-btn" onclick="playYt('${p.id}')">â–¶</button>`:''}
        ${p.url?`<a class="c-link" href="${esc(p.url)}" target="_blank" rel="noopener">â†—</a>`:''}
        <div style="margin-left:auto;display:flex;gap:.25rem">
          <button class="c-btn" onclick="openEdit('${p.id}')">ç·¨é›†</button>
          <button class="c-btn del" onclick="delPost('${p.id}')">å‰Šé™¤</button>
        </div>
      </div>
    </div>
  </div>`;
}

function rowHTML(p){
  const d=p.createdAt?new Date(p.createdAt).toLocaleDateString('ja-JP',{month:'short',day:'numeric'}):'';
  const tagS=(p.tags||[]).map(id=>{const t=tags.find(t=>t.id===id);return t?`<span class="c-tag" style="background:${t.color}1a;color:${t.color}">${esc(t.name)}</span>`:''}).join('');
  const ytThumb=p.type==='youtube'&&p.url?`https://img.youtube.com/vi/${getYtId(p.url)}/mqdefault.jpg`:'';
  const imgSrc=p.image||ytThumb;
  const favFlag=p.is_favorite?'â­ ':p.watch_later?'ğŸ“Œ ':'';
  return `<div class="list-row">
    ${imgSrc
      ?`<div class="list-thumb"><img src="${esc(imgSrc)}" onerror="this.parentElement.innerHTML='<div class=list-thumb-ph>â€”</div>'" alt="" loading="lazy"></div>`
      :`<div class="list-thumb-ph">${p.type==='youtube'?'â–¶':'â€”'}</div>`}
    <div class="list-body">
      <div class="list-top"><span class="list-author">${favFlag}${typeBadge(p.type)}${esc(p.author)}</span><span class="list-handle">${esc(p.handle)}</span><span class="list-date">${d}</span></div>
      ${p.content?`<div class="list-content">${esc(p.content.slice(0,100))}</div>`:''}
      <div class="list-bottom">${tagS}<button class="c-btn" onclick="openDetail('${p.id}')" style="font-size:.66rem">è©³ç´°</button><button class="c-btn" onclick="openEdit('${p.id}')" style="font-size:.66rem">ç·¨é›†</button><button class="c-btn del" onclick="delPost('${p.id}')" style="font-size:.66rem">å‰Šé™¤</button></div>
    </div>
  </div>`;
}

function memoHTML(m){return esc(m).replace(/https?:\/\/[^\s]+/g,u=>`<a href="${u}" target="_blank" rel="noopener" style="color:var(--blue)">${u}</a>`);}
function getYtId(url){const m=url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/);return m?m[1]:'';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMap(){
  document.getElementById('mapWrap').style.display='block';
  document.getElementById('postsWrap').style.display='none';
  const initLat=myLat||35.6812,initLng=myLng||139.7671,initZoom=myLat?13:10;
  if(!map){
    map=L.map('mapWrap').setView([initLat,initLng],initZoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
  } else if(myLat) map.setView([myLat,myLng],13);
  mapMarkers.forEach(m=>m.remove()); mapMarkers=[];
  if(myLat){const icon=L.divIcon({className:'',html:'<div style="width:14px;height:14px;border-radius:50%;background:#3b82f6;border:3px solid white;box-shadow:0 0 0 3px rgba(59,130,246,.4)"></div>',iconSize:[14,14],iconAnchor:[7,7]});L.marker([myLat,myLng],{icon}).addTo(map).bindPopup('ğŸ“ ç¾åœ¨åœ°');}
  const filtered=getFiltered().filter(p=>p.lat&&p.lng);
  document.getElementById('resultInfo').textContent=filtered.length?filtered.length+' clips (åœ°å›³)':'åœ°å›³è¡¨ç¤ºã§ãã‚‹æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“';
  const bounds=[];
  filtered.forEach(p=>{
    const popup=`<div style="min-width:160px;font-family:sans-serif"><b>${esc(p.author)}</b><br><span style="font-size:11px;color:#555">${esc((p.content||'').slice(0,60))}</span><br><button onclick="openDetail('${p.id}')" style="margin-top:4px;font-size:11px;padding:2px 8px;background:#111;color:#fff;border:none;border-radius:2px;cursor:pointer">è©³ç´°</button></div>`;
    const m=L.marker([p.lat,p.lng]).addTo(map).bindPopup(popup);
    mapMarkers.push(m); bounds.push([p.lat,p.lng]);
  });
  if(myLat){bounds.push([myLat,myLng]);map.fitBounds(bounds,{padding:[40,40],maxZoom:14});}
  else if(bounds.length) map.fitBounds(bounds,{padding:[40,40]});
  setTimeout(()=>map.invalidateSize(),100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetail(id){
  const p=posts.find(p=>p.id===id); if(!p) return;
  const tagS=(p.tags||[]).map(id=>{const t=tags.find(t=>t.id===id);return t?`<span class="c-tag" style="background:${t.color}1a;color:${t.color};padding:2px 8px;border-radius:10px">${esc(t.name)}</span>`:''}).join(' ');
  const d=p.createdAt?new Date(p.createdAt).toLocaleDateString('ja-JP',{year:'numeric',month:'long',day:'numeric'}):'';
  const areaStr=[p.country,p.prefecture,p.area].filter(Boolean).join(' â€º ');
  const gmapUrl=areaStr?`https://www.google.com/maps/search/${encodeURIComponent(areaStr)}`:'';
  let ytSection='';
  if(p.type==='youtube'&&p.url){const vid=getYtId(p.url);ytSection=`<div class="yt-embed-wrap"><iframe src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe></div>`;}
  const imgSection=(!ytSection&&p.image)?`<div class="detail-img-wrap"><img src="${esc(p.image)}" onerror="this.parentElement.style.display='none'" alt=""></div>`:'';
  document.getElementById('detailBody').innerHTML=`
    ${ytSection}${imgSection}
    <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.9rem">
      <div class="c-avatar">${(p.author||'?').charAt(0).toUpperCase()}</div>
      <div><div class="c-author">${typeBadge(p.type)}${esc(p.author)}${p.is_favorite?' â­':''}</div><div class="c-handle">${esc(p.handle)}</div></div>
      <div class="c-date" style="margin-left:auto">${d}</div>
    </div>
    ${p.type==='youtube'?`<div style="margin-bottom:.65rem"><span class="yt-status-badge ${p.youtube_status}">${p.youtube_status==='watched'?'âœ… è¦–è´æ¸ˆ':'â–¶ æœªè¦–è´'}</span>${p.watch_later?'<span style="margin-left:.4rem;font-size:.76rem">ğŸ“Œ ã‚ã¨ã§è¦‹ã‚‹</span>':''}</div>`:''}
    ${p.content?`<div style="font-size:.85rem;line-height:1.85;color:var(--ink2);margin-bottom:.9rem;white-space:pre-wrap">${esc(p.content)}</div>`:''}
    ${p.summary?`<div class="c-summary" style="margin-bottom:.9rem">âœ¨ ${esc(p.summary)}</div>`:''}
    ${areaStr?`<div style="font-size:.78rem;color:var(--ink3);margin-bottom:.65rem">ğŸ“ ${esc(areaStr)}${gmapUrl?` <a href="${gmapUrl}" target="_blank" rel="noopener" style="color:var(--blue)">Googleãƒãƒƒãƒ— â†—</a>`:''}</div>`:''}
    ${p.memo?`<div class="c-memo-row" style="margin-bottom:.65rem">${memoHTML(p.memo)}</div>`:''}
    ${tagS?`<div class="c-tags" style="margin-bottom:.65rem">${tagS}</div>`:''}
    <div style="display:flex;gap:.4rem;flex-wrap:wrap">
      ${p.url?`<a class="btn-ghost" href="${esc(p.url)}" target="_blank" rel="noopener" style="font-size:.78rem;padding:.32rem .8rem;text-decoration:none">â†— å…ƒãƒªãƒ³ã‚¯</a>`:''}
      ${p.type==='youtube'?`<button class="c-btn" onclick="toggleWatched('${p.id}')">
        ${p.youtube_status==='watched'?'â–¶ æœªè¦–è´ã«æˆ»ã™':'âœ… è¦–è´æ¸ˆã¿ã«ã™ã‚‹'}
      </button>`:''}
      <button class="c-btn" onclick="closeModal('detailModal');openEdit('${p.id}')" style="margin-left:auto">ç·¨é›†</button>
    </div>`;
  openModal('detailModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEdit(id){
  const p=posts.find(p=>p.id===id); if(!p) return;
  editId=id;
  document.getElementById('eAuthor').value=p.author;
  document.getElementById('eHandle').value=p.handle;
  document.getElementById('eContent').value=p.content;
  document.getElementById('eMemo').value=p.memo||'';
  document.getElementById('eImgUrl').value=p.image||'';
  document.getElementById('eCountry').value=p.country||'';
  document.getElementById('ePrefecture').value=p.prefecture||'';
  document.getElementById('eArea').value=p.area||'';
  document.getElementById('eLat').value='';
  document.getElementById('eLng').value='';
  document.getElementById('eAreaStatus').textContent=p.lat?`ç¾åœ¨ã®ä½ç½®: ${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}`:'';
  document.getElementById('eFavorite').checked=p.is_favorite;
  eImgPrev();
  const ytF=document.getElementById('eYtFields');
  if(p.type==='youtube'){
    ytF.style.display='block';
    document.getElementById('eYtWatched').checked=p.youtube_status==='watched';
    document.getElementById('eWatchLater').checked=p.watch_later;
  } else ytF.style.display='none';
  eSel=new Set(p.tags||[]);
  renderPicker('editPicker',eSel);
  openModal('editModal');
}

function eImgPrev(){
  const u=document.getElementById('eImgUrl').value.trim();
  const img=document.getElementById('eImgPrevImg'),ph=document.getElementById('eImgPh');
  if(u){img.src=u;img.style.display='block';ph.style.display='none';}
  else{img.style.display='none';ph.style.display='flex';}
}

function handleEditFile(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{document.getElementById('eImgUrl').value=ev.target.result;eImgPrev();};
  r.readAsDataURL(f);
}

async function saveEdit(){
  const p=posts.find(p=>p.id===editId); if(!p) return;
  p.author=document.getElementById('eAuthor').value.trim()||'ä¸æ˜';
  p.handle=document.getElementById('eHandle').value.trim();
  p.content=document.getElementById('eContent').value.trim();
  p.memo=document.getElementById('eMemo').value.trim();
  p.image=document.getElementById('eImgUrl').value.trim();
  p.country=document.getElementById('eCountry').value.trim();
  p.prefecture=document.getElementById('ePrefecture').value.trim();
  p.area=document.getElementById('eArea').value.trim();
  p.is_favorite=document.getElementById('eFavorite').checked;
  const newLat=parseFloat(document.getElementById('eLat').value);
  const newLng=parseFloat(document.getElementById('eLng').value);
  if(!isNaN(newLat)&&!isNaN(newLng)){p.lat=newLat;p.lng=newLng;}
  p.tags=[...eSel];
  if(p.type==='youtube'){
    p.youtube_status=document.getElementById('eYtWatched').checked?'watched':'unwatch';
    p.watch_later=document.getElementById('eWatchLater').checked;
    // é–²è¦§æ¸ˆã¿ãªã‚‰ watch_later OFF
    if(p.youtube_status==='watched') p.watch_later=false;
  }
  try{
    await sb('posts?id=eq.'+p.id,'PATCH',{
      author:p.author,handle:p.handle,content:p.content,memo:p.memo,
      image:p.image,country:p.country,prefecture:p.prefecture,area:p.area,
      lat:p.lat||null,lng:p.lng||null,tags:p.tags,
      is_favorite:p.is_favorite,watch_later:p.watch_later,
      youtube_status:p.youtube_status,youtube_priority:p.youtube_priority
    });
    closeModal('editModal');renderAll();toast('æ›´æ–°ã—ã¾ã—ãŸ âœ“','ok');
  }catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

async function toggleWatched(id){
  const p=posts.find(p=>p.id===id); if(!p) return;
  const wasWatched=p.youtube_status==='watched';
  p.youtube_status=wasWatched?'unwatch':'watched';
  // è¦–è´æ¸ˆã¿ã«ã—ãŸã‚‰ watch_later=falseã€ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’done=true
  if(!wasWatched){
    p.watch_later=false;
    // é–¢é€£ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’æ¸ˆã¿ã«
    const related=reminders.filter(r=>r.post_id===id&&!r.done);
    for(const r of related){r.done=true;await sb('reminders?id=eq.'+r.id,'PATCH',{done:true}).catch(()=>{});}
  }
  try{
    await sb('posts?id=eq.'+p.id,'PATCH',{youtube_status:p.youtube_status,watch_later:p.watch_later});
    closeModal('detailModal');renderAll();renderReminderBar();toast(p.youtube_status==='watched'?'è¦–è´æ¸ˆã¿ã«ã—ã¾ã—ãŸ':'æœªè¦–è´ã«æˆ»ã—ã¾ã—ãŸ','ok');
  }catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function delPost(id){
  if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  try{await sb('posts?id=eq.'+id,'DELETE');posts=posts.filter(p=>p.id!==id);renderAll();toast('å‰Šé™¤ã—ã¾ã—ãŸ');}
  catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE POST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function savePost(){
  const url=document.getElementById('urlIn')?.value.trim()||'';
  const content=document.getElementById('fContent').value.trim();
  const memo=document.getElementById('fMemo').value.trim();
  if(!content&&!memo&&!url&&currentType!=='memo'){toast('å†…å®¹ãƒ»ãƒ¡ãƒ¢ãƒ»URLã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err');return;}
  const now=Date.now();
  let author='',handle='',summary='';
  if(currentType==='x'){author=document.getElementById('fAuthor').value.trim()||'ä¸æ˜';handle=document.getElementById('fHandle').value.trim();}
  else if(currentType==='web'){const title=document.getElementById('fTitle').value.trim();const site=document.getElementById('fSite').value.trim();author=document.getElementById('fAuthorWeb').value.trim()||title||'Webè¨˜äº‹';handle=site;summary=document.getElementById('fSummary').value.trim();}
  else if(currentType==='youtube'){author=document.getElementById('fYtTitle').value.trim()||'YouTubeå‹•ç”»';handle=document.getElementById('fYtChannel').value.trim();}
  else{author='ãƒ¡ãƒ¢';}

  // ã‚¿ã‚°ï¼šå­ã‚¿ã‚°é¸æŠæ™‚ã¯è¦ªã‚¿ã‚°ã‚‚è‡ªå‹•è¿½åŠ 
  const selectedTags=new Set([...fSel]);
  fSel.forEach(tid=>{
    const t=tags.find(t=>t.id===tid);
    if(t?.parent_id&&!selectedTags.has(t.parent_id)) selectedTags.add(t.parent_id);
  });

  const remindDate=document.getElementById('fRemindDate').value;
  const remindMsg=document.getElementById('fRemindMsg').value.trim();
  const p={
    id:'p'+now,url,created_at:now,
    author,handle,content,memo,
    image:document.getElementById('fImgUrl').value.trim(),
    tags:[...selectedTags],
    area:document.getElementById('fArea').value.trim()||null,
    country:document.getElementById('fCountry').value.trim()||null,
    prefecture:document.getElementById('fPrefecture').value.trim()||null,
    lat:parseFloat(document.getElementById('fLat').value)||null,
    lng:parseFloat(document.getElementById('fLng').value)||null,
    type:currentType,summary:summary||null,
    youtube_status:document.getElementById('fYtWatched')?.checked?'watched':'unwatch',
    youtube_priority:false,
    is_favorite:document.getElementById('fFavorite').checked,
    watch_later:document.getElementById('fWatchLater')?.checked||false,
  };
  try{
    await sb('posts','POST',p);
    posts.unshift(mapPost({...p}));
    if(remindDate){
      const r={id:'r'+now,post_id:p.id,remind_at:new Date(remindDate).getTime(),message:remindMsg,done:false};
      await sb('reminders','POST',r); reminders.push(r);
    }
    clearForm();renderAll();renderReminderBar();toast('ä¿å­˜ã—ã¾ã—ãŸ âœ“','ok');switchTab('home');
  }catch(e){toast('ä¿å­˜ã‚¨ãƒ©ãƒ¼: '+e.message,'err');console.error(e);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH FROM URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchFromUrl(){
  const url=document.getElementById('urlIn').value.trim();
  if(!url){toast('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err');return;}
  const btn=document.getElementById('fetchBtn');
  btn.disabled=true;btn.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  const status=document.getElementById('statusBar');
  status.style.display='block';status.textContent='å–å¾—ä¸­...';
  try{
    if(currentType==='x'){
      const m=url.match(/(?:twitter\.com|x\.com)\/@?([\w]+)\/status\/(\d+)/);
      if(!m){toast('Xã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err');return;}
      document.getElementById('fHandle').value='@'+m[1];
      document.getElementById('fAuthor').value=m[1];
      const r=await fetch(`https://publish.twitter.com/oembed?url=${encodeURIComponent(url)}&omit_script=true`);
      const d=await r.json();
      if(d.html){
        const doc=new DOMParser().parseFromString(d.html,'text/html');
        const txt=doc.querySelector('p')?.textContent||'';
        document.getElementById('fContent').value=txt;
        if(d.author_name) document.getElementById('fAuthor').value=d.author_name;
      }
      status.textContent='âœ“ XæŠ•ç¨¿ã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ';
    } else if(currentType==='youtube'){
      const vid=getYtId(url);
      if(!vid){toast('YouTubeã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err');return;}
      try{
        const r=await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
        const d=await r.json();
        if(d.title) document.getElementById('fYtTitle').value=d.title;
        if(d.author_name) document.getElementById('fYtChannel').value=d.author_name;
        document.getElementById('fImgUrl').value=`https://img.youtube.com/vi/${vid}/mqdefault.jpg`;
        prevImgUrl();
      }catch(e){}
      // YouTube ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œã‚ã¨ã§è¦‹ã‚‹ã€ON
      document.getElementById('fWatchLater').checked=true;
      status.textContent='âœ“ YouTubeå‹•ç”»ã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ';
    } else if(currentType==='web'){
      let html='';
      const proxies=[`https://corsproxy.io/?${encodeURIComponent(url)}`,`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`];
      for(const px of proxies){
        try{const r=await fetch(px,{signal:AbortSignal.timeout(8000)});html=px.includes('allorigins')?(await r.json()).contents||'':await r.text();if(html)break;}catch(e){continue;}
      }
      if(!html) throw new Error('å–å¾—å¤±æ•—');
      const doc=new DOMParser().parseFromString(html,'text/html');
      const get=(sel,attr)=>doc.querySelector(sel)?.getAttribute(attr)||'';
      const title=get('meta[property="og:title"]','content')||get('meta[name="twitter:title"]','content')||doc.querySelector('title')?.textContent||'';
      const desc=get('meta[property="og:description"]','content')||get('meta[name="description"]','content')||'';
      const site=get('meta[property="og:site_name"]','content')||'';
      const img=get('meta[property="og:image"]','content')||get('meta[name="twitter:image"]','content')||'';
      const author=get('meta[name="author"]','content')||'';
      if(title) document.getElementById('fTitle').value=title;
      if(site) document.getElementById('fSite').value=site;
      if(author) document.getElementById('fAuthorWeb').value=author;
      if(desc) document.getElementById('fContent').value=desc;
      if(img){document.getElementById('fImgUrl').value=img;prevImgUrl();}
      status.textContent='âœ“ æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸã€‚è¦ç´„ä¸­...';
      const toSummarize=[title,desc].filter(Boolean).join('\n');
      if(toSummarize){
        try{
          const cr=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:300,messages:[{role:'user',content:`ä»¥ä¸‹ã®è¨˜äº‹ã‚’æ—¥æœ¬èªã§3ã€œ5æ–‡ã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚\n\n${toSummarize}`}]})});
          const cd=await cr.json();
          const sum=cd.content?.[0]?.text||'';
          if(sum){document.getElementById('fSummary').value=sum;status.textContent='âœ“ å–å¾—ãƒ»è¦ç´„ãŒå®Œäº†ã—ã¾ã—ãŸ';}
          else status.textContent='âœ“ æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ';
        }catch(e){status.textContent='âœ“ æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸï¼ˆè¦ç´„ã‚¹ã‚­ãƒƒãƒ—ï¼‰';}
      } else status.textContent='âœ“ æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ';
    }
  }catch(e){status.textContent='âš ï¸ è‡ªå‹•å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„';}
  btn.disabled=false;btn.innerHTML='æƒ…å ±å–å¾—';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORM HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setType(t){
  currentType=t;
  ['x','web','youtube','memo'].forEach(tt=>{
    const el=document.getElementById('type'+tt.charAt(0).toUpperCase()+tt.slice(1));
    if(el) el.classList.toggle('active',tt===t);
  });
  document.getElementById('urlRow').style.display=t==='memo'?'none':'flex';
  document.getElementById('xFields').style.display=t==='x'?'contents':'none';
  document.getElementById('webFields').style.display=t==='web'?'block':'none';
  document.getElementById('ytFields').style.display=t==='youtube'?'block':'none';
  document.getElementById('summaryField').style.display=t==='web'?'block':'none';
  document.getElementById('watchLaterLabel').style.display=t==='youtube'?'inline-flex':'none';
  document.getElementById('ytWatchedLabel').style.display=t==='youtube'?'inline-flex':'none';
  document.getElementById('statusBar').style.display='none';
  const ph={x:'https://x.com/username/status/...',web:'https://example.com/article...',youtube:'https://youtube.com/watch?v=...',memo:''};
  const urlIn=document.getElementById('urlIn');
  if(urlIn) urlIn.placeholder=ph[t]||'';
}

function clearForm(){
  ['urlIn','fAuthor','fHandle','fTitle','fSite','fAuthorWeb','fYtTitle','fYtChannel',
   'fContent','fSummary','fMemo','fImgUrl','fArea','fCountry','fPrefecture','fLat','fLng','fRemindDate','fRemindMsg']
   .forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  ['fFavorite','fWatchLater','fYtWatched'].forEach(id=>{const el=document.getElementById(id);if(el)el.checked=false;});
  document.getElementById('imgPrev').style.display='none';
  document.getElementById('imgPh').style.display='flex';
  document.getElementById('fAreaStatus').textContent='';
  document.getElementById('statusBar').style.display='none';
  fSel.clear();renderPicker('formPicker',fSel);setType('x');
}

function prevImgUrl(){
  const u=document.getElementById('fImgUrl').value.trim();
  const img=document.getElementById('imgPrev'),ph=document.getElementById('imgPh');
  if(u){img.src=u;img.style.display='block';ph.style.display='none';}
  else{img.style.display='none';ph.style.display='flex';}
}

function handleFile(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{document.getElementById('fImgUrl').value=ev.target.result;prevImgUrl();};
  r.readAsDataURL(f);
}

async function geocodeArea(prefix){
  const area=document.getElementById(prefix+'Area').value.trim();
  const country=document.getElementById(prefix+'Country').value.trim();
  const q=[area,country].filter(Boolean).join(', ');
  if(!q){toast('å ´æ‰€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err');return;}
  const statusId=prefix+'AreaStatus';
  document.getElementById(statusId).textContent='æ¤œç´¢ä¸­...';
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=1&addressdetails=1`);
    const d=await r.json();
    if(!d.length){document.getElementById(statusId).textContent='å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ';return;}
    const addr=d[0].address||{};
    document.getElementById(prefix+'Lat').value=d[0].lat;
    document.getElementById(prefix+'Lng').value=d[0].lon;
    if(!document.getElementById(prefix+'Country').value&&addr.country) document.getElementById(prefix+'Country').value=addr.country;
    if(!document.getElementById(prefix+'Prefecture').value){const pref=addr.state||addr.province||addr.region||'';if(pref) document.getElementById(prefix+'Prefecture').value=pref;}
    document.getElementById(statusId).textContent='âœ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ';
  }catch(e){document.getElementById(statusId).textContent='ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAG PICKERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPickers(){renderPicker('formPicker',fSel);renderPicker('editPicker',eSel);}

function renderPicker(id,sel){
  const el=document.getElementById(id);if(!el)return;
  el.innerHTML=tags.map(t=>`<span class="tp-pill" style="border-color:${t.color};color:${t.color};${sel.has(t.id)?'background:'+t.color+'22':''}" onclick="togglePill('${t.id}','${id}',this)">${esc(t.name)}</span>`).join('');
}

function togglePill(id,pickerId,el){
  const sel=pickerId==='formPicker'?fSel:eSel;
  if(sel.has(id)){sel.delete(id);el.style.background='';}
  else{sel.add(id);const t=tags.find(t=>t.id===id);el.style.background=t.color+'22';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAGS CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addTag(){
  const inp=document.getElementById('newTagIn'),name=inp.value.trim();
  const color=document.getElementById('newTagColor').value;
  if(!name)return;
  if(tags.find(t=>t.name===name)){toast('åŒã˜åå‰ã®ã‚¿ã‚°ãŒå­˜åœ¨ã—ã¾ã™','err');return;}
  const t={id:'t'+Date.now(),name,color,parent_id:null,sort_order:tags.filter(t=>!t.parent_id).length};
  try{await sb('tags','POST',t);tags.push(t);inp.value='';saveTagOrder(tags.map(t=>t.id));renderAll();renderSettings();toast('ã‚¿ã‚°è¿½åŠ ','ok');}
  catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

async function addSubTag(){
  const parentId=document.getElementById('parentTagSelect').value;
  const name=document.getElementById('newSubTagIn').value.trim();
  if(!parentId){toast('è¦ªã‚¿ã‚°ã‚’é¸æŠã—ã¦ãã ã•ã„','err');return;}
  if(!name){toast('ã‚¿ã‚°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err');return;}
  if(tags.find(t=>t.name===name)){toast('åŒã˜åå‰ã®ã‚¿ã‚°ãŒå­˜åœ¨ã—ã¾ã™','err');return;}
  const parent=tags.find(t=>t.id===parentId);
  const t={id:'t'+Date.now(),name,color:parent?.color||COLORS[tags.length%COLORS.length],parent_id:parentId,sort_order:tags.length};
  try{await sb('tags','POST',t);tags.push(t);document.getElementById('newSubTagIn').value='';saveTagOrder(tags.map(t=>t.id));renderAll();renderSettings();toast(`ã€Œ${name}ã€ã‚’è¿½åŠ `,'ok');}
  catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

async function delTag(id){
  if(!confirm('ã“ã®ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  try{
    await sb('tags?id=eq.'+id,'DELETE');
    tags=tags.filter(t=>t.id!==id);
    for(const p of posts){if(p.tags?.includes(id)){p.tags=p.tags.filter(x=>x!==id);await sb('posts?id=eq.'+p.id,'PATCH',{tags:p.tags}).catch(()=>{});}}
    if(tagFilter===id)tagFilter=null;
    saveTagOrder(tags.map(t=>t.id));renderAll();renderSettings();toast('ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  }catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

async function renameTag(id){
  const t=tags.find(t=>t.id===id);if(!t)return;
  const name=prompt('æ–°ã—ã„ã‚¿ã‚°å',t.name);if(!name||name.trim()===t.name)return;
  try{await sb('tags?id=eq.'+id,'PATCH',{name:name.trim()});t.name=name.trim();renderAll();renderSettings();toast('ã‚¿ã‚°åã‚’å¤‰æ›´ã—ã¾ã—ãŸ','ok');}
  catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

async function changeTagColor(id,color){
  try{await sb('tags?id=eq.'+id,'PATCH',{color});const t=tags.find(t=>t.id===id);if(t)t.color=color;renderAll();renderSettings();}
  catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

function moveTag(id,dir){
  const idx=tags.indexOf(tags.find(t=>t.id===id));
  if(idx<0)return;
  const newIdx=idx+dir;
  if(newIdx<0||newIdx>=tags.length)return;
  [tags[idx],tags[newIdx]]=[tags[newIdx],tags[idx]];
  saveTagOrder(tags.map(t=>t.id));renderAll();renderSettings();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REMINDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderReminderBar(){
  const today=new Date();today.setHours(0,0,0,0);
  const tomorrow=new Date(today);tomorrow.setDate(tomorrow.getDate()+1);
  const due=reminders.filter(r=>!r.done&&r.remind_at>=today.getTime()&&r.remind_at<tomorrow.getTime());
  const rbEmpty=document.getElementById('rbEmpty');
  const rbItems=document.getElementById('rbItems');
  if(!due.length){rbEmpty.style.display='block';rbItems.innerHTML='';return;}
  rbEmpty.style.display='none';
  rbItems.innerHTML=due.map(r=>{
    const p=posts.find(p=>p.id===r.post_id);
    const label=p?esc(p.author+(r.message?' â€” '+r.message:'')):esc(r.message||'ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼');
    return `<div class="rb-item"><span>${label}</span>${p?`<button class="c-btn" onclick="openDetail('${p.id}')" style="font-size:.65rem;padding:.12rem .4rem">ç¢ºèª</button>`:''}<button class="rb-dismiss" onclick="dismissReminder('${r.id}')">âœ•</button></div>`;
  }).join('');
}

async function dismissReminder(id){
  try{await sb('reminders?id=eq.'+id,'PATCH',{done:true});const r=reminders.find(r=>r.id===id);if(r)r.done=true;renderReminderBar();}
  catch(e){console.error(e);}
}

function openReminderModal(postId){
  reminderPostId=postId;
  const p=posts.find(p=>p.id===postId);
  document.getElementById('reminderPostInfo').textContent=p?`ã€Œ${p.author}ã€: ${(p.content||p.memo||'').slice(0,60)}`:'';
  document.getElementById('rDate').value='';
  document.getElementById('rMessage').value='';
  const existing=reminders.filter(r=>r.post_id===postId&&!r.done);
  document.getElementById('existingReminders').innerHTML=existing.length
    ?`<div style="font-size:.75rem;color:var(--ink3);margin-bottom:.3rem">è¨­å®šæ¸ˆã¿</div>`+existing.map(r=>`<div class="tag-mgr-row"><span style="font-family:'DM Mono',monospace;font-size:.68rem">${new Date(r.remind_at).toLocaleDateString('ja-JP')}</span><span style="font-size:.76rem;flex:1;padding-left:.4rem">${esc(r.message||'')}</span><button class="tmr-btn" onclick="deleteReminder('${r.id}')">âœ•</button></div>`).join(''):'';
  openModal('reminderModal');
}

async function saveReminder(){
  const date=document.getElementById('rDate').value;
  if(!date){toast('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„','err');return;}
  const r={id:'r'+Date.now(),post_id:reminderPostId,remind_at:new Date(date).getTime(),message:document.getElementById('rMessage').value.trim(),done:false};
  try{await sb('reminders','POST',r);reminders.push(r);toast('ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ âœ“','ok');closeModal('reminderModal');renderReminderBar();}
  catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

async function deleteReminder(id){
  try{await sb('reminders?id=eq.'+id,'DELETE');reminders=reminders.filter(r=>r.id!==id);toast('å‰Šé™¤ã—ã¾ã—ãŸ');if(reminderPostId)openReminderModal(reminderPostId);renderReminderBar();}
  catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YOUTUBE PLAYER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadYtApi(){
  const tag=document.createElement('script');tag.src='https://www.youtube.com/iframe_api';document.head.appendChild(tag);
}
window.onYouTubeIframeAPIReady=function(){ytApiReady=true;};

function playYt(id){
  const filtered=getFiltered().filter(p=>p.type==='youtube');
  if(!filtered.length){toast('YouTubeãŒã‚ã‚Šã¾ã›ã‚“','err');return;}
  ytPlaylist=filtered;
  const idx=ytPlaylist.findIndex(p=>p.id===id);
  ytPlayIdx=idx>=0?idx:0;
  openHomePlayer();
}

function startHomePlaylist(){
  const includeWatched=document.getElementById('includeWatched')?.checked||false;
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ¤å®š: yt-watchlater ã‚„ fav ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒ active ãªã‚‰æœªè¦–è´ã®ã¿
  const forceUnwatchedOnly=curFilter==='yt-watchlater'||curFilter==='fav';
  let filtered=getFiltered().filter(p=>p.type==='youtube');
  if(!includeWatched&&(forceUnwatchedOnly||!includeWatched)){
    filtered=filtered.filter(p=>p.youtube_status!=='watched');
  }
  if(!filtered.length){toast('å†ç”Ÿã§ãã‚‹YouTubeãŒã‚ã‚Šã¾ã›ã‚“','err');return;}
  ytPlaylist=filtered;ytPlayIdx=0;
  openHomePlayer();
}

function startPlaylist(){startHomePlaylist();switchTab('home');}

function openHomePlayer(){
  document.getElementById('homeYtPanel').style.display='block';
  document.getElementById('homeYtPanel').scrollIntoView({behavior:'smooth',block:'start'});
  loadHomeYtVideo();renderYtQueue();
}

function closeHomePlayer(){
  document.getElementById('homeYtPanel').style.display='none';
  document.getElementById('homeYtIframeContainer').innerHTML='';
  ytPlayer=null;
}

function loadHomeYtVideo(){
  const p=ytPlaylist[ytPlayIdx];if(!p)return;
  const vid=getYtId(p.url);if(!vid)return;
  if(ytPlayer&&ytPlayer.loadVideoById){ytPlayer.loadVideoById(vid);}
  else if(ytApiReady&&window.YT&&window.YT.Player){
    document.getElementById('homeYtIframeContainer').innerHTML='<div id="ytIframeEl" style="width:100%;height:100%;position:absolute;inset:0"></div>';
    ytPlayer=new YT.Player('ytIframeEl',{videoId:vid,width:'100%',height:'100%',playerVars:{autoplay:1,rel:0},events:{onStateChange(e){if(e.data===YT.PlayerState.ENDED)ytNextAuto();}}});
  } else {
    document.getElementById('homeYtIframeContainer').innerHTML=`<iframe src="https://www.youtube.com/embed/${vid}?autoplay=1&rel=0" style="width:100%;height:100%;position:absolute;inset:0" frameborder="0" allowfullscreen allow="autoplay"></iframe>`;
  }
  updateYtPlayInfo();renderYtQueue();
}

function updateYtPlayInfo(){
  const p=ytPlaylist[ytPlayIdx];if(!p)return;
  const el=document.getElementById('homeYtPlayInfo');
  if(el) el.innerHTML=`<span style="font-family:'DM Mono',monospace;font-size:.62rem;opacity:.5">${ytPlayIdx+1}/${ytPlaylist.length}</span> <span style="font-weight:500">${esc(p.author)}</span>${p.is_favorite?' â­':''}${p.watch_later?' ğŸ“Œ':''}`;
}

function renderYtQueue(){
  const el=document.getElementById('homeYtQueue');if(!el)return;
  const showWatched=document.getElementById('plIncludeWatched')?.checked;
  const list=showWatched?ytPlaylist:ytPlaylist.filter(p=>p.youtube_status!=='watched'||ytPlaylist.indexOf(p)===ytPlayIdx);
  el.innerHTML=ytPlaylist.map((p,i)=>{
    if(!showWatched&&p.youtube_status==='watched'&&i!==ytPlayIdx) return '';
    return `<div class="yt-queue-item${i===ytPlayIdx?' active':''}" onclick="ytJump(${i})">
      <img class="yt-queue-thumb" src="https://img.youtube.com/vi/${getYtId(p.url)}/default.jpg" onerror="this.style.display='none'" alt="">
      <div class="yt-queue-title" style="opacity:${p.youtube_status==='watched'?.4:1}">${esc(p.author)}${p.is_favorite?' â­':''}${p.youtube_status==='watched'?' âœ…':''}</div>
    </div>`;
  }).join('');
}

function ytJump(idx){ytPlayIdx=idx;loadHomeYtVideo();}
function ytPrev(){if(ytPlayIdx>0){ytPlayIdx--;loadHomeYtVideo();}else toast('æœ€åˆã®å‹•ç”»ã§ã™');}
function ytNext(){if(ytPlayIdx<ytPlaylist.length-1){ytPlayIdx++;loadHomeYtVideo();}else{toast('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆçµ‚äº† ğŸ‰','ok');closeHomePlayer();}}

async function ytNextAuto(){
  const p=ytPlaylist[ytPlayIdx];
  if(p&&p.youtube_status!=='watched'){
    p.youtube_status='watched';p.watch_later=false;
    try{await sb('posts?id=eq.'+p.id,'PATCH',{youtube_status:'watched',watch_later:false});}catch(e){}
  }
  let next=ytPlayIdx+1;
  const includeWatched=document.getElementById('plIncludeWatched')?.checked;
  while(!includeWatched&&next<ytPlaylist.length&&ytPlaylist[next].youtube_status==='watched') next++;
  if(next<ytPlaylist.length){ytPlayIdx=next;loadHomeYtVideo();toast(`æ¬¡: ${ytPlaylist[ytPlayIdx].author}`);}
  else{toast('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆçµ‚äº† ğŸ‰','ok');closeHomePlayer();renderAll();}
}

async function markWatched(){
  const p=ytPlaylist[ytPlayIdx];if(!p)return;
  p.youtube_status='watched';p.watch_later=false;
  try{
    await sb('posts?id=eq.'+p.id,'PATCH',{youtube_status:'watched',watch_later:false});
    toast('è¦–è´æ¸ˆã¿ã«ã—ã¾ã—ãŸ âœ“','ok');renderYtQueue();
    await ytNextAuto();
  }catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSettings(){
  const parentTags=tags.filter(t=>!t.parent_id);
  const childTags=tags.filter(t=>t.parent_id);
  let html='';
  tags.forEach((t,i)=>{
    const isParent=!t.parent_id;
    html+=`<div class="tag-mgr-row" style="${isParent?'':'padding-left:1.5rem;background:var(--off);border-radius:3px;margin-bottom:1px'}">
      <div class="tmr-order">
        <button onclick="moveTag('${t.id}',-1)" title="ä¸Šã¸">â–²</button>
        <button onclick="moveTag('${t.id}',1)" title="ä¸‹ã¸">â–¼</button>
      </div>
      <div class="t-dot" style="background:${t.color};width:${isParent?8:6}px;height:${isParent?8:6}px;margin-left:.2rem"></div>
      <input type="color" value="${t.color}" onchange="changeTagColor('${t.id}',this.value)" style="width:20px;height:20px;padding:1px;border:1px solid var(--line);border-radius:50%;cursor:pointer" title="è‰²ã‚’å¤‰æ›´">
      <span class="tmr-name">${isParent?'':' â”” '}${esc(t.name)}</span>
      <button class="tmr-btn" onclick="renameTag('${t.id}')">âœï¸</button>
      <button class="tmr-btn" onclick="delTag('${t.id}')">âœ•</button>
    </div>`;
  });
  document.getElementById('tagMgrList').innerHTML=html;

  // è¦ªã‚¿ã‚°ã‚»ãƒ¬ã‚¯ãƒˆæ›´æ–°
  const psel=document.getElementById('parentTagSelect');
  if(psel) psel.innerHTML='<option value="">è¦ªã‚¿ã‚°ã‚’é¸æŠ...</option>'+parentTags.map(t=>`<option value="${t.id}">${esc(t.name)}</option>`).join('');
  const ytSel=document.getElementById('ytPlayTag');
  if(ytSel) ytSel.innerHTML='<option value="">ã™ã¹ã¦ï¼ˆçµã‚Šè¾¼ã¿ãªã—ï¼‰</option>'+tags.map(t=>`<option value="${t.id}">${esc(t.name)}</option>`).join('');

  // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ä¸€è¦§
  const allR=document.getElementById('allRemindersList');
  if(allR){
    const upcoming=reminders.filter(r=>!r.done).sort((a,b)=>a.remind_at-b.remind_at);
    allR.innerHTML=upcoming.length?upcoming.map(r=>{
      const p=posts.find(p=>p.id===r.post_id);
      return `<div class="tag-mgr-row">
        <input type="checkbox" onchange="completeReminder('${r.id}')" style="accent-color:var(--green)">
        <span style="font-family:'DM Mono',monospace;font-size:.66rem;color:var(--ink3)">${new Date(r.remind_at).toLocaleDateString('ja-JP')}</span>
        <span style="font-size:.76rem;flex:1;padding-left:.35rem">${esc(p?.author||'')} ${esc(r.message||'')}</span>
        <button class="tmr-btn" onclick="deleteReminder('${r.id}')">âœ•</button>
      </div>`;
    }).join(''):`<div style="font-size:.78rem;color:var(--ink3)">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãªã—</div>`;
  }

  // çµ±è¨ˆ
  const yt=posts.filter(p=>p.type==='youtube');
  const statsWrap=document.getElementById('statsWrap');
  if(statsWrap) statsWrap.innerHTML=`
    <div>ç·ã‚¯ãƒªãƒƒãƒ—æ•°: <b>${posts.length}</b></div>
    <div>Xãƒã‚¹ãƒˆ: <b>${posts.filter(p=>p.type==='x').length}</b></div>
    <div>Webè¨˜äº‹: <b>${posts.filter(p=>p.type==='web').length}</b></div>
    <div>YouTube: <b>${yt.length}</b>ï¼ˆæœªè¦–è´: <b>${yt.filter(p=>p.youtube_status!=='watched').length}</b>ã€ã‚ã¨ã§è¦‹ã‚‹: <b>${yt.filter(p=>p.watch_later).length}</b>ï¼‰</div>
    <div>ãƒ¡ãƒ¢: <b>${posts.filter(p=>p.type==='memo').length}</b></div>
    <div>ãŠæ°—ã«å…¥ã‚Š: <b>${posts.filter(p=>p.is_favorite).length}</b></div>
    <div>ã‚¿ã‚°æ•°: <b>${tags.length}</b></div>
    <div>ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼: <b>${reminders.filter(r=>!r.done).length}</b> ä»¶</div>`;
}

async function completeReminder(id){
  try{await sb('reminders?id=eq.'+id,'PATCH',{done:true});const r=reminders.find(r=>r.id===id);if(r)r.done=true;renderSettings();renderReminderBar();toast('ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’å®Œäº†ã«ã—ã¾ã—ãŸ','ok');}
  catch(e){toast('ã‚¨ãƒ©ãƒ¼: '+e.message,'err');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW / MODE / STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setView(v){
  viewMode=v;
  ['vGrid','vList','vMap'].forEach(id=>document.getElementById(id)?.classList.remove('active'));
  document.getElementById('v'+v.charAt(0).toUpperCase()+v.slice(1))?.classList.add('active');
  document.getElementById('mapWrap').style.display=v==='map'?'block':'none';
  document.getElementById('postsWrap').style.display=v==='map'?'none':'block';
  renderHome();
}

function setMode(m){
  displayMode=m;
  document.getElementById('modeA')?.classList.toggle('active',m==='A');
  document.getElementById('modeB')?.classList.toggle('active',m==='B');
  renderHome();
}

function updateStats(){
  const now=Date.now(),wk=7*864e5;
  document.getElementById('totalCount').textContent=posts.length;
  document.getElementById('tagCount').textContent=tags.length;
  const yt=posts.filter(p=>p.type==='youtube');
  document.getElementById('cAll').textContent=posts.length;
  document.getElementById('cFav').textContent=posts.filter(p=>p.is_favorite).length;
  document.getElementById('cYtWl').textContent=yt.filter(p=>p.watch_later&&p.youtube_status!=='watched').length;
  document.getElementById('cRec').textContent=posts.filter(p=>now-p.createdAt<wk).length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
let tTimer;
function toast(msg,type=''){
  const el=document.getElementById('toast');el.textContent=msg;el.className='toast show'+(type?' '+type:'');
  clearTimeout(tTimer);tTimer=setTimeout(()=>{el.className='toast';},3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('newTagIn')?.addEventListener('keydown',e=>{if(e.key==='Enter')addTag();});
['detailModal','editModal','reminderModal'].forEach(id=>{
  document.getElementById(id)?.addEventListener('click',e=>{if(e.target===document.getElementById(id))closeModal(id);});
});

init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XCLIP</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Noto+Sans+JP:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<style>
:root{
  --white:#fff;--off:#f7f6f3;--paper:#faf9f6;
  --ink:#111;--ink2:#444;--ink3:#999;
  --line:#e0ddd6;--line2:#ebebeb;
  --accent:#d4502a;--accent-light:#f5e8e3;
  --blue:#3b82f6;--green:#059669;--yellow:#f59e0b;--yellow-bg:#fff8e1;
  --red:#dc2626;--purple:#8b5cf6;
  --shadow-sm:0 1px 4px rgba(0,0,0,.06);
  --shadow-md:0 4px 24px rgba(0,0,0,.09);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--paper);color:var(--ink);font-family:'Noto Sans JP',sans-serif;font-weight:300;min-height:100vh;-webkit-font-smoothing:antialiased;}

/* ‚îÄ‚îÄ‚îÄ REMINDER BAR ‚îÄ‚îÄ‚îÄ */
#reminderBar{background:var(--yellow-bg);border-bottom:2px solid var(--yellow);padding:.55rem 1.5rem;display:flex;align-items:center;gap:.75rem;flex-wrap:wrap;min-height:42px;}
#reminderBar .rb-label{font-family:'DM Mono',monospace;font-size:.6rem;letter-spacing:.15em;color:#92400e;white-space:nowrap;}
.rb-item{display:flex;align-items:center;gap:.4rem;background:#fff;border:1px solid #fcd34d;border-radius:4px;padding:.2rem .6rem;font-size:.76rem;color:#92400e;}
.rb-dismiss{background:transparent;border:none;color:#a16207;cursor:pointer;font-size:.85rem;margin-left:.2rem;}
#rbEmpty{font-size:.78rem;color:#a16207;}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
header{position:sticky;top:0;z-index:300;background:rgba(250,249,246,.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--line);}
.hd{max-width:1440px;margin:0 auto;padding:0 1.5rem;height:52px;display:flex;align-items:center;gap:1.25rem;}
.logo{font-family:'Playfair Display',serif;font-weight:900;font-size:1.3rem;letter-spacing:-.03em;}
.logo em{color:var(--accent);font-style:normal;}
.hd-rule{flex:1;height:1px;background:var(--line);}
.hd-stat{text-align:right;}
.hd-stat .n{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;line-height:1;}
.hd-stat .l{font-family:'DM Mono',monospace;font-size:.48rem;letter-spacing:.12em;color:var(--ink3);text-transform:uppercase;}
.hd-stats{display:flex;gap:1.25rem;}

/* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
.tabs{display:flex;background:var(--white);border-bottom:1px solid var(--line);position:sticky;top:52px;z-index:200;}
.tab-btn{flex:1;padding:.7rem;font-size:.8rem;font-family:'Noto Sans JP',sans-serif;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--ink3);cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:.35rem;}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:500;}
.tab-btn:hover:not(.active){background:var(--off);color:var(--ink);}
.tab-pane{display:none;}
.tab-pane.active{display:block;}

/* ‚îÄ‚îÄ‚îÄ ACTIVE FILTER BADGE ‚îÄ‚îÄ‚îÄ */
#activeBadgeBar{display:none;padding:.4rem 1.5rem;background:var(--accent-light);border-bottom:1px solid #f0c4b4;gap:.4rem;flex-wrap:wrap;align-items:center;}
#activeBadgeBar.show{display:flex;}
.a-badge{display:inline-flex;align-items:center;gap:.3rem;background:var(--accent);color:#fff;border-radius:12px;padding:.2rem .7rem;font-size:.72rem;}
.a-badge-clear{background:transparent;border:none;color:#fff;cursor:pointer;opacity:.7;font-size:.8rem;margin-left:.1rem;}
.a-badge-clear:hover{opacity:1;}

/* ‚îÄ‚îÄ‚îÄ MOBILE FILTER BAR ‚îÄ‚îÄ‚îÄ */
#mobileFilterBar{display:none;position:sticky;top:104px;z-index:150;background:var(--white);border-bottom:1px solid var(--line);}
.mfb-scroll{display:flex;gap:.35rem;overflow-x:auto;padding:.5rem 1rem;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.mfb-scroll::-webkit-scrollbar{display:none;}
.mfb-pill{flex-shrink:0;padding:.3rem .8rem;border-radius:20px;border:1.5px solid var(--line);background:var(--white);color:var(--ink2);font-size:.74rem;font-family:'Noto Sans JP',sans-serif;cursor:pointer;transition:all .15s;white-space:nowrap;}
.mfb-pill.active{background:var(--ink);border-color:var(--ink);color:#fff;}
.mfb-pill.yt-pill.active{background:#2563eb;border-color:#2563eb;color:#fff;}
.mfb-pill.fav-pill.active{background:#f59e0b;border-color:#f59e0b;color:#fff;}
.mfb-expand{display:none;padding:.35rem 1rem .5rem;gap:.3rem;flex-wrap:wrap;border-bottom:1px solid var(--line);}
.mfb-expand.open{display:flex;}
.mfb-ep{flex-shrink:0;padding:.3rem .8rem;border-radius:16px;border:1.5px solid var(--line);background:var(--off);color:var(--ink2);font-size:.76rem;cursor:pointer;white-space:nowrap;transition:all .15s;font-family:'Noto Sans JP',sans-serif;display:inline-flex;align-items:center;gap:.3rem;}
.mfb-ep.active{color:#fff !important;border-color:transparent !important;}
#contentAnchor{scroll-margin-top:160px;}

/* ‚îÄ‚îÄ‚îÄ HOME LAYOUT ‚îÄ‚îÄ‚îÄ */
.home-wrap{max-width:1440px;margin:0 auto;display:grid;grid-template-columns:300px 1fr;min-height:calc(100vh - 160px);}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
.sidebar{border-right:1px solid var(--line);padding:1.25rem;position:sticky;top:104px;height:calc(100vh - 104px);overflow-y:auto;background:var(--white);}
.sb-section{margin-bottom:1.25rem;}
.sb-head{font-family:'DM Mono',monospace;font-size:.56rem;letter-spacing:.2em;text-transform:uppercase;color:var(--ink3);padding-bottom:.5rem;border-bottom:1px solid var(--line);margin-bottom:.5rem;}
.filter-btn{display:flex;align-items:center;gap:.5rem;width:100%;padding:.38rem .55rem;background:transparent;border:none;border-radius:4px;color:var(--ink2);cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-size:.79rem;font-weight:300;text-align:left;transition:all .15s;margin-bottom:1px;}
.filter-btn:hover{background:var(--off);}
.filter-btn.active{background:var(--ink);color:#fff;}
.filter-btn.yt-btn.active{background:#2563eb;color:#fff;}
.filter-btn.fav-btn.active{background:#f59e0b;color:#fff;}
.filter-btn .fc{margin-left:auto;font-family:'DM Mono',monospace;font-size:.6rem;opacity:.55;}
.tag-tree-parent{margin-bottom:2px;}
.tag-row{display:flex;align-items:center;gap:.4rem;padding:.32rem .55rem;border-radius:4px;cursor:pointer;transition:background .15s;font-size:.79rem;color:var(--ink2);}
.tag-row:hover{background:var(--off);}
.tag-row.active{background:var(--accent-light);color:var(--accent);font-weight:500;}
.t-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.t-cnt{margin-left:auto;font-family:'DM Mono',monospace;font-size:.6rem;color:var(--ink3);}
.tag-child-wrap{padding-left:.9rem;}
.tag-child-wrap .tag-row{font-size:.74rem;}
.tag-child-wrap .t-dot{width:5px;height:5px;}
.area-select{width:100%;background:var(--off);border:1px solid var(--line);border-radius:4px;color:var(--ink);padding:.38rem .55rem;font-size:.76rem;font-family:'Noto Sans JP',sans-serif;outline:none;cursor:pointer;margin-bottom:.35rem;}
.sb-play-btn{width:100%;padding:.38rem .55rem;background:var(--ink);border:none;border-radius:4px;color:#fff;font-size:.74rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.3rem;font-family:'Noto Sans JP',sans-serif;margin-top:.3rem;transition:background .15s;}
.sb-play-btn:hover{background:var(--accent);}

/* ‚îÄ‚îÄ‚îÄ MAIN AREA ‚îÄ‚îÄ‚îÄ */
.main-area{padding:1.25rem 1.5rem;}
.toolbar{display:flex;align-items:center;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap;}
.search-wrap{flex:1;min-width:160px;position:relative;}
.search-ico{position:absolute;left:.7rem;top:50%;transform:translateY(-50%);color:var(--ink3);font-size:.85rem;}
.search-fi{width:100%;background:var(--white);border:1px solid var(--line);border-radius:6px;padding:.45rem .7rem .45rem 2rem;font-size:.82rem;outline:none;transition:border-color .2s;font-family:'Noto Sans JP',sans-serif;}
.search-fi:focus{border-color:var(--ink);}
.view-toggle{display:flex;gap:.2rem;}
.vt-btn{background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.36rem .6rem;cursor:pointer;color:var(--ink3);font-size:.88rem;transition:all .15s;}
.vt-btn.active{background:var(--ink);color:#fff;border-color:var(--ink);}
.mode-toggle{display:flex;gap:.2rem;}
.mode-btn{background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.3rem .65rem;cursor:pointer;color:var(--ink2);font-size:.7rem;font-family:'DM Mono',monospace;transition:all .15s;}
.mode-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);}
.result-info{font-family:'DM Mono',monospace;font-size:.65rem;color:var(--ink3);letter-spacing:.08em;margin-bottom:.75rem;}

/* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
.posts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:.9rem;}
.posts-list{display:flex;flex-direction:column;gap:.5rem;}
.card{background:var(--white);border:1px solid var(--line);border-radius:6px;overflow:hidden;transition:box-shadow .2s;position:relative;}
.card:hover{box-shadow:var(--shadow-md);}
.card-img-wrap{width:100%;height:160px;background:#f8f8f8;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.card-img-wrap img{max-width:100%;max-height:100%;object-fit:contain;}
.card-body{padding:.85rem;}
.card-meta{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;}
.c-avatar{width:26px;height:26px;border-radius:50%;background:var(--ink);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.68rem;font-weight:700;flex-shrink:0;}
.c-author{font-size:.8rem;font-weight:500;}
.c-handle{font-size:.7rem;color:var(--ink3);}
.c-date{font-family:'DM Mono',monospace;font-size:.6rem;color:var(--ink3);margin-left:auto;white-space:nowrap;}
.c-content{font-size:.8rem;color:var(--ink2);line-height:1.6;margin-bottom:.45rem;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
.c-summary{font-size:.73rem;color:#6d28d9;background:#f5f3ff;border-left:2px solid #8b5cf6;padding:.35rem .55rem;border-radius:0 4px 4px 0;margin-bottom:.45rem;line-height:1.5;}
.c-memo-row{font-size:.72rem;color:var(--ink2);background:var(--off);border-left:2px solid var(--line);padding:.3rem .55rem;border-radius:0 3px 3px 0;margin-bottom:.4rem;word-break:break-all;}
.c-area{font-size:.68rem;color:var(--ink3);margin-bottom:.35rem;}
.c-dist{font-family:'DM Mono',monospace;font-size:.6rem;color:var(--blue);background:#eff6ff;padding:1px 5px;border-radius:3px;margin-left:.3rem;}
.c-tags{display:flex;flex-wrap:wrap;gap:.25rem;margin-bottom:.4rem;}
.c-tag{font-size:.66rem;padding:1px 7px;border-radius:10px;}
.c-footer{display:flex;align-items:center;gap:.3rem;flex-wrap:wrap;padding-top:.45rem;border-top:1px solid var(--line);}
.c-btn{background:var(--off);border:1px solid var(--line);border-radius:3px;padding:.18rem .52rem;font-size:.68rem;cursor:pointer;color:var(--ink2);transition:all .15s;font-family:'Noto Sans JP',sans-serif;}
.c-btn:hover{background:var(--ink);color:#fff;border-color:var(--ink);}
.c-btn.del:hover{background:var(--red);border-color:var(--red);color:#fff;}
.c-btn.green{background:#d1fae5;border-color:#6ee7b7;color:#065f46;}
.c-link{font-size:.7rem;color:var(--blue);text-decoration:none;}
.c-link:hover{text-decoration:underline;}
.type-badge{font-family:'DM Mono',monospace;font-size:.56rem;padding:1px 6px;border-radius:10px;margin-right:.2rem;vertical-align:middle;}
/* „Éï„É©„Ç∞„Ç¢„Ç§„Ç≥„É≥ */
.flag-fav{position:absolute;top:.5rem;right:.5rem;font-size:.95rem;line-height:1;}
.flag-wl{font-size:.8rem;color:var(--blue);}
.yt-status-badge{font-size:.66rem;padding:1px 7px;border-radius:10px;font-family:'DM Mono',monospace;}
.yt-status-badge.unwatch{background:#fee2e2;color:#991b1b;}
.yt-status-badge.watched{background:#d1fae5;color:#065f46;}

/* LIST ROW */
.list-row{background:var(--white);border:1px solid var(--line);border-radius:6px;display:grid;grid-template-columns:80px 1fr;overflow:hidden;transition:box-shadow .2s;position:relative;}
.list-row:hover{box-shadow:var(--shadow-sm);}
.list-thumb{width:80px;height:80px;background:#f8f8f8;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;}
.list-thumb img{max-width:100%;max-height:100%;object-fit:contain;}
.list-thumb-ph{width:80px;height:80px;display:flex;align-items:center;justify-content:center;background:var(--off);color:var(--ink3);font-size:1.1rem;}
.list-body{padding:.55rem .75rem;display:flex;flex-direction:column;gap:.15rem;min-width:0;}
.list-top{display:flex;align-items:center;gap:.4rem;font-size:.76rem;}
.list-author{font-weight:500;}
.list-handle{color:var(--ink3);font-size:.7rem;}
.list-date{color:var(--ink3);font-family:'DM Mono',monospace;font-size:.6rem;margin-left:auto;white-space:nowrap;}
.list-content{font-size:.76rem;color:var(--ink2);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.list-bottom{display:flex;align-items:center;gap:.25rem;flex-wrap:wrap;margin-top:.2rem;}

/* GROUP HEADER */
.group-header{font-family:'DM Mono',monospace;font-size:.6rem;letter-spacing:.15em;text-transform:uppercase;color:var(--ink3);padding:.4rem 0 .25rem;border-bottom:1px solid var(--line);margin-bottom:.5rem;margin-top:.9rem;}
.group-header:first-child{margin-top:0;}

/* ‚îÄ‚îÄ‚îÄ ADD TAB ‚îÄ‚îÄ‚îÄ */
.add-wrap{max-width:740px;margin:0 auto;padding:1.5rem;}
.add-card{background:var(--white);border:1px solid var(--line);border-radius:8px;padding:1.5rem;}
.type-tabs{display:flex;gap:.4rem;margin-bottom:1.1rem;}
.type-tab{flex:1;padding:.5rem;background:var(--off);border:1.5px solid var(--line);border-radius:20px;color:var(--ink2);font-size:.78rem;cursor:pointer;transition:all .15s;font-family:'Noto Sans JP',sans-serif;text-align:center;}
.type-tab.active{background:var(--ink);border-color:var(--ink);color:#fff;}
.url-row{display:flex;gap:.4rem;margin-bottom:.9rem;}
.url-field{flex:1;background:var(--off);border:1px solid var(--line);border-radius:6px;padding:.5rem .75rem;font-size:.82rem;outline:none;transition:border-color .2s;font-family:'Noto Sans JP',sans-serif;}
.url-field:focus{border-color:var(--ink);}
.fetch-btn{background:var(--ink);border:none;border-radius:6px;color:#fff;padding:.5rem 1rem;font-size:.8rem;cursor:pointer;white-space:nowrap;transition:background .15s;}
.fetch-btn:hover{background:var(--accent);}
.fetch-btn:disabled{opacity:.5;cursor:not-allowed;}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:.65rem;margin-bottom:.65rem;}
.fg-full{grid-column:1/-1;}
.fl{font-size:.7rem;color:var(--ink3);letter-spacing:.05em;margin-bottom:.2rem;display:block;}
.fi{width:100%;background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.42rem .65rem;font-size:.8rem;color:var(--ink);outline:none;transition:border-color .2s;font-family:'Noto Sans JP',sans-serif;}
.fi:focus{border-color:var(--ink);}
.fi::placeholder{color:var(--ink3);}
.fta{width:100%;background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.45rem .65rem;font-size:.8rem;color:var(--ink);outline:none;resize:vertical;min-height:75px;transition:border-color .2s;font-family:'Noto Sans JP',sans-serif;}
.fta:focus{border-color:var(--ink);}
.img-area{border:1.5px dashed var(--line);border-radius:6px;overflow:hidden;cursor:pointer;position:relative;min-height:90px;display:flex;align-items:center;justify-content:center;background:#f8f8f8;}
.img-area input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;}
.img-area-prev{width:100%;max-height:220px;object-fit:contain;display:block;}
.img-area-ph{display:flex;flex-direction:column;align-items:center;gap:.3rem;color:var(--ink3);font-size:.76rem;pointer-events:none;}
/* ‚îÄ‚îÄ‚îÄ HIERARCHICAL TAG PICKER ‚îÄ‚îÄ‚îÄ */
.tag-picker{display:flex;flex-direction:column;gap:.5rem;}
.tp-group{border:1.5px solid var(--line);border-radius:10px;overflow:hidden;}
.tp-parent-row{display:flex;align-items:center;gap:.55rem;padding:.6rem .75rem;cursor:pointer;user-select:none;transition:background .15s;min-height:48px;}
.tp-parent-row:hover{background:#ebebeb;}
.tp-parent-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.tp-parent-name{font-size:.88rem;font-weight:500;flex:1;color:var(--ink);}
.tp-parent-check{width:22px;height:22px;border-radius:5px;border:1.5px solid var(--line);display:flex;align-items:center;justify-content:center;font-size:.75rem;flex-shrink:0;transition:all .15s;background:#fff;}
.tp-parent-row.selected .tp-parent-check{color:#fff;border-color:transparent;}
.tp-children{display:flex;flex-wrap:wrap;gap:.4rem;padding:.5rem .75rem .65rem 1.5rem;border-top:1px solid var(--line);background:#fdfdfd;}
.tp-child-pill{font-size:.78rem;padding:.35rem .75rem;border-radius:14px;cursor:pointer;border:1.5px solid;transition:all .15s;display:inline-flex;align-items:center;gap:.3rem;background:#fff;min-height:36px;}
.tp-child-pill:hover{opacity:.82;}
.tp-child-pill.selected{color:#fff !important;border-color:transparent !important;}
.tp-lone-row{display:flex;flex-wrap:wrap;gap:.4rem;}
@media(max-width:768px){
  .tp-parent-row{min-height:52px;padding:.65rem .85rem;}
  .tp-parent-name{font-size:.92rem;}
  .tp-parent-check{width:26px;height:26px;font-size:.82rem;}
  .tp-child-pill{font-size:.82rem;padding:.4rem .85rem;min-height:40px;}
  .tp-children{gap:.45rem;padding:.6rem .85rem .75rem 1.5rem;}
}
.status-bar{font-size:.76rem;color:var(--ink3);background:var(--off);border-left:2px solid var(--accent);padding:.45rem .7rem;border-radius:0 4px 4px 0;margin-bottom:.7rem;display:none;}
.form-actions{display:flex;justify-content:flex-end;gap:.5rem;margin-top:.9rem;padding-top:.9rem;border-top:1px solid var(--line);}
.btn-ghost{background:transparent;border:1px solid var(--line);border-radius:6px;padding:.45rem 1.1rem;font-size:.8rem;cursor:pointer;color:var(--ink2);transition:all .15s;}
.btn-ghost:hover{border-color:var(--ink);color:var(--ink);}
.btn-solid{background:var(--ink);border:none;border-radius:6px;padding:.45rem 1.4rem;font-size:.8rem;color:#fff;cursor:pointer;transition:background .15s;}
.btn-solid:hover{background:var(--accent);}
.flag-row{display:flex;align-items:center;gap:1.25rem;padding:.45rem 0;}
.flag-row label{display:flex;align-items:center;gap:.4rem;font-size:.8rem;cursor:pointer;color:var(--ink2);}

/* ‚îÄ‚îÄ‚îÄ QUICK ADD (SP) ‚îÄ‚îÄ‚îÄ */
.quick-add-card{background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:12px;padding:1.1rem 1.1rem .9rem;margin-bottom:.85rem;color:#fff;}
.qa-label{font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.2em;text-transform:uppercase;color:#a5b4fc;margin-bottom:.3rem;}
.qa-desc{font-size:.78rem;color:#c7d2fe;margin-bottom:.75rem;line-height:1.5;}
.qa-row{display:flex;gap:.4rem;margin-bottom:.4rem;}
.qa-input{flex:1;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:.55rem .75rem;font-size:.85rem;color:#fff;outline:none;font-family:'Noto Sans JP',sans-serif;}
.qa-input::placeholder{color:rgba(255,255,255,.4);}
.qa-input:focus{border-color:rgba(165,180,252,.7);background:rgba(255,255,255,.15);}
.qa-btn{background:#6366f1;border:none;border-radius:8px;color:#fff;padding:.55rem 1.1rem;font-size:.85rem;cursor:pointer;font-family:'Noto Sans JP',sans-serif;white-space:nowrap;transition:background .15s;}
.qa-btn:hover{background:#4f46e5;}
.qa-btn:disabled{opacity:.5;cursor:not-allowed;}
.qa-status{font-size:.72rem;color:#a5b4fc;min-height:1.1rem;margin-bottom:.4rem;}
.qa-toggle{background:transparent;border:none;color:rgba(255,255,255,.5);font-size:.72rem;cursor:pointer;padding:.2rem 0;font-family:'Noto Sans JP',sans-serif;}
.qa-toggle:hover{color:rgba(255,255,255,.8);}
@media(min-width:769px){
  .quick-add-card{display:none;}/* PC „ÅØÂ∏∏„Å´Ë©≥Á¥∞„Éï„Ç©„Éº„É†„ÅÆ„ÅøË°®Á§∫ */
}
@media(max-width:768px){
  #detailAddCard{display:none;}/* SP „ÅØ„Éá„Éï„Ç©„É´„Éà„ÅßË©≥Á¥∞„Éï„Ç©„Éº„É†„ÇíÈö†„Åô */
  #detailAddCard.sp-show{display:block;}
}
.settings-wrap{max-width:980px;margin:0 auto;padding:1.5rem;}
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;}
.settings-card{background:var(--white);border:1px solid var(--line);border-radius:8px;padding:1.1rem;}
.settings-title{font-family:'DM Mono',monospace;font-size:.62rem;letter-spacing:.15em;text-transform:uppercase;color:var(--ink3);margin-bottom:.9rem;padding-bottom:.45rem;border-bottom:1px solid var(--line);}
.tag-mgr-row{display:flex;align-items:center;gap:.35rem;padding:.28rem .4rem;border-radius:4px;transition:background .15s;margin-bottom:1px;}
.tag-mgr-row:hover{background:var(--off);}
.tmr-name{font-size:.78rem;flex:1;color:var(--ink2);}
.tmr-btn{background:transparent;border:none;cursor:pointer;font-size:.78rem;padding:.1rem .28rem;border-radius:3px;color:var(--ink3);transition:all .15s;}
.tmr-btn:hover{color:var(--ink);background:var(--off);}
.tmr-order{display:flex;flex-direction:column;gap:1px;}
.tmr-order button{background:var(--off);border:1px solid var(--line);border-radius:2px;width:18px;height:14px;cursor:pointer;font-size:.55rem;color:var(--ink2);display:flex;align-items:center;justify-content:center;padding:0;}
.add-row{display:flex;gap:.35rem;margin-top:.65rem;}
.add-row input{flex:1;background:var(--off);border:1px solid var(--line);border-radius:4px;color:var(--ink);padding:.38rem .55rem;font-size:.76rem;font-family:'Noto Sans JP',sans-serif;outline:none;}
.add-row input:focus{border-color:var(--ink);}
.add-row button{background:var(--ink);border:none;border-radius:4px;color:#fff;padding:.38rem .75rem;font-size:.76rem;cursor:pointer;}

/* ‚îÄ‚îÄ‚îÄ YOUTUBE PLAYER ‚îÄ‚îÄ‚îÄ */
#homeYtPanel{display:none;background:var(--ink);color:#fff;border-radius:8px;padding:1rem;margin-bottom:1rem;}
.yt-panel-grid{display:grid;grid-template-columns:1fr 240px;gap:1rem;align-items:start;}
.yt-iframe-wrap{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:6px;background:#000;}
#homeYtIframeContainer{position:absolute;inset:0;}
.yt-controls{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.6rem;align-items:center;}
.yt-btn{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:4px;color:#fff;padding:.25rem .6rem;font-size:.72rem;cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:background .15s;}
.yt-btn:hover{background:rgba(255,255,255,.22);}
.yt-btn.green{background:#065f46;border-color:#6ee7b7;color:#d1fae5;}
.yt-queue{max-height:280px;overflow-y:auto;}
.yt-queue-item{display:flex;align-items:center;gap:.45rem;padding:.35rem .4rem;border-radius:4px;cursor:pointer;transition:background .15s;margin-bottom:2px;}
.yt-queue-item:hover{background:rgba(255,255,255,.08);}
.yt-queue-item.active{background:rgba(255,255,255,.15);}
.yt-queue-thumb{width:42px;height:30px;object-fit:cover;border-radius:2px;flex-shrink:0;}
.yt-queue-title{font-size:.7rem;line-height:1.3;opacity:.85;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.yt-info{font-size:.79rem;opacity:.88;margin:.45rem 0;display:flex;align-items:center;gap:.4rem;flex-wrap:wrap;}
.watched-toggle{display:flex;align-items:center;gap:.3rem;font-size:.72rem;opacity:.75;}
.watched-toggle input{accent-color:#6ee7b7;}

/* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.48);z-index:600;display:flex;align-items:center;justify-content:center;padding:1rem;opacity:0;pointer-events:none;transition:opacity .2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--white);border-radius:10px;max-width:620px;width:100%;max-height:92vh;overflow-y:auto;box-shadow:var(--shadow-md);display:flex;flex-direction:column;}
.modal-sticky-head{position:sticky;top:0;z-index:10;background:var(--white);border-bottom:1px solid var(--line);padding:1rem 1.5rem;display:flex;align-items:center;justify-content:space-between;border-radius:10px 10px 0 0;}
.modal-body{padding:1.5rem;}
.modal-close-sticky{background:var(--ink);border:none;border-radius:6px;padding:.5rem 1rem;cursor:pointer;font-size:.82rem;color:#fff;font-family:'Noto Sans JP',sans-serif;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;gap:.3rem;transition:background .15s;}
.modal-close-sticky:hover{background:var(--accent);}

/* ‚îÄ‚îÄ‚îÄ BOTTOM NAV (mobile) ‚îÄ‚îÄ‚îÄ */
#bottomNav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:500;background:rgba(250,249,246,.97);backdrop-filter:blur(16px);border-top:1px solid var(--line);padding:0 0 env(safe-area-inset-bottom,0);}
.bn-inner{display:flex;}
.bn-btn{flex:1;padding:.55rem .2rem .45rem;background:transparent;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:.18rem;color:var(--ink3);font-family:'Noto Sans JP',sans-serif;font-size:.6rem;transition:color .15s;min-height:56px;justify-content:center;}
.bn-btn.active{color:var(--accent);}
.bn-btn:hover:not(.active){color:var(--ink);}
.bn-icon{font-size:1.15rem;line-height:1;}

/* ‚îÄ‚îÄ‚îÄ DRAWER (SP detail) ‚îÄ‚îÄ‚îÄ */
.drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.48);z-index:700;opacity:0;pointer-events:none;transition:opacity .3s;}
.drawer-overlay.open{opacity:1;pointer-events:all;}
.drawer{position:fixed;bottom:0;left:0;right:0;z-index:701;background:var(--white);border-radius:16px 16px 0 0;max-height:92vh;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .32s cubic-bezier(.32,1,.28,1);}
.drawer-overlay.open .drawer{transform:translateY(0);}
.drawer-handle{width:40px;height:4px;background:var(--line);border-radius:2px;margin:.7rem auto .5rem;flex-shrink:0;}
.drawer-sticky-head{position:sticky;top:0;z-index:10;background:var(--white);border-bottom:1px solid var(--line);padding:.75rem 1.25rem;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.drawer-body{overflow-y:auto;padding:1.25rem;flex:1;}
.modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.1rem;padding-bottom:.65rem;border-bottom:1px solid var(--line);}
.modal-title{font-family:'Playfair Display',serif;font-size:1.05rem;font-weight:700;}
.modal-close{background:var(--off);border:1px solid var(--line);border-radius:4px;padding:.22rem .6rem;cursor:pointer;font-size:.76rem;color:var(--ink2);}
.detail-img-wrap{width:100%;background:#f8f8f8;border-radius:4px;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:1rem;max-height:320px;}
.detail-img-wrap img{max-width:100%;max-height:320px;object-fit:contain;}
.yt-embed-wrap{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:6px;margin-bottom:1rem;}
.yt-embed-wrap iframe{position:absolute;inset:0;width:100%;height:100%;}

/* ‚îÄ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ‚îÄ */
#lightbox{position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;cursor:zoom-out;}
#lightbox.open{display:flex;}
#lightbox img{max-width:92vw;max-height:88vh;object-fit:contain;border-radius:6px;box-shadow:0 8px 48px rgba(0,0,0,.6);user-select:none;}
#lbClose{position:fixed;top:1rem;right:1rem;background:rgba(255,255,255,.15);border:none;border-radius:50%;width:40px;height:40px;color:#fff;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
#lbClose:hover{background:rgba(255,255,255,.28);}
.img-zoomable{cursor:zoom-in;}

/* ‚îÄ‚îÄ‚îÄ INSTAGRAM IMAGE SELECTOR ‚îÄ‚îÄ‚îÄ */
.insta-thumb-wrap{width:80px;height:80px;border-radius:8px;cursor:pointer;border:3px solid transparent;transition:all .18s;position:relative;flex-shrink:0;overflow:hidden;background:#f0f0f0;}
.insta-thumb-wrap img{width:100%;height:100%;object-fit:cover;display:block;}
.insta-thumb-wrap.selected{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent);}
.insta-sel-num{position:absolute;top:3px;right:3px;width:20px;height:20px;border-radius:50%;background:var(--accent);color:#fff;font-size:.62rem;font-weight:700;display:none;align-items:center;justify-content:center;font-family:'DM Mono',monospace;}
.insta-thumb-wrap.selected .insta-sel-num{display:flex;}
.insta-vid-badge{position:absolute;bottom:3px;left:3px;background:rgba(0,0,0,.6);color:#fff;font-size:.55rem;padding:1px 5px;border-radius:3px;}

/* ‚îÄ‚îÄ‚îÄ MAP MARKERS ‚îÄ‚îÄ‚îÄ */
.leaflet-popup-content-wrapper{border-radius:10px !important;box-shadow:0 4px 20px rgba(0,0,0,.15) !important;padding:0 !important;overflow:hidden;}
.leaflet-popup-content{margin:10px 12px !important;font-family:'Noto Sans JP',sans-serif !important;}
.leaflet-div-icon{background:transparent !important;border:none !important;}

/* ‚îÄ‚îÄ‚îÄ QUICK ADD SHEET (SP) ‚îÄ‚îÄ‚îÄ */
#quickAddSheet{position:fixed;inset:0;z-index:800;display:none;}
#quickAddSheet.open{display:block;}
.qa-overlay{position:absolute;inset:0;background:rgba(0,0,0,.5);}
.qa-panel{position:absolute;bottom:0;left:0;right:0;background:#fff;border-radius:20px 20px 0 0;padding:0 0 env(safe-area-inset-bottom,0);max-height:85vh;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .32s cubic-bezier(.32,1,.28,1);}
#quickAddSheet.open .qa-panel{transform:translateY(0);}
.qa-handle{width:40px;height:4px;background:var(--line);border-radius:2px;margin:.75rem auto .25rem;}
.qa-head{padding:.6rem 1.25rem .75rem;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;}
.qa-title{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;}
.qa-close{background:var(--off);border:1px solid var(--line);border-radius:20px;padding:.28rem .75rem;font-size:.78rem;cursor:pointer;color:var(--ink2);}
.qa-body{padding:1rem 1.25rem;overflow-y:auto;flex:1;}
.qa-url-wrap{display:flex;gap:.5rem;margin-bottom:.85rem;}
.qa-url-input{flex:1;border:2px solid var(--line);border-radius:10px;padding:.7rem 1rem;font-size:.9rem;font-family:'Noto Sans JP',sans-serif;outline:none;background:var(--off);transition:border-color .2s;}
.qa-url-input:focus{border-color:var(--accent);background:#fff;}
.qa-fetch-btn{background:var(--ink);border:none;border-radius:10px;color:#fff;padding:.7rem 1.1rem;font-size:.82rem;cursor:pointer;white-space:nowrap;font-family:'Noto Sans JP',sans-serif;transition:background .15s;flex-shrink:0;}
.qa-fetch-btn:hover{background:var(--accent);}
.qa-status{font-size:.75rem;color:var(--ink3);background:var(--off);border-radius:8px;padding:.45rem .75rem;margin-bottom:.75rem;display:none;line-height:1.5;}
.qa-status.show{display:block;}
.qa-preview{background:var(--off);border:1px solid var(--line);border-radius:10px;padding:.75rem 1rem;margin-bottom:.85rem;display:none;}
.qa-preview.show{display:block;}
.qa-preview-img{width:100%;height:120px;object-fit:cover;border-radius:6px;margin-bottom:.5rem;display:block;}
.qa-preview-title{font-size:.88rem;font-weight:600;margin-bottom:.2rem;line-height:1.4;}
.qa-preview-sub{font-size:.72rem;color:var(--ink3);}
.qa-memo-wrap{margin-bottom:.75rem;}
.qa-memo-label{font-size:.72rem;color:var(--ink3);margin-bottom:.3rem;display:block;}
.qa-memo{width:100%;border:1.5px solid var(--line);border-radius:10px;padding:.6rem .9rem;font-size:.84rem;font-family:'Noto Sans JP',sans-serif;outline:none;resize:none;min-height:60px;background:var(--off);}
.qa-memo:focus{border-color:var(--accent);background:#fff;}
.qa-save-btn{width:100%;padding:.85rem;background:var(--accent);border:none;border-radius:12px;color:#fff;font-size:.95rem;font-family:'Noto Sans JP',sans-serif;font-weight:500;cursor:pointer;transition:opacity .15s;letter-spacing:.03em;}
.qa-save-btn:active{opacity:.85;}
.qa-save-btn:disabled{opacity:.45;cursor:not-allowed;}
.qa-detail-link{display:block;text-align:center;font-size:.75rem;color:var(--ink3);margin-top:.6rem;cursor:pointer;text-decoration:underline;}

/* ‚îÄ‚îÄ‚îÄ „Çø„Ç∞„Å™„Åó‰∏ÄË¶ß„Ç∞„É´„Éº„Éó ‚îÄ‚îÄ‚îÄ */
.untagged-group{background:#fff8f5;border:1.5px dashed #f0c4b4;border-radius:8px;padding:.75rem 1rem;margin-bottom:1rem;}
.untagged-group-head{font-family:'DM Mono',monospace;font-size:.6rem;letter-spacing:.15em;text-transform:uppercase;color:var(--accent);margin-bottom:.5rem;display:flex;align-items:center;gap:.4rem;}

/* ‚îÄ‚îÄ‚îÄ TOAST / LOADING ‚îÄ‚îÄ‚îÄ */
.toast{position:fixed;bottom:1.5rem;right:1.5rem;background:var(--ink);color:#fff;padding:.55rem 1.2rem;border-radius:6px;font-size:.8rem;z-index:1000;opacity:0;transform:translateY(8px);transition:all .25s;pointer-events:none;}
.toast.show{opacity:1;transform:translateY(0);}
.toast.ok{background:var(--green);}
.toast.err{background:var(--red);}
.ld{display:inline-flex;gap:3px;align-items:center;}
.ld span{width:4px;height:4px;border-radius:50%;background:currentColor;animation:ld .8s ease-in-out infinite;}
.ld span:nth-child(2){animation-delay:.15s;}
.ld span:nth-child(3){animation-delay:.3s;}
@keyframes ld{0%,80%,100%{opacity:.2}40%{opacity:1}}
.empty{text-align:center;padding:4rem 2rem;color:var(--ink3);}
.empty-mark{font-family:'Playfair Display',serif;font-size:3rem;opacity:.18;margin-bottom:1rem;}
.empty h3{font-size:.95rem;font-weight:400;margin-bottom:.4rem;color:var(--ink2);}
.empty p{font-size:.8rem;}

/* ‚îÄ‚îÄ‚îÄ COLOR PICKER ‚îÄ‚îÄ‚îÄ */
.color-swatch{width:16px;height:16px;border-radius:50%;flex-shrink:0;cursor:pointer;border:2px solid rgba(255,255,255,.4);box-shadow:0 0 0 1px rgba(0,0,0,.15);}
input[type=color]{border:none;background:transparent;cursor:pointer;width:22px;height:22px;padding:0;border-radius:50%;}

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
@media(max-width:768px){
  #mobileFilterBar{display:block;}
  .sidebar{display:none;}
  .home-wrap{grid-template-columns:1fr;}
  .main-area{padding:.75rem 1rem;}
  .settings-grid{grid-template-columns:1fr;}
  .yt-panel-grid{grid-template-columns:1fr;}
  .posts-grid{grid-template-columns:1fr;}
  .add-wrap{padding:.75rem 1rem;}
  #bottomNav{display:block;}
  body{padding-bottom:64px;}
  .tabs{display:none;}
  .modal-close-sticky{min-width:48px;min-height:48px;font-size:.88rem;}
  .modal{border-radius:16px 16px 0 0;max-height:88vh;}
}
@media(min-width:769px){
  #mobileFilterBar{display:none !important;}
  .sidebar{display:block;}
  #bottomNav{display:none !important;}
  .drawer-overlay{display:none !important;}
}

/* ‚îÄ‚îÄ‚îÄ HOME REMINDER SECTION ‚îÄ‚îÄ‚îÄ */
.home-reminder-section{background:var(--yellow-bg);border:1px solid #fcd34d;border-radius:8px;padding:.85rem 1rem;margin-bottom:1rem;}
.hrs-head{display:flex;align-items:center;gap:.5rem;font-family:'DM Mono',monospace;font-size:.6rem;letter-spacing:.15em;text-transform:uppercase;color:#92400e;margin-bottom:.65rem;}
.hrs-cards{display:flex;flex-wrap:wrap;gap:.4rem;}
.hrs-card{background:#fff;border:1px solid #fcd34d;border-radius:8px;padding:.45rem .75rem;display:flex;align-items:center;gap:.45rem;cursor:pointer;transition:box-shadow .15s;min-width:0;}
.hrs-card:hover{box-shadow:0 2px 8px rgba(0,0,0,.1);}
.hrs-dot{font-size:.85rem;flex-shrink:0;}
.hrs-info{min-width:0;}
.hrs-title{font-size:.76rem;font-weight:500;color:#92400e;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px;}
.hrs-date{font-family:'DM Mono',monospace;font-size:.6rem;color:#a16207;}
.hrs-dismiss{background:transparent;border:none;color:#a16207;cursor:pointer;font-size:.75rem;padding:.1rem;flex-shrink:0;}

/* ‚îÄ‚îÄ‚îÄ TRAVEL PLANNER ‚îÄ‚îÄ‚îÄ */
.tp-wrap{max-width:980px;margin:0 auto;padding:1.5rem 1rem 6rem;}
.tp-header{display:flex;align-items:center;gap:.75rem;margin-bottom:1.25rem;}
.tp-title{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;}
.tp-plans-list{display:flex;flex-direction:column;gap:.65rem;margin-bottom:1.25rem;}
.tp-plan-card{background:var(--white);border:1px solid var(--line);border-radius:10px;padding:.9rem 1rem;cursor:pointer;transition:box-shadow .15s;}
.tp-plan-card:hover{box-shadow:var(--shadow-md);}
.tp-plan-name{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;margin-bottom:.2rem;}
.tp-plan-meta{font-family:'DM Mono',monospace;font-size:.6rem;color:var(--ink3);}
.tp-new-btn{background:var(--ink);color:#fff;border:none;border-radius:8px;padding:.6rem 1.4rem;font-size:.82rem;cursor:pointer;font-family:'Noto Sans JP',sans-serif;}
.tp-new-btn:hover{background:var(--accent);}
/* „Éó„É©„É≥„Ç®„Éá„Ç£„Çø */
.tp-editor{display:none;}
.tp-editor.open{display:block;}
.tp-back-btn{background:transparent;border:1px solid var(--line);border-radius:6px;padding:.4rem .9rem;font-size:.76rem;cursor:pointer;color:var(--ink2);margin-bottom:1rem;}
.tp-days-wrap{display:flex;flex-direction:column;gap:1rem;}
.tp-day{background:var(--white);border:1px solid var(--line);border-radius:10px;overflow:hidden;}
.tp-day-head{background:var(--ink);color:#fff;padding:.6rem 1rem;display:flex;align-items:center;gap:.65rem;}
.tp-day-label{font-family:'DM Mono',monospace;font-size:.7rem;letter-spacing:.1em;}
.tp-day-date{background:rgba(255,255,255,.15);border:none;border-radius:4px;color:#fff;font-size:.72rem;padding:.2rem .5rem;font-family:'Noto Sans JP',sans-serif;cursor:pointer;}
.tp-day-date:focus{outline:none;background:rgba(255,255,255,.25);}
.tp-day-del{background:transparent;border:none;color:rgba(255,255,255,.5);cursor:pointer;margin-left:auto;font-size:.85rem;}
.tp-items{padding:.6rem .7rem;display:flex;flex-direction:column;gap:.45rem;min-height:48px;}
.tp-item{background:var(--off);border-radius:8px;padding:.55rem .75rem;display:flex;align-items:flex-start;gap:.6rem;position:relative;}
.tp-item.dragging{opacity:.4;}
.tp-item-drag{cursor:grab;color:var(--ink3);font-size:.9rem;flex-shrink:0;margin-top:.1rem;}
.tp-item-body{flex:1;min-width:0;}
.tp-item-title{font-size:.82rem;font-weight:500;color:var(--ink);line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tp-item-sub{font-size:.68rem;color:var(--ink3);margin-top:.1rem;}
.tp-item-badge{display:inline-block;font-size:.58rem;padding:1px 6px;border-radius:8px;margin-right:.3rem;}
.tp-item-pri{display:flex;gap:.25rem;margin-top:.35rem;}
.tp-pri-btn{background:transparent;border:1px solid var(--line);border-radius:10px;font-size:.62rem;padding:.1rem .5rem;cursor:pointer;color:var(--ink3);}
.tp-pri-btn.active-high{background:#fee2e2;border-color:#fca5a5;color:#dc2626;}
.tp-pri-btn.active-mid{background:#fff7ed;border-color:#fed7aa;color:#ea580c;}
.tp-pri-btn.active-low{background:#f0fdf4;border-color:#bbf7d0;color:#16a34a;}
.tp-item-del{background:transparent;border:none;color:var(--ink3);cursor:pointer;font-size:.8rem;flex-shrink:0;padding:.1rem;}
.tp-add-row{padding:.4rem .7rem .7rem;display:flex;gap:.4rem;flex-wrap:wrap;}
.tp-add-clip-btn{background:transparent;border:1px dashed var(--line);border-radius:6px;padding:.3rem .75rem;font-size:.72rem;color:var(--ink3);cursor:pointer;}
.tp-add-clip-btn:hover{border-color:var(--accent);color:var(--accent);}
.tp-add-custom-btn{background:var(--accent-light);border:1px solid var(--accent);border-radius:6px;padding:.3rem .75rem;font-size:.72rem;color:var(--accent);cursor:pointer;}
.tp-add-day-btn{background:transparent;border:2px dashed var(--line);border-radius:10px;padding:.75rem;text-align:center;font-size:.78rem;color:var(--ink3);cursor:pointer;margin-top:.5rem;}
.tp-add-day-btn:hover{border-color:var(--accent);color:var(--accent);}
/* „ÇØ„É™„ÉÉ„ÉóÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ */
.tp-clip-modal{position:fixed;inset:0;z-index:1500;display:none;}
.tp-clip-modal.open{display:flex;flex-direction:column;}
.tp-clip-overlay{position:absolute;inset:0;background:rgba(0,0,0,.5);}
.tp-clip-panel{position:relative;z-index:1;background:var(--white);border-radius:14px 14px 0 0;margin-top:auto;max-height:82vh;display:flex;flex-direction:column;}
.tp-clip-head{padding:.9rem 1rem .6rem;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:.6rem;}
.tp-clip-search{flex:1;background:var(--off);border:1px solid var(--line);border-radius:6px;padding:.38rem .65rem;font-size:.82rem;font-family:'Noto Sans JP',sans-serif;outline:none;}
.tp-clip-close{background:transparent;border:none;font-size:.85rem;cursor:pointer;color:var(--ink3);}
.tp-clip-list{overflow-y:auto;flex:1;padding:.5rem;}
.tp-clip-item{display:flex;align-items:center;gap:.6rem;padding:.45rem .5rem;border-radius:6px;cursor:pointer;}
.tp-clip-item:hover{background:var(--off);}
.tp-clip-item.selected{background:var(--accent-light);}
.tp-clip-thumb{width:42px;height:42px;border-radius:6px;object-fit:cover;flex-shrink:0;background:var(--line);}
.tp-clip-info{flex:1;min-width:0;}
.tp-clip-name{font-size:.8rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tp-clip-tag{font-size:.65rem;color:var(--ink3);}
.tp-clip-confirm{padding:.7rem 1rem;border-top:1px solid var(--line);}
.tp-clip-confirm button{width:100%;background:var(--ink);color:#fff;border:none;border-radius:8px;padding:.65rem;font-size:.85rem;cursor:pointer;font-family:'Noto Sans JP',sans-serif;}
/* „Ç´„Çπ„Çø„É†„Ç¢„Ç§„ÉÜ„É†ÂÖ•Âäõ */
.tp-custom-row{padding:.5rem .7rem;display:flex;gap:.4rem;}
.tp-custom-input{flex:1;background:var(--off);border:1px solid var(--line);border-radius:6px;padding:.38rem .65rem;font-size:.8rem;font-family:'Noto Sans JP',sans-serif;outline:none;}
.tp-custom-type{background:var(--off);border:1px solid var(--line);border-radius:6px;padding:.38rem .5rem;font-size:.76rem;font-family:'Noto Sans JP',sans-serif;color:var(--ink);outline:none;cursor:pointer;}
.tp-custom-add{background:var(--ink);color:#fff;border:none;border-radius:6px;padding:.38rem .85rem;font-size:.76rem;cursor:pointer;}
/* „Çµ„Éû„É™„Éº„Éê„Éº */
.tp-summary{background:var(--off);border-radius:8px;padding:.7rem 1rem;margin-bottom:1rem;display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;}
.tp-summary-item{font-size:.75rem;color:var(--ink2);}
.tp-summary-item b{color:var(--ink);}
/* „Éó„É©„É≥ÂêçÁ∑®ÈõÜ */
.tp-plan-name-input{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;background:transparent;border:none;border-bottom:2px solid var(--accent);outline:none;width:100%;max-width:400px;padding:.2rem 0;}
@media(max-width:768px){
  .tp-wrap{padding:1rem .75rem 5rem;}
  .tp-day-head{flex-wrap:wrap;gap:.4rem;}
}
</style>
</head>
<body>

<!-- REMINDER BAR -->
<div id="reminderBar">
  <span class="rb-label">üîî Today</span>
  <span id="rbEmpty" class="rb-empty">Êú¨Êó•„ÅÆ‰∫àÂÆö„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</span>
  <div id="rbItems" style="display:flex;gap:.4rem;flex-wrap:wrap;flex:1"></div>
</div>

<!-- HEADER -->
<header>
  <div class="hd">
    <div class="logo">XC<em>L</em>IP</div>
    <div class="hd-rule"></div>
    <div class="hd-stats">
      <div class="hd-stat"><div class="n" id="totalCount">0</div><div class="l">Clips</div></div>
      <div class="hd-stat"><div class="n" id="tagCount">0</div><div class="l">Tags</div></div>
    </div>
  </div>
</header>

<!-- TABS -->
<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('home')">üè† Home</button>
  <button class="tab-btn" onclick="switchTab('add')">Ôºã Add</button>
  <button class="tab-btn" onclick="switchTab('travel')">‚úàÔ∏è Trip</button>
  <button class="tab-btn" onclick="switchTab('settings')">‚öô Settings</button>
</div>

<!-- ACTIVE FILTER BADGE BAR -->
<div id="activeBadgeBar"></div>

<!-- MOBILE FILTER BAR -->
<div id="mobileFilterBar">
  <div class="mfb-scroll" id="mfbMain">
    <button class="mfb-pill active" data-f="all" onclick="setFilter('all')">„Åô„Åπ„Å¶</button>
    <button class="mfb-pill fav-pill" data-f="fav" onclick="setFilter('fav')">‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„Çä</button>
    <button class="mfb-pill yt-pill" data-f="yt-watchlater" onclick="setFilter('yt-watchlater')">üìå „ÅÇ„Å®„ÅßË¶ã„Çã</button>
    <button class="mfb-pill" data-f="untagged" onclick="setFilter('untagged')" style="color:var(--accent);border-color:var(--accent)">üè∑ „Çø„Ç∞Ë®≠ÂÆöÂâç</button>
    <button class="mfb-pill" data-f="recent" onclick="setFilter('recent')">ÊúÄËøëËøΩÂä†</button>
    <button class="mfb-pill accent" onclick="startHomePlaylist()">‚ñ∂ ÈÄ£Á∂öÂÜçÁîü</button>
    <button class="mfb-pill" onclick="toggleMfbExpand('Tags')">üè∑ „Çø„Ç∞ ‚ñæ</button>
    <button class="mfb-pill" onclick="toggleMfbExpand('Area')">üìç „Ç®„É™„Ç¢ ‚ñæ</button>
  </div>
  <div class="mfb-expand" id="mfbTags"></div>
  <div class="mfb-expand" id="mfbArea">
    <select class="area-select" id="mCountrySelect" onchange="setCountryFilter(this.value)" style="flex:1;min-width:120px"><option value="">ÂõΩ„ÇíÈÅ∏Êäû...</option></select>
    <select class="area-select" id="mPrefSelect" onchange="setPrefFilter(this.value)" style="flex:1;min-width:120px;display:none"><option value="">ÈÉΩÈÅìÂ∫úÁúå...</option></select>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-pane active" id="tab-home">
  <div class="home-wrap">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sb-section">
        <div class="sb-head">Filter</div>
        <button class="filter-btn active" id="fAll" onclick="setFilter('all')">„Åô„Åπ„Å¶ <span class="fc" id="cAll">0</span></button>
        <button class="filter-btn fav-btn" id="fFav" onclick="setFilter('fav')">‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„Çä <span class="fc" id="cFav">0</span></button>
        <button class="filter-btn yt-btn" id="fYtWl" onclick="setFilter('yt-watchlater')">üìå „ÅÇ„Å®„ÅßË¶ã„Çã <span class="fc" id="cYtWl">0</span></button>
        <button class="filter-btn" id="fRecent" onclick="setFilter('recent')">ÊúÄËøëËøΩÂä† <span class="fc" id="cRec">0</span></button>
        <button class="filter-btn" id="fUntagged" onclick="setFilter('untagged')" style="color:var(--accent)">üè∑ „Çø„Ç∞Ë®≠ÂÆöÂâç <span class="fc" id="cUntagged">0</span></button>
      </div>

      <div class="sb-section">
        <div class="sb-head">üìç „Ç®„É™„Ç¢</div>
        <select class="area-select" id="countrySelect" onchange="setCountryFilter(this.value)"><option value="">ÂõΩ„ÇíÈÅ∏Êäû...</option></select>
        <select class="area-select" id="prefSelect" onchange="setPrefFilter(this.value)" style="display:none"><option value="">ÈÉΩÈÅìÂ∫úÁúå„ÇíÈÅ∏Êäû...</option></select>
      </div>

      <div class="sb-section">
        <div class="sb-head">Tags</div>
        <div id="sideTagList"></div>
      </div>

      <div class="sb-section">
        <div class="sb-head">‚ñ∂ YouTube</div>
        <label class="watched-toggle" style="color:var(--ink2);font-size:.76rem;display:flex;align-items:center;gap:.4rem;cursor:pointer;padding:.2rem 0">
          <input type="checkbox" id="includeWatched" onchange="renderHome()"> Ë¶ñËÅ¥Ê∏à„Åø„ÇÇÂê´„ÇÅ„Çã
        </label>
        <button class="sb-play-btn" onclick="startHomePlaylist()">‚ñ∂ ÈÄ£Á∂öÂÜçÁîü</button>
      </div>
    </aside>

    <!-- MAIN -->
    <div class="main-area">
      <div id="contentAnchor"></div>

      <!-- YouTube Player Panel -->
      <div id="homeYtPanel">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.65rem">
          <span style="font-family:'DM Mono',monospace;font-size:.6rem;letter-spacing:.1em;opacity:.5">‚ñ∂ NOW PLAYING</span>
          <button class="yt-btn" onclick="closeHomePlayer()">‚úï Èñâ„Åò„Çã</button>
        </div>
        <div class="yt-panel-grid">
          <div>
            <div class="yt-iframe-wrap"><div id="homeYtIframeContainer"></div></div>
            <div class="yt-info" id="homeYtPlayInfo"></div>
            <div class="yt-controls">
              <button class="yt-btn" onclick="ytPrev()">‚óÄ Ââç„Å∏</button>
              <button class="yt-btn" onclick="ytNext()">Ê¨°„Å∏ ‚ñ∂</button>
              <button class="yt-btn green" onclick="markWatched()" style="margin-left:auto">‚úÖ Ë¶ñËÅ¥Ê∏à„Åø</button>
              <label class="watched-toggle" style="margin-left:.5rem"><input type="checkbox" id="plIncludeWatched" onchange="renderYtQueue()"> Ë¶ñËÅ¥Ê∏à„Åø„ÇÇË°®Á§∫</label>
            </div>
          </div>
          <div>
            <div style="font-family:'DM Mono',monospace;font-size:.6rem;opacity:.4;margin-bottom:.35rem">QUEUE</div>
            <div class="yt-queue" id="homeYtQueue"></div>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <div class="search-wrap">
          <span class="search-ico">üîç</span>
          <input class="search-fi" id="searchIn" placeholder="Ê§úÁ¥¢..." oninput="renderHome()">
        </div>
        <div class="mode-toggle">
          <button class="mode-btn active" id="modeA" onclick="setMode('A')">A: „Ç∏„É£„É≥„É´</button>
          <button class="mode-btn" id="modeB" onclick="setMode('B')">B: „Ç®„É™„Ç¢</button>
        </div>
        <div class="view-toggle">
          <button class="vt-btn active" id="vGrid" onclick="setView('grid')" title="„Ç∞„É™„ÉÉ„Éâ">‚äû</button>
          <button class="vt-btn" id="vList" onclick="setView('list')" title="„É™„Çπ„Éà">‚ò∞</button>
          <button class="vt-btn" id="vMap" onclick="setView('map')" title="„Éû„ÉÉ„Éó">üó∫</button>
        </div>
        <button class="c-btn" onclick="locateMe()" title="ÁèæÂú®Âú∞" style="white-space:nowrap">üìç ÁèæÂú®Âú∞</button>
      </div>
      <div class="result-info" id="resultInfo"></div>
      <!-- „Éû„ÉÉ„Éó „Ç®„É™„Ç¢Áµû„ÇäËæº„Åø„Éê„ÉºÔºà„Éû„ÉÉ„ÉóË°®Á§∫ÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ -->
      <div id="mapFilterBar" style="display:none;background:var(--white);border:1px solid var(--line);border-radius:8px;padding:.6rem .85rem;margin-bottom:.6rem;display:none">
        <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
          <span style="font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.15em;text-transform:uppercase;color:var(--ink3);white-space:nowrap">„Ç®„É™„Ç¢</span>
          <select id="mapCountrySelect" onchange="setMapCountryFilter(this.value)" style="flex:1;min-width:100px;max-width:160px;background:var(--off);border:1px solid var(--line);border-radius:5px;padding:.32rem .5rem;font-size:.76rem;font-family:'Noto Sans JP',sans-serif;color:var(--ink);outline:none;cursor:pointer">
            <option value="">„Åô„Åπ„Å¶„ÅÆÂõΩ</option>
          </select>
          <select id="mapPrefSelect" onchange="setMapPrefFilter(this.value)" style="display:none;flex:1;min-width:100px;max-width:160px;background:var(--off);border:1px solid var(--line);border-radius:5px;padding:.32rem .5rem;font-size:.76rem;font-family:'Noto Sans JP',sans-serif;color:var(--ink);outline:none;cursor:pointer">
            <option value="">„Åô„Åπ„Å¶„ÅÆÈÉΩÈÅìÂ∫úÁúå</option>
          </select>
          <button onclick="clearMapFilter()" style="background:transparent;border:1px solid var(--line);border-radius:5px;padding:.3rem .65rem;font-size:.7rem;color:var(--ink3);cursor:pointer;white-space:nowrap">„ÇØ„É™„Ç¢</button>
          <span id="mapFilterCount" style="font-family:'DM Mono',monospace;font-size:.64rem;color:var(--accent);margin-left:auto"></span>
        </div>
      </div>
      <div id="mapWrap" style="display:none;height:480px;border-radius:6px;border:1px solid var(--line);overflow:hidden;margin-bottom:1rem"></div>
      <div id="postsWrap"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-pane" id="tab-add">
  <div class="add-wrap">
    <div class="add-card" id="detailAddCard">
      <div class="type-tabs">
        <button class="type-tab active" id="typeX" onclick="setType('x')">ùïè „Éù„Çπ„Éà</button>
        <button class="type-tab" id="typeInsta" onclick="setType('instagram')">üì∏ Instagram</button>
        <button class="type-tab" id="typeWeb" onclick="setType('web')">üåê WebË®ò‰∫ã</button>
        <button class="type-tab" id="typeYt" onclick="setType('youtube')">‚ñ∂ YouTube</button>
        <button class="type-tab" id="typeTiktok" onclick="setType('tiktok')">üéµ TikTok</button>
        <button class="type-tab" id="typeMemo" onclick="setType('memo')">üìù „É°„É¢</button>
      </div>
      <div id="urlRow" class="url-row">
        <input class="url-field" id="urlIn" placeholder="URL„ÇíË≤º„Çä‰ªò„Åë...">
        <button class="fetch-btn" id="fetchBtn" onclick="fetchFromUrl()">ÊÉÖÂ†±ÂèñÂæó</button>
      </div>
      <div class="status-bar" id="statusBar"></div>
      <div class="fg">
        <div id="xFields" style="display:contents">
          <div><label class="fl">ÊäïÁ®øËÄÖÂêç</label><input class="fi" id="fAuthor" placeholder="Taro Yamada"></div>
          <div><label class="fl">„Éè„É≥„Éâ„É´</label><input class="fi" id="fHandle" placeholder="@handle"></div>
        </div>
        <div id="webFields" style="display:none;grid-column:1/-1">
          <div class="fg" style="margin:0">
            <div class="fg-full"><label class="fl">Ë®ò‰∫ã„Çø„Ç§„Éà„É´</label><input class="fi" id="fTitle" placeholder="Ëá™ÂãïÂèñÂæó„Åæ„Åü„ÅØÊâãÂãïÂÖ•Âäõ"></div>
            <div><label class="fl">„Çµ„Ç§„ÉàÂêç</label><input class="fi" id="fSite"></div>
            <div><label class="fl">ËëóËÄÖ</label><input class="fi" id="fAuthorWeb"></div>
          </div>
        </div>
        <div id="ytFields" style="display:none;grid-column:1/-1">
          <div class="fg" style="margin:0">
            <div class="fg-full"><label class="fl">ÂãïÁîª„Çø„Ç§„Éà„É´</label><input class="fi" id="fYtTitle"></div>
            <div><label class="fl">„ÉÅ„É£„É≥„Éç„É´Âêç</label><input class="fi" id="fYtChannel"></div>
          </div>
        </div>
        <div class="fg-full"><label class="fl">Êú¨Êñá„ÉªÂÜÖÂÆπ</label><textarea class="fta" id="fContent" placeholder="ÂÜÖÂÆπ..."></textarea></div>
        <div class="fg-full" id="summaryField" style="display:none"><label class="fl">‚ú® AIË¶ÅÁ¥Ñ</label><textarea class="fta" id="fSummary" style="min-height:55px"></textarea></div>
        <div class="fg-full"><label class="fl">„É°„É¢ÔºàURL„ÇÇÂèØÔºâ</label><input class="fi" id="fMemo" placeholder="„É°„É¢„ÇÑÂèÇËÄÉURL..."></div>
        <div class="fg-full">
          <label class="fl">ÁîªÂÉè</label>
          <input class="fi" id="fImgUrl" placeholder="https://... „Åæ„Åü„ÅØ‰∏ã„Åß„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû" oninput="prevImgUrl()" style="margin-bottom:.4rem">
          <div class="img-area" id="imgArea">
            <input type="file" accept="image/*" onchange="handleFile(event)">
            <div class="img-area-ph" id="imgPh"><span style="font-size:1.4rem">üì∑</span><span>„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÁîªÂÉè„ÇíÈÅ∏Êäû</span></div>
            <img class="img-area-prev" id="imgPrev" style="display:none">
          </div>
        </div>
        <!-- Instagram Ë§áÊï∞ÁîªÂÉè„Çª„É¨„ÇØ„Çø„ÉºÔºàInstagram„Çø„Ç§„Éó„ÅÆ„ÅøË°®Á§∫Ôºâ -->
        <div class="fg-full" id="instaImageSelector" style="display:none">
          <label class="fl">üì∏ Instagram ÁîªÂÉè„ÇíÈÅ∏ÊäûÔºàË§áÊï∞ÂèØÔºâ</label>
          <div id="instaImgGrid" style="display:flex;flex-wrap:wrap;gap:.45rem;margin-bottom:.5rem"></div>
          <div style="font-size:.7rem;color:var(--ink3);line-height:1.5" id="instaImgHint">ÊÉÖÂ†±ÂèñÂæóÂæå„Å´ÁîªÂÉè‰∏ÄË¶ß„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ„Çµ„É†„Éç„Ç§„É´„Å´„Åó„Åü„ÅÑÁîªÂÉè„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÊúÄÂàù„Å´ÈÅ∏„Çì„Å†„ÇÇ„ÅÆ„Åå„É°„Ç§„É≥ÁîªÂÉè„Å´„Å™„Çä„Åæ„ÅôÔºâ„ÄÇ</div>
        </div>
        <div class="fg-full">
          <label class="fl">üè∑ „Çø„Ç∞</label>
          <div class="tag-picker" id="formPicker"></div>
        </div>
        <div class="fg-full">
          <label class="fl">üìç „Ç®„É™„Ç¢Ôºà‰ªªÊÑèÔºâ</label>
          <div class="fg" style="margin:0">
            <div><label class="fl">ÂõΩ</label><input class="fi" id="fCountry" placeholder="Êó•Êú¨..."></div>
            <div><label class="fl">ÈÉΩÈÅìÂ∫úÁúå</label><input class="fi" id="fPrefecture" placeholder="Êù±‰∫¨ÈÉΩ..."></div>
            <div class="fg-full">
              <label class="fl">Ë©≥Á¥∞„Å™Â†¥ÊâÄ</label>
              <div style="display:flex;gap:.35rem">
                <input class="fi" id="fArea" placeholder="Ê∏ãË∞∑, Ê¢ÖÁî∞..." style="flex:1">
                <button class="btn-ghost" onclick="geocodeArea('f')" style="font-size:.7rem;white-space:nowrap">‰ΩçÁΩÆÂèñÂæó</button>
              </div>
              <div id="fAreaStatus" style="font-size:.68rem;color:var(--ink3);margin-top:.2rem"></div>
              <div style="margin-top:.35rem;display:flex;gap:.35rem">
                <input class="fi" id="fMapUrlInput" placeholder="Google„Éû„ÉÉ„ÉóURL..." style="flex:1;font-size:.72rem">
                <button class="btn-ghost" onclick="geocodeFromMapUrl('f')" style="font-size:.7rem;white-space:nowrap">üó∫ Âú∞Âõ≥URLÂèñÂæó</button>
              </div>
            </div>
          </div>
          <input type="hidden" id="fLat"><input type="hidden" id="fLng">
        </div>
        <div class="fg-full" style="background:var(--yellow-bg);border-radius:6px;padding:.75rem">
          <label class="fl" style="color:#92400e">üîî „É™„Éû„Ç§„É≥„ÉÄ„ÉºÔºà‰ªªÊÑèÔºâ</label>
          <div style="display:flex;gap:.4rem">
            <input type="date" class="fi" id="fRemindDate" style="flex:1">
            <input class="fi" id="fRemindMsg" placeholder="„É°„É¢..." style="flex:2">
          </div>
        </div>
        <div class="fg-full">
          <div class="flag-row">
            <label><input type="checkbox" id="fFavorite" style="accent-color:var(--yellow)"> ‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„Çä</label>
            <label id="watchLaterLabel" style="display:none"><input type="checkbox" id="fWatchLater" style="accent-color:var(--blue)"> üìå „ÅÇ„Å®„ÅßË¶ã„Çã</label>
            <label id="ytWatchedLabel" style="display:none"><input type="checkbox" id="fYtWatched" style="accent-color:var(--green)"> ‚úÖ Ë¶ñËÅ¥Ê∏à„Åø</label>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn-ghost" onclick="clearForm()">„ÇØ„É™„Ç¢</button>
        <button class="btn-solid" onclick="savePost()">‰øùÂ≠ò„Åô„Çã</button>
      </div>
    </div><!-- /detailAddCard -->
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TRAVEL PLANNER TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-pane" id="tab-travel">
  <div class="tp-wrap">
    <!-- „Éó„É©„É≥‰∏ÄË¶ß -->
    <div id="tpListView">
      <div class="tp-header">
        <div class="tp-title">‚úàÔ∏è ÊóÖË°å„Éó„É©„É≥„Éä„Éº</div>
        <button class="tp-new-btn" onclick="tpNewPlan()">Ôºã Êñ∞„Åó„ÅÑ„Éó„É©„É≥</button>
      </div>
      <div id="tpPlansList"></div>
      <div id="tpEmptyMsg" style="text-align:center;padding:3rem 1rem;color:var(--ink3);font-size:.85rem;display:none">
        <div style="font-size:2.5rem;margin-bottom:.75rem">‚úàÔ∏è</div>
        <div>„Åæ„Å†„Éó„É©„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
        <div style="font-size:.75rem;margin-top:.35rem">„ÄåÊñ∞„Åó„ÅÑ„Éó„É©„É≥„Äç„Åã„ÇâÊóÖË°å„Çí‰ΩúÊàê„Åó„Åæ„Åó„Çá„ÅÜ</div>
      </div>
    </div>
    <!-- „Éó„É©„É≥„Ç®„Éá„Ç£„Çø -->
    <div id="tpEditor" class="tp-editor">
      <button class="tp-back-btn" onclick="tpBackToList()">‚Üê „Éó„É©„É≥‰∏ÄË¶ß„Å´Êàª„Çã</button>
      <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:.75rem;flex-wrap:wrap">
        <input class="tp-plan-name-input" id="tpPlanNameInput" placeholder="„Éó„É©„É≥Âêç„ÇíÂÖ•Âäõ...">
        <button onclick="tpSavePlan()" style="background:var(--ink);color:#fff;border:none;border-radius:6px;padding:.4rem 1rem;font-size:.76rem;cursor:pointer;font-family:'Noto Sans JP',sans-serif">‰øùÂ≠ò</button>
        <button onclick="tpDeletePlan()" style="background:transparent;border:1px solid #fca5a5;border-radius:6px;padding:.4rem .8rem;font-size:.72rem;color:#dc2626;cursor:pointer">ÂâäÈô§</button>
      </div>
      <div class="tp-summary" id="tpSummary"></div>
      <div class="tp-days-wrap" id="tpDaysWrap"></div>
      <div class="tp-add-day-btn" onclick="tpAddDay()">Ôºã Êó•Á®ã„ÇíËøΩÂä†</div>
    </div>
  </div>
</div>

<!-- Travel: „ÇØ„É™„ÉÉ„ÉóÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
<div class="tp-clip-modal" id="tpClipModal">
  <div class="tp-clip-overlay" onclick="tpCloseClipModal()"></div>
  <div class="tp-clip-panel">
    <div class="tp-clip-head">
      <input class="tp-clip-search" id="tpClipSearch" placeholder="„ÇØ„É™„ÉÉ„Éó„ÇíÊ§úÁ¥¢..." oninput="tpRenderClipList()">
      <button class="tp-clip-close" onclick="tpCloseClipModal()">‚úï Èñâ„Åò„Çã</button>
    </div>
    <div class="tp-clip-list" id="tpClipList"></div>
    <div class="tp-clip-confirm">
      <button onclick="tpConfirmClips()">ÈÅ∏Êäû„Åó„Åü„ÇØ„É™„ÉÉ„Éó„ÇíËøΩÂä†</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-pane" id="tab-settings">
  <div class="settings-wrap">
    <div class="settings-grid">
      <!-- „Çø„Ç∞ÁÆ°ÁêÜ -->
      <div class="settings-card">
        <div class="settings-title">„Çø„Ç∞ÁÆ°ÁêÜÔºà„Éâ„É©„ÉÉ„Ç∞‰∏çÂèØ„ÅÆÂ†¥Âêà‚Üë‚Üì„Åß‰∏¶„ÅπÊõø„ÅàÔºâ</div>
        <div id="tagMgrList"></div>
        <div class="add-row" style="margin-top:.65rem">
          <input id="newTagIn" placeholder="Êñ∞„Åó„ÅÑ„Çø„Ç∞..." maxlength="20">
          <input type="color" id="newTagColor" value="#3b82f6" title="Ëâ≤„ÇíÈÅ∏Êäû" style="width:36px;padding:2px;border:1px solid var(--line);border-radius:4px;">
          <button onclick="addTag()">ËøΩÂä†</button>
        </div>
        <div style="margin-top:.9rem;padding-top:.9rem;border-top:1px solid var(--line)">
          <div style="font-size:.72rem;color:var(--ink3);margin-bottom:.4rem">„Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™„Éº„ÇíËøΩÂä†</div>
          <select class="area-select" id="parentTagSelect"><option value="">Ë¶™„Çø„Ç∞„ÇíÈÅ∏Êäû...</option></select>
          <div class="add-row">
            <input id="newSubTagIn" placeholder="„Çµ„Éñ„Çø„Ç∞Âêç..." maxlength="20">
            <button onclick="addSubTag()">ËøΩÂä†</button>
          </div>
        </div>
      </div>

      <!-- „É™„Éû„Ç§„É≥„ÉÄ„Éº -->
      <div class="settings-card">
        <div class="settings-title">„É™„Éû„Ç§„É≥„ÉÄ„Éº‰∏ÄË¶ß</div>
        <div id="allRemindersList"></div>
      </div>

      <!-- YouTubeÈÄ£Á∂öÂÜçÁîü -->
      <div class="settings-card">
        <div class="settings-title">YouTube ÈÄ£Á∂öÂÜçÁîüË®≠ÂÆö</div>
        <div style="font-size:.78rem;color:var(--ink2);margin-bottom:.65rem">„Çø„Ç∞„ÅßÁµû„ÇäËæº„Çì„ÅßHome„Çø„Éñ„ÅßÂÜçÁîü</div>
        <select class="area-select" id="ytPlayTag"><option value="">„Çø„Ç∞„ÅßÁµû„ÇäËæº„ÅøÔºà‰ªªÊÑèÔºâ</option></select>
        <button class="btn-solid" onclick="startHomePlaylist();switchTab('home')" style="width:100%;margin-top:.65rem">‚ñ∂ ÈÄ£Á∂öÂÜçÁîü„Çπ„Çø„Éº„Éà</button>
      </div>

      <!-- Áµ±Ë®à -->
      <div class="settings-card">
        <div class="settings-title">Áµ±Ë®à</div>
        <div id="statsWrap" style="font-size:.8rem;line-height:2.1;color:var(--ink2)"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- Detail (desktop modal / SP drawer) -->
<div class="overlay" id="detailModal">
  <div class="modal" id="detailModalInner">
    <div class="modal-sticky-head">
      <span class="modal-title">Ë©≥Á¥∞</span>
      <button class="modal-close-sticky" onclick="closeModal('detailModal')">‚úï Èñâ„Åò„Çã</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
  </div>
</div>

<!-- Detail Drawer (SP) -->
<div class="drawer-overlay" id="detailDrawer">
  <div class="drawer" id="detailDrawerInner">
    <div class="drawer-handle"></div>
    <div class="drawer-sticky-head">
      <span class="modal-title">Ë©≥Á¥∞</span>
      <button class="modal-close-sticky" onclick="closeDrawer()">‚úï Èñâ„Åò„Çã</button>
    </div>
    <div class="drawer-body" id="detailDrawerBody"></div>
  </div>
</div>

<!-- Edit -->
<div class="overlay" id="editModal">
  <div class="modal">
    <div class="modal-sticky-head">
      <span class="modal-title">Á∑®ÈõÜ</span>
      <button class="modal-close-sticky" onclick="closeModal('editModal')">‚úï Èñâ„Åò„Çã</button>
    </div>
    <div class="modal-body">
    <div class="fg">
      <div><label class="fl">ÊäïÁ®øËÄÖÂêç / „Çø„Ç§„Éà„É´</label><input class="fi" id="eAuthor"></div>
      <div><label class="fl">„Éè„É≥„Éâ„É´ / „Çµ„Ç§„ÉàÂêç</label><input class="fi" id="eHandle"></div>
      <div class="fg-full"><label class="fl">Êú¨Êñá</label><textarea class="fta" id="eContent"></textarea></div>
      <div class="fg-full"><label class="fl">„É°„É¢</label><input class="fi" id="eMemo"></div>
      <div class="fg-full">
        <label class="fl">ÁîªÂÉèURL</label>
        <input class="fi" id="eImgUrl" style="margin-bottom:.35rem" oninput="eImgPrev()">
        <div class="img-area" id="eImgArea" style="min-height:70px">
          <input type="file" accept="image/*" onchange="handleEditFile(event)">
          <div class="img-area-ph" id="eImgPh"><span style="font-size:1.2rem">üì∑</span><span>„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Â§âÊõ¥</span></div>
          <img class="img-area-prev" id="eImgPrevImg" style="display:none">
        </div>
      </div>
      <div><label class="fl">ÂõΩ</label><input class="fi" id="eCountry"></div>
      <div><label class="fl">ÈÉΩÈÅìÂ∫úÁúå</label><input class="fi" id="ePrefecture"></div>
      <div class="fg-full">
        <label class="fl">Ë©≥Á¥∞„Å™Â†¥ÊâÄ</label>
        <div style="display:flex;gap:.35rem">
          <input class="fi" id="eArea" style="flex:1">
          <button class="btn-ghost" onclick="geocodeArea('e')" style="font-size:.7rem;white-space:nowrap">‰ΩçÁΩÆÂèñÂæó</button>
        </div>
        <div id="eAreaStatus" style="font-size:.68rem;color:var(--ink3);margin-top:.2rem"></div>
        <div style="margin-top:.35rem;display:flex;gap:.35rem">
          <input class="fi" id="eMapUrlInput" placeholder="Google„Éû„ÉÉ„ÉóURLÔºà‰ΩçÁΩÆÊÉÖÂ†±„ÅÆ‰øÆÊ≠£„Å´Ôºâ..." style="flex:1;font-size:.72rem">
          <button class="btn-ghost" onclick="geocodeFromMapUrl('e')" style="font-size:.7rem;white-space:nowrap">üó∫ Âú∞Âõ≥URLÂèñÂæó</button>
        </div>
        <input type="hidden" id="eLat"><input type="hidden" id="eLng">
      </div>
      <div class="fg-full">
        <label class="fl">üó∫ Google„Éû„ÉÉ„ÉóURLÔºà‰ªªÊÑè„ÉªÊâãÂãïÁ∑®ÈõÜÂèØÔºâ</label>
        <input class="fi" id="eMapUrl" placeholder="https://maps.google.com/...">
      </div>
      <div class="fg-full" id="eYtFields" style="display:none">
        <div class="flag-row">
          <label><input type="checkbox" id="eYtWatched" style="accent-color:var(--green)"> ‚úÖ Ë¶ñËÅ¥Ê∏à„Åø</label>
          <label><input type="checkbox" id="eWatchLater" style="accent-color:var(--blue)"> üìå „ÅÇ„Å®„ÅßË¶ã„Çã</label>
        </div>
      </div>
      <div class="fg-full">
        <div class="flag-row">
          <label><input type="checkbox" id="eFavorite" style="accent-color:var(--yellow)"> ‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„Çä</label>
        </div>
      </div>
      <div class="fg-full"><label class="fl">„Çø„Ç∞</label><div class="tag-picker" id="editPicker"></div></div>
    </div>
    <div class="form-actions">
      <button class="btn-ghost" onclick="closeModal('editModal')">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn-solid" onclick="saveEdit()">Êõ¥Êñ∞„Åô„Çã</button>
    </div>
    </div><!-- /modal-body -->
  </div>
</div>
<div class="overlay" id="reminderModal">
  <div class="modal">
    <div class="modal-sticky-head">
      <span class="modal-title">üîî „É™„Éû„Ç§„É≥„ÉÄ„Éº</span>
      <button class="modal-close-sticky" onclick="closeModal('reminderModal')">‚úï Èñâ„Åò„Çã</button>
    </div>
    <div class="modal-body">
    <div id="reminderPostInfo" style="background:var(--off);border-radius:4px;padding:.7rem .9rem;margin-bottom:.9rem;font-size:.8rem;color:var(--ink2)"></div>
    <div class="fg">
      <div class="fg-full"><label class="fl">„É™„Éû„Ç§„É≥„ÉâÊó•</label><input type="date" class="fi" id="rDate"></div>
      <div class="fg-full"><label class="fl">„É°„É¢Ôºà‰ªªÊÑèÔºâ</label><input class="fi" id="rMessage" placeholder="„ÅÇ„Å®„ÅßË™≠„ÇÄ..."></div>
    </div>
    <div id="existingReminders" style="margin-top:.65rem"></div>
    <div class="form-actions">
      <button class="btn-ghost" onclick="closeModal('reminderModal')">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn-solid" onclick="saveReminder()">Ë®≠ÂÆö„Åô„Çã</button>
    </div>
    </div><!-- /modal-body -->
  </div>
</div>

<!-- BOTTOM NAV -->
<!-- QUICK ADD SHEET (SP only) -->
<div id="quickAddSheet">
  <div class="qa-overlay" onclick="closeQuickAdd()"></div>
  <div class="qa-panel">
    <div class="qa-handle"></div>
    <div class="qa-head">
      <div>
        <div class="qa-title">„ÇØ„Ç§„ÉÉ„ÇØ‰øùÂ≠ò</div>
        <div style="font-size:.7rem;color:var(--ink3);margin-top:.1rem">URL„ÇíË≤º„Çã„Å†„Åë„Åß‰øùÂ≠ò„ÄÇ„Çø„Ç∞„ÅØÂæå„ÅßË®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ</div>
      </div>
      <button class="qa-close" onclick="closeQuickAdd()">‚úï</button>
    </div>
    <div class="qa-body">
      <!-- URLÂÖ•Âäõ -->
      <div class="qa-url-wrap">
        <input class="qa-url-input" id="qsUrl" placeholder="URL„ÇíË≤º„Çä‰ªò„Åë..."
               oninput="qsOnInput()" onpaste="setTimeout(qsOnPaste,50)">
        <button class="qa-fetch-btn" id="qsFetchBtn" onclick="qsFetch()" style="display:none">ÂèñÂæó</button>
      </div>
      <!-- Ëá™ÂãïÂà§Âà•„Éê„ÉÉ„Ç∏ -->
      <div id="qsTypeBadge" style="display:none;margin-bottom:.6rem"></div>
      <!-- „Çπ„ÉÜ„Éº„Çø„Çπ -->
      <div class="qa-status" id="qsStatus"></div>
      <!-- „Éó„É¨„Éì„É•„Éº -->
      <div class="qa-preview" id="qsPreview">
        <img class="qa-preview-img" id="qsPreviewImg" style="display:none">
        <div class="qa-preview-title" id="qsPreviewTitle"></div>
        <div class="qa-preview-sub" id="qsPreviewSub"></div>
      </div>
      <!-- „É°„É¢ -->
      <div class="qa-memo-wrap">
        <label class="qa-memo-label">üìù „É°„É¢Ôºà‰ªªÊÑèÔºâ</label>
        <textarea class="qa-memo" id="qsMemo" placeholder="ÊÑüÊÉ≥„Éª„É°„É¢..."></textarea>
      </div>
      <!-- ‰øùÂ≠ò„Éú„Çø„É≥ -->
      <button class="qa-save-btn" id="qsSaveBtn" onclick="qsSave()" disabled>‰øùÂ≠ò„Åô„Çã</button>
      <span class="qa-detail-link" onclick="closeQuickAdd();switchTab('add')">Ë©≥Á¥∞Ë®≠ÂÆöÔºà„Çø„Ç∞„Éª„Ç®„É™„Ç¢„Å™„Å©Ôºâ„ÅØ„Åì„Å°„Çâ ‚ñ∂</span>
    </div>
  </div>
</div>

<nav id="bottomNav">
  <div class="bn-inner">
    <button class="bn-btn active" id="bnHome" onclick="switchTab('home');bnActive('bnHome')">
      <span class="bn-icon">üè†</span><span>HOME</span>
    </button>
    <button class="bn-btn" id="bnAdd" onclick="onBnAdd()">
      <span class="bn-icon">Ôºã</span><span>ËøΩÂä†</span>
    </button>
    <button class="bn-btn" id="bnTravel" onclick="switchTab('travel');bnActive('bnTravel')">
      <span class="bn-icon">‚úàÔ∏è</span><span>Trip</span>
    </button>
    <button class="bn-btn" id="bnSettings" onclick="switchTab('settings');bnActive('bnSettings')">
      <span class="bn-icon">‚öô</span><span>Ë®≠ÂÆö</span>
    </button>
  </div>
</nav>

<!-- LIGHTBOX -->
<div id="lightbox" onclick="closeLightbox()">
  <button id="lbClose" onclick="closeLightbox()">‚úï</button>
  <img id="lbImg" src="" alt="">
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SB_URL='https://hpgcymyyugrzblvahkcc.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwZ2N5bXl5dWdyemJsdmFoa2NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MjAxOTEsImV4cCI6MjA4NzM5NjE5MX0.l2C4TWVU-CeMPB3Thz238z5qqeiOsFLhkm-GlOYVL8o';

async function sb(path,method='GET',body=null){
  const h={'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json'};
  if(method==='POST') h['Prefer']='return=representation,resolution=merge-duplicates';
  if(method==='PATCH') h['Prefer']='return=representation';
  const opts={method,headers:h};
  if(body) opts.body=JSON.stringify(body);
  const r=await fetch(SB_URL+'/rest/v1/'+path,opts);
  if(!r.ok){const e=await r.text();throw new Error(e);}
  const t=await r.text(); return t?JSON.parse(t):[];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let posts=[],tags=[],reminders=[];
let curFilter='all',tagFilter=null,viewMode='grid',displayMode='A';
let areaFilter={country:null,prefecture:null};
let fSel=new Set(),eSel=new Set();
let editId=null,reminderPostId=null,currentType='x';
let myLat=null,myLng=null;
let map=null,mapMarkers=[];
let ytPlaylist=[],ytPlayIdx=0;
let ytPlayer=null,ytApiReady=false;
const COLORS=['#3b82f6','#8b5cf6','#e11d48','#d97706','#059669','#0891b2','#65a30d','#9333ea','#ea580c','#6366f1'];
// LocalStorage: „Çø„Ç∞‰∏¶„Å≥È†ÜÔºà„É≠„Éº„Ç´„É´„Ç≠„É£„ÉÉ„Ç∑„É•Ôºâ
function loadTagOrder(){return JSON.parse(localStorage.getItem('xclip_tag_order')||'[]');}
function saveTagOrder(ids){
  localStorage.setItem('xclip_tag_order',JSON.stringify(ids));
  // Supabase„Å´„ÇÇÈùûÂêåÊúü„Åß‰øùÂ≠òÔºà„Éá„Éê„Ç§„ÇπÈñìÂêåÊúüÔºâ
  ids.forEach((id,i)=>{
    sb('tags?id=eq.'+id,'PATCH',{sort_order:i}).catch(()=>{});
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init(){
  toast('Ë™≠„ÅøËæº„Åø‰∏≠...','');
  try{
    const [rawP,rawT,rawR]=await Promise.all([
      sb('posts?select=*&order=created_at.desc'),
      sb('tags?select=*&order=sort_order.asc,name.asc'),
      sb('reminders?select=*&order=remind_at.asc')
    ]);
    posts=rawP.map(mapPost);
    tags=applyTagOrder(rawT);
    reminders=rawR;
    if(!tags.length){
      const defs=[['ÂèÇËÄÉ','#3b82f6'],['ÊäÄË°ì','#8b5cf6'],['„Éá„Ç∂„Ç§„É≥','#e11d48'],['„Éã„É•„Éº„Çπ','#d97706'],['„Ç§„É≥„Çπ„Éî„É¨„Éº„Ç∑„Éß„É≥','#059669'],['„ÅäÊ∞ó„Å´ÂÖ•„Çä','#f59e0b']];
      for(let i=0;i<defs.length;i++){
        const t={id:'t'+(Date.now()+i),name:defs[i][0],color:defs[i][1],parent_id:null,sort_order:i};
        await sb('tags','POST',t); tags.push(t);
      }
    }
    renderAll(); renderReminderBar(); renderSettings();
    setTimeout(()=>{document.getElementById('toast').className='toast';},600);
    setInterval(renderReminderBar,60000);
    loadYtApi();
  }catch(e){toast('Êé•Á∂ö„Ç®„É©„Éº: '+e.message,'err');console.error(e);}
}

function applyTagOrder(rawTags){
  // Supabase„ÅÆsort_order„Åß‰∏ÄÊ¨°„ÇΩ„Éº„Éà„ÄÅLocalStorage„ÅßË£úÂÆå
  const bySortOrder=[...rawTags].sort((a,b)=>(a.sort_order??999)-(b.sort_order??999));
  const order=loadTagOrder();
  if(!order.length) return bySortOrder;
  // LocalStorage„ÅÆÈ†ÜÂ∫è„Åå„ÅÇ„Çå„Å∞„Åù„Å°„Çâ„ÇíÂÑ™ÂÖàÔºà„Çà„ÇäÊñ∞„Åó„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„ÇãÔºâ
  const map=new Map(bySortOrder.map(t=>[t.id,t]));
  const sorted=order.map(id=>map.get(id)).filter(Boolean);
  bySortOrder.forEach(t=>{if(!order.includes(t.id)) sorted.push(t);});
  return sorted;
}

function mapPost(r){
  return{
    id:r.id,url:r.url||'',author:r.author||'',handle:r.handle||'',
    content:r.content||'',memo:r.memo||'',image:r.image||'',
    tags:r.tags||[],createdAt:typeof r.created_at==='number'?r.created_at:new Date(r.created_at).getTime()||0,
    area:r.area||'',country:r.country||'',prefecture:r.prefecture||'',
    lat:r.lat||null,lng:r.lng||null,
    type:r.type||'x',summary:r.summary||'',
    youtube_status:r.youtube_status||'unwatch',
    youtube_priority:r.youtube_priority||false,
    is_favorite:r.is_favorite||false,
    watch_later:r.watch_later||false,
    map_url:r.map_url||null,
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab){
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  ['home','add','travel','settings'].forEach((t,i)=>{
    if(t===tab) document.querySelectorAll('.tab-btn')[i]?.classList.add('active');
  });
  const bnMap={home:'bnHome',add:'bnAdd',travel:'bnTravel',settings:'bnSettings'};
  document.querySelectorAll('.bn-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(bnMap[tab])?.classList.add('active');
  if(tab==='home') renderHome();
  if(tab==='settings') renderSettings();
  if(tab==='travel') tpRenderList();
  window.scrollTo({top:0,behavior:'smooth'});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIGHTBOX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openLightbox(src){
  const lb=document.getElementById('lightbox');
  const img=document.getElementById('lbImg');
  if(!lb||!img||!src) return;
  img.src=src;
  lb.classList.add('open');
  document.body.style.overflow='hidden';
}
function closeLightbox(){
  document.getElementById('lightbox')?.classList.remove('open');
  document.body.style.overflow='';
}
document.addEventListener('keydown',e=>{if(e.key==='Escape') closeLightbox();});

function bnActive(id){
  document.querySelectorAll('.bn-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id)?.classList.add('active');
}

function onBnAdd(){
  // „Çπ„Éû„Éõ: „ÇØ„Ç§„ÉÉ„ÇØÁôªÈå≤„Ç∑„Éº„Éà / PC: ÈÄöÂ∏∏„ÅÆAdd„Çø„Éñ
  if(window.innerWidth<=768){openQuickAdd();}
  else{switchTab('add');bnActive('bnAdd');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUICK ADD SHEET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let qsData={url:'',type:'web',author:'',handle:'',content:'',image:''};
let qsFetching=false;

const QS_TYPE_INFO={
  youtube:{label:'‚ñ∂ YouTube',bg:'#dc2626'},
  tiktok:{label:'üéµ TikTok',bg:'#010101'},
  x:{label:'ùïè X(Twitter)',bg:'#111'},
  instagram:{label:'üì∏ Instagram',bg:'#c13584'},
  web:{label:'üåê WebË®ò‰∫ã',bg:'#0369a1'},
};
function qsDetectType(url){
  if(/youtube\.com|youtu\.be/.test(url)) return 'youtube';
  if(/tiktok\.com/.test(url)) return 'tiktok';
  if(/x\.com\/|twitter\.com\//.test(url)) return 'x';
  if(/instagram\.com\//.test(url)) return 'instagram';
  return 'web';
}

function openQuickAdd(){
  document.getElementById('quickAddSheet').classList.add('open');
  ['qsUrl','qsMemo'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  const s=document.getElementById('qsStatus');if(s){s.textContent='';s.className='qa-status';}
  const pr=document.getElementById('qsPreview');if(pr)pr.className='qa-preview';
  const sb=document.getElementById('qsSaveBtn');if(sb)sb.disabled=true;
  const fb=document.getElementById('qsFetchBtn');if(fb)fb.style.display='none';
  const tb=document.getElementById('qsTypeBadge');if(tb)tb.style.display='none';
  qsData={url:'',type:'web',author:'',handle:'',content:'',image:''};
  qsFetching=false;
  setTimeout(()=>{const e=document.getElementById('qsUrl');if(e)e.focus();},350);
}

function closeQuickAdd(){
  document.getElementById('quickAddSheet').classList.remove('open');
}

function qsOnInput(){
  const urlEl=document.getElementById('qsUrl'); if(!urlEl) return;
  const url=urlEl.value.trim();
  const badge=document.getElementById('qsTypeBadge');
  const fetchBtn=document.getElementById('qsFetchBtn');
  const saveBtn=document.getElementById('qsSaveBtn');
  if(!url){
    if(badge)badge.style.display='none';
    if(fetchBtn)fetchBtn.style.display='none';
    if(saveBtn)saveBtn.disabled=true;
    return;
  }
  const type=qsDetectType(url);
  const t=QS_TYPE_INFO[type];
  if(badge){
    badge.innerHTML=`<span style="background:${t.bg};color:#fff;font-size:.72rem;padding:.2rem .75rem;border-radius:12px;font-family:'DM Mono',monospace;display:inline-block">${t.label}</span>`;
    badge.style.display='block';
  }
  if(fetchBtn)fetchBtn.style.display='block';
  if(saveBtn)saveBtn.disabled=false;
  qsData.url=url;qsData.type=type;
}

async function qsOnPaste(){
  // „Éö„Éº„Çπ„ÉàÂæå50msÂæÖ„Å£„Å¶„Åã„ÇâÂÖ•ÂäõÂá¶ÁêÜ ‚Üí Ëá™ÂãïÂèñÂæó
  setTimeout(async()=>{
    qsOnInput();
    const url=(document.getElementById('qsUrl')||{}).value?.trim();
    if(url&&!qsFetching) await qsFetch();
  },80);
}

async function qsFetch(){
  const urlEl=document.getElementById('qsUrl');if(!urlEl)return;
  const url=urlEl.value.trim();
  if(!url||qsFetching) return;
  qsFetching=true;
  const fetchBtn=document.getElementById('qsFetchBtn');
  const status=document.getElementById('qsStatus');
  if(fetchBtn){fetchBtn.disabled=true;fetchBtn.textContent='ÂèñÂæó‰∏≠...';}
  if(status){status.textContent='ÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...';status.className='qa-status show';}

  const type=qsDetectType(url);
  qsData.type=type;qsData.url=url;

  try{
    if(type==='instagram'){
      // „ÇØ„Ç§„ÉÉ„ÇØ„Ç∑„Éº„Éà„Åß„ÅØOGP1Êûö„ÅÆ„ÅøÂèñÂæóÔºàË©≥Á¥∞„Éï„Ç©„Éº„É†„ÅßË§áÊï∞ÈÅ∏ÊäûÊé®Â•®Ôºâ
      const shortcode=url.match(/instagram\.com\/(?:p|reel|tv)\/([A-Za-z0-9_-]+)/)?.[1]||'';
      const usernameFromUrl=url.match(/instagram\.com\/([^\/\?]+)\/(?:p|reel)/)?.[1]||'';
      qsData.handle=usernameFromUrl?'@'+usernameFromUrl:'';
      qsData.author=usernameFromUrl||'Instagram';
      let gotData=false;
      const proxies=[
        `https://corsproxy.io/?${encodeURIComponent(url)}`,
        `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`
      ];
      for(const px of proxies){
        try{
          const r=await fetch(px,{signal:AbortSignal.timeout(8000)});
          const rawHtml=px.includes('allorigins')?(await r.json()).contents||'':await r.text();
          if(!rawHtml) continue;
          const doc=new DOMParser().parseFromString(rawHtml,'text/html');
          const g=(sel,a)=>doc.querySelector(sel)?.getAttribute(a)||'';
          const uMatch=rawHtml.match(/"username":"([^"]+)"/);
          if(uMatch){qsData.author=uMatch[1];qsData.handle='@'+uMatch[1];}
          const desc=g('meta[property="og:description"]','content')||'';
          if(desc) qsData.content=desc.replace(/^[^:]+:\s*/,'').slice(0,200);
          const img=g('meta[property="og:image"]','content')||g('meta[name="twitter:image"]','content')||'';
          if(img) qsData.image=img;
          gotData=true; break;
        }catch(e){continue;}
      }
      if(status) status.textContent=gotData
        ?'‚úì InstagramÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Åæ„Åó„ÅüÔºàË©≥Á¥∞„Éï„Ç©„Éº„É†„ÅßË§áÊï∞ÁîªÂÉè„ÇíÈÅ∏Êäû„Åß„Åç„Åæ„ÅôÔºâ'
        :'‚ö† Ë©≥Á¥∞ÊÉÖÂ†±ÂèñÂæóÂ§±Êïó„ÄÇURL„ÅÆ„Åø‰øùÂ≠ò„Åó„Åæ„Åô';

    }else if(type==='x'){
      const vid=url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/)?.[1]||'';
      try{
        const r=await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
        const d=await r.json();
        qsData.author=d.title||'YouTubeÂãïÁîª';qsData.handle=d.author_name||'';
        if(vid) qsData.image=`https://img.youtube.com/vi/${vid}/mqdefault.jpg`;
        if(status) status.textContent='‚úì YouTubeÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü';
      }catch(e){
        qsData.author='YouTubeÂãïÁîª';
        if(vid) qsData.image=`https://img.youtube.com/vi/${vid}/mqdefault.jpg`;
        if(status) status.textContent='‚úì YouTubeÂãïÁîª„Å®„Åó„Å¶ÁôªÈå≤„Åó„Åæ„Åô';
      }

    }else if(type==='tiktok'){
      const handle=url.match(/tiktok\.com\/@([\w.]+)/)?.[1]||'';
      qsData.handle='@'+handle;qsData.author=handle||'TikTok';
      try{
        const r=await fetch(`https://www.tiktok.com/oembed?url=${encodeURIComponent(url)}`);
        const d=await r.json();
        if(d.author_name)qsData.author=d.author_name;
        if(d.thumbnail_url)qsData.image=d.thumbnail_url;
        if(d.title)qsData.content=d.title;
        if(status) status.textContent='‚úì TikTokÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü';
      }catch(e){if(status) status.textContent='‚úì TikTok„Å®„Åó„Å¶ÁôªÈå≤„Åó„Åæ„Åô';}

    }else if(type==='x'){
      const m=url.match(/(?:twitter\.com|x\.com)\/@?([\w]+)\/status\/(\d+)/);
      if(m){qsData.handle='@'+m[1];qsData.author=m[1];}
      try{
        const r=await fetch(`https://publish.twitter.com/oembed?url=${encodeURIComponent(url)}&omit_script=true`);
        const d=await r.json();
        if(d.author_name) qsData.author=d.author_name;
        const doc=new DOMParser().parseFromString(d.html||'','text/html');
        qsData.content=doc.querySelector('p')?.textContent||'';
        if(status) status.textContent='‚úì X(Twitter)ÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü';
      }catch(e){if(status) status.textContent='‚úì X„Éù„Çπ„Éà„Å®„Åó„Å¶ÁôªÈå≤„Åó„Åæ„Åô';}

    }else{
      const proxies=[
        `https://corsproxy.io/?${encodeURIComponent(url)}`,
        `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`
      ];
      let html='';
      for(const px of proxies){
        try{
          const r=await fetch(px,{signal:AbortSignal.timeout(7000)});
          html=px.includes('allorigins')?(await r.json()).contents||'':await r.text();
          if(html) break;
        }catch(e){continue;}
      }
      if(html){
        const doc=new DOMParser().parseFromString(html,'text/html');
        const g=(sel,a)=>doc.querySelector(sel)?.getAttribute(a)||'';
        qsData.author=g('meta[property="og:title"]','content')||g('meta[name="twitter:title"]','content')||doc.querySelector('title')?.textContent||url;
        qsData.handle=g('meta[property="og:site_name"]','content')||new URL(url).hostname;
        qsData.content=g('meta[property="og:description"]','content')||g('meta[name="description"]','content')||'';
        qsData.image=g('meta[property="og:image"]','content')||g('meta[name="twitter:image"]','content')||'';
        if(status) status.textContent='‚úì Ë®ò‰∫ãÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü';
      }else{
        try{qsData.author=new URL(url).hostname;qsData.handle=qsData.author;}catch(e){qsData.author=url;}
        if(status) status.textContent='‚ö† ÊÉÖÂ†±ÂèñÂæóÂ§±Êïó„ÄÇURL„ÅÆ„Åø‰øùÂ≠ò„Åß„Åç„Åæ„Åô';
      }
    }
    // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
    const prev=document.getElementById('qsPreview');
    const img=document.getElementById('qsPreviewImg');
    const tEl=document.getElementById('qsPreviewTitle');
    const sEl=document.getElementById('qsPreviewSub');
    if(tEl) tEl.textContent=qsData.author||'';
    if(sEl) sEl.textContent=[qsData.handle,qsData.content?qsData.content.slice(0,50)+'‚Ä¶':''].filter(Boolean).join(' ¬∑ ');
    if(img){
      if(qsData.image){img.src=qsData.image;img.style.display='block';img.onerror=()=>img.style.display='none';}
      else img.style.display='none';
    }
    if(prev) prev.className='qa-preview show';
    const sb2=document.getElementById('qsSaveBtn');if(sb2)sb2.disabled=false;

  }catch(e){
    if(status) status.textContent='‚ö† ÂèñÂæó„Ç®„É©„Éº„ÄÇURL„ÅÆ„Åø‰øùÂ≠ò„Åó„Åæ„Åô';
    const sb2=document.getElementById('qsSaveBtn');if(sb2)sb2.disabled=false;
  }
  if(fetchBtn){fetchBtn.disabled=false;fetchBtn.textContent='ÂÜçÂèñÂæó';}
  qsFetching=false;
}

async function qsSave(){
  const urlEl=document.getElementById('qsUrl');
  const url=(urlEl?.value||'').trim();
  if(!url){toast('URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  const btn=document.getElementById('qsSaveBtn');
  if(btn){btn.disabled=true;btn.textContent='‰øùÂ≠ò‰∏≠...';}
  const now=Date.now();
  const memoEl=document.getElementById('qsMemo');
  const memo=(memoEl?.value||'').trim();
  const p={
    id:'p'+now,url:qsData.url||url,created_at:now,
    author:qsData.author||url,handle:qsData.handle||'',
    content:qsData.content||'',memo,
    image:qsData.image||'',tags:[],
    area:null,country:null,prefecture:null,lat:null,lng:null,
    type:qsData.type||'web',summary:null,
    youtube_status:'unwatch',youtube_priority:false,
    is_favorite:false,
    watch_later:['youtube','tiktok'].includes(qsData.type),
  };
  try{
    await sb('posts','POST',p);
    posts.unshift(mapPost({...p}));
    renderAll();renderReminderBar();
    toast('‰øùÂ≠ò„Åó„Åæ„Åó„Åü ‚úì','ok');
    closeQuickAdd();
    switchTab('home');bnActive('bnHome');
  }catch(e){
    toast('‰øùÂ≠ò„Ç®„É©„Éº: '+e.message,'err');
    if(btn){btn.disabled=false;btn.textContent='‰øùÂ≠ò„Åô„Çã';}
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRAVEL PLANNER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TP_STORAGE_KEY='xclip_travel_plans';
let tpPlans=[];         // [{id,name,days:[{id,date,items:[]}]}]
let tpCurrentId=null;   // Á∑®ÈõÜ‰∏≠„Éó„É©„É≥ID
let tpTargetDayId=null; // „ÇØ„É™„ÉÉ„ÉóËøΩÂä†ÂÖà„ÅÆday ID
let tpClipSelected=new Set(); // ÈÅ∏Êäû‰∏≠„ÇØ„É™„ÉÉ„ÉóID

const TP_ITEM_TYPES=[
  {value:'spot',label:'üìç „Çπ„Éù„ÉÉ„Éà',emoji:'üìç'},
  {value:'food',label:'üçΩ „Ç∞„É´„É°',emoji:'üçΩ'},
  {value:'hotel',label:'üè® „Éõ„ÉÜ„É´',emoji:'üè®'},
  {value:'transport',label:'üöó ÁßªÂãï',emoji:'üöó'},
  {value:'flight',label:'‚úàÔ∏è „Éï„É©„Ç§„Éà',emoji:'‚úàÔ∏è'},
  {value:'activity',label:'üéØ „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£',emoji:'üéØ'},
  {value:'shopping',label:'üõç „Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞',emoji:'üõç'},
  {value:'other',label:'üìù „Åù„ÅÆ‰ªñ',emoji:'üìù'},
];

// ---------- „Çπ„Éà„É¨„Éº„Ç∏ ----------
function tpLoad(){
  try{tpPlans=JSON.parse(localStorage.getItem(TP_STORAGE_KEY)||'[]');}
  catch(e){tpPlans=[];}
}
function tpSave(){
  localStorage.setItem(TP_STORAGE_KEY,JSON.stringify(tpPlans));
}

// ---------- „Éó„É©„É≥‰∏ÄË¶ß ----------
function tpRenderList(){
  tpLoad();
  document.getElementById('tpListView').style.display='block';
  document.getElementById('tpEditor').classList.remove('open');
  const wrap=document.getElementById('tpPlansList');
  const empty=document.getElementById('tpEmptyMsg');
  if(!tpPlans.length){wrap.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  wrap.innerHTML=tpPlans.map(plan=>{
    const totalItems=plan.days.reduce((s,d)=>s+d.items.length,0);
    const dateRange=tpGetDateRange(plan);
    return `<div class="tp-plan-card" onclick="tpOpenPlan('${plan.id}')">
      <div class="tp-plan-name">${esc(plan.name||'ÁÑ°È°å„ÅÆ„Éó„É©„É≥')}</div>
      <div class="tp-plan-meta">${dateRange?dateRange+' ¬∑ ':''}${plan.days.length}Êó•Èñì ¬∑ ${totalItems}‰ª∂</div>
    </div>`;
  }).join('');
}

function tpGetDateRange(plan){
  const dates=plan.days.map(d=>d.date).filter(Boolean).sort();
  if(!dates.length) return '';
  if(dates.length===1) return dates[0];
  return dates[0]+' „Äú '+dates[dates.length-1];
}

// ---------- Êñ∞Ë¶è„Éó„É©„É≥ ----------
function tpNewPlan(){
  const id='tp'+Date.now();
  const plan={id,name:'Êñ∞„Åó„ÅÑÊóÖË°å„Éó„É©„É≥',days:[{id:'td'+Date.now(),date:'',items:[]}]};
  tpPlans.unshift(plan);
  tpSave();
  tpOpenPlan(id);
}

// ---------- „Éó„É©„É≥„ÇíÈñã„Åè ----------
function tpOpenPlan(id){
  tpLoad();
  tpCurrentId=id;
  const plan=tpPlans.find(p=>p.id===id);
  if(!plan) return;
  document.getElementById('tpListView').style.display='none';
  document.getElementById('tpEditor').classList.add('open');
  document.getElementById('tpPlanNameInput').value=plan.name||'';
  tpRenderEditor();
}

function tpBackToList(){
  tpSavePlan();
  tpRenderList();
}

// ---------- „Éó„É©„É≥‰øùÂ≠ò ----------
function tpSavePlan(){
  const plan=tpPlans.find(p=>p.id===tpCurrentId);
  if(!plan) return;
  plan.name=document.getElementById('tpPlanNameInput').value.trim()||'ÁÑ°È°å„ÅÆ„Éó„É©„É≥';
  tpSave();
  toast('„Éó„É©„É≥„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü','ok');
}

function tpDeletePlan(){
  if(!confirm('„Åì„ÅÆ„Éó„É©„É≥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
  tpPlans=tpPlans.filter(p=>p.id!==tpCurrentId);
  tpSave();
  tpRenderList();
}

// ---------- „Ç®„Éá„Ç£„ÇøÊèèÁîª ----------
function tpRenderEditor(){
  const plan=tpPlans.find(p=>p.id===tpCurrentId);
  if(!plan) return;

  // „Çµ„Éû„É™„Éº
  const totalItems=plan.days.reduce((s,d)=>s+d.items.length,0);
  const spots=plan.days.flatMap(d=>d.items).filter(i=>i.itemType==='spot'||i.clipId).length;
  const hotels=plan.days.flatMap(d=>d.items).filter(i=>i.itemType==='hotel').length;
  document.getElementById('tpSummary').innerHTML=`
    <div class="tp-summary-item">üìÖ <b>${plan.days.length}</b> Êó•Èñì</div>
    <div class="tp-summary-item">üìç <b>${spots}</b> „Çπ„Éù„ÉÉ„Éà</div>
    ${hotels?`<div class="tp-summary-item">üè® <b>${hotels}</b> ÂÆøÊ≥ä</div>`:''}
    <div class="tp-summary-item">ÂêàË®à <b>${totalItems}</b> ‰ª∂</div>
  `;

  // Êó•Á®ã„É™„Çπ„Éà
  const wrap=document.getElementById('tpDaysWrap');
  wrap.innerHTML=plan.days.map((day,di)=>tpDayHTML(day,di)).join('');

  // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóË®≠ÂÆö
  wrap.querySelectorAll('.tp-item').forEach(el=>tpBindDrag(el));
}

function tpDayHTML(day,di){
  const itemsHTML=day.items.map((item,ii)=>tpItemHTML(item,day.id,ii)).join('');
  return `<div class="tp-day" id="tpDay_${day.id}">
    <div class="tp-day-head">
      <span class="tp-day-label">DAY ${di+1}</span>
      <input type="date" class="tp-day-date" value="${day.date||''}" onchange="tpSetDayDate('${day.id}',this.value)" title="Êó•Á®ã">
      <span style="font-size:.7rem;color:rgba(255,255,255,.6);flex:1">${day.date?new Date(day.date).toLocaleDateString('ja-JP',{month:'short',day:'numeric',weekday:'short'}):'Êó•Á®ãÊú™ÂÆö'}</span>
      <button class="tp-day-del" onclick="tpDeleteDay('${day.id}')" title="„Åì„ÅÆÊó•Á®ã„ÇíÂâäÈô§">üóë</button>
    </div>
    <div class="tp-items" id="tpItems_${day.id}" ondragover="event.preventDefault()" ondrop="tpDrop(event,'${day.id}')">
      ${itemsHTML||`<div style="text-align:center;font-size:.72rem;color:var(--ink3);padding:.5rem">„Ç¢„Ç§„ÉÜ„É†„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>`}
    </div>
    <div class="tp-add-row">
      <button class="tp-add-clip-btn" onclick="tpOpenClipModal('${day.id}')">Ôºã „ÇØ„É™„ÉÉ„Éó„Åã„ÇâËøΩÂä†</button>
      <button class="tp-add-custom-btn" onclick="tpShowCustomInput('${day.id}')">Ôºã „Ç´„Çπ„Çø„É†ËøΩÂä†</button>
    </div>
    <div class="tp-custom-row" id="tpCustomRow_${day.id}" style="display:none">
      <select class="tp-custom-type" id="tpCustomType_${day.id}">
        ${TP_ITEM_TYPES.map(t=>`<option value="${t.value}">${t.label}</option>`).join('')}
      </select>
      <input class="tp-custom-input" id="tpCustomInput_${day.id}" placeholder="Â†¥ÊâÄÂêç„Éª„É°„É¢..." onkeydown="if(event.key==='Enter')tpAddCustomItem('${day.id}')">
      <button class="tp-custom-add" onclick="tpAddCustomItem('${day.id}')">ËøΩÂä†</button>
    </div>
  </div>`;
}

function tpItemHTML(item,dayId,idx){
  const post=item.clipId?posts.find(p=>p.id===item.clipId):null;
  const title=item.title||(post?.author||'');
  const sub=item.sub||(post?[post.handle,post.area].filter(Boolean).join(' ¬∑ '):'');
  const imgSrc=item.imgSrc||(post?.image||'')||(post?.type==='youtube'?`https://img.youtube.com/vi/${getYtId(post.url||'')}/mqdefault.jpg`:'');
  const typeInfo=TP_ITEM_TYPES.find(t=>t.value===(item.itemType||'spot'))||TP_ITEM_TYPES[0];
  const priCls={high:'active-high',mid:'active-mid',low:'active-low'};
  const pri=item.priority||'mid';
  const tagColor=post?.tags?.[0]?tags.find(t=>t.id===post.tags[0])?.color||'#999':'#999';

  return `<div class="tp-item" id="tpItem_${dayId}_${idx}" draggable="true"
      ondragstart="tpDragStart(event,'${dayId}',${idx})"
      ondragend="tpDragEnd(event)">
    <span class="tp-item-drag">‚†ø</span>
    <div class="tp-item-body">
      <div style="display:flex;align-items:center;gap:.4rem">
        ${imgSrc?`<img src="${esc(imgSrc)}" style="width:36px;height:36px;border-radius:5px;object-fit:cover;flex-shrink:0;cursor:zoom-in" onclick="openLightbox('${esc(imgSrc)}')" onerror="this.style.display='none'" loading="lazy">`:''}
        <div style="min-width:0">
          <div class="tp-item-title">
            <span class="tp-item-badge" style="background:${typeInfo.emoji?'transparent':'#eee'}">${typeInfo.emoji}</span>${esc(title||'ÁÑ°È°å')}
          </div>
          ${sub?`<div class="tp-item-sub">${esc(sub)}</div>`:''}
        </div>
      </div>
      <div class="tp-item-pri">
        <button class="tp-pri-btn${pri==='high'?' active-high':''}" onclick="tpSetPriority('${dayId}',${idx},'high')">üî¥ È´ò</button>
        <button class="tp-pri-btn${pri==='mid'?' active-mid':''}" onclick="tpSetPriority('${dayId}',${idx},'mid')">üü° ‰∏≠</button>
        <button class="tp-pri-btn${pri==='low'?' active-low':''}" onclick="tpSetPriority('${dayId}',${idx},'low')">üü¢ ‰Ωé</button>
        ${post?`<button class="tp-pri-btn" onclick="openDetail('${post.id}')" style="margin-left:auto">Ë©≥Á¥∞ ‚Üí</button>`:''}
      </div>
    </div>
    <button class="tp-item-del" onclick="tpDeleteItem('${dayId}',${idx})">‚úï</button>
  </div>`;
}

// ---------- Êó•Á®ãÊìç‰Ωú ----------
function tpSetDayDate(dayId,val){
  const plan=tpPlans.find(p=>p.id===tpCurrentId);if(!plan)return;
  const day=plan.days.find(d=>d.id===dayId);if(!day)return;
  day.date=val;tpSave();tpRenderEditor();
}
function tpDeleteDay(dayId){
  const plan=tpPlans.find(p=>p.id===tpCurrentId);if(!plan)return;
  if(plan.days.length<=1){toast('ÊúÄ‰Ωé1Êó•Á®ã„ÅØÂøÖË¶Å„Åß„Åô','err');return;}
  if(!confirm('„Åì„ÅÆÊó•Á®ã„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü'))return;
  plan.days=plan.days.filter(d=>d.id!==dayId);
  tpSave();tpRenderEditor();
}
function tpAddDay(){
  const plan=tpPlans.find(p=>p.id===tpCurrentId);if(!plan)return;
  plan.days.push({id:'td'+Date.now(),date:'',items:[]});
  tpSave();tpRenderEditor();
  // ÊúÄ‰∏ãÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´
  setTimeout(()=>document.getElementById('tpDaysWrap').lastElementChild?.scrollIntoView({behavior:'smooth'}),100);
}

// ---------- „Ç¢„Ç§„ÉÜ„É†Êìç‰Ωú ----------
function tpSetPriority(dayId,idx,pri){
  const plan=tpPlans.find(p=>p.id===tpCurrentId);if(!plan)return;
  const day=plan.days.find(d=>d.id===dayId);if(!day)return;
  if(day.items[idx]) day.items[idx].priority=pri;
  tpSave();tpRenderEditor();
}
function tpDeleteItem(dayId,idx){
  const plan=tpPlans.find(p=>p.id===tpCurrentId);if(!plan)return;
  const day=plan.days.find(d=>d.id===dayId);if(!day)return;
  day.items.splice(idx,1);
  tpSave();tpRenderEditor();
}

// ---------- „Ç´„Çπ„Çø„É†„Ç¢„Ç§„ÉÜ„É† ----------
function tpShowCustomInput(dayId){
  const row=document.getElementById('tpCustomRow_'+dayId);
  if(!row)return;
  row.style.display=row.style.display==='none'?'flex':'none';
  if(row.style.display==='flex') document.getElementById('tpCustomInput_'+dayId)?.focus();
}
function tpAddCustomItem(dayId){
  const plan=tpPlans.find(p=>p.id===tpCurrentId);if(!plan)return;
  const day=plan.days.find(d=>d.id===dayId);if(!day)return;
  const input=document.getElementById('tpCustomInput_'+dayId);
  const typeEl=document.getElementById('tpCustomType_'+dayId);
  const title=(input?.value||'').trim();
  if(!title){toast('ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  day.items.push({
    id:'ti'+Date.now(),
    clipId:null,
    itemType:typeEl?.value||'spot',
    title,priority:'mid'
  });
  if(input) input.value='';
  tpSave();tpRenderEditor();
}

// ---------- „ÇØ„É™„ÉÉ„ÉóÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ ----------
function tpOpenClipModal(dayId){
  tpTargetDayId=dayId;
  tpClipSelected=new Set();
  document.getElementById('tpClipSearch').value='';
  document.getElementById('tpClipModal').classList.add('open');
  tpRenderClipList();
}
function tpCloseClipModal(){
  document.getElementById('tpClipModal').classList.remove('open');
  tpTargetDayId=null;
  tpClipSelected.clear();
}
function tpRenderClipList(){
  const q=(document.getElementById('tpClipSearch')?.value||'').toLowerCase();
  const filtered=posts.filter(p=>{
    if(q&&!p.author.toLowerCase().includes(q)&&!p.content.toLowerCase().includes(q)&&!(p.area||'').toLowerCase().includes(q)) return false;
    return true;
  }).slice(0,60);
  document.getElementById('tpClipList').innerHTML=filtered.map(p=>{
    const imgSrc=p.image||(p.type==='youtube'?`https://img.youtube.com/vi/${getYtId(p.url)}/mqdefault.jpg`:'');
    const tagStr=(p.tags||[]).map(id=>tags.find(t=>t.id===id)?.name||'').filter(Boolean).join(', ');
    const areaStr=[p.country,p.prefecture,p.area].filter(Boolean).join(' ‚Ä∫ ');
    const sel=tpClipSelected.has(p.id);
    return `<div class="tp-clip-item${sel?' selected':''}" onclick="tpToggleClip('${p.id}')">
      ${imgSrc
        ?`<img class="tp-clip-thumb" src="${esc(imgSrc)}" onerror="this.style.display='none'" loading="lazy">`
        :`<div class="tp-clip-thumb" style="display:flex;align-items:center;justify-content:center;font-size:1.2rem">${typeBadge(p.type)}</div>`}
      <div class="tp-clip-info">
        <div class="tp-clip-name">${esc(p.author)}</div>
        <div class="tp-clip-tag">${areaStr||tagStr||p.type}</div>
      </div>
      ${sel?'<span style="color:var(--accent);font-size:1rem">‚úì</span>':''}
    </div>`;
  }).join('')||'<div style="text-align:center;padding:2rem;color:var(--ink3);font-size:.8rem">Ë©≤ÂΩì„Åô„Çã„ÇØ„É™„ÉÉ„Éó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
}
function tpToggleClip(id){
  if(tpClipSelected.has(id)) tpClipSelected.delete(id);
  else tpClipSelected.add(id);
  tpRenderClipList();
}
function tpConfirmClips(){
  if(!tpClipSelected.size){toast('„ÇØ„É™„ÉÉ„Éó„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  const plan=tpPlans.find(p=>p.id===tpCurrentId);if(!plan)return;
  const day=plan.days.find(d=>d.id===tpTargetDayId);if(!day)return;
  tpClipSelected.forEach(clipId=>{
    const post=posts.find(p=>p.id===clipId);
    const itemType=post?.type==='youtube'||post?.type==='tiktok'?'activity':
      (post?.area||post?.lat)?'spot':'spot';
    day.items.push({id:'ti'+Date.now()+Math.random(),clipId,itemType,priority:'mid'});
  });
  tpSave();
  tpCloseClipModal();
  tpRenderEditor();
  toast(`${tpClipSelected.size}‰ª∂ËøΩÂä†„Åó„Åæ„Åó„Åü`,'ok');
}

// ---------- „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó ----------
let dragSrc={dayId:null,idx:null};
function tpDragStart(e,dayId,idx){
  dragSrc={dayId,idx};
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed='move';
}
function tpDragEnd(e){
  e.currentTarget.classList.remove('dragging');
}
function tpDrop(e,targetDayId){
  e.preventDefault();
  if(!dragSrc.dayId) return;
  const plan=tpPlans.find(p=>p.id===tpCurrentId);if(!plan)return;
  const srcDay=plan.days.find(d=>d.id===dragSrc.dayId);
  const tgtDay=plan.days.find(d=>d.id===targetDayId);
  if(!srcDay||!tgtDay) return;
  const [item]=srcDay.items.splice(dragSrc.idx,1);
  tgtDay.items.push(item);
  dragSrc={dayId:null,idx:null};
  tpSave();tpRenderEditor();
}
function tpBindDrag(el){}// placeholder

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){renderSide();renderPickers();renderHome();updateStats();renderMobileFilterBar();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSide(){
  const parentTags=tags.filter(t=>!t.parent_id);
  const childTags=tags.filter(t=>t.parent_id);
  let html='';
  parentTags.forEach(pt=>{
    const children=childTags.filter(c=>c.parent_id===pt.id);
    const cnt=posts.filter(p=>p.tags&&p.tags.includes(pt.id)).length;
    html+=`<div class="tag-tree-parent">
      <div class="tag-row${tagFilter===pt.id?' active':''}" onclick="toggleTagFilter('${pt.id}')">
        <div class="t-dot" style="background:${pt.color}"></div>
        <span>${esc(pt.name)}</span><span class="t-cnt">${cnt}</span>
      </div>`;
    if(children.length){
      html+=`<div class="tag-child-wrap">`;
      children.forEach(ct=>{
        const cc=posts.filter(p=>p.tags&&p.tags.includes(ct.id)).length;
        html+=`<div class="tag-row${tagFilter===ct.id?' active':''}" onclick="toggleTagFilter('${ct.id}')">
          <div class="t-dot" style="background:${ct.color}"></div>
          <span>${esc(ct.name)}</span><span class="t-cnt">${cc}</span>
        </div>`;
      });
      html+=`</div>`;
    }
    html+=`</div>`;
  });
  document.getElementById('sideTagList').innerHTML=html;
  renderAreaFilter();
}

function renderAreaFilter(){
  const countries=[...new Set(posts.map(p=>p.country).filter(Boolean))].sort();
  ['countrySelect','mCountrySelect'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    const cur=areaFilter.country||'';
    el.innerHTML='<option value="">ÂõΩ„ÇíÈÅ∏Êäû...</option>'+countries.map(c=>`<option value="${esc(c)}"${cur===c?' selected':''}>${esc(c)}</option>`).join('');
  });
  ['prefSelect','mPrefSelect'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    if(areaFilter.country){
      const prefs=[...new Set(posts.filter(p=>p.country===areaFilter.country).map(p=>p.prefecture).filter(Boolean))].sort();
      if(prefs.length){
        el.style.display='block';
        el.innerHTML='<option value="">ÈÉΩÈÅìÂ∫úÁúå„ÇíÈÅ∏Êäû...</option>'+prefs.map(pr=>`<option value="${esc(pr)}"${areaFilter.prefecture===pr?' selected':''}>${esc(pr)}</option>`).join('');
      } else el.style.display='none';
    } else {el.style.display='none'; el.value='';}
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBILE FILTER BAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMobileFilterBar(){
  const parentTags=tags.filter(t=>!t.parent_id);
  const childTags=tags.filter(t=>t.parent_id);
  let html='';
  parentTags.forEach(pt=>{
    const children=childTags.filter(c=>c.parent_id===pt.id);
    const active=tagFilter===pt.id;
    const bg=active?pt.color:`${pt.color}18`;
    const border=active?pt.color:`${pt.color}55`;
    const color=active?'#fff':pt.color;
    html+=`<button class="mfb-ep${active?' active':''}" style="background:${bg};border-color:${border};color:${color}" onclick="mfbTag('${pt.id}')">
      <span style="width:7px;height:7px;border-radius:50%;background:${active?'rgba(255,255,255,.8)':pt.color};flex-shrink:0;display:inline-block"></span>${esc(pt.name)}
    </button>`;
    children.forEach(ct=>{
      const ca=tagFilter===ct.id;
      const cbg=ca?ct.color:`${ct.color}12`;
      const cborder=ca?ct.color:`${ct.color}44`;
      const ccolor=ca?'#fff':ct.color;
      html+=`<button class="mfb-ep${ca?' active':''}" style="background:${cbg};border-color:${cborder};color:${ccolor};padding-left:.6rem" onclick="mfbTag('${ct.id}')">
        <span style="width:5px;height:5px;border-radius:50%;background:${ca?'rgba(255,255,255,.8)':ct.color};flex-shrink:0;display:inline-block"></span>‚îî ${esc(ct.name)}
      </button>`;
    });
  });
  const mfbTags=document.getElementById('mfbTags');
  if(mfbTags) mfbTags.innerHTML=html;
  document.querySelectorAll('#mfbMain .mfb-pill[data-f]').forEach(el=>el.classList.toggle('active',el.dataset.f===curFilter));
  renderAreaFilter();
}

function mfbTag(id){tagFilter=tagFilter===id?null:id;renderSide();renderMobileFilterBar();renderHome();scrollToContent();document.querySelectorAll('.mfb-expand').forEach(e=>e.classList.remove('open'));}
function toggleMfbExpand(name){const el=document.getElementById('mfb'+name);if(!el)return;const open=el.classList.contains('open');document.querySelectorAll('.mfb-expand').forEach(e=>e.classList.remove('open'));if(!open)el.classList.add('open');}
function scrollToContent(){const a=document.getElementById('contentAnchor');if(a)a.scrollIntoView({behavior:'smooth',block:'start'});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACTIVE BADGE BAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBadgeBar(){
  const bar=document.getElementById('activeBadgeBar');
  const badges=[];
  const filterLabels={all:null,fav:'‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„Çä','yt-watchlater':'‚ñ∂ „ÅÇ„Å®„ÅßË¶ã„ÇãÔºàÊú™Ë¶ñËÅ¥Ôºâ',recent:'ÊúÄËøëËøΩÂä†'};
  if(curFilter&&curFilter!=='all'&&filterLabels[curFilter]){
    badges.push(`<span class="a-badge">${filterLabels[curFilter]}<button class="a-badge-clear" onclick="setFilter('all')">‚úï</button></span>`);
  }
  if(tagFilter){
    const t=tags.find(t=>t.id===tagFilter);
    if(t) badges.push(`<span class="a-badge" style="background:${t.color}">${esc(t.name)}<button class="a-badge-clear" onclick="toggleTagFilter('${t.id}')">‚úï</button></span>`);
  }
  if(areaFilter.country){
    badges.push(`<span class="a-badge">${esc(areaFilter.country)}${areaFilter.prefecture?' ‚Ä∫ '+esc(areaFilter.prefecture):''}<button class="a-badge-clear" onclick="clearAreaFilter()">‚úï</button></span>`);
  }
  if(badges.length){bar.innerHTML=badges.join('');bar.classList.add('show');}
  else{bar.innerHTML='';bar.classList.remove('show');}
}

function clearAreaFilter(){areaFilter={country:null,prefecture:null};renderAreaFilter();renderMobileFilterBar();renderHome();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTER & SORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getFiltered(){
  const s=document.getElementById('searchIn')?.value.toLowerCase()||'';
  const now=Date.now(),wk=7*864e5;
  let result=posts.filter(p=>{
    if(s&&![p.author,p.handle,p.content,p.memo].join(' ').toLowerCase().includes(s)) return false;
    if(tagFilter&&!(p.tags&&p.tags.includes(tagFilter))) return false;
    if(curFilter==='fav'&&!p.is_favorite) return false;
    if(curFilter==='yt-watchlater'&&!(p.watch_later&&(p.type!=='youtube'||(p.type==='youtube'&&p.youtube_status!=='watched')))) return false;
    if(curFilter==='recent'&&now-p.createdAt>wk) return false;
    if(curFilter==='untagged'&&p.tags&&p.tags.length>0) return false;
    if(areaFilter.country&&p.country!==areaFilter.country) return false;
    if(areaFilter.prefecture&&p.prefecture!==areaFilter.prefecture) return false;
    if(displayMode==='B'&&!p.area&&!p.country) return false;
    return true;
  });

  // „ÇΩ„Éº„Éà: „ÅäÊ∞ó„Å´ÂÖ•„Çä > „É™„Éû„Ç§„É≥„ÉÄ„ÉºÊó•ÔºàËøëÔºâ> ÁôªÈå≤Êó•ÔºàÊñ∞Ôºâ
  const todayMs=Date.now();
  const remindMap=new Map();
  reminders.filter(r=>!r.done).forEach(r=>{
    if(!remindMap.has(r.post_id)||r.remind_at<remindMap.get(r.post_id)) remindMap.set(r.post_id,r.remind_at);
  });

  result.sort((a,b)=>{
    // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÂÑ™ÂÖà
    if(a.is_favorite!==b.is_favorite) return a.is_favorite?-1:1;
    // „É™„Éû„Ç§„É≥„ÉÄ„ÉºËøë„ÅÑÈ†Ü
    const ra=remindMap.get(a.id)??Infinity, rb=remindMap.get(b.id)??Infinity;
    if(ra!==rb) return ra-rb;
    // ÁôªÈå≤Êó•Êñ∞„Åó„ÅÑÈ†Ü
    return b.createdAt-a.createdAt;
  });

  // ÁèæÂú®Âú∞„ÇΩ„Éº„Éà„ÅØ is_favorite ‰ª•Â§ñ„ÅÆÈÉ®ÂàÜ„Å´ÈÅ©Áî®
  if(myLat!==null){
    result=result.map(p=>{
      let dist=Infinity;
      if(p.lat&&p.lng) dist=haversine(myLat,myLng,p.lat,p.lng);
      return{...p,_dist:dist};
    });
    // „ÅäÊ∞ó„Å´ÂÖ•„Çä„Ç∞„É´„Éº„ÉóÂÜÖ„Åß„ÇÇË∑ùÈõ¢„ÇΩ„Éº„Éà
    result.sort((a,b)=>{
      if(a.is_favorite!==b.is_favorite) return a.is_favorite?-1:1;
      return a._dist-b._dist;
    });
  }
  return result;
}

function haversine(la1,lo1,la2,lo2){
  const R=6371,dLat=(la2-la1)*Math.PI/180,dLon=(lo2-lo1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function locateMe(){
  if(!navigator.geolocation){toast('‰ΩçÁΩÆÊÉÖÂ†±„Åå‰Ωø„Åà„Åæ„Åõ„Çì','err');return;}
  toast('ÁèæÂú®Âú∞„ÇíÂèñÂæó‰∏≠...','');
  navigator.geolocation.getCurrentPosition(
    pos=>{
      myLat=pos.coords.latitude;myLng=pos.coords.longitude;
      toast('ÁèæÂú®Âú∞„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü ‚úì','ok');
      // „Éû„ÉÉ„Éó„Éì„É•„Éº„Å´Âç≥Âàá„ÇäÊõø„Åà„Å¶„Ç∫„Éº„É†
      if(viewMode==='map'){
        // „Åô„Åß„Å´„Éû„ÉÉ„Éó„Å™„ÇâÂç≥„Ç∫„Éº„É†
        if(map) map.setView([myLat,myLng],10,{animate:true});
        renderMap();
      } else {
        setView('map');
      }
    },
    err=>{
      const msg=err.code===1?'‰ΩçÁΩÆÊÉÖÂ†±„ÅÆË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô':err.code===2?'‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü':'„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü';
      toast(msg,'err');
    },
    {enableHighAccuracy:true,timeout:10000,maximumAge:0}
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTER SETTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setFilter(f){
  curFilter=f; tagFilter=null;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  const map={all:'fAll',fav:'fFav','yt-watchlater':'fYtWl',recent:'fRecent',untagged:'fUntagged'};
  document.getElementById(map[f]||'fAll')?.classList.add('active');
  document.querySelectorAll('#mfbMain .mfb-pill[data-f]').forEach(el=>el.classList.toggle('active',el.dataset.f===f));
  renderBadgeBar(); renderHome(); scrollToContent();
}
function setCountryFilter(v){areaFilter.country=v||null;areaFilter.prefecture=null;renderAreaFilter();renderBadgeBar();renderHome();scrollToContent();}
function setPrefFilter(v){areaFilter.prefecture=v||null;renderBadgeBar();renderHome();scrollToContent();}
function toggleTagFilter(id){tagFilter=tagFilter===id?null:id;renderSide();renderMobileFilterBar();renderBadgeBar();renderHome();scrollToContent();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER HOME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHome(){
  if(viewMode==='map'){renderMap();return;}
  document.getElementById('mapWrap').style.display='none';
  document.getElementById('postsWrap').style.display='block';
  const filtered=getFiltered();
  document.getElementById('resultInfo').textContent=filtered.length+' clips'+(myLat?' (ÁèæÂú®Âú∞ÂÑ™ÂÖà)':'');
  // „É™„Éû„Ç§„É≥„ÉÄ„Éº„Çª„ÇØ„Ç∑„Éß„É≥
  renderHomeReminders();
  const wrap=document.getElementById('postsWrap');
  if(!filtered.length){
    wrap.innerHTML=`<div class="empty"><div class="empty-mark">‚Äî</div>
      <h3>${curFilter==='untagged'?'„Çø„Ç∞Ë®≠ÂÆöÂâç„ÅÆ„ÇØ„É™„ÉÉ„Éó„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì üéâ':'„ÇØ„É™„ÉÉ„Éó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'}</h3>
      <p>${curFilter==='untagged'?'„Åô„Åπ„Å¶„ÅÆ„ÇØ„É™„ÉÉ„Éó„Å´„Çø„Ç∞„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô':'„Éï„Ç£„É´„Çø„Éº„ÇíÂ§âÊõ¥„Åô„Çã„Åã„ÄåAdd„Äç„Åã„ÇâËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ'}</p></div>`;
    return;
  }
  // untagged„Éï„Ç£„É´„Çø„ÉºÊôÇ„ÅØ„Éï„É©„ÉÉ„Éà„É™„Çπ„Éà„ÅßË°®Á§∫Ôºà„Çø„Ç∞‰ªò„Åë„Åó„ÇÑ„Åô„ÅÑ„Çà„ÅÜ„Å´Ôºâ
  if(curFilter==='untagged'){
    wrap.innerHTML=`<div class="untagged-group">
      <div class="untagged-group-head">
        <span style="font-size:.9rem">üè∑</span>
        „Çø„Ç∞Ë®≠ÂÆöÂâç ‚Äî ${filtered.length}‰ª∂
        <span style="font-size:.72rem;color:var(--ink3);font-weight:300;margin-left:.3rem">„ÇØ„É™„ÉÉ„Éó„ÇíÈñã„ÅÑ„Å¶„ÄåÁ∑®ÈõÜ„Äç„Åã„Çâ„Çø„Ç∞„ÇíË®≠ÂÆö„Åß„Åç„Åæ„Åô</span>
      </div>
      ${viewMode==='grid'
        ?`<div class="posts-grid">${filtered.map(cardHTML).join('')}</div>`
        :`<div class="posts-list">${filtered.map(rowHTML).join('')}</div>`}
    </div>`;
    return;
  }
  if(displayMode==='A') renderGrouped(filtered,wrap,'tag');
  else renderGrouped(filtered,wrap,'area');
}

function renderHomeReminders(){
  let el=document.getElementById('homeReminderSection');
  if(!el){
    el=document.createElement('div');el.id='homeReminderSection';
    const toolbar=document.querySelector('.toolbar');
    if(toolbar) toolbar.parentElement.insertBefore(el,toolbar);
  }
  const now=Date.now();
  const threeDays=3*864e5;
  const upcoming=reminders.filter(r=>!r.done&&r.remind_at>=now-864e5&&r.remind_at<=now+threeDays)
    .sort((a,b)=>a.remind_at-b.remind_at).slice(0,8);
  if(!upcoming.length){el.style.display='none';return;}
  el.style.display='block';
  el.className='home-reminder-section';
  el.innerHTML=`<div class="hrs-head">üîî „É™„Éû„Ç§„É≥„ÉÄ„ÉºÔºà3Êó•‰ª•ÂÜÖÔºâ</div>
    <div class="hrs-cards">${upcoming.map(r=>{
      const p=posts.find(p=>p.id===r.post_id);
      const dDiff=Math.ceil((r.remind_at-now)/864e5);
      const dateStr=dDiff<=0?'‰ªäÊó•':(dDiff===1?'ÊòéÊó•':dDiff+'Êó•Âæå');
      const tagColor=p?.tags?.[0]?tags.find(t=>t.id===p.tags[0])?.color||'#f59e0b':'#f59e0b';
      return `<div class="hrs-card" onclick="openDetail('${r.post_id}')" style="border-color:${tagColor}55">
        <div class="hrs-dot">üîî</div>
        <div class="hrs-info">
          <div class="hrs-title">${esc(p?.author||r.message||'„É™„Éû„Ç§„É≥„ÉÄ„Éº')}</div>
          <div class="hrs-date" style="color:${dDiff<=0?'var(--red)':'#a16207'}">${dateStr}${r.message?' ¬∑ '+esc(r.message.slice(0,12)):''}</div>
        </div>
        <button class="hrs-dismiss" onclick="event.stopPropagation();dismissReminder('${r.id}')">‚úï</button>
      </div>`;
    }).join('')}</div>`;
}

function renderGrouped(filtered,wrap,groupBy){
  const ungrouped=groupBy==='tag'?'__untagged__':'„Ç®„É™„Ç¢„Å™„Åó';
  const groups={};
  if(groupBy==='tag'){
    filtered.forEach(p=>{
      const ptags=(p.tags||[]).map(id=>tags.find(t=>t.id===id)).filter(t=>t&&!t.parent_id);
      if(ptags.length) ptags.forEach(pt=>{(groups[pt.id]=groups[pt.id]||{name:pt.name,items:[]}).items.push(p);});
      else (groups['__untagged__']=groups['__untagged__']||{name:'__untagged__',items:[]}).items.push(p);
    });
    const parentTagIds=tags.filter(t=>!t.parent_id).map(t=>t.id);
    const sortedKeys=[...parentTagIds.filter(id=>groups[id]),'__untagged__'].filter(k=>groups[k]);
    let html='';
    sortedKeys.forEach(k=>{
      const g=groups[k];
      if(k==='__untagged__'){
        // „Çø„Ç∞Ë®≠ÂÆöÂâçÔºöÂ∞ÇÁî®„ÅÆÁõÆÁ´ã„Å§„Éá„Ç∂„Ç§„É≥
        const cnt=g.items.length;
        html+=`<div class="untagged-group">
          <div class="untagged-group-head">
            <span style="font-size:.9rem">üè∑</span>
            „Çø„Ç∞Ë®≠ÂÆöÂâç
            <span style="margin-left:.3rem;background:var(--accent);color:#fff;border-radius:10px;padding:0 8px;font-size:.65rem">${cnt}</span>
            <button onclick="switchTab('settings')" style="margin-left:auto;background:transparent;border:1px solid var(--accent);border-radius:4px;color:var(--accent);font-size:.65rem;padding:.15rem .5rem;cursor:pointer;font-family:'Noto Sans JP',sans-serif">„Çø„Ç∞ÁÆ°ÁêÜ</button>
          </div>
          ${viewMode==='grid'
            ?`<div class="posts-grid">${g.items.map(cardHTML).join('')}</div>`
            :`<div class="posts-list">${g.items.map(rowHTML).join('')}</div>`}
        </div>`;
      } else {
        html+=`<div class="group-header">${esc(g.name)} <span style="opacity:.4">(${g.items.length})</span></div>`;
        if(viewMode==='grid') html+=`<div class="posts-grid" style="margin-bottom:.9rem">${g.items.map(cardHTML).join('')}</div>`;
        else html+=`<div class="posts-list" style="margin-bottom:.9rem">${g.items.map(rowHTML).join('')}</div>`;
      }
    });
    wrap.innerHTML=html;
  } else {
    // B„É¢„Éº„ÉâÔºöÂõΩ ‚Üí ÈÉΩÈÅìÂ∫úÁúå „ÅÆ2ÈöéÂ±§„Åß„Ç∞„É´„Éº„ÉóÂåñ
    const countryGroups={}; // {country: {pref: [posts]}}
    filtered.forEach(p=>{
      const country=p.country||'__no_country__';
      const pref=p.prefecture||'__no_pref__';
      if(!countryGroups[country]) countryGroups[country]={};
      if(!countryGroups[country][pref]) countryGroups[country][pref]=[];
      countryGroups[country][pref].push(p);
    });

    const sortedCountries=Object.keys(countryGroups)
      .sort((a,b)=>a==='__no_country__'?1:b==='__no_country__'?-1:a.localeCompare(b,'ja'));

    let html='';
    sortedCountries.forEach(country=>{
      const prefs=countryGroups[country];
      const sortedPrefs=Object.keys(prefs)
        .sort((a,b)=>a==='__no_pref__'?1:b==='__no_pref__'?-1:a.localeCompare(b,'ja'));
      const totalCnt=sortedPrefs.reduce((s,k)=>s+prefs[k].length,0);

      // ÂõΩ„Éò„ÉÉ„ÉÄ„Éº
      const countryLabel=country==='__no_country__'?'ÂõΩÊú™Ë®≠ÂÆö':country;
      html+=`<div style="margin-top:1.1rem;margin-bottom:.35rem;display:flex;align-items:center;gap:.5rem">
        <div style="font-family:'Playfair Display',serif;font-size:.95rem;font-weight:700;color:var(--ink)">${esc(countryLabel)}</div>
        <div style="flex:1;height:1px;background:var(--line)"></div>
        <div style="font-family:'DM Mono',monospace;font-size:.6rem;color:var(--ink3)">${totalCnt}</div>
      </div>`;

      sortedPrefs.forEach(pref=>{
        const items=prefs[pref];
        const prefLabel=pref==='__no_pref__'?'ÈÉΩÈÅìÂ∫úÁúåÊú™Ë®≠ÂÆö':pref;
        html+=`<div class="group-header" style="margin-top:.55rem;padding-left:.35rem;border-left:2px solid var(--line)">
          ${esc(prefLabel)} <span style="opacity:.4">(${items.length})</span>
        </div>`;
        if(viewMode==='grid') html+=`<div class="posts-grid" style="margin-bottom:.75rem">${items.map(cardHTML).join('')}</div>`;
        else html+=`<div class="posts-list" style="margin-bottom:.75rem">${items.map(rowHTML).join('')}</div>`;
      });
    });
    wrap.innerHTML=html;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CARD / ROW HTML
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function typeBadge(type){
  const label={x:'ùïè',web:'WEB',youtube:'‚ñ∂',memo:'MEMO',tiktok:'TT',instagram:'üì∏'};
  const bg={x:'#111',web:'#0369a1',youtube:'#dc2626',memo:'#166534',tiktok:'#010101',instagram:'#c13584'};
  const fg={x:'#fff',web:'#e0f2fe',youtube:'#fee2e2',memo:'#f0fdf4',tiktok:'#69c9d0',instagram:'#fff'};
  return `<span class="type-badge" style="background:${bg[type]||'#111'};color:${fg[type]||'#fff'}">${label[type]||type}</span>`;
}

function cardHTML(p){
  const d=p.createdAt?new Date(p.createdAt).toLocaleDateString('ja-JP',{month:'short',day:'numeric'}):'';
  const tagS=(p.tags||[]).map(id=>{const t=tags.find(t=>t.id===id);return t?`<span class="c-tag" style="background:${t.color}1a;color:${t.color}">${esc(t.name)}</span>`:''}).join('');
  const areaStr=[p.country,p.prefecture,p.area].filter(Boolean).join(' ‚Ä∫ ');
  const distBadge=p._dist&&p._dist<Infinity?`<span class="c-dist">${p._dist<1?Math.round(p._dist*1000)+'m':p._dist.toFixed(1)+'km'}</span>`:'';
  const ytThumb=p.type==='youtube'&&p.url?`https://img.youtube.com/vi/${getYtId(p.url)}/mqdefault.jpg`:'';
  const tiktokThumb=p.type==='tiktok'&&p.image?p.image:'';
  const imgSrc=p.image||ytThumb||tiktokThumb;
  const favFlag=p.is_favorite?`<span class="flag-fav">‚≠ê</span>`:'';
  const wlFlag=p.watch_later?`<span class="flag-wl">üìå</span>`:'';
  const ytStatusBadge=p.type==='youtube'?`<span class="yt-status-badge ${p.youtube_status}">${p.youtube_status==='watched'?'‚úÖ Ë¶ñËÅ¥Ê∏à':'‚ñ∂ Êú™Ë¶ñËÅ¥'}</span>`:'';
  const reminderEl=reminders.filter(r=>r.post_id===p.id&&!r.done).length?`<span style="font-size:.65rem;color:var(--yellow);background:#fff8e1;padding:1px 6px;border-radius:10px">üîî</span>`:'';
  return `<div class="card">
    ${favFlag}
    ${imgSrc?`<div class="card-img-wrap"><img src="${esc(imgSrc)}" onerror="this.parentElement.style.display='none'" alt="" loading="lazy" class="img-zoomable" onclick="openLightbox('${esc(imgSrc)}')"></div>`:''}
    <div class="card-body">
      <div class="card-meta">
        <div class="c-avatar">${(p.author||'?').charAt(0).toUpperCase()}</div>
        <div><div class="c-author">${typeBadge(p.type)}${esc(p.author)}</div><div class="c-handle">${esc(p.handle)}</div></div>
        <div class="c-date">${d}</div>
      </div>
      ${ytStatusBadge?`<div style="margin-bottom:.35rem">${ytStatusBadge}${wlFlag}</div>`:''}
      ${p.content?`<div class="c-content">${esc(p.content.slice(0,120))}</div>`:''}
      ${p.summary?`<div class="c-summary">‚ú® ${esc(p.summary.slice(0,80))}${p.summary.length>80?'‚Ä¶':''}</div>`:''}
      ${areaStr?`<div class="c-area">üìç ${esc(areaStr)}${distBadge}</div>`:''}
      ${p.memo?`<div class="c-memo-row">${memoHTML(p.memo.slice(0,60))}</div>`:''}
      ${tagS?`<div class="c-tags">${tagS}</div>`:''}
      <div class="c-footer">
        <button class="c-btn" onclick="openDetail('${p.id}')">Ë©≥Á¥∞</button>
        <button class="c-btn${p.is_favorite?' active-fav':''}" onclick="quickToggleFav('${p.id}')" title="„ÅäÊ∞ó„Å´ÂÖ•„Çä" style="${p.is_favorite?'background:#fff8e1;border-color:#f59e0b;color:#d97706':''}">‚≠ê</button>
        <button class="c-btn${p.watch_later?' active-wl':''}" onclick="quickToggleWL('${p.id}')" title="„ÅÇ„Å®„ÅßË¶ã„Çã" style="${p.watch_later?'background:#eff6ff;border-color:#3b82f6;color:#2563eb':''}">üìå</button>
        <button class="c-btn" onclick="openReminderModal('${p.id}')" title="„É™„Éû„Ç§„É≥„ÉÄ„Éº">üîî${reminderEl}</button>
        ${p.type==='youtube'?`<button class="c-btn" onclick="playYt('${p.id}')">‚ñ∂</button>`:''}
        ${p.url?`<a class="c-link" href="${esc(p.url)}" target="_blank" rel="noopener">‚Üó</a>`:''}
        <div style="margin-left:auto;display:flex;gap:.25rem">
          <button class="c-btn" onclick="openEdit('${p.id}')">Á∑®ÈõÜ</button>
          <button class="c-btn del" onclick="delPost('${p.id}')">ÂâäÈô§</button>
        </div>
      </div>
    </div>
  </div>`;
}

function rowHTML(p){
  const d=p.createdAt?new Date(p.createdAt).toLocaleDateString('ja-JP',{month:'short',day:'numeric'}):'';
  const tagS=(p.tags||[]).map(id=>{const t=tags.find(t=>t.id===id);return t?`<span class="c-tag" style="background:${t.color}1a;color:${t.color}">${esc(t.name)}</span>`:''}).join('');
  const ytThumb=p.type==='youtube'&&p.url?`https://img.youtube.com/vi/${getYtId(p.url)}/mqdefault.jpg`:'';
  const imgSrc=p.image||ytThumb;
  const favFlag=p.is_favorite?'‚≠ê ':p.watch_later?'üìå ':'';
  return `<div class="list-row">
    ${imgSrc
      ?`<div class="list-thumb"><img src="${esc(imgSrc)}" onerror="this.parentElement.innerHTML='<div class=list-thumb-ph>‚Äî</div>'" alt="" loading="lazy"></div>`
      :`<div class="list-thumb-ph">${p.type==='youtube'?'‚ñ∂':'‚Äî'}</div>`}
    <div class="list-body">
      <div class="list-top"><span class="list-author">${favFlag}${typeBadge(p.type)}${esc(p.author)}</span><span class="list-handle">${esc(p.handle)}</span><span class="list-date">${d}</span></div>
      ${p.content?`<div class="list-content">${esc(p.content.slice(0,100))}</div>`:''}
      <div class="list-bottom">${tagS}<button class="c-btn" onclick="openDetail('${p.id}')" style="font-size:.66rem">Ë©≥Á¥∞</button><button class="c-btn" onclick="openEdit('${p.id}')" style="font-size:.66rem">Á∑®ÈõÜ</button><button class="c-btn del" onclick="delPost('${p.id}')" style="font-size:.66rem">ÂâäÈô§</button></div>
    </div>
  </div>`;
}

function memoHTML(m){return esc(m).replace(/https?:\/\/[^\s]+/g,u=>`<a href="${u}" target="_blank" rel="noopener" style="color:var(--blue)">${u}</a>`);}
function getYtId(url){const m=url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/);return m?m[1]:'';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let markerCluster=null;
let mapAreaFilter={country:null,prefecture:null};

function setMapCountryFilter(val){
  mapAreaFilter.country=val||null;mapAreaFilter.prefecture=null;
  const ps=document.getElementById('mapPrefSelect');
  if(mapAreaFilter.country){
    const prefs=[...new Set(posts.filter(p=>p.country===mapAreaFilter.country&&p.lat&&p.lng).map(p=>p.prefecture).filter(Boolean))].sort();
    if(prefs.length){
      ps.innerHTML='<option value="">„Åô„Åπ„Å¶„ÅÆÈÉΩÈÅìÂ∫úÁúå</option>'+prefs.map(pr=>`<option value="${esc(pr)}">${esc(pr)}</option>`).join('');
      ps.style.display='block';
    } else ps.style.display='none';
  } else {ps.style.display='none';}
  renderMap();
}
function setMapPrefFilter(val){mapAreaFilter.prefecture=val||null;renderMap();}
function clearMapFilter(){
  mapAreaFilter={country:null,prefecture:null};
  document.getElementById('mapCountrySelect').value='';
  document.getElementById('mapPrefSelect').style.display='none';
  renderMap();
}
function updateMapFilterBar(){
  const bar=document.getElementById('mapFilterBar');if(!bar)return;
  bar.style.display='block';
  const sel=document.getElementById('mapCountrySelect');
  // ÂõΩ„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
  const countries=[...new Set(posts.filter(p=>p.lat&&p.lng).map(p=>p.country).filter(Boolean))].sort();
  sel.innerHTML='<option value="">„Åô„Åπ„Å¶„ÅÆÂõΩ</option>'+countries.map(c=>`<option value="${esc(c)}"${mapAreaFilter.country===c?' selected':''}>${esc(c)}</option>`).join('');
}
function renderMap(){
  document.getElementById('mapWrap').style.display='block';
  document.getElementById('postsWrap').style.display='none';
  updateMapFilterBar();
  const initLat=myLat||35.6812,initLng=myLng||139.7671,initZoom=myLat?13:10;
  if(!map){
    map=L.map('mapWrap').setView([initLat,initLng],initZoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
  }
  mapMarkers.forEach(m=>m.remove()); mapMarkers=[];
  if(markerCluster){map.removeLayer(markerCluster);markerCluster=null;}
  if(myLat){
    const icon=L.divIcon({className:'',html:'<div style="width:18px;height:18px;border-radius:50%;background:#3b82f6;border:3px solid white;box-shadow:0 2px 10px rgba(59,130,246,.6)"></div>',iconSize:[18,18],iconAnchor:[9,9]});
    L.marker([myLat,myLng],{icon,zIndexOffset:1000}).addTo(map).bindPopup('üìç ÁèæÂú®Âú∞');
    map.setView([myLat,myLng],10,{animate:true});
  }
  // „Ç®„É™„Ç¢„Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®
  let filtered=getFiltered().filter(p=>p.lat&&p.lng);
  if(mapAreaFilter.country) filtered=filtered.filter(p=>p.country===mapAreaFilter.country);
  if(mapAreaFilter.prefecture) filtered=filtered.filter(p=>p.prefecture===mapAreaFilter.prefecture);
  const cntEl=document.getElementById('mapFilterCount');
  if(cntEl) cntEl.textContent=filtered.length+'‰ª∂Ë°®Á§∫‰∏≠';
  document.getElementById('resultInfo').textContent=filtered.length?filtered.length+' clips (Âú∞Âõ≥)':'Âú∞Âõ≥Ë°®Á§∫„Åß„Åç„ÇãÊäïÁ®ø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
  const bounds=[];

  // MarkerClusterGroup„Çí‰ΩúÊàêÔºàÈáç„Å™„ÇäËß£Ê∂àÔºâ
  markerCluster=L.markerClusterGroup({
    maxClusterRadius:50,
    iconCreateFunction:cluster=>{
      const count=cluster.getChildCount();
      // „ÇØ„É©„Çπ„Çø„ÉºÂÜÖ„ÅÆÊúÄÂàù„ÅÆ„Éû„Éº„Ç´„Éº„ÅÆÁîªÂÉè„Çí„Éó„É¨„Éì„É•„Éº„Å´‰Ωø„ÅÜ
      const firstChild=cluster.getAllChildMarkers()[0];
      const thumbUrl=firstChild?.options?._thumbUrl;
      const size=count<5?44:count<10?50:56;
      const html=thumbUrl
        ?`<div style="width:${size}px;height:${size}px;border-radius:50%;border:3px solid var(--accent);background:#fff;overflow:hidden;position:relative;box-shadow:0 2px 10px rgba(0,0,0,.25)">
            <img src="${thumbUrl}" style="width:100%;height:100%;object-fit:cover">
            <div style="position:absolute;bottom:0;right:0;background:var(--accent);color:#fff;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:700;font-family:'DM Mono',monospace">${count}</div>
          </div>`
        :`<div style="width:${size}px;height:${size}px;border-radius:50%;background:var(--accent);border:3px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:.85rem;font-family:'DM Mono',monospace">${count}</div>`;
      return L.divIcon({className:'',html,iconSize:[size,size],iconAnchor:[size/2,size/2]});
    }
  });

  filtered.forEach(p=>{
    const ytThumb=p.type==='youtube'&&p.url?`https://img.youtube.com/vi/${getYtId(p.url)}/mqdefault.jpg`:'';
    const imgSrc=p.image||ytThumb;
    const tagColor=p.tags?.[0]?tags.find(t=>t.id===p.tags[0])?.color||'#3b82f6':'#3b82f6';
    const typeEmoji={x:'ùïè',web:'üåê',youtube:'‚ñ∂',memo:'üìù',tiktok:'üéµ',instagram:'üì∏'};

    let iconHtml;
    if(imgSrc){
      iconHtml=`<div style="width:52px;height:52px;border-radius:50%;border:3px solid ${tagColor};background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.25);overflow:hidden;position:relative;cursor:pointer">
        <img src="${esc(imgSrc)}" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.style.background='${tagColor}22';this.style.display='none'">
        ${p.is_favorite?'<div style="position:absolute;top:-2px;right:-2px;font-size:11px">‚≠ê</div>':''}
      </div>
      <div style="width:2px;height:8px;background:${tagColor};margin:0 auto;opacity:.8"></div>`;
    } else {
      iconHtml=`<div style="width:44px;height:44px;border-radius:50%;background:${tagColor};border:3px solid #fff;box-shadow:0 2px 10px rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer">
        ${typeEmoji[p.type]||'üìå'}
      </div>
      <div style="width:2px;height:8px;background:${tagColor};margin:0 auto;opacity:.8"></div>`;
    }

    const size=imgSrc?[52,62]:[44,54];
    const anchor=imgSrc?[26,62]:[22,54];
    const icon=L.divIcon({className:'',html:iconHtml,iconSize:size,iconAnchor:anchor,popupAnchor:[0,-62]});

    const popup=`<div style="min-width:180px;font-family:'Noto Sans JP',sans-serif;line-height:1.5">
      ${imgSrc?`<img src="${esc(imgSrc)}" style="width:100%;max-height:110px;object-fit:cover;border-radius:6px 6px 0 0;display:block;margin:-10px -12px 8px;width:calc(100% + 24px)">`:''}
      <div style="font-weight:600;font-size:13px">${esc(p.author)}</div>
      ${p.handle?`<div style="font-size:11px;color:#888">${esc(p.handle)}</div>`:''}
      ${p.content?`<div style="font-size:11px;color:#555;margin-top:4px;line-height:1.5">${esc((p.content||'').slice(0,60))}${p.content.length>60?'‚Ä¶':''}</div>`:''}
      <button onclick="openDetail('${p.id}')" style="margin-top:8px;font-size:12px;padding:5px 12px;background:#111;color:#fff;border:none;border-radius:6px;cursor:pointer;width:100%;font-family:'Noto Sans JP',sans-serif">Ë©≥Á¥∞„ÇíË¶ã„Çã ‚Üí</button>
    </div>`;

    const marker=L.marker([p.lat,p.lng],{icon,_thumbUrl:imgSrc||''}).bindPopup(popup,{maxWidth:220});
    markerCluster.addLayer(marker);
    mapMarkers.push(marker);
    bounds.push([p.lat,p.lng]);
  });

  map.addLayer(markerCluster);

  if(!myLat&&bounds.length) map.fitBounds(bounds,{padding:[40,40],maxZoom:15});
  setTimeout(()=>map.invalidateSize(),100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DETAIL MODAL / DRAWER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getDetailHTML(p){
  const tagS=(p.tags||[]).map(id=>{const t=tags.find(t=>t.id===id);return t?`<span class="c-tag" style="background:${t.color}1a;color:${t.color};padding:2px 8px;border-radius:10px">${esc(t.name)}</span>`:''}).join(' ');
  const d=p.createdAt?new Date(p.createdAt).toLocaleDateString('ja-JP',{year:'numeric',month:'long',day:'numeric'}):'';
  const areaStr=[p.country,p.prefecture,p.area].filter(Boolean).join(' ‚Ä∫ ');
  const gmapUrl=p.map_url||(areaStr?`https://www.google.com/maps/search/${encodeURIComponent(areaStr)}`:'');
  let ytSection='';
  if(p.type==='youtube'&&p.url){const vid=getYtId(p.url);ytSection=`<div class="yt-embed-wrap"><iframe src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe></div>`;}
  const imgSection=(!ytSection&&p.image)?`<div class="detail-img-wrap"><img src="${esc(p.image)}" onerror="this.parentElement.style.display='none'" alt=""></div>`:'';
  return `
    ${ytSection}${imgSection}
    <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.9rem">
      <div class="c-avatar">${(p.author||'?').charAt(0).toUpperCase()}</div>
      <div><div class="c-author">${typeBadge(p.type)}${esc(p.author)}${p.is_favorite?' ‚≠ê':''}</div><div class="c-handle">${esc(p.handle)}</div></div>
      <div class="c-date" style="margin-left:auto">${d}</div>
    </div>
    ${p.type==='youtube'?`<div style="margin-bottom:.65rem"><span class="yt-status-badge ${p.youtube_status}">${p.youtube_status==='watched'?'‚úÖ Ë¶ñËÅ¥Ê∏à':'‚ñ∂ Êú™Ë¶ñËÅ¥'}</span>${p.watch_later?'<span style="margin-left:.4rem;font-size:.76rem">üìå „ÅÇ„Å®„ÅßË¶ã„Çã</span>':''}</div>`:''}
    ${p.content?`<div style="font-size:.85rem;line-height:1.85;color:var(--ink2);margin-bottom:.9rem;white-space:pre-wrap">${esc(p.content)}</div>`:''}
    ${p.summary?`<div class="c-summary" style="margin-bottom:.9rem">‚ú® ${esc(p.summary)}</div>`:''}
    ${areaStr?`<div style="font-size:.78rem;color:var(--ink3);margin-bottom:.65rem">üìç ${esc(areaStr)}${gmapUrl?` <a href="${gmapUrl}" target="_blank" rel="noopener" style="color:var(--blue)">Google„Éû„ÉÉ„Éó ‚Üó</a>`:''}</div>`:''}
    ${p.memo?`<div class="c-memo-row" style="margin-bottom:.65rem">${memoHTML(p.memo)}</div>`:''}
    ${tagS?`<div class="c-tags" style="margin-bottom:.65rem">${tagS}</div>`:''}
    <div style="display:flex;gap:.4rem;flex-wrap:wrap">
      ${p.url?`<a class="btn-ghost" href="${esc(p.url)}" target="_blank" rel="noopener" style="font-size:.78rem;padding:.32rem .8rem;text-decoration:none">‚Üó ÂÖÉ„É™„É≥„ÇØ</a>`:''}
      ${p.type==='youtube'?`<button class="c-btn" onclick="toggleWatched('${p.id}')">${p.youtube_status==='watched'?'‚ñ∂ Êú™Ë¶ñËÅ¥„Å´Êàª„Åô':'‚úÖ Ë¶ñËÅ¥Ê∏à„Åø„Å´„Åô„Çã'}</button>`:''}
      <button class="c-btn" onclick="closeDetailAll();openEdit('${p.id}')" style="margin-left:auto">Á∑®ÈõÜ</button>
    </div>`;
}

function openDetail(id){
  const p=posts.find(p=>p.id===id); if(!p) return;
  const html=getDetailHTML(p);
  const isSP=window.innerWidth<=768;
  if(isSP){
    document.getElementById('detailDrawerBody').innerHTML=html;
    document.getElementById('detailDrawer').classList.add('open');
  } else {
    document.getElementById('detailBody').innerHTML=html;
    openModal('detailModal');
  }
}

function closeDrawer(){
  document.getElementById('detailDrawer').classList.remove('open');
}

function closeDetailAll(){
  closeDrawer();
  closeModal('detailModal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openEdit(id){
  const p=posts.find(p=>p.id===id); if(!p) return;
  editId=id;
  document.getElementById('eAuthor').value=p.author;
  document.getElementById('eHandle').value=p.handle;
  document.getElementById('eContent').value=p.content;
  document.getElementById('eMemo').value=p.memo||'';
  document.getElementById('eImgUrl').value=p.image||'';
  document.getElementById('eCountry').value=p.country||'';
  document.getElementById('ePrefecture').value=p.prefecture||'';
  document.getElementById('eArea').value=p.area||'';
  document.getElementById('eLat').value='';
  document.getElementById('eLng').value='';
  document.getElementById('eMapUrlInput').value='';
  document.getElementById('eAreaStatus').textContent=p.lat?`ÁèæÂú®„ÅÆ‰ΩçÁΩÆ: ${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}`:'';
  document.getElementById('eFavorite').checked=p.is_favorite;
  eImgPrev();
  const ytF=document.getElementById('eYtFields');
  if(p.type==='youtube'){
    ytF.style.display='block';
    document.getElementById('eYtWatched').checked=p.youtube_status==='watched';
    document.getElementById('eWatchLater').checked=p.watch_later;
  } else ytF.style.display='none';
  eSel=new Set(p.tags||[]);
  renderPicker('editPicker',eSel);
  openModal('editModal');
}

function eImgPrev(){
  const u=document.getElementById('eImgUrl').value.trim();
  const img=document.getElementById('eImgPrevImg'),ph=document.getElementById('eImgPh');
  if(u){img.src=u;img.style.display='block';ph.style.display='none';}
  else{img.style.display='none';ph.style.display='flex';}
}

function handleEditFile(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{document.getElementById('eImgUrl').value=ev.target.result;eImgPrev();};
  r.readAsDataURL(f);
}

async function saveEdit(){
  const p=posts.find(p=>p.id===editId); if(!p) return;
  p.author=document.getElementById('eAuthor').value.trim()||'‰∏çÊòé';
  p.handle=document.getElementById('eHandle').value.trim();
  p.content=document.getElementById('eContent').value.trim();
  p.memo=document.getElementById('eMemo').value.trim();
  p.image=document.getElementById('eImgUrl').value.trim();
  p.country=document.getElementById('eCountry').value.trim();
  p.prefecture=document.getElementById('ePrefecture').value.trim();
  p.area=document.getElementById('eArea').value.trim();
  p.is_favorite=document.getElementById('eFavorite').checked;
  p.map_url=document.getElementById('eMapUrl').value.trim()||null;
  const newLat=parseFloat(document.getElementById('eLat').value);
  const newLng=parseFloat(document.getElementById('eLng').value);
  if(!isNaN(newLat)&&!isNaN(newLng)){p.lat=newLat;p.lng=newLng;}
  p.tags=[...eSel];
  if(p.type==='youtube'){
    p.youtube_status=document.getElementById('eYtWatched').checked?'watched':'unwatch';
    p.watch_later=document.getElementById('eWatchLater').checked;
    // Èñ≤Ë¶ßÊ∏à„Åø„Å™„Çâ watch_later OFF
    if(p.youtube_status==='watched') p.watch_later=false;
  }
  try{
    const patch={
      author:p.author,handle:p.handle,content:p.content,memo:p.memo,
      image:p.image,country:p.country,prefecture:p.prefecture,area:p.area,
      lat:p.lat||null,lng:p.lng||null,tags:p.tags,
      is_favorite:p.is_favorite,watch_later:p.watch_later,
      youtube_status:p.youtube_status,youtube_priority:p.youtube_priority
    };
    // map_url„ÅØDB„Å´„Ç´„É©„É†„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÈÄÅ‰ø°
    if(p.map_url!==undefined) patch.memo=p.memo; // map_url„ÅØmemo„Éï„Ç£„Éº„É´„Éâ„Å´‰øùÂ≠ò„Åó„Å™„ÅÑ
    await sb('posts?id=eq.'+p.id,'PATCH',patch);
    closeModal('editModal');renderAll();toast('Êõ¥Êñ∞„Åó„Åæ„Åó„Åü ‚úì','ok');
  }catch(e){toast('„Ç®„É©„Éº: '+e.message,'err');}
}

async function toggleWatched(id){
  const p=posts.find(p=>p.id===id); if(!p) return;
  const wasWatched=p.youtube_status==='watched';
  p.youtube_status=wasWatched?'unwatch':'watched';
  // Ë¶ñËÅ¥Ê∏à„Åø„Å´„Åó„Åü„Çâ watch_later=false„ÄÅ„É™„Éû„Ç§„É≥„ÉÄ„Éº„Çídone=true
  if(!wasWatched){
    p.watch_later=false;
    // Èñ¢ÈÄ£„É™„Éû„Ç§„É≥„ÉÄ„Éº„ÇíÊ∏à„Åø„Å´
    const related=reminders.filter(r=>r.post_id===id&&!r.done);
    for(const r of related){r.done=true;await sb('reminders?id=eq.'+r.id,'PATCH',{done:true}).catch(()=>{});}
  }
  try{
    await sb('posts?id=eq.'+p.id,'PATCH',{youtube_status:p.youtube_status,watch_later:p.watch_later});
    closeDetailAll();renderAll();renderReminderBar();toast(p.youtube_status==='watched'?'Ë¶ñËÅ¥Ê∏à„Åø„Å´„Åó„Åæ„Åó„Åü':'Êú™Ë¶ñËÅ¥„Å´Êàª„Åó„Åæ„Åó„Åü','ok');
  }catch(e){toast('„Ç®„É©„Éº: '+e.message,'err');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUICK TOGGLES („Ç´„Éº„Éâ„Åã„ÇâÁõ¥Êé•Êìç‰Ωú)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function quickToggleFav(id){
  const p=posts.find(p=>p.id===id);if(!p)return;
  p.is_favorite=!p.is_favorite;
  try{await sb('posts?id=eq.'+id,'PATCH',{is_favorite:p.is_favorite});renderAll();toast(p.is_favorite?'‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†':'„ÅäÊ∞ó„Å´ÂÖ•„ÇäËß£Èô§');}
  catch(e){p.is_favorite=!p.is_favorite;toast('„Ç®„É©„Éº: '+e.message,'err');}
}

async function quickToggleWL(id){
  const p=posts.find(p=>p.id===id);if(!p)return;
  p.watch_later=!p.watch_later;
  try{await sb('posts?id=eq.'+id,'PATCH',{watch_later:p.watch_later});renderAll();toast(p.watch_later?'üìå „ÅÇ„Å®„ÅßË¶ã„Çã„Å´ËøΩÂä†':'„ÅÇ„Å®„ÅßË¶ã„Çã„ÇíËß£Èô§');}
  catch(e){p.watch_later=!p.watch_later;toast('„Ç®„É©„Éº: '+e.message,'err');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUICK ADD („Çπ„Éû„ÉõÁî®„ÇØ„Ç§„ÉÉ„ÇØÁôªÈå≤)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DELETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function delPost(id){
  if(!confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
  try{await sb('posts?id=eq.'+id,'DELETE');posts=posts.filter(p=>p.id!==id);renderAll();toast('ÂâäÈô§„Åó„Åæ„Åó„Åü');}
  catch(e){toast('„Ç®„É©„Éº: '+e.message,'err');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE POST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function savePost(){
  const url=document.getElementById('urlIn')?.value.trim()||'';
  const content=document.getElementById('fContent').value.trim();
  const memo=document.getElementById('fMemo').value.trim();
  if(!content&&!memo&&!url&&currentType!=='memo'){toast('ÂÜÖÂÆπ„Éª„É°„É¢„ÉªURL„ÅÆ„ÅÑ„Åö„Çå„Åã„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  const now=Date.now();
  let author='',handle='',summary='';
  if(currentType==='x'){author=document.getElementById('fAuthor').value.trim()||'‰∏çÊòé';handle=document.getElementById('fHandle').value.trim();}
  else if(currentType==='instagram'){author=document.getElementById('fAuthor').value.trim()||'Instagram';handle=document.getElementById('fHandle').value.trim();}
  else if(currentType==='tiktok'){author=document.getElementById('fAuthor').value.trim()||'TikTok';handle=document.getElementById('fHandle').value.trim();}
  else if(currentType==='web'){const title=document.getElementById('fTitle').value.trim();const site=document.getElementById('fSite').value.trim();author=document.getElementById('fAuthorWeb').value.trim()||title||'WebË®ò‰∫ã';handle=site;summary=document.getElementById('fSummary').value.trim();}
  else if(currentType==='youtube'){author=document.getElementById('fYtTitle').value.trim()||'YouTubeÂãïÁîª';handle=document.getElementById('fYtChannel').value.trim();}
  else{author='„É°„É¢';}

  // „Çø„Ç∞ÔºöÂ≠ê„Çø„Ç∞ÈÅ∏ÊäûÊôÇ„ÅØË¶™„Çø„Ç∞„ÇÇËá™ÂãïËøΩÂä†
  const selectedTags=new Set([...fSel]);
  fSel.forEach(tid=>{
    const t=tags.find(t=>t.id===tid);
    if(t?.parent_id&&!selectedTags.has(t.parent_id)) selectedTags.add(t.parent_id);
  });

  const remindDate=document.getElementById('fRemindDate').value;
  const remindMsg=document.getElementById('fRemindMsg').value.trim();
  const p={
    id:'p'+now,url,created_at:now,
    author,handle,content,memo,
    image:(currentType==='instagram'
      ? (instaSelectedImages.length?instaSelectedImages[0]:'')
      : document.getElementById('fImgUrl').value.trim()),
    tags:[...selectedTags],
    area:document.getElementById('fArea').value.trim()||null,
    country:document.getElementById('fCountry').value.trim()||null,
    prefecture:document.getElementById('fPrefecture').value.trim()||null,
    lat:parseFloat(document.getElementById('fLat').value)||null,
    lng:parseFloat(document.getElementById('fLng').value)||null,
    type:currentType,summary:summary||null,
    youtube_status:document.getElementById('fYtWatched')?.checked?'watched':'unwatch',
    youtube_priority:false,
    is_favorite:document.getElementById('fFavorite').checked,
    watch_later:document.getElementById('fWatchLater')?.checked||false,
  };
  try{
    await sb('posts','POST',p);
    posts.unshift(mapPost({...p}));
    if(remindDate){
      const r={id:'r'+now,post_id:p.id,remind_at:new Date(remindDate).getTime(),message:remindMsg,done:false};
      await sb('reminders','POST',r); reminders.push(r);
    }
    clearForm();renderAll();renderReminderBar();toast('‰øùÂ≠ò„Åó„Åæ„Åó„Åü ‚úì','ok');switchTab('home');
  }catch(e){toast('‰øùÂ≠ò„Ç®„É©„Éº: '+e.message,'err');console.error(e);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FETCH FROM URL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchFromUrl(){
  const url=document.getElementById('urlIn').value.trim();
  if(!url){toast('URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  const btn=document.getElementById('fetchBtn');
  btn.disabled=true;btn.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  const status=document.getElementById('statusBar');
  status.style.display='block';status.textContent='ÂèñÂæó‰∏≠...';
  try{
    if(currentType==='instagram'){
      await fetchInstagram(url,status);
    } else if(currentType==='x'){
      const m=url.match(/(?:twitter\.com|x\.com)\/@?([\w]+)\/status\/(\d+)/);
      if(!m){toast('X„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
      document.getElementById('fHandle').value='@'+m[1];
      document.getElementById('fAuthor').value=m[1];
      const r=await fetch(`https://publish.twitter.com/oembed?url=${encodeURIComponent(url)}&omit_script=true`);
      const d=await r.json();
      if(d.html){
        const doc=new DOMParser().parseFromString(d.html,'text/html');
        const txt=doc.querySelector('p')?.textContent||'';
        document.getElementById('fContent').value=txt;
        if(d.author_name) document.getElementById('fAuthor').value=d.author_name;
        // oEmbed HTML„Åã„ÇâÂãïÁîª„Çµ„É†„Éç„Ç§„É´„ÇíÊé¢„ÅôÔºàÂãïÁîª‰ªò„Åç„Éù„Çπ„Éà„ÅÆÂ†¥ÂêàÔºâ
        // twitter/x „ÅØÂÖ¨ÂºèoEmbed„Åß„ÅØ„Çµ„É†„Éç„Ç§„É´„ÇíËøî„Åï„Å™„ÅÑ„Åå thumbnail_url „ÅåÂê´„Åæ„Çå„ÇãÂ†¥Âêà„Åå„ÅÇ„Çã
        if(d.thumbnail_url){
          document.getElementById('fImgUrl').value=d.thumbnail_url;prevImgUrl();
        }
      }
      status.textContent='‚úì XÊäïÁ®ø„ÅÆÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Åæ„Åó„ÅüÔºàÂãïÁîª„Çµ„É†„Éç„Ç§„É´„ÅØËá™ÂãïÂèñÂæó„Åß„Åç„Å™„ÅÑÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„ÅôÔºâ';
    } else if(currentType==='tiktok'){
      // TikTok oEmbed API„Åß„Çµ„É†„Éç„Ç§„É´„Éª‰ΩúËÄÖÂêç„ÇíÂèñÂæó
      const m=url.match(/tiktok\.com\/@([\w.]+)\/video\/(\d+)/i)||url.match(/vm\.tiktok\.com\/([\w]+)/i)||url.match(/vt\.tiktok\.com\/([\w]+)/i);
      if(!m){toast('TikTok„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
      try{
        const oeResp=await fetch(`https://www.tiktok.com/oembed?url=${encodeURIComponent(url)}`);
        const oe=await oeResp.json();
        if(oe.author_name) document.getElementById('fAuthor').value=oe.author_name;
        if(oe.author_url){const h=oe.author_url.match(/tiktok\.com\/@([^\/\?]+)/);if(h) document.getElementById('fHandle').value='@'+h[1];}
        if(oe.title) document.getElementById('fContent').value=oe.title;
        if(oe.thumbnail_url){document.getElementById('fImgUrl').value=oe.thumbnail_url;prevImgUrl();}
        status.textContent='‚úì TikTokÂãïÁîª„ÅÆÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü';
      }catch(e){
        // oEmbed„ÅåÂ§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØURL„Åã„Çâ‰ΩúËÄÖÂêç„ÇíÂèñÂæó
        const handle=url.match(/tiktok\.com\/@([\w.]+)/)?.[1]||'';
        if(handle){document.getElementById('fHandle').value='@'+handle;document.getElementById('fAuthor').value=handle;}
        status.textContent='‚úì URL„Åã„Çâ„Éè„É≥„Éâ„É´Âêç„ÇíÂèñÂæó„Åó„Åæ„Åó„ÅüÔºà„Çµ„É†„Éç„Ç§„É´ÂèñÂæó„Å´Â§±ÊïóÔºâ';
      }
      // watch_later„ÅØËá™ÂãïË®≠ÂÆö„Åó„Å™„ÅÑÔºà„É¶„Éº„Ç∂„Éº„ÅåÊâãÂãï„ÅßË®≠ÂÆöÔºâ
    } else if(currentType==='youtube'){
      const vid=getYtId(url);
      if(!vid){toast('YouTube„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
      try{
        const r=await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
        const d=await r.json();
        if(d.title) document.getElementById('fYtTitle').value=d.title;
        if(d.author_name) document.getElementById('fYtChannel').value=d.author_name;
        document.getElementById('fImgUrl').value=`https://img.youtube.com/vi/${vid}/mqdefault.jpg`;
        prevImgUrl();
      }catch(e){}
      // watch_later„ÅØËá™ÂãïË®≠ÂÆö„Åó„Å™„ÅÑÔºà„É¶„Éº„Ç∂„Éº„ÅåÊâãÂãï„ÅßË®≠ÂÆöÔºâ
      status.textContent='‚úì YouTubeÂãïÁîª„ÅÆÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü';
    } else if(currentType==='web'){
      let html='';
      const proxies=[`https://corsproxy.io/?${encodeURIComponent(url)}`,`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`];
      for(const px of proxies){
        try{const r=await fetch(px,{signal:AbortSignal.timeout(8000)});html=px.includes('allorigins')?(await r.json()).contents||'':await r.text();if(html)break;}catch(e){continue;}
      }
      if(!html) throw new Error('ÂèñÂæóÂ§±Êïó');
      const doc=new DOMParser().parseFromString(html,'text/html');
      const get=(sel,attr)=>doc.querySelector(sel)?.getAttribute(attr)||'';
      const title=get('meta[property="og:title"]','content')||get('meta[name="twitter:title"]','content')||doc.querySelector('title')?.textContent||'';
      const desc=get('meta[property="og:description"]','content')||get('meta[name="description"]','content')||'';
      const site=get('meta[property="og:site_name"]','content')||'';
      const img=get('meta[property="og:image"]','content')||get('meta[name="twitter:image"]','content')||'';
      const author=get('meta[name="author"]','content')||'';
      if(title) document.getElementById('fTitle').value=title;
      if(site) document.getElementById('fSite').value=site;
      if(author) document.getElementById('fAuthorWeb').value=author;
      if(desc) document.getElementById('fContent').value=desc;
      if(img){document.getElementById('fImgUrl').value=img;prevImgUrl();}
      status.textContent='‚úì ÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü„ÄÇË¶ÅÁ¥Ñ‰∏≠...';
      const toSummarize=[title,desc].filter(Boolean).join('\n');
      if(toSummarize){
        try{
          const cr=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:300,messages:[{role:'user',content:`‰ª•‰∏ã„ÅÆË®ò‰∫ã„ÇíÊó•Êú¨Ë™û„Åß3„Äú5Êñá„ÅßË¶ÅÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n${toSummarize}`}]})});
          const cd=await cr.json();
          const sum=cd.content?.[0]?.text||'';
          if(sum){document.getElementById('fSummary').value=sum;status.textContent='‚úì ÂèñÂæó„ÉªË¶ÅÁ¥Ñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü';}
          else status.textContent='‚úì ÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü';
        }catch(e){status.textContent='‚úì ÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Åæ„Åó„ÅüÔºàË¶ÅÁ¥Ñ„Çπ„Ç≠„ÉÉ„ÉóÔºâ';}
      } else status.textContent='‚úì ÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü';
    }
  }catch(e){status.textContent='‚ö†Ô∏è Ëá™ÂãïÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÊâãÂãï„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';}
  btn.disabled=false;btn.innerHTML='ÊÉÖÂ†±ÂèñÂæó';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSTAGRAM FETCH & IMAGE SELECTOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let instaSelectedImages=[];   // ÈÅ∏ÊäûÊ∏à„ÅøÁîªÂÉèURL„ÅÆÈÖçÂàóÔºàÈ†ÜÂ∫è‰ªò„ÅçÔºâ
let instaAllImages=[];        // ÂèñÂæó„Åó„ÅüÂÖ®ÁîªÂÉèURL

async function fetchInstagram(url, statusEl){
  instaSelectedImages=[];instaAllImages=[];
  renderInstaGrid([]);
  statusEl.style.display='block';statusEl.textContent='Instagram„Åã„ÇâÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...';

  // URL„Åã„Çâ„Ç∑„Éß„Éº„Éà„Ç≥„Éº„Éâ„ÇíÊäΩÂá∫
  const shortcode=url.match(/instagram\.com\/(?:p|reel|tv)\/([A-Za-z0-9_-]+)/)?.[1];
  if(!shortcode){
    statusEl.textContent='‚ö† Instagram„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰æã: https://www.instagram.com/p/XXXXX/Ôºâ';
    return;
  }

  // „É¶„Éº„Ç∂„ÉºÂêç„ÇíURL„Åã„ÇâÊäΩÂá∫
  const usernameFromUrl=url.match(/instagram\.com\/([^\/\?]+)\/(?:p|reel)/)?.[1]||'';

  // OEmbed APIÔºàInstagram„ÅÆÂÖ¨ÂºèoEmbed ‚Äì „Ç¢„ÇØ„Çª„Çπ„Éà„Éº„ÇØ„É≥‰∏çË¶Å„Éê„Éº„Ç∏„Éß„É≥Ôºâ
  let oembedOk=false;
  try{
    const oeUrl=`https://www.instagram.com/api/v1/oembed/?url=${encodeURIComponent(url)}&hidecaption=false&maxwidth=640`;
    const proxied=`https://corsproxy.io/?${encodeURIComponent(oeUrl)}`;
    const r=await fetch(proxied,{signal:AbortSignal.timeout(8000)});
    if(r.ok){
      const d=await r.json();
      if(d.author_name){
        document.getElementById('fAuthor').value=d.author_name;
        document.getElementById('fHandle').value='@'+(d.author_url?.match(/instagram\.com\/([^\/\?]+)/)?.[1]||d.author_name);
      }
      if(d.title) document.getElementById('fContent').value=d.title;
      // OGPÁîªÂÉè„ÇíoEmbed„Åã„ÇâÂèñÂæóÔºàthumbnail_urlÔºâ
      if(d.thumbnail_url){
        instaAllImages.push({url:d.thumbnail_url,type:'image'});
      }
      oembedOk=true;
    }
  }catch(e){}

  // OGP„É°„Çø„Çø„Ç∞„Åã„Çâ„ÇÇÂèñÂæó„ÇíË©¶„Åø„ÇãÔºà„Éó„É≠„Ç≠„Ç∑ÁµåÁî±Ôºâ
  let ogImages=[];
  let ogLocation=null;
  const proxies=[
    `https://corsproxy.io/?${encodeURIComponent(url)}`,
    `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`
  ];
  for(const px of proxies){
    try{
      const r=await fetch(px,{signal:AbortSignal.timeout(8000)});
      const rawHtml=px.includes('allorigins')?(await r.json()).contents||'':await r.text();
      if(!rawHtml) continue;
      const doc=new DOMParser().parseFromString(rawHtml,'text/html');
      const g=(sel,a)=>doc.querySelector(sel)?.getAttribute(a)||'';

      // „É¶„Éº„Ç∂„ÉºÂêç
      if(!document.getElementById('fAuthor').value){
        const authorMeta=g('meta[property="og:title"]','content')||g('meta[name="twitter:title"]','content')||'';
        const usernameMatch=rawHtml.match(/"username":"([^"]+)"/)||rawHtml.match(/\"owner\":\{[^}]*\"username\":\"([^"]+)\"/);
        if(usernameMatch){
          document.getElementById('fHandle').value='@'+usernameMatch[1];
          document.getElementById('fAuthor').value=usernameMatch[1];
        } else if(usernameFromUrl){
          document.getElementById('fHandle').value='@'+usernameFromUrl;
          document.getElementById('fAuthor').value=usernameFromUrl;
        }
      }

      // „Ç≠„É£„Éó„Ç∑„Éß„É≥ÔºàÊú¨ÊñáÔºâ
      if(!document.getElementById('fContent').value){
        const desc=g('meta[property="og:description"]','content')||g('meta[name="description"]','content')||'';
        if(desc) document.getElementById('fContent').value=desc.replace(/^[^:]+:\s*/,'').slice(0,500);
      }

      // OGPÁîªÂÉèÔºàÈÄöÂ∏∏1„Äú3ÊûöÔºâ
      doc.querySelectorAll('meta[property="og:image"]').forEach(m=>{
        const imgUrl=m.getAttribute('content');
        if(imgUrl&&!ogImages.includes(imgUrl)) ogImages.push(imgUrl);
      });

      // ÂãïÁîª„Çµ„É†„Éç„Ç§„É´Ôºà„É™„Éº„É´„ÅÆÂ†¥ÂêàÔºâ
      const videoThumb=g('meta[property="og:image:secure_url"]','content')||g('meta[name="twitter:image"]','content')||'';
      if(videoThumb&&!ogImages.includes(videoThumb)) ogImages.push(videoThumb);

      // isVideoÂà§ÂÆöÔºà„É™„Éº„É´ or ÂãïÁîªÔºâ
      const isVideo=/reel|video/i.test(url)||rawHtml.includes('"is_video":true');

      // Ë§áÊï∞ÊûöÁîªÂÉè„ÇíJSON„Åã„ÇâÊéò„ÇäÂá∫„Åô
      const jsonMatches=rawHtml.matchAll(/"display_url":"(https:\/\/[^"]+)"/g);
      for(const m of jsonMatches){
        try{const decoded=m[1].replace(/\\u0026/g,'&').replace(/\\/g,'');if(!ogImages.includes(decoded))ogImages.push(decoded);}catch(e){}
      }
      // edge_sidecar_to_children „Åã„ÇâË§áÊï∞Êûö
      const sidecarMatch=rawHtml.match(/"edge_sidecar_to_children":\{"edges":\[(.*?)\]\}/s);
      if(sidecarMatch){
        const sidecarImgs=sidecarMatch[1].matchAll(/"display_url":"(https:\/\/[^"]+)"/g);
        for(const m of sidecarImgs){
          try{const decoded=m[1].replace(/\\u0026/g,'&').replace(/\\/g,'');if(!ogImages.includes(decoded))ogImages.push(decoded);}catch(e){}
        }
      }

      // ‰ΩçÁΩÆÊÉÖÂ†±
      const locMatch=rawHtml.match(/"location":\{"id":"[^"]*","has_public_page":[^,]*,"name":"([^"]+)"/)||
                     rawHtml.match(/"location_name":"([^"]+)"/);
      if(locMatch) ogLocation=locMatch[1];

      // lat/lng
      const latMatch=rawHtml.match(/"lat":([-\d.]+)/);
      const lngMatch=rawHtml.match(/"lng":([-\d.]+)/);
      if(latMatch&&lngMatch){
        document.getElementById('fLat').value=latMatch[1];
        document.getElementById('fLng').value=lngMatch[1];
        // ÈÄÜ„Ç∏„Ç™„Ç≥„Éº„Éá„Ç£„É≥„Ç∞
        try{
          const rev=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latMatch[1]}&lon=${lngMatch[1]}&format=json&accept-language=ja`);
          const rd=await rev.json();
          const addr=rd.address||{};
          if(addr.country) document.getElementById('fCountry').value=addr.country;
          const pref=addr.state||addr.province||addr.region||addr.county||'';
          if(pref) document.getElementById('fPrefecture').value=pref;
          const place=addr.city||addr.town||addr.village||addr.suburb||addr.neighbourhood||ogLocation||'';
          if(place) document.getElementById('fArea').value=place;
          document.getElementById('fAreaStatus').textContent=`‚úì ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó: ${addr.country||''}${pref?' / '+pref:''}`;
        }catch(e){
          if(ogLocation) document.getElementById('fArea').value=ogLocation;
          document.getElementById('fAreaStatus').textContent=`‚úì Â†¥ÊâÄ: ${ogLocation}`;
        }
      } else if(ogLocation){
        document.getElementById('fArea').value=ogLocation;
        document.getElementById('fAreaStatus').textContent=`üìç Â†¥ÊâÄÂêç: ${ogLocation}`;
      }

      if(ogImages.length>0||oembedOk) break;
    }catch(e){continue;}
  }

  // ÁîªÂÉè„Çí„Éû„Éº„Ç∏ÔºàÈáçË§áÊéíÈô§Ôºâ
  ogImages.forEach(u=>{
    if(!instaAllImages.find(x=>x.url===u)){
      const isVid=/reel|video/i.test(url);
      instaAllImages.push({url:u, type: isVid&&instaAllImages.length===0?'video':'image'});
    }
  });

  if(instaAllImages.length>0){
    renderInstaGrid(instaAllImages);
    // ÊúÄÂàù„ÅÆÁîªÂÉè„ÇíËá™ÂãïÈÅ∏Êäû
    toggleInstaImage(0);
    statusEl.textContent=`‚úì ${instaAllImages.length}Êûö„ÅÆÁîªÂÉè„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü„ÄÇ‰ΩøÁî®„Åô„ÇãÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
    if(ogLocation||document.getElementById('fLat').value) statusEl.textContent+=' ‰ΩçÁΩÆÊÉÖÂ†±„ÇÇÂèñÂæó„Åó„Åæ„Åó„Åü„ÄÇ';
  } else {
    statusEl.textContent='‚ö† ÁîªÂÉè„ÅÆËá™ÂãïÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇInstagram„ÅØ„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÇÑ„Éó„É≠„Ç≠„Ç∑„ÅÆÂà∂Èôê„Å´„Çà„ÇäÂèñÂæó„Åß„Åç„Å™„ÅÑÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊâãÂãï„ÅßÁîªÂÉèURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
    // ÈÄöÂ∏∏„ÅÆÁîªÂÉèÂÖ•ÂäõUI„ÇíË°®Á§∫
    const imgArea=document.getElementById('imgArea');
    const imgUrlInput=document.getElementById('fImgUrl');
    if(imgArea) imgArea.style.display='block';
    if(imgUrlInput) imgUrlInput.style.display='block';
  }
}

function renderInstaGrid(images){
  const grid=document.getElementById('instaImgGrid');if(!grid)return;
  if(!images.length){grid.innerHTML='';return;}
  grid.innerHTML=images.map((img,i)=>`
    <div class="insta-thumb-wrap${instaSelectedImages.includes(img.url)?' selected':''}" id="instaThumb${i}" onclick="toggleInstaImage(${i})">
      <img src="${esc(img.url)}" onerror="this.parentElement.style.opacity='.3'" loading="lazy">
      ${img.type==='video'?'<div class="insta-vid-badge">‚ñ∂ ÂãïÁîª</div>':''}
      <div class="insta-sel-num">${instaSelectedImages.indexOf(img.url)+1||''}</div>
    </div>
  `).join('');
}

function toggleInstaImage(idx){
  const img=instaAllImages[idx];if(!img)return;
  const selIdx=instaSelectedImages.indexOf(img.url);
  if(selIdx>=0){
    instaSelectedImages.splice(selIdx,1);
  } else {
    instaSelectedImages.push(img.url);
  }
  // fImgUrl„Å´ÊúÄÂàù„ÅÆÈÅ∏ÊäûÁîªÂÉè„Çí„Çª„ÉÉ„ÉàÔºà„Éó„É¨„Éì„É•„ÉºÁî®Ôºâ
  if(instaSelectedImages.length>0){
    document.getElementById('fImgUrl').value=instaSelectedImages[0];
  } else {
    document.getElementById('fImgUrl').value='';
  }
  renderInstaGrid(instaAllImages);
  // „Éí„É≥„Éà„ÇíÊõ¥Êñ∞
  const hint=document.getElementById('instaImgHint');
  if(hint) hint.textContent=instaSelectedImages.length
    ?`${instaSelectedImages.length}ÊûöÈÅ∏Êäû‰∏≠Ôºà1ÊûöÁõÆ„Åå„Çµ„É†„Éç„Ç§„É´„Å´„Å™„Çä„Åæ„ÅôÔºâ`
    :'„Çµ„É†„Éç„Ç§„É´„Å´„Åó„Åü„ÅÑÁîªÂÉè„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
}

// clearForm„Å´InstagramÂàùÊúüÂåñ„ÇíËøΩÂä†Áî®„Éï„ÉÉ„ÇØ
function resetInstaSelector(){
  instaSelectedImages=[];instaAllImages=[];
  const grid=document.getElementById('instaImgGrid');if(grid)grid.innerHTML='';
  const hint=document.getElementById('instaImgHint');
  if(hint) hint.textContent='ÊÉÖÂ†±ÂèñÂæóÂæå„Å´ÁîªÂÉè‰∏ÄË¶ß„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ„Çµ„É†„Éç„Ç§„É´„Å´„Åó„Åü„ÅÑÁîªÂÉè„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
  const imgArea=document.getElementById('imgArea');
  const imgUrlInput=document.getElementById('fImgUrl');
  if(imgArea) imgArea.style.display='block';
  if(imgUrlInput) imgUrlInput.style.display='block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORM HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setType(t){
  currentType=t;
  ['x','instagram','web','youtube','tiktok','memo'].forEach(tt=>{
    const key='type'+tt.charAt(0).toUpperCase()+tt.slice(1);
    // instagram ‚Üí typeInsta
    const elId=tt==='instagram'?'typeInsta':key;
    const el=document.getElementById(elId);
    if(el) el.classList.toggle('active',tt===t);
  });
  document.getElementById('urlRow').style.display=t==='memo'?'none':'flex';
  document.getElementById('xFields').style.display=(t==='x'||t==='tiktok'||t==='instagram')?'contents':'none';
  document.getElementById('webFields').style.display=t==='web'?'block':'none';
  document.getElementById('ytFields').style.display=t==='youtube'?'block':'none';
  document.getElementById('summaryField').style.display=t==='web'?'block':'none';
  document.getElementById('watchLaterLabel').style.display=(t==='youtube'||t==='tiktok')?'inline-flex':'none';
  document.getElementById('ytWatchedLabel').style.display='none';
  document.getElementById('statusBar').style.display='none';
  // InstagramÂ∞ÇÁî®ÁîªÂÉè„Çª„É¨„ÇØ„Çø„Éº
  const instaUI=document.getElementById('instaImageSelector');
  const normalImgUI=document.getElementById('imgArea')?.parentElement;
  if(instaUI) instaUI.style.display=t==='instagram'?'block':'none';
  // ÈÄöÂ∏∏ÁîªÂÉè„Ç®„É™„Ç¢„ÅØInstagram„Åß„ÅØÈùûË°®Á§∫
  const imgAreaWrap=document.getElementById('imgArea');
  if(imgAreaWrap){
    imgAreaWrap.style.display=t==='instagram'?'none':'block';
    const imgUrlInput=document.getElementById('fImgUrl');
    if(imgUrlInput) imgUrlInput.style.display=t==='instagram'?'none':'block';
  }
  const ph={x:'https://x.com/username/status/...',instagram:'https://www.instagram.com/p/XXXXX/',web:'https://example.com/article...',youtube:'https://youtube.com/watch?v=...',tiktok:'https://www.tiktok.com/@user/video/...',memo:''};
  const urlIn=document.getElementById('urlIn');
  if(urlIn) urlIn.placeholder=ph[t]||'';
}

function clearForm(){
  ['urlIn','fAuthor','fHandle','fTitle','fSite','fAuthorWeb','fYtTitle','fYtChannel',
   'fContent','fSummary','fMemo','fImgUrl','fArea','fCountry','fPrefecture','fLat','fLng','fRemindDate','fRemindMsg']
   .forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  ['fFavorite','fWatchLater','fYtWatched'].forEach(id=>{const el=document.getElementById(id);if(el)el.checked=false;});
  document.getElementById('imgPrev').style.display='none';
  document.getElementById('imgPh').style.display='flex';
  document.getElementById('fAreaStatus').textContent='';
  document.getElementById('statusBar').style.display='none';
  resetInstaSelector();
  fSel.clear();renderPicker('formPicker',fSel);setType('x');
}

function prevImgUrl(){
  const u=document.getElementById('fImgUrl').value.trim();
  const img=document.getElementById('imgPrev'),ph=document.getElementById('imgPh');
  if(u){img.src=u;img.style.display='block';ph.style.display='none';}
  else{img.style.display='none';ph.style.display='flex';}
}

function handleFile(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{document.getElementById('fImgUrl').value=ev.target.result;prevImgUrl();};
  r.readAsDataURL(f);
}

async function geocodeArea(prefix){
  const area=document.getElementById(prefix+'Area').value.trim();
  const country=document.getElementById(prefix+'Country').value.trim();
  const q=[area,country].filter(Boolean).join(', ');
  if(!q){toast('Â†¥ÊâÄÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  const statusId=prefix+'AreaStatus';
  document.getElementById(statusId).textContent='Ê§úÁ¥¢‰∏≠...';
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=3&addressdetails=1&accept-language=ja`);
    const d=await r.json();
    if(!d.length){document.getElementById(statusId).textContent='Â†¥ÊâÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü';return;}
    const best=d[0];
    const addr=best.address||{};
    document.getElementById(prefix+'Lat').value=best.lat;
    document.getElementById(prefix+'Lng').value=best.lon;
    // ÂõΩ„ÇíËá™ÂãïÂÖ•Âäõ
    if(addr.country) document.getElementById(prefix+'Country').value=addr.country;
    // ÈÉΩÈÅìÂ∫úÁúåÔºöÊó•Êú¨„ÅØ state„ÄÅÊµ∑Â§ñ„ÅØÂ§öÊßò„Å™„Éï„Ç£„Éº„É´„Éâ„ÇíË©¶„Åø„Çã
    const pref=addr.state||addr.state_district||addr.province||addr.region||addr.county||
      addr['ISO3166-2-lvl4']?.split('-').slice(-1)[0]||'';
    if(pref) document.getElementById(prefix+'Prefecture').value=pref;
    // Â†¥ÊâÄÂêç„ÅåÁ©∫„Å™„Çâ display_name „ÅÆÂÖàÈ†≠„Çí‰Ωø„ÅÜ
    if(!document.getElementById(prefix+'Area').value&&best.display_name){
      document.getElementById(prefix+'Area').value=best.display_name.split(',')[0];
    }
    document.getElementById(statusId).textContent=`‚úì ${addr.country||''}${pref?' / '+pref:''} „Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü`;
  }catch(e){document.getElementById(statusId).textContent='„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';}
}

async function geocodeFromMapUrl(prefix){
  const mapUrlId=prefix==='f'?'fMapUrlInput':'eMapUrlInput';
  const mapUrl=document.getElementById(mapUrlId)?.value.trim();
  if(!mapUrl){toast('Google„Éû„ÉÉ„ÉóURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  const statusId=prefix+'AreaStatus';
  document.getElementById(statusId).textContent='Google„Éû„ÉÉ„ÉóURL„Åã„ÇâÂèñÂæó‰∏≠...';
  try{
    let lat=null,lng=null;
    const m1=mapUrl.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
    if(m1){lat=parseFloat(m1[1]);lng=parseFloat(m1[2]);}
    if(!lat){const m2=mapUrl.match(/\/place\/([^\/]+)\/@(-?\d+\.\d+),(-?\d+\.\d+)/);if(m2){lat=parseFloat(m2[2]);lng=parseFloat(m2[3]);}}
    if(!lat){const m3=mapUrl.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/);if(m3){lat=parseFloat(m3[1]);lng=parseFloat(m3[2]);}}
    if(!lat){const m4=mapUrl.match(/ll=(-?\d+\.\d+),(-?\d+\.\d+)/);if(m4){lat=parseFloat(m4[1]);lng=parseFloat(m4[2]);}}
    if(lat&&lng){
      document.getElementById(prefix+'Lat').value=lat;
      document.getElementById(prefix+'Lng').value=lng;
      const rev=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ja`);
      const rd=await rev.json();
      const addr=rd.address||{};
      if(addr.country) document.getElementById(prefix+'Country').value=addr.country;
      const pref=addr.state||addr.province||addr.region||addr.county||'';
      if(pref) document.getElementById(prefix+'Prefecture').value=pref;
      const place=addr.city||addr.town||addr.village||addr.suburb||addr.neighbourhood||'';
      if(place) document.getElementById(prefix+'Area').value=place;
      document.getElementById(statusId).textContent=`‚úì Google„Éû„ÉÉ„Éó„Åã„ÇâÂèñÂæó: ${rd.display_name?.split(',').slice(0,2).join(',') ||''}`;
    } else {
      // URL„Åã„ÇâÂú∞Âêç„ÇíÊäΩÂá∫„Åó„Å¶Ê§úÁ¥¢
      const placeName=decodeURIComponent((mapUrl.match(/\/place\/([^\/\?@+]+)/)?.[1]||mapUrl.match(/[?&]q=([^&@]+)/)?.[1]||'').replace(/\+/g,' '));
      if(placeName){document.getElementById(prefix+'Area').value=placeName;await geocodeArea(prefix);}
      else document.getElementById(statusId).textContent='‚ö†Ô∏è URL„Åã„ÇâÂ∫ßÊ®ô„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü';
    }
  }catch(e){document.getElementById(statusId).textContent='„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';}
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAG PICKERS (ÈöéÂ±§Âûã: Ë¶™‚ÜíÂ≠ê)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPickers(){renderPicker('formPicker',fSel);renderPicker('editPicker',eSel);}

function renderPicker(pickerId,sel){
  const el=document.getElementById(pickerId);if(!el)return;
  const parentTags=tags.filter(t=>!t.parent_id);
  let html='';

  parentTags.forEach(pt=>{
    const children=tags.filter(c=>c.parent_id===pt.id);
    const parentSel=sel.has(pt.id);

    if(children.length){
      // Â≠ê„Çø„Ç∞„ÅÇ„ÇäÔºö„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥ÂΩ¢Âºè„Ç∞„É´„Éº„Éó
      const bgStyle=parentSel?`background:${pt.color}18;border-color:${pt.color}55`:'background:var(--off)';
      const checkStyle=parentSel?`background:${pt.color};border-color:${pt.color}`:'';
      html+=`<div class="tp-group" style="${parentSel?'border-color:'+pt.color+'55':''}">
        <div class="tp-parent-row${parentSel?' selected':''}" style="${bgStyle}" onclick="togglePill('${pt.id}','${pickerId}',this)">
          <div class="tp-parent-dot" style="background:${pt.color}"></div>
          <span class="tp-parent-name">${esc(pt.name)}</span>
          <div class="tp-parent-check" style="${checkStyle}">${parentSel?'‚úì':''}</div>
        </div>
        <div class="tp-children">
          ${children.map(ct=>{
            const childSel=sel.has(ct.id);
            const cStyle=childSel?`background:${ct.color};border-color:${ct.color}`:`border-color:${ct.color};color:${ct.color}`;
            return `<span class="tp-child-pill${childSel?' selected':''}" style="${cStyle}" onclick="togglePill('${ct.id}','${pickerId}',this)">
              <span style="width:6px;height:6px;border-radius:50%;background:${childSel?'rgba(255,255,255,.7)':ct.color};display:inline-block;flex-shrink:0"></span>
              ${esc(ct.name)}
            </span>`;
          }).join('')}
        </div>
      </div>`;
    } else {
      // Â≠ê„Çø„Ç∞„Å™„ÅóÔºö„Ç∑„É≥„Éó„É´„Å™Ë°åË°®Á§∫
      const pSel=sel.has(pt.id);
      const bgStyle=pSel?`background:${pt.color}18;border-color:${pt.color}55`:'';
      const checkStyle=pSel?`background:${pt.color};border-color:${pt.color}`:'';
      if(!html.includes('tp-lone-wrap')) html+=`<div class="tp-lone-wrap" style="display:flex;flex-wrap:wrap;gap:.35rem">`;
      // Âçò‰Ωì„Éî„É´ÔºàÂ≠ê„Å™„ÅóË¶™Ôºâ„ÅØÂæå„Åß„Åæ„Å®„ÇÅ„Å¶Âá∫Âäõ„Åô„Çã„Åü„ÇÅ‰∏ÄÊôÇÈÄÄÈÅø
      html+=`__LONE__${pt.id}__${pSel}__${pt.color}__${esc(pt.name)}__END`;
    }
  });

  // Âçò‰Ωì„Éî„É´„Çí„Åæ„Å®„ÇÅ„Å¶„É©„ÉÉ„Éó
  const loneMatches=[...html.matchAll(/__LONE__([^_]+)__(true|false)__([^_]+)__(.+?)__END/g)];
  if(loneMatches.length){
    const lonePillsHtml=loneMatches.map(m=>{
      const[,pid,pselStr,color,name]=m;
      const pSel=pselStr==='true';
      const style=pSel?`background:${color};border-color:${color};color:#fff`:`border-color:${color};color:${color}`;
      return `<span class="tp-child-pill${pSel?' selected':''}" style="${style}" onclick="togglePill('${pid}','${pickerId}',this)">
        <span style="width:7px;height:7px;border-radius:50%;background:${pSel?'rgba(255,255,255,.7)':color};display:inline-block;flex-shrink:0"></span>
        ${name}
      </span>`;
    }).join('');
    html=html.replace(/__LONE__[^]*?__END/g,'');
    html+=`<div style="display:flex;flex-wrap:wrap;gap:.35rem">${lonePillsHtml}</div>`;
  }

  el.innerHTML=html;
}

function togglePill(id,pickerId,el){
  const sel=pickerId==='formPicker'?fSel:eSel;
  const t=tags.find(t=>t.id===id);
  if(sel.has(id)){
    sel.delete(id);
    // Â≠ê„Çø„Ç∞Ëß£Èô§ÊôÇÔºö‰ªñ„ÅÆÂ≠ê„Çø„Ç∞„Åå„Å™„Åë„Çå„Å∞Ë¶™„ÇÇËß£Èô§
    if(t?.parent_id){
      const remainSiblings=tags.filter(c=>c.parent_id===t.parent_id&&sel.has(c.id));
      if(!remainSiblings.length) sel.delete(t.parent_id);
    }
    // Ë¶™„Çø„Ç∞Ëß£Èô§ÊôÇÔºöÂ≠ê„Çø„Ç∞„ÇÇ„Åô„Åπ„Å¶Ëß£Èô§
    if(!t?.parent_id){
      tags.filter(c=>c.parent_id===t.id).forEach(c=>sel.delete(c.id));
    }
  } else {
    sel.add(id);
    // Â≠ê„Çø„Ç∞ÈÅ∏ÊäûÊôÇÔºöË¶™„Çø„Ç∞„ÇíËá™ÂãïËøΩÂä†
    if(t?.parent_id) sel.add(t.parent_id);
  }
  renderPicker(pickerId,sel);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAGS CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function addTag(){
  const inp=document.getElementById('newTagIn'),name=inp.value.trim();
  const color=document.getElementById('newTagColor').value;
  if(!name)return;
  if(tags.find(t=>t.name===name)){toast('Âêå„ÅòÂêçÂâç„ÅÆ„Çø„Ç∞„ÅåÂ≠òÂú®„Åó„Åæ„Åô','err');return;}
  const t={id:'t'+Date.now(),name,color,parent_id:null,sort_order:tags.filter(t=>!t.parent_id).length};
  try{await sb('tags','POST',t);tags.push(t);inp.value='';saveTagOrder(tags.map(t=>t.id));renderAll();renderSettings();toast('„Çø„Ç∞ËøΩÂä†','ok');}
  catch(e){toast('„Ç®„É©„Éº: '+e.message,'err');}
}

async function addSubTag(){
  const parentId=document.getElementById('parentTagSelect').value;
  const name=document.getElementById('newSubTagIn').value.trim();
  if(!parentId){toast('Ë¶™„Çø„Ç∞„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  if(!name){toast('„Çø„Ç∞Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  if(tags.find(t=>t.name===name)){toast('Âêå„ÅòÂêçÂâç„ÅÆ„Çø„Ç∞„ÅåÂ≠òÂú®„Åó„Åæ„Åô','err');return;}
  const parent=tags.find(t=>t.id===parentId);
  const t={id:'t'+Date.now(),name,color:parent?.color||COLORS[tags.length%COLORS.length],parent_id:parentId,sort_order:tags.length};
  try{await sb('tags','POST',t);tags.push(t);document.getElementById('newSubTagIn').value='';saveTagOrder(tags.map(t=>t.id));renderAll();renderSettings();toast(`„Äå${name}„Äç„ÇíËøΩÂä†`,'ok');}
  catch(e){toast('„Ç®„É©„Éº: '+e.message,'err');}
}

async function delTag(id){
  if(!confirm('„Åì„ÅÆ„Çø„Ç∞„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü'))return;
  try{
    await sb('tags?id=eq.'+id,'DELETE');
    tags=tags.filter(t=>t.id!==id);
    for(const p of posts){if(p.tags?.includes(id)){p.tags=p.tags.filter(x=>x!==id);await sb('posts?id=eq.'+p.id,'PATCH',{tags:p.tags}).catch(()=>{});}}
    if(tagFilter===id)tagFilter=null;
    saveTagOrder(tags.map(t=>t.id));renderAll();renderSettings();toast('„Çø„Ç∞„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
  }catch(e){toast('„Ç®„É©„Éº: '+e.message,'err');}
}

async function renameTag(id){
  const t=tags.find(t=>t.id===id);if(!t)return;
  const name=prompt('Êñ∞„Åó„ÅÑ„Çø„Ç∞Âêç',t.name);if(!name||name.trim()===t.name)return;
  try{await sb('tags?id=eq.'+id,'PATCH',{name:name.trim()});t.name=name.trim();renderAll();renderSettings();toast('„Çø„Ç∞Âêç„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü','ok');}
  catch(e){toast('„Ç®„É©„Éº: '+e.message,'err');}
}

async function changeTagColor(id,color){
  try{await sb('tags?id=eq.'+id,'PATCH',{color});const t=tags.find(t=>t.id===id);if(t)t.color=color;renderAll();renderSettings();}
  catch(e){toast('„Ç®„É©„Éº: '+e.message,'err');}
}

function moveTag(id,dir){
  const t=tags.find(t=>t.id===id);
  if(!t) return;
  if(t.parent_id){
    // Â≠ê„Çø„Ç∞ÔºöÂêå‰∏ÄË¶™ÂÜÖ„Åß„ÅÆ„ÅøÁßªÂãï
    const siblings=tags.filter(s=>s.parent_id===t.parent_id);
    const idx=siblings.indexOf(t);
    const newIdx=idx+dir;
    if(newIdx<0||newIdx>=siblings.length) return;
    // tagsÈÖçÂàóÂÜÖ„Åß„ÅÆ‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
    const globalIdx=tags.indexOf(t);
    const swapWith=siblings[newIdx];
    const swapIdx=tags.indexOf(swapWith);
    [tags[globalIdx],tags[swapIdx]]=[tags[swapIdx],tags[globalIdx]];
  } else {
    // Ë¶™„Çø„Ç∞ÔºöÈÖç‰∏ã„ÅÆÂ≠ê„Çø„Ç∞„ÇÇÂê´„ÇÅ„Å¶„Ç∞„É´„Éº„Éó„Åî„Å®ÁßªÂãï
    const parentTags=tags.filter(t=>!t.parent_id);
    const ptIdx=parentTags.indexOf(t);
    const newPtIdx=ptIdx+dir;
    if(newPtIdx<0||newPtIdx>=parentTags.length) return;
    // „Ç∞„É´„Éº„Éó„Çí‰ΩúÊàêÔºö[Ë¶™, Â≠ê1, Â≠ê2, ...]
    const buildGroup=(parent)=>[parent,...tags.filter(c=>c.parent_id===parent.id)];
    const groups=parentTags.map(pt=>buildGroup(pt));
    [groups[ptIdx],groups[newPtIdx]]=[groups[newPtIdx],groups[ptIdx]];
    // tagsÂÖ®‰Ωì„ÇíÂÜçÊßãÁØâÔºà„Ç∞„É´„Éº„ÉóÈ†Ü + Â≠§Á´ã„Çø„Ç∞Ôºâ
    const flatGrouped=groups.flat();
    const orphans=tags.filter(t=>t.parent_id&&!parentTags.some(pt=>pt.id===t.parent_id));
    const newTags=[...flatGrouped,...orphans];
    tags.length=0;newTags.forEach(t2=>tags.push(t2));
  }
  saveTagOrder(tags.map(t=>t.id));renderAll();renderSettings();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REMINDERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderReminderBar(){
  const today=new Date();today.setHours(0,0,0,0);
  const tomorrow=new Date(today);tomorrow.setDate(tomorrow.getDate()+1);
  const due=reminders.filter(r=>!r.done&&r.remind_at>=today.getTime()&&r.remind_at<tomorrow.getTime());
  const rbEmpty=document.getElementById('rbEmpty');
  const rbItems=document.getElementById('rbItems');
  if(!due.length){rbEmpty.style.display='block';rbItems.innerHTML='';return;}
  rbEmpty.style.display='none';
  rbItems.innerHTML=due.map(r=>{
    const p=posts.find(p=>p.id===r.post_id);
    const label=p?esc(p.author+(r.message?' ‚Äî '+r.message:'')):esc(r.message||'„É™„Éû„Ç§„É≥„ÉÄ„Éº');
    return `<div class="rb-item"><span>${label}</span>${p?`<button class="c-btn" onclick="openDetail('${p.id}')" style="font-size:.65rem;padding:.12rem .4rem">Á¢∫Ë™ç</button>`:''}<button class="rb-dismiss" onclick="dismissReminder('${r.id}')">‚úï</button></div>`;
  }).join('');
}

async function dismissReminder(id){
  try{await sb('reminders?id=eq.'+id,'PATCH',{done:true});const r=reminders.find(r=>r.id===id);if(r)r.done=true;renderReminderBar();}
  catch(e){console.error(e);}
}

function openReminderModal(postId){
  reminderPostId=postId;
  const p=posts.find(p=>p.id===postId);
  document.getElementById('reminderPostInfo').textContent=p?`„Äå${p.author}„Äç: ${(p.content||p.memo||'').slice(0,60)}`:'';
  document.getElementById('rDate').value='';
  document.getElementById('rMessage').value='';
  const existing=reminders.filter(r=>r.post_id===postId&&!r.done);
  document.getElementById('existingReminders').innerHTML=existing.length
    ?`<div style="font-size:.75rem;color:var(--ink3);margin-bottom:.3rem">Ë®≠ÂÆöÊ∏à„Åø</div>`+existing.map(r=>`<div class="tag-mgr-row"><span style="font-family:'DM Mono',monospace;font-size:.68rem">${new Date(r.remind_at).toLocaleDateString('ja-JP')}</span><span style="font-size:.76rem;flex:1;padding-left:.4rem">${esc(r.message||'')}</span><button class="tmr-btn" onclick="deleteReminder('${r.id}')">‚úï</button></div>`).join(''):'';
  openModal('reminderModal');
}

async function saveReminder(){
  const date=document.getElementById('rDate').value;
  if(!date){toast('Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  const r={id:'r'+Date.now(),post_id:reminderPostId,remind_at:new Date(date).getTime(),message:document.getElementById('rMessage').value.trim(),done:false};
  try{await sb('reminders','POST',r);reminders.push(r);toast('„É™„Éû„Ç§„É≥„ÉÄ„Éº„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Åü ‚úì','ok');closeModal('reminderModal');renderReminderBar();}
  catch(e){toast('„Ç®„É©„Éº: '+e.message,'err');}
}

async function deleteReminder(id){
  try{await sb('reminders?id=eq.'+id,'DELETE');reminders=reminders.filter(r=>r.id!==id);toast('ÂâäÈô§„Åó„Åæ„Åó„Åü');if(reminderPostId)openReminderModal(reminderPostId);renderReminderBar();}
  catch(e){toast('„Ç®„É©„Éº: '+e.message,'err');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// YOUTUBE PLAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadYtApi(){
  const tag=document.createElement('script');tag.src='https://www.youtube.com/iframe_api';document.head.appendChild(tag);
}
window.onYouTubeIframeAPIReady=function(){ytApiReady=true;};

function playYt(id){
  const filtered=getFiltered().filter(p=>p.type==='youtube');
  if(!filtered.length){toast('YouTube„Åå„ÅÇ„Çä„Åæ„Åõ„Çì','err');return;}
  ytPlaylist=filtered;
  const idx=ytPlaylist.findIndex(p=>p.id===id);
  ytPlayIdx=idx>=0?idx:0;
  openHomePlayer();
}

function startHomePlaylist(){
  const includeWatched=document.getElementById('includeWatched')?.checked||false;
  // „Éï„Ç£„É´„Çø„ÉºÂà§ÂÆö: yt-watchlater „ÇÑ fav „Éï„Ç£„É´„Çø„Éº„Åå active „Å™„ÇâÊú™Ë¶ñËÅ¥„ÅÆ„Åø
  const forceUnwatchedOnly=curFilter==='yt-watchlater'||curFilter==='fav';
  let filtered=getFiltered().filter(p=>p.type==='youtube');
  if(!includeWatched&&(forceUnwatchedOnly||!includeWatched)){
    filtered=filtered.filter(p=>p.youtube_status!=='watched');
  }
  if(!filtered.length){toast('ÂÜçÁîü„Åß„Åç„ÇãYouTube„Åå„ÅÇ„Çä„Åæ„Åõ„Çì','err');return;}
  ytPlaylist=filtered;ytPlayIdx=0;
  openHomePlayer();
}

function startPlaylist(){startHomePlaylist();switchTab('home');}

function openHomePlayer(){
  document.getElementById('homeYtPanel').style.display='block';
  document.getElementById('homeYtPanel').scrollIntoView({behavior:'smooth',block:'start'});
  loadHomeYtVideo();renderYtQueue();
}

function closeHomePlayer(){
  document.getElementById('homeYtPanel').style.display='none';
  document.getElementById('homeYtIframeContainer').innerHTML='';
  ytPlayer=null;
}

function loadHomeYtVideo(){
  const p=ytPlaylist[ytPlayIdx];if(!p)return;
  const vid=getYtId(p.url);if(!vid)return;
  const isMobile=/iPhone|iPad|Android/i.test(navigator.userAgent);
  if(ytPlayer&&ytPlayer.loadVideoById&&!isMobile){ytPlayer.loadVideoById(vid);}
  else if(!isMobile&&ytApiReady&&window.YT&&window.YT.Player){
    document.getElementById('homeYtIframeContainer').innerHTML='<div id="ytIframeEl" style="width:100%;height:100%;position:absolute;inset:0"></div>';
    ytPlayer=new YT.Player('ytIframeEl',{videoId:vid,width:'100%',height:'100%',playerVars:{autoplay:1,rel:0,playsinline:1},events:{onStateChange(e){if(e.data===YT.PlayerState.ENDED)ytNextAuto();}}});
  } else {
    // „É¢„Éê„Ç§„É´„ÇÑAPI„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥Âêà: postMessage„ÅßÁµÇ‰∫ÜÊ§úÁü•„Åô„Çãiframe
    document.getElementById('homeYtIframeContainer').innerHTML=
      `<iframe id="ytFbIframe" src="https://www.youtube.com/embed/${vid}?autoplay=1&rel=0&playsinline=1&enablejsapi=1&origin=${encodeURIComponent(location.origin)}" style="width:100%;height:100%;position:absolute;inset:0" frameborder="0" allowfullscreen allow="autoplay;encrypted-media"></iframe>`;
    ytPlayer=null;
    // „É¢„Éê„Ç§„É´Áî®ÔºöpostMessage„ÅßYT API„Ç§„Éô„É≥„Éà„ÇíÂèó‰ø°
    if(!window._ytMsgBound){
      window._ytMsgBound=true;
      window.addEventListener('message',ev=>{
        try{
          const d=JSON.parse(ev.data);
          if(d.event==='onStateChange'&&d.info===0) ytNextAuto();
        }catch(e){}
      });
    }
  }
  updateYtPlayInfo();renderYtQueue();
}

function updateYtPlayInfo(){
  const p=ytPlaylist[ytPlayIdx];if(!p)return;
  const el=document.getElementById('homeYtPlayInfo');
  if(el) el.innerHTML=`<span style="font-family:'DM Mono',monospace;font-size:.62rem;opacity:.5">${ytPlayIdx+1}/${ytPlaylist.length}</span> <span style="font-weight:500">${esc(p.author)}</span>${p.is_favorite?' ‚≠ê':''}${p.watch_later?' üìå':''}`;
}

function renderYtQueue(){
  const el=document.getElementById('homeYtQueue');if(!el)return;
  const showWatched=document.getElementById('plIncludeWatched')?.checked;
  el.innerHTML=ytPlaylist.map((p,i)=>{
    if(!showWatched&&p.youtube_status==='watched'&&i!==ytPlayIdx) return '';
    return `<div class="yt-queue-item${i===ytPlayIdx?' active':''}" 
      draggable="true"
      ondragstart="ytDragStart(event,${i})"
      ondragover="ytDragOver(event)"
      ondrop="ytDrop(event,${i})"
      ondragend="ytDragEnd(event)"
      onclick="ytJump(${i})">
      <span style="font-size:.65rem;color:var(--ink3);cursor:grab;padding:0 .2rem;user-select:none">‚†ø</span>
      <img class="yt-queue-thumb" src="https://img.youtube.com/vi/${getYtId(p.url)}/default.jpg" onerror="this.style.display='none'" alt="">
      <div class="yt-queue-title" style="opacity:${p.youtube_status==='watched'?.4:1}">${esc(p.author)}${p.is_favorite?' ‚≠ê':''}${p.youtube_status==='watched'?' ‚úÖ':''}</div>
      <span style="font-family:'DM Mono',monospace;font-size:.55rem;color:var(--ink3);flex-shrink:0">${i+1}</span>
    </div>`;
  }).join('');
}

let ytDragIdx=null;
function ytDragStart(e,idx){ytDragIdx=idx;e.currentTarget.style.opacity='.4';}
function ytDragOver(e){e.preventDefault();e.currentTarget.style.background='rgba(255,255,255,.15)';}
function ytDragEnd(e){e.currentTarget.style.opacity='';e.currentTarget.style.background='';}
function ytDrop(e,toIdx){
  e.preventDefault();e.currentTarget.style.background='';
  if(ytDragIdx===null||ytDragIdx===toIdx)return;
  const item=ytPlaylist.splice(ytDragIdx,1)[0];
  ytPlaylist.splice(toIdx,0,item);
  if(ytPlayIdx===ytDragIdx) ytPlayIdx=toIdx;
  else if(ytDragIdx<ytPlayIdx&&toIdx>=ytPlayIdx) ytPlayIdx--;
  else if(ytDragIdx>ytPlayIdx&&toIdx<=ytPlayIdx) ytPlayIdx++;
  ytDragIdx=null;
  renderYtQueue();updateYtPlayInfo();
}

function ytJump(idx){ytPlayIdx=idx;loadHomeYtVideo();}
function ytPrev(){if(ytPlayIdx>0){ytPlayIdx--;loadHomeYtVideo();}else toast('ÊúÄÂàù„ÅÆÂãïÁîª„Åß„Åô');}
function ytNext(){if(ytPlayIdx<ytPlaylist.length-1){ytPlayIdx++;loadHomeYtVideo();}else{toast('„Éó„É¨„Ç§„É™„Çπ„ÉàÁµÇ‰∫Ü üéâ','ok');closeHomePlayer();}}

async function ytNextAuto(){
  const p=ytPlaylist[ytPlayIdx];
  if(p&&p.youtube_status!=='watched'){
    p.youtube_status='watched';p.watch_later=false;
    try{await sb('posts?id=eq.'+p.id,'PATCH',{youtube_status:'watched',watch_later:false});}catch(e){}
  }
  let next=ytPlayIdx+1;
  const includeWatched=document.getElementById('plIncludeWatched')?.checked;
  while(!includeWatched&&next<ytPlaylist.length&&ytPlaylist[next].youtube_status==='watched') next++;
  if(next<ytPlaylist.length){ytPlayIdx=next;loadHomeYtVideo();toast(`Ê¨°: ${ytPlaylist[ytPlayIdx].author}`);}
  else{toast('„Éó„É¨„Ç§„É™„Çπ„ÉàÁµÇ‰∫Ü üéâ','ok');closeHomePlayer();renderAll();}
}

async function markWatched(){
  const p=ytPlaylist[ytPlayIdx];if(!p)return;
  p.youtube_status='watched';p.watch_later=false;
  try{
    await sb('posts?id=eq.'+p.id,'PATCH',{youtube_status:'watched',watch_later:false});
    toast('Ë¶ñËÅ¥Ê∏à„Åø„Å´„Åó„Åæ„Åó„Åü ‚úì','ok');renderYtQueue();
    await ytNextAuto();
  }catch(e){toast('„Ç®„É©„Éº: '+e.message,'err');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSettings(){
  const parentTags=tags.filter(t=>!t.parent_id);
  let html='';
  parentTags.forEach(pt=>{
    const children=tags.filter(c=>c.parent_id===pt.id);
    html+=`<div class="tag-mgr-row" style="border-left:3px solid ${pt.color};padding-left:.6rem;background:transparent">
      <div class="tmr-order">
        <button onclick="moveTag('${pt.id}',-1)" title="‰∏ä„Å∏">‚ñ≤</button>
        <button onclick="moveTag('${pt.id}',1)" title="‰∏ã„Å∏">‚ñº</button>
      </div>
      <div class="t-dot" style="background:${pt.color};width:8px;height:8px"></div>
      <input type="color" value="${pt.color}" onchange="changeTagColor('${pt.id}',this.value)" style="width:20px;height:20px;padding:1px;border:1px solid var(--line);border-radius:50%;cursor:pointer" title="Ëâ≤„ÇíÂ§âÊõ¥">
      <span class="tmr-name" style="font-weight:500">${esc(pt.name)}</span>
      <button class="tmr-btn" onclick="renameTag('${pt.id}')">‚úèÔ∏è</button>
      <button class="tmr-btn" onclick="delTag('${pt.id}')">‚úï</button>
    </div>`;
    children.forEach(ct=>{
      html+=`<div class="tag-mgr-row" style="padding-left:2rem;background:var(--off);border-radius:3px;margin-bottom:1px;border-left:3px solid ${ct.color}40">
        <div class="tmr-order">
          <button onclick="moveTag('${ct.id}',-1)" title="‰∏ä„Å∏">‚ñ≤</button>
          <button onclick="moveTag('${ct.id}',1)" title="‰∏ã„Å∏">‚ñº</button>
        </div>
        <div class="t-dot" style="background:${ct.color};width:6px;height:6px"></div>
        <input type="color" value="${ct.color}" onchange="changeTagColor('${ct.id}',this.value)" style="width:18px;height:18px;padding:1px;border:1px solid var(--line);border-radius:50%;cursor:pointer" title="Ëâ≤„ÇíÂ§âÊõ¥">
        <span class="tmr-name" style="font-size:.74rem;color:var(--ink3)">‚îî ${esc(ct.name)}</span>
        <button class="tmr-btn" onclick="renameTag('${ct.id}')">‚úèÔ∏è</button>
        <button class="tmr-btn" onclick="delTag('${ct.id}')">‚úï</button>
      </div>`;
    });
  });
  document.getElementById('tagMgrList').innerHTML=html;

  // Ë¶™„Çø„Ç∞„Çª„É¨„ÇØ„ÉàÊõ¥Êñ∞
  const psel=document.getElementById('parentTagSelect');
  if(psel) psel.innerHTML='<option value="">Ë¶™„Çø„Ç∞„ÇíÈÅ∏Êäû...</option>'+parentTags.map(t=>`<option value="${t.id}">${esc(t.name)}</option>`).join('');
  const ytSel=document.getElementById('ytPlayTag');
  if(ytSel) ytSel.innerHTML='<option value="">„Åô„Åπ„Å¶ÔºàÁµû„ÇäËæº„Åø„Å™„ÅóÔºâ</option>'+tags.map(t=>`<option value="${t.id}">${esc(t.name)}</option>`).join('');

  // „É™„Éû„Ç§„É≥„ÉÄ„Éº‰∏ÄË¶ß
  const allR=document.getElementById('allRemindersList');
  if(allR){
    const upcoming=reminders.filter(r=>!r.done).sort((a,b)=>a.remind_at-b.remind_at);
    allR.innerHTML=upcoming.length?upcoming.map(r=>{
      const p=posts.find(p=>p.id===r.post_id);
      return `<div class="tag-mgr-row">
        <input type="checkbox" onchange="completeReminder('${r.id}')" style="accent-color:var(--green)">
        <span style="font-family:'DM Mono',monospace;font-size:.66rem;color:var(--ink3)">${new Date(r.remind_at).toLocaleDateString('ja-JP')}</span>
        <span style="font-size:.76rem;flex:1;padding-left:.35rem">${esc(p?.author||'')} ${esc(r.message||'')}</span>
        <button class="tmr-btn" onclick="deleteReminder('${r.id}')">‚úï</button>
      </div>`;
    }).join(''):`<div style="font-size:.78rem;color:var(--ink3)">„É™„Éû„Ç§„É≥„ÉÄ„Éº„Å™„Åó</div>`;
  }

  // Áµ±Ë®à
  const yt=posts.filter(p=>p.type==='youtube');
  const statsWrap=document.getElementById('statsWrap');
  if(statsWrap) statsWrap.innerHTML=`
    <div>Á∑è„ÇØ„É™„ÉÉ„ÉóÊï∞: <b>${posts.length}</b></div>
    <div>X„Éù„Çπ„Éà: <b>${posts.filter(p=>p.type==='x').length}</b></div>
    <div>Instagram: <b>${posts.filter(p=>p.type==='instagram').length}</b></div>
    <div>WebË®ò‰∫ã: <b>${posts.filter(p=>p.type==='web').length}</b></div>
    <div>YouTube: <b>${yt.length}</b>ÔºàÊú™Ë¶ñËÅ¥: <b>${yt.filter(p=>p.youtube_status!=='watched').length}</b>„ÄÅ„ÅÇ„Å®„ÅßË¶ã„Çã: <b>${yt.filter(p=>p.watch_later).length}</b>Ôºâ</div>
    <div>„É°„É¢: <b>${posts.filter(p=>p.type==='memo').length}</b></div>
    <div>„ÅäÊ∞ó„Å´ÂÖ•„Çä: <b>${posts.filter(p=>p.is_favorite).length}</b></div>
    <div>„Çø„Ç∞Êï∞: <b>${tags.length}</b></div>
    <div>„É™„Éû„Ç§„É≥„ÉÄ„Éº: <b>${reminders.filter(r=>!r.done).length}</b> ‰ª∂</div>`;
}

async function completeReminder(id){
  try{await sb('reminders?id=eq.'+id,'PATCH',{done:true});const r=reminders.find(r=>r.id===id);if(r)r.done=true;renderSettings();renderReminderBar();toast('„É™„Éû„Ç§„É≥„ÉÄ„Éº„ÇíÂÆå‰∫Ü„Å´„Åó„Åæ„Åó„Åü','ok');}
  catch(e){toast('„Ç®„É©„Éº: '+e.message,'err');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEW / MODE / STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setView(v){
  viewMode=v;
  ['vGrid','vList','vMap'].forEach(id=>document.getElementById(id)?.classList.remove('active'));
  document.getElementById('v'+v.charAt(0).toUpperCase()+v.slice(1))?.classList.add('active');
  document.getElementById('mapWrap').style.display=v==='map'?'block':'none';
  document.getElementById('postsWrap').style.display=v==='map'?'none':'block';
  const mfb=document.getElementById('mapFilterBar');
  if(mfb) mfb.style.display=v==='map'?'block':'none';
  renderHome();
}

function setMode(m){
  displayMode=m;
  document.getElementById('modeA')?.classList.toggle('active',m==='A');
  document.getElementById('modeB')?.classList.toggle('active',m==='B');
  renderHome();
}

function updateStats(){
  const now=Date.now(),wk=7*864e5;
  document.getElementById('totalCount').textContent=posts.length;
  document.getElementById('tagCount').textContent=tags.length;
  const yt=posts.filter(p=>p.type==='youtube');
  document.getElementById('cAll').textContent=posts.length;
  document.getElementById('cFav').textContent=posts.filter(p=>p.is_favorite).length;
  document.getElementById('cYtWl').textContent=posts.filter(p=>p.watch_later&&(p.type!=='youtube'||(p.type==='youtube'&&p.youtube_status!=='watched'))).length;
  document.getElementById('cRec').textContent=posts.filter(p=>now-p.createdAt<wk).length;
  const untaggedEl=document.getElementById('cUntagged');
  if(untaggedEl) untaggedEl.textContent=posts.filter(p=>!p.tags||p.tags.length===0).length;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
let tTimer;
function toast(msg,type=''){
  const el=document.getElementById('toast');el.textContent=msg;el.className='toast show'+(type?' '+type:'');
  clearTimeout(tTimer);tTimer=setTimeout(()=>{el.className='toast';},3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('newTagIn')?.addEventListener('keydown',e=>{if(e.key==='Enter')addTag();});
['detailModal','editModal','reminderModal'].forEach(id=>{
  document.getElementById(id)?.addEventListener('click',e=>{if(e.target===document.getElementById(id))closeModal(id);});
});
// „Éâ„É≠„ÉØ„ÉºÔºöËÉåÊôØ„Çø„ÉÉ„Éó„ÅßÈñâ„Åò„Çã
document.getElementById('detailDrawer')?.addEventListener('click',e=>{
  if(e.target===document.getElementById('detailDrawer')) closeDrawer();
});
// „Éâ„É≠„ÉØ„ÉºÔºö„Çπ„ÉØ„Ç§„Éó„ÉÄ„Ç¶„É≥„ÅßÈñâ„Åò„Çã
let touchStartY=0;
document.getElementById('detailDrawerInner')?.addEventListener('touchstart',e=>{touchStartY=e.touches[0].clientY;},{passive:true});
document.getElementById('detailDrawerInner')?.addEventListener('touchend',e=>{
  const dy=e.changedTouches[0].clientY-touchStartY;
  if(dy>60) closeDrawer();
},{passive:true});

init();
</script>
</body>
</html>
